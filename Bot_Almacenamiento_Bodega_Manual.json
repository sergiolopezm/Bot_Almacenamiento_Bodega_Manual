{
  "name": "Pruebas",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "b53e7f9a-75f6-4090-a956-97c8fa707895",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -13792,
        5072
      ],
      "id": "a55848bb-7ea9-473b-aec7-f7bcefb2d9ef",
      "name": "Mensaje Entrada",
      "webhookId": "b53e7f9a-75f6-4090-a956-97c8fa707895"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "42be7c60-3517-4559-9891-c6e774f76888",
              "name": "message.id",
              "value": "={{ $json.body.data.key.id }}",
              "type": "string"
            },
            {
              "id": "4379efd4-3f5c-418c-8126-c3ce1e18b7a3",
              "name": "message.contenido",
              "value": "={{ $json.body.data.message.conversation }}",
              "type": "string"
            },
            {
              "id": "08d830cc-5846-41e2-b2f5-d2e6dbbb37e2",
              "name": "message.date",
              "value": "={{ new Date(Date.now() - 5*60*60*1000).toISOString() }}",
              "type": "string"
            },
            {
              "id": "51f87c32-fe22-430b-9a43-04f45e9cc969",
              "name": "message.chat.id",
              "value": "={{ $json.body.data.key.remoteJid }}",
              "type": "string"
            },
            {
              "id": "18719256-6e5b-4a97-91c3-9a4e9c440997",
              "name": "message.chat.instance",
              "value": "={{ $json.body.instance }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -13600,
        5072
      ],
      "id": "e8b34e40-347a-4d29-ad6c-f6212fe4ae7e",
      "name": "Parametrizaci칩n"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO MensajesWhatsApp (message_id, contenido, fecha, chat_id, instance)\nVALUES ('{{ $json.message.id }}',\n        '{{ $json.message.contenido }}',\n        FORMAT(CONVERT(datetime, '{{ $json.message.date }}', 127), 'yyyy-MM-dd HH:mm:ss'),\n        '{{ $json[\"message\"][\"chat\"][\"id\"] }}',\n        '{{ $json[\"message\"][\"chat\"][\"instance\"] }}');\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        -13392,
        5072
      ],
      "id": "398010cf-d08d-4811-8ac7-0c0f13b5bf04",
      "name": "Guarda el mensaje en SQL",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM MensajesWhatsApp\nWHERE chat_id = '{{ $('Parametrizaci칩n').item.json.message.chat.id }}'\n   OR (chat_id = 'agenteAI' AND message_id IN (\n       SELECT message_id \n       FROM MensajesWhatsApp \n       WHERE chat_id = '{{ $('Parametrizaci칩n').item.json.message.chat.id }}'\n   ))\nORDER BY fecha ASC;\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        -13152,
        5072
      ],
      "id": "163edee8-31fb-46e3-b4d8-5f5d637ada96",
      "name": "Recupera todos los mensajes",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener los mensajes del input\nconst mensajes = $('Recupera todos los mensajes').all();\n\n// Asegurar que haya mensajes antes de continuar\nif (mensajes.length === 0) {\n  return [{ mensajeCount: 0, tiempoUltimoMensaje: null }];\n}\n\n// Obtener la fecha del 칰ltimo mensaje\nconst fechaMensajeStr = mensajes[mensajes.length - 1].json.fecha; // Aseg칰rate de que 'fecha' es el nombre correcto\nconst fechaMensajeDate = new Date(fechaMensajeStr); // Convertir a Date\n\n// Obtener la fecha y hora actual\nconst fechaActual = new Date();\n\n// Calcular la diferencia en segundos\nconst diferenciaSegundos = Math.floor((fechaActual.getTime() - fechaMensajeDate.getTime()) / 1000);\n\n// Retornar datos para el nodo Switch\nreturn [{\n  mensajeCount: mensajes.length,\n  tiempoUltimoMensaje: diferenciaSegundos\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -12960,
        5456
      ],
      "id": "34d19867-3910-4f92-90ad-19f94c7e9af1",
      "name": "Count y Tiempo 칔ltimo Mensaje"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "81c77bfb-8151-4c31-9380-784ae2c20f02",
              "leftValue": "={{ $json.mensajeCount }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "e049aa85-8cb2-483a-814e-0b17613927a5",
              "leftValue": "={{ $json.tiempoUltimoMensaje }}",
              "rightValue": 5,
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -12736,
        5280
      ],
      "id": "08ed27b3-1510-4059-ba57-ef48c3947a2d",
      "name": "If (Salida 0 - No hacer nada)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e327003b-210e-4d36-a17d-6550957ca66c",
              "leftValue": "={{ $json.tiempoUltimoMensaje }}",
              "rightValue": 5,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            },
            {
              "id": "de6f6e64-1e10-434c-8bc5-303d98bdb3ac",
              "leftValue": "={{ $json.tiempoUltimoMensaje }}",
              "rightValue": 15,
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -12512,
        5392
      ],
      "id": "393ce285-ec00-48ff-ad4a-122bffd295e2",
      "name": "If (Salida 1 - Esperar)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "143c51ad-50d4-44ee-a050-61e4ffcf2eb3",
              "leftValue": "={{ $json.tiempoUltimoMensaje }}",
              "rightValue": 15,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -12320,
        5568
      ],
      "id": "95567ffd-f073-4f49-8a0a-b1e15cf1176f",
      "name": "If (Salida 2 - Seguir)"
    },
    {
      "parameters": {
        "amount": "={{$json[\"tiempoUltimoMensaje\"]}}"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -11648,
        5632
      ],
      "id": "99f49783-25d0-46e9-99b5-85c3f6a30719",
      "name": "Espera X segundos",
      "webhookId": "9c8f7481-324f-499e-9136-938ad85f693c"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -12512,
        5200
      ],
      "id": "58b7d531-d386-4675-bb41-060e722b3eb3",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -12080,
        5632
      ],
      "id": "7750703c-e121-41cc-92da-c6af87adb53d",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8086b05f-a632-494c-a9c3-d1b74bc1a244",
              "name": "infoMensaje.chat_id",
              "value": "={{ $node[\"Recupera todos los mensajes\"].json.chat_id }}",
              "type": "string"
            },
            {
              "id": "5d101db7-b90d-4464-8da5-68b82779fc85",
              "name": "infoMensaje.historialMensajes",
              "value": "={{ $node[\"Organizaci칩n y estructuracion de mensajes\"].json.historialMensajes }}",
              "type": "string"
            },
            {
              "id": "5c95d18f-1470-4096-83a5-f0a55234d1e5",
              "name": "infoMensaje.count",
              "value": "={{ $('If (Salida 2 - Seguir)').first().json.mensajeCount }}",
              "type": "string"
            },
            {
              "id": "0c776e32-ba1b-41b2-86f4-33f19d7c06dc",
              "name": "infoMensaje.tiempoUltimoMensaje",
              "value": "={{ $('If (Salida 2 - Seguir)').first().json.tiempoUltimoMensaje }}",
              "type": "string"
            },
            {
              "id": "d86a9164-3da9-4e08-872b-c05816a4ef92",
              "name": "infoMensaje.mensajeActual",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.message.conversation }}",
              "type": "string"
            },
            {
              "id": "530fe022-b6aa-4e79-adbb-c4f32edd8ccb",
              "name": "infoMensaje.fechaMensajeActual",
              "value": "={{ $('Parametrizaci칩n').first().json.message.date.split('T')[0] }}",
              "type": "string"
            },
            {
              "id": "c51a7336-1fd0-40aa-a1b6-7afab57af93c",
              "name": "infoMensaje.horaMensajeActual",
              "value": "={{ \n  new Date($('Parametrizaci칩n').first().json.message.date)\n    .toLocaleTimeString(\"es-CO\", { \n      hour: '2-digit', \n      minute: '2-digit', \n      hour12: true,\n      timeZone: 'UTC' \n    }) \n}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -11392,
        5408
      ],
      "id": "d757aa8f-f59c-4fdb-b6d4-6d7c5ca075f5",
      "name": "Organiza el Mensaje"
    },
    {
      "parameters": {
        "jsCode": "// Obtener todos los datos de entrada\nconst datosEntrada = $(\"Recupera todos los mensajes\").all();\n\n// Filtrar solo los objetos que contienen un mensaje, descartando estad칤sticas\nconst mensajes = datosEntrada.filter(item => item.json.message_id);\n\n// Funci칩n para convertir la fecha a formato Colombia (UTC-5) en formato de 12 horas\nfunction convertirHoraColombia(fechaUTC) {\n    if (!fechaUTC) return \"[Hora no encontrada]\";\n    let fecha = new Date(fechaUTC);\n    fecha.setHours(fecha.getHours()); // Convertir a UTC-5\n    return fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', hour12: true });\n}\n\n// Funci칩n para dar formato de fecha en espa침ol sin hora\nfunction formatearFecha(fechaUTC) {\n    if (!fechaUTC) return \"[Fecha no encontrada]\";\n    let fecha = new Date(fechaUTC);\n    return fecha.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });\n}\n\n// Estructurar los mensajes en un formato claro para el agente IA\nconst mensajesEstructurados = mensajes.map((mensaje, index) => {\n    let fecha = mensaje.json.fecha ? formatearFecha(mensaje.json.fecha) : \"[Fecha no encontrada]\";\n    let hora = mensaje.json.fecha ? convertirHoraColombia(mensaje.json.fecha) : \"[Hora no encontrada]\";\n    let contenido = mensaje.json.contenido || \"[Sin contenido]\";\n    \n    // Determinar si el mensaje es del usuario o del agente IA\n    let remitente = mensaje.json.chat_id === 'agenteAI' ? 'El Agente ChatBot IA dice:' : 'El usuario dice:';\n    \n    return `Mensaje ${index + 1} enviado el ${fecha} a las ${hora}.\\n${remitente} \"${contenido}\".`;\n});\n\n// Unir todos los mensajes en un solo texto estructurado\nconst historialMensajes = mensajesEstructurados.join('\\n\\n');\n\n// Retornar los datos estructurados\nreturn [{ historialMensajes }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -11648,
        5408
      ],
      "id": "c171eccf-1de1-4dd6-b8b0-7d1df711893b",
      "name": "Organizaci칩n y estructuracion de mensajes"
    },
    {
      "parameters": {
        "content": "# 游닐 Agrupa todos los mensajes del usuario\n\n## 游댳 Este flujo se encarga de recibir y almacenar los mensajes enviados por el usuario, recuperar el historial completo de la conversaci칩n, estructurar la informaci칩n de manera clara y organizada, y enviarla al siguiente proceso para su interpretaci칩n y respuesta.\n",
        "height": 1000,
        "width": 3480,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -13888,
        4880
      ],
      "typeVersion": 1,
      "id": "184d339f-3735-4f17-96c4-1bbf5c9b62e3",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT DISTINCT * FROM CitasRecepcion\nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}'\nAND (estado = 'PROGRAMADA' OR estado = 'REPROGRAMADA')\nORDER BY fecha_creacion ASC;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        -11792,
        5088
      ],
      "id": "c1e00bc1-a62e-414b-ada0-10582ebb076a",
      "name": "Recuperar historial Citas",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -12080,
        5088
      ],
      "id": "0410db7d-abdf-43df-ad43-16139c0a2a46",
      "name": "Merge de Datos"
    },
    {
      "parameters": {
        "jsCode": "// Obtener todos los elementos del historial de citas\nconst historialCitas = $input.all();\n\n// Verificar si hay datos\nif (!historialCitas || historialCitas.length === 0) {\n  return [{ historialCitasFormateado: \"No hay historial de citas disponible\" }];\n}\n\n// Funci칩n para obtener valor seguro\nfunction getValorSeguro(objeto, propiedad) {\n  try {\n    // Intenta acceder directamente\n    if (objeto && objeto[propiedad] !== undefined && objeto[propiedad] !== null) {\n      return objeto[propiedad];\n    }\n    \n    // Intenta acceder a trav칠s de json\n    if (objeto && objeto.json && objeto.json[propiedad] !== undefined && objeto.json[propiedad] !== null) {\n      return objeto.json[propiedad];\n    }\n    \n    return 'N/A';\n  } catch (error) {\n    return 'N/A';\n  }\n}\n\n// Funci칩n para formatear fecha\nfunction formatearFecha(fechaStr) {\n  if (!fechaStr || fechaStr === 'N/A') return 'N/A';\n  \n  try {\n    const fecha = new Date(fechaStr);\n    return fecha.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });\n  } catch (error) {\n    return fechaStr;\n  }\n}\n\n// Estructurar las citas en un formato claro\nconst citasEstructuradas = historialCitas.map((cita, index) => {\n  // Obtener valores de forma segura\n  const id = getValorSeguro(cita, 'id');\n  const chatId = getValorSeguro(cita, 'chat_id');\n  const nombre = getValorSeguro(cita, 'nombre');\n  const ordenCompra = getValorSeguro(cita, 'orden_compra');\n  const peso = getValorSeguro(cita, 'peso');\n  const unidades = getValorSeguro(cita, 'unidades');\n  const fechaCita = formatearFecha(getValorSeguro(cita, 'fecha_cita'));\n  const estado = getValorSeguro(cita, 'estado');\n  const fechaCreacion = formatearFecha(getValorSeguro(cita, 'fecha_creacion'));\n  const chatHistorial = getValorSeguro(cita, 'chat_historial');\n  \n  // Crear texto estructurado para esta cita\n  let citaTexto = `CITA #${index + 1}\\n`;\n  citaTexto += `ID: ${id}\\n`;\n  citaTexto += `Chat ID: ${chatId}\\n`;\n  citaTexto += `Nombre: ${nombre}\\n`;\n  citaTexto += `Orden de compra: ${ordenCompra}\\n`;\n  citaTexto += `Peso: ${peso}\\n`;\n  citaTexto += `Unidades: ${unidades}\\n`;\n  citaTexto += `Fecha de cita: ${fechaCita}\\n`;\n  citaTexto += `Estado: ${estado}\\n`;\n  citaTexto += `Fecha de creaci칩n: ${fechaCreacion}\\n`;\n  \n  // Agregar historial de chat si existe\n  if (chatHistorial && chatHistorial !== 'N/A') {\n    citaTexto += `Chat: ${chatHistorial}\\n`;\n  }\n  \n  return citaTexto;\n});\n\n// Unir todas las citas en un solo texto estructurado\nconst historialCitasFormateado = citasEstructuradas.join('\\n\\n');\n\n// Retornar un objeto simple con el texto formateado\nreturn [{ historialCitasFormateado }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -11360,
        5088
      ],
      "id": "2aae1d86-2d8e-45eb-8517-8fd36f2e038b",
      "name": "Organizaci칩n y estructuracion historial citas"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.removeDuplicates",
      "typeVersion": 2,
      "position": [
        -11568,
        5088
      ],
      "id": "6b9d72ca-bf0e-49f7-a9cb-604cc140f48f",
      "name": "Remueve registros de citas duplicados"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "51f49645-ea1d-4717-8195-837dbb674f73",
              "name": "infoMensajecita.chat_id",
              "value": "={{ $('Remueve registros de citas duplicados').first().json.chat_id }}",
              "type": "string"
            },
            {
              "id": "ae0619ec-87bc-47d7-9b8a-d7b629bbea4a",
              "name": "infoMensajecita.historialCitas",
              "value": "={{ $json.historialCitasFormateado }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -11136,
        5088
      ],
      "id": "a7aa8607-ae41-4f3b-bc9e-8774509094e8",
      "name": "Organiza el historial de citas"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -10832,
        5312
      ],
      "id": "b79e989a-2914-4bd1-9b30-eebf967b2715",
      "name": "Merge de Datos para session ID"
    },
    {
      "parameters": {
        "jsCode": "// ====================================================================\n// UNIFICACI칍N Y CONSISTENCIA DE DATOS - VERSI칍N CORREGIDA\n// ====================================================================\n\nconst output = {};\n\n// Inicializar estructuras con valores por defecto\noutput.infoMensajecita = { \n    chat_id: \"\", \n    historialCitas: \"\" \n};\n\noutput.infoMensaje = { \n    chat_id: null, \n    historialMensajes: \"\", \n    count: null, \n    tiempoUltimoMensaje: null, \n    mensajeActual: \"\", \n    fechaMensajeActual: \"\", \n    horaMensajeActual: \"\" \n};\n\n// ====================================================================\n// SOLUCI칍N 1: OBTENER DATOS DEL NODO \"Organiza el Mensaje\"\n// ====================================================================\ntry {\n    const nodoMensaje = $node[\"Organiza el Mensaje\"];\n    \n    if (nodoMensaje && nodoMensaje.json) {\n        console.log('Datos disponibles en Organiza el Mensaje:', Object.keys(nodoMensaje.json));\n        \n        // Extraer datos usando las claves correctas con fallbacks m칰ltiples\n        output.infoMensaje = {\n            chat_id: nodoMensaje.json[\"infoMensaje.chat_id\"] || \n                     $('Parametrizaci칩n').first().json[\"message\"][\"chat\"][\"id\"] || \n                     null,\n            historialMensajes: nodoMensaje.json[\"infoMensaje.historialMensajes\"] || \n                              $('Organizaci칩n y estructuracion de mensajes').first().json.historialMensajes || \n                              \"\",\n            count: nodoMensaje.json[\"infoMensaje.count\"] || \n                   $('If (Salida 2 - Seguir)').first().json.mensajeCount || \n                   null,\n            tiempoUltimoMensaje: nodoMensaje.json[\"infoMensaje.tiempoUltimoMensaje\"] || \n                                $('If (Salida 2 - Seguir)').first().json.tiempoUltimoMensaje || \n                                null,\n            mensajeActual: nodoMensaje.json[\"infoMensaje.mensajeActual\"] || \n                          $('Mensaje Entrada').first().json.body.data.message.conversation || \n                          \"\",\n            fechaMensajeActual: nodoMensaje.json[\"infoMensaje.fechaMensajeActual\"] || \n                               ($('Parametrizaci칩n').first().json.message.date ? \n                                $('Parametrizaci칩n').first().json.message.date.split('T')[0] : \"\") ||\n                               \"\",\n            horaMensajeActual: nodoMensaje.json[\"infoMensaje.horaMensajeActual\"] || \n                              ($('Parametrizaci칩n').first().json.message.date ? \n                               new Date($('Parametrizaci칩n').first().json.message.date)\n                                 .toLocaleTimeString(\"es-CO\", { \n                                   hour: '2-digit', \n                                   minute: '2-digit', \n                                   hour12: true,\n                                   timeZone: 'UTC' \n                                 }) : \"\") ||\n                              \"\"\n        };\n    }\n} catch (error) {\n    console.log('Error al obtener datos del nodo \"Organiza el Mensaje\":', error.message);\n    \n    // FALLBACK DIRECTO: Si el nodo falla, tomar datos directamente de fuentes originales\n    try {\n        output.infoMensaje = {\n            chat_id: $('Parametrizaci칩n').first().json.message.chat.id || null,\n            historialMensajes: $('Organizaci칩n y estructuracion de mensajes').first().json.historialMensajes || \"\",\n            count: $('If (Salida 2 - Seguir)').first().json.mensajeCount || null,\n            tiempoUltimoMensaje: $('If (Salida 2 - Seguir)').first().json.tiempoUltimoMensaje || null,\n            mensajeActual: $('Mensaje Entrada').first().json.body.data.message.conversation || \"\",\n            fechaMensajeActual: $('Parametrizaci칩n').first().json.message.date.split('T')[0] || \"\",\n            horaMensajeActual: new Date($('Parametrizaci칩n').first().json.message.date)\n                .toLocaleTimeString(\"es-CO\", { \n                    hour: '2-digit', \n                    minute: '2-digit', \n                    hour12: true,\n                    timeZone: 'UTC' \n                }) || \"\"\n        };\n    } catch (fallbackError) {\n        console.log('Error en fallback directo para infoMensaje:', fallbackError.message);\n    }\n}\n\n// ====================================================================\n// SOLUCI칍N 2: OBTENER DATOS DEL NODO \"Organiza el historial de citas\"\n// ====================================================================\ntry {\n    const nodoCitas = $node[\"Organiza el historial de citas\"];\n    \n    if (nodoCitas && nodoCitas.json) {\n        console.log('Datos disponibles en Organiza el historial de citas:', Object.keys(nodoCitas.json));\n        \n        // Extraer datos usando las claves correctas con fallbacks m칰ltiples\n        output.infoMensajecita = {\n            chat_id: nodoCitas.json[\"infoMensajecita.chat_id\"] || \n                     $('Parametrizaci칩n').first().json.message.chat.id || \n                     \"\",\n            historialCitas: nodoCitas.json[\"infoMensajecita.historialCitas\"] || \n                           $('Organizaci칩n y estructuracion historial citas').first().json.historialCitasFormateado || \n                           \"\"\n        };\n    }\n} catch (error) {\n    console.log('Error al obtener datos del nodo \"Organiza el historial de citas\":', error.message);\n    \n    // FALLBACK DIRECTO: Si el nodo falla, tomar datos directamente\n    try {\n        output.infoMensajecita = {\n            chat_id: $('Parametrizaci칩n').first().json.message.chat.id || \"\",\n            historialCitas: $('Organizaci칩n y estructuracion historial citas').first().json.historialCitasFormateado || \"\"\n        };\n    } catch (fallbackError) {\n        console.log('Error en fallback directo para infoMensajecita:', fallbackError.message);\n    }\n}\n\n// ====================================================================\n// GENERAR SESSION ID Y DATOS COMPLEMENTARIOS\n// ====================================================================\n// Priorizar chat_id de infoMensajecita, luego infoMensaje\noutput.sessionId = output.infoMensajecita.chat_id || output.infoMensaje.chat_id || null;\n\n// Calcular la semana actual\nconst fechaActual = new Date();\nconst inicioAno = new Date(fechaActual.getFullYear(), 0, 1);\nconst diff = fechaActual - inicioAno;\nconst diasDesdeInicio = Math.floor(diff / (1000 * 60 * 60 * 24));\nconst numeroSemana = Math.ceil((diasDesdeInicio + inicioAno.getDay()) / 7);\noutput.hojaSeleccionada = `SEMANA ${numeroSemana}`;\n\n// ====================================================================\n// LOGGING PARA DEBUGGING\n// ====================================================================\nconsole.log('=== DEBUGGING UNIFICACI칍N DE DATOS ===');\nconsole.log('sessionId:', output.sessionId);\nconsole.log('hojaSeleccionada:', output.hojaSeleccionada);\nconsole.log('infoMensaje.chat_id:', output.infoMensaje.chat_id);\nconsole.log('infoMensaje.historialMensajes length:', output.infoMensaje.historialMensajes.length);\nconsole.log('infoMensajecita.chat_id:', output.infoMensajecita.chat_id);\nconsole.log('infoMensajecita.historialCitas length:', output.infoMensajecita.historialCitas.length);\nconsole.log('======================================');\n\n// Retornar el resultado unificado\nreturn [{ json: output }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10592,
        5312
      ],
      "id": "ed5ffa3a-ce99-4adf-8c40-0c5bdd66ebf8",
      "name": "Unificaci칩n y consistencia de datos"
    },
    {
      "parameters": {
        "url": "https://graph.microsoft.com/v1.0/sites/a592f886-4560-4e62-9646-1eee7add7abe/drives/b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8/items/01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME/content",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "ExcelMallaRecibido2025"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1408,
        1216
      ],
      "id": "40a0bec5-077d-4a28-a5a5-c8c3682d0387",
      "name": "HTTP Request MALLA DE RECIBO 2025",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      }
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "ExcelMallaRecibido2025",
        "options": {
          "sheetName": "={{ $('Unificaci칩n y consistencia de datos').item.json.hojaSeleccionada }}"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1664,
        1104
      ],
      "id": "fe49d77e-a57d-43e5-9bda-d6c221fdd2ec",
      "name": "Extract MALLA DE RECIBO 2025"
    },
    {
      "parameters": {
        "url": "https://graph.microsoft.com/v1.0/drives/b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8/items/01PPLUUYTWY3753ZJ6ERAZ6LQBYUR2JOTY/content",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "MallaFija"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1408,
        1600
      ],
      "id": "330bd9f2-2999-4971-9830-b3e57022def4",
      "name": "HTTP Request Malla Fija",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      }
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "MallaFija",
        "options": {
          "sheetName": "DatosProveedor"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1664,
        1456
      ],
      "id": "b149a7aa-6377-4ecf-b73d-7a4d477b668e",
      "name": "Extract Datos Proveedor"
    },
    {
      "parameters": {
        "jsCode": "// Obtener los datos del Excel\nconst excelData = $input.all();\nconst hojaSeleccionada = $('Unificaci칩n y consistencia de datos').first().json.hojaSeleccionada;\n\n// Obtener hora local en Bogot치\nconst ahora = new Date(new Date().toLocaleString(\"en-US\", { timeZone: \"America/Bogota\" }));\nconst diaSemanaActual = ahora.getDay(); // 0=domingo, 1=lunes, ..., 5=viernes\nconst horaActual = ahora.getHours();\nconst minutosActual = ahora.getMinutes();\n// Determinar si es despu칠s de las 16:30\nconst pasoLimiteDia = horaActual > 16 || (horaActual === 16 && minutosActual >= 30);\n\n// Definir estructura de la semana y los d칤as\nconst diasSemana = ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'];\n\n// Mapeo para saber qu칠 d칤as incluir si hoy es x d칤a y pas칩 el l칤mite\n/**\n * Dado el d칤a de la semana actual (0=domingo ... 6=s치bado),\n * devuelve qu칠 d칤as de la semana actual deben incluirse seg칰n si pas칩 el l칤mite.\n */\nfunction diasValidosSemanaActual(diaSemanaActual, pasoLimite) {\n  const mapa = {\n    1: ['martes', 'mi칠rcoles', 'jueves', 'viernes'],   // lunes\n    2: ['mi칠rcoles', 'jueves', 'viernes'],             // martes\n    3: ['jueves', 'viernes'],                          // mi칠rcoles\n    4: ['viernes'],                                     // jueves\n    5: []                                               // viernes (muy tarde para s치bado)\n  };\n  if (diaSemanaActual < 1 || diaSemanaActual > 5) {\n    return []; // s치bado o domingo no se agendan en semana actual\n  }\n  if (!pasoLimite) {\n    // a칰n est치 antes de las 4:30 p.m., se puede incluir el d칤a siguiente\n    const siguiente = diasSemana[diaSemanaActual];\n    return [siguiente, ...mapa[diaSemanaActual]];\n  }\n  return mapa[diaSemanaActual];\n}\n\n// Objeto para almacenar la malla estructurada\nconst mallaEstructurada = {\n  titulo: \"\",\n  a침o: \"\",\n  semana: \"\",\n  rangoDias: \"\",\n  franjas: [],\n  dias: {}\n};\n\n// Tabla de meses y d칤as. Ajusta si necesitas contemplar bisiestos, etc.\nconst meses = {\n  \"enero\": 1,\n  \"febrero\": 2,\n  \"marzo\": 3,\n  \"abril\": 4,\n  \"mayo\": 5,\n  \"junio\": 6,\n  \"julio\": 7,\n  \"agosto\": 8,\n  \"septiembre\": 9,\n  \"octubre\": 10,\n  \"noviembre\": 11,\n  \"diciembre\": 12\n};\n\nconst nombreMes = {\n  1: \"enero\",\n  2: \"febrero\",\n  3: \"marzo\",\n  4: \"abril\",\n  5: \"mayo\",\n  6: \"junio\",\n  7: \"julio\",\n  8: \"agosto\",\n  9: \"septiembre\",\n  10: \"octubre\",\n  11: \"noviembre\",\n  12: \"diciembre\"\n};\n\n/**\n * Funci칩n para determinar si un a침o es bisiesto\n * Un a침o es bisiesto si es divisible por 4, excepto aquellos divisibles por 100 \n * que no son divisibles por 400\n */\nfunction esBisiesto(year) {\n  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n}\n\n/**\n * Funci칩n para obtener el n칰mero de d칤as en un mes, considerando a침os bisiestos\n */\nfunction getDiasMes(mes, a침o) {\n  const diasPorMes = {\n    1: 31, // enero\n    2: esBisiesto(a침o) ? 29 : 28, // febrero - ajustado para a침o bisiesto\n    3: 31, // marzo\n    4: 30, // abril\n    5: 31, // mayo\n    6: 30, // junio\n    7: 31, // julio\n    8: 31, // agosto\n    9: 30, // septiembre\n    10: 31, // octubre\n    11: 30, // noviembre\n    12: 31  // diciembre\n  };\n  \n  return diasPorMes[mes];\n}\n\n/**\n * Funci칩n para eliminar acentos y pasar a min칰sculas (para buscar palabras clave sin importar tildes ni may칰sculas).\n */\nfunction normalizarTexto(texto) {\n  if (typeof texto !== 'string') return \"\";\n  // Normaliza (NFD) y elimina diacr칤ticos, luego pasa a min칰sculas.\n  return texto\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase();\n}\n\n/**\n * Dada la informaci칩n de proveedor, ordenCompra, peso, categor칤a y unidades,\n * revisa si existe la palabra 'fuera de servicio', 'cancelado' o 'reagendado'\n * en cualquiera de esos campos. De ser as칤, retorna ese estado especial;\n * de lo contrario, retorna 'ocupado'.\n * \n * Se ignoran may칰sculas, min칰sculas y tildes.\n */\nfunction determinarEstadoOcupado(proveedor, ordenCompra, peso, categoria, unidades) {\n  const conjunto = `${proveedor} ${ordenCompra} ${peso} ${categoria} ${unidades}`;\n  const texto = normalizarTexto(conjunto);\n\n  if (texto.includes(\"fuera de servicio\")) {\n    return \"fuera de servicio\";\n  }\n  if (texto.includes(\"cancelado\")) {\n    return \"cancelado\";\n  }\n  if (texto.includes(\"reagendado\")) {\n    return \"reagendado\";\n  }\n  return \"ocupado\";  \n}\n\n// -------------------------------------------------------------\n// 1) PROCESAR DATOS (Cabecera, Horas, Muelles, etc.)\n// -------------------------------------------------------------\nfunction procesarDatos(excelData) {\n  const datos = excelData.map(item => item.json);\n  \n  // A) Cabecera (T칤tulo, A침o, Rango)\n  datos.forEach((dato, index) => {\n    // Buscar t칤tulo\n    if (dato.__EMPTY_2 === \"MALLA DE RECIBO CEDI KONFIE IA\") {\n      mallaEstructurada.titulo = dato.__EMPTY_2;\n      \n      // En la siguiente fila puede estar a침o, semana, rango\n      if (index + 1 < datos.length) {\n        const datoSiguiente = datos[index + 1];\n        if (datoSiguiente) {\n          // A침o\n          if (datoSiguiente.__EMPTY_2 && !isNaN(datoSiguiente.__EMPTY_2)) {\n            mallaEstructurada.a침o = datoSiguiente.__EMPTY_2;\n          }\n          // Semana\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"SEMANA\")) {\n              mallaEstructurada.semana = v;\n            }\n          });\n          // Rango: p.ej. \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"LUNES\") && v.includes(\"VIERNES\")) {\n              mallaEstructurada.rangoDias = v;\n            }\n          });\n        }\n      }\n    }\n  });\n  \n  // B) Detectar franjas horarias (.__EMPTY = fracci칩n de d칤a)\n  const franjasHorarias = [];\n  datos.forEach(dato => {\n    if (\n      dato.__EMPTY !== undefined &&\n      typeof dato.__EMPTY === 'number' &&\n      dato.__EMPTY > 0 &&\n      dato.__EMPTY < 1\n    ) {\n      const totalMin = Math.round(dato.__EMPTY * 24 * 60);\n      const hh = Math.floor(totalMin / 60);\n      const mm = totalMin % 60;\n      \n      let periodo = \"AM\";\n      let hora12 = hh;\n      if (hh >= 12) {\n        periodo = \"PM\";\n        hora12 = (hh === 12 ? 12 : hh - 12);\n      }\n      if (hh === 0) {\n        hora12 = 12;\n      }\n      \n      const horaStr = `${hora12}:${String(mm).padStart(2, '0')} ${periodo}`;\n      franjasHorarias.push({\n        hora: horaStr,\n        indice: datos.indexOf(dato) // fila base\n      });\n    }\n  });\n  franjasHorarias.sort((a, b) => a.indice - b.indice);\n  mallaEstructurada.franjas = franjasHorarias;\n  \n  // C) Detectar muelles (col)\n  const muellesInfo = {};\n  datos.forEach(dato => {\n    Object.entries(dato).forEach(([key, value]) => {\n      if (value === \"MUELLE 01\" || value === \"MUELLE 02\") {\n        const col = parseInt(key.replace(\"__EMPTY_\", \"\"), 10);\n        const muelleKey = (value === \"MUELLE 01\") ? 'muelle1' : 'muelle2';\n        if (!muellesInfo[muelleKey]) {\n          muellesInfo[muelleKey] = [];\n        }\n        muellesInfo[muelleKey].push(col);\n      }\n    });\n  });\n  if (muellesInfo.muelle1) muellesInfo.muelle1.sort((a, b) => a - b);\n  if (muellesInfo.muelle2) muellesInfo.muelle2.sort((a, b) => a - b);\n  \n  // D) Generar los 5 d칤as (lunes-viernes) con su fecha\n  parsearRangoDias();\n  \n  // E) Extraer Citas\n  extraerCitas(datos, muellesInfo);\n  \n  return mallaEstructurada;\n}\n\n/**\n * Parsea la cadena \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n * (o \"LUNES 31 AL VIERNES 04 DE ABRIL\") y maneja el cruce de mes.\n * Ej.: si dayStart=31 y dayEnd=4, la 1춹 fecha es 31 de MARZO,\n * luego 1,2,3,4 de ABRIL, en vez de 32,33, etc.\n */\nfunction parsearRangoDias() {\n  const texto = mallaEstructurada.rangoDias;\n  // Regex simple: p.ej. \"31 AL ... 4 DE ABRIL\"\n  // Captura: dayStart, dayEnd, mesFin\n  // Ojo: si dice \"LUNES 31 DE MARZO AL VIERNES 4 DE ABRIL\",\n  // quedar치: dayStart=31, dayEnd=4, month=ABRIL (al final).\n  const regex = /(\\d+)\\s+AL\\s+\\D+(\\d+)\\s+DE\\s+(\\w+)/i;\n  const match = regex.exec(texto);\n  \n  // Por defecto, creamos 5 d칤as vac칤os sin fecha\n  diasSemana.forEach(d => {\n    mallaEstructurada.dias[d] = {\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  if (!match) {\n    // Sin coincidencia, dejamos los d칤as sin fecha\n    return;\n  }\n  \n  const dayStart = parseInt(match[1], 10); // 31\n  const dayEnd   = parseInt(match[2], 10); // 4\n  const finalMonthName = match[3].toLowerCase(); // \"abril\"\n  \n  // Convertimos a n칰mero\n  const finalMonth = meses[finalMonthName] || 3; // fallback marzo\n  const yearNum = parseInt(mallaEstructurada.a침o, 10) || 2025;\n  \n  // Funci칩n para obtener la fecha formateada\n  function fechaFormateada(d, m, y) {\n    return `${d} de ${nombreMes[m]} de ${y}`;\n  }\n  \n  // Comprobamos cu치ntos d칤as tiene el mes final, considerando bisiestos\n  const diasMesFinal = getDiasMes(finalMonth, yearNum);\n  // y del mes previo\n  const monthPrev = (finalMonth === 1) ? 12 : finalMonth - 1;\n  const yearPrev = (finalMonth === 1) ? yearNum - 1 : yearNum;\n  \n  // Arreglo final con 5 fechas\n  const fechasDias = [];\n  \n  if (dayStart <= dayEnd) {\n    // Caso \"normal\": todo en el mismo mes\n    let d = dayStart;\n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: finalMonth,\n        yearNum: yearNum\n      });\n      d++;\n      if (d > diasMesFinal) {\n        d = 1;\n        const nextMonth = finalMonth % 12 + 1;\n        const nextYear = (nextMonth === 1) ? yearNum + 1 : yearNum;\n        fechasDias[fechasDias.length - 1].mesNum = nextMonth;\n        fechasDias[fechasDias.length - 1].yearNum = nextYear;\n      }\n    }\n  } else {\n    // Caso \"cruza de mes\": dayStart > dayEnd\n    let d = dayStart;\n    let m = monthPrev;\n    let y = yearPrev;\n    \n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: m,\n        yearNum: y\n      });\n      d++;\n      if (d > getDiasMes(m, y)) {\n        d = 1;\n        m = m % 12 + 1;\n        if (m === 1) {\n          y++;\n        }\n      }\n    }\n  }\n  \n  // Ahora volcamos esas 5 fechas en la estructura\n  fechasDias.forEach(fd => {\n    const { diaSem, diaNum, mesNum, yearNum } = fd;\n    mallaEstructurada.dias[diaSem] = {\n      fechaDia: fechaFormateada(diaNum, mesNum, yearNum),\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  // Inicializamos las franjas a 'disponible'\n  if (mallaEstructurada.franjas.length > 0) {\n    diasSemana.forEach(d => {\n      mallaEstructurada.franjas.forEach(f => {\n        mallaEstructurada.dias[d].muelle1[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n        mallaEstructurada.dias[d].muelle2[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n      });\n    });\n  }\n}\n\n/**\n * Funci칩n auxiliar: decide a qu칠 d칤a pertenece una columna,\n * corrigiendo 2 columnas de offset (porque 'Extract from XLSX'\n * deja todo desplazado).\n */\nfunction getDayForColumn(colNumber) {\n  // Ajuste de offset +2\n  const realCol = colNumber + 2;\n\n  // Rangos:\n  //  Lunes:      3..8\n  //  Martes:     9..14\n  //  Mi칠rcoles: 15..20\n  //  Jueves:    21..26\n  //  Viernes:   27..32\n  if (realCol >= 3 && realCol <= 8) {\n    return \"lunes\";\n  }\n  if (realCol >= 9 && realCol <= 14) {\n    return \"martes\";\n  }\n  if (realCol >= 15 && realCol <= 20) {\n    return \"mi칠rcoles\";\n  }\n  if (realCol >= 21 && realCol <= 26) {\n    return \"jueves\";\n  }\n  if (realCol >= 27 && realCol <= 32) {\n    return \"viernes\";\n  }\n  // Si nada coincide, devolvemos null\n  return null;\n}\n\n/**\n * Extraer las citas para cada franja:\n * - Para cada franja, miramos 3 filas:\n *    - Fila base => proveedor\n *    - Fila base+1 => orden\n *    - Fila base+2 => peso, categor칤a, unidades\n */\nfunction extraerCitas(datos, muellesInfo) {\n  mallaEstructurada.franjas.forEach(franja => {\n    const indiceBase = franja.indice;\n    if (indiceBase < 0 || indiceBase + 2 >= datos.length) {\n      return; // no hay suficientes filas\n    }\n    \n    // Recorremos muelle1, muelle2 y sus columnas\n    const asignarCita = (muelleKey, cols) => {\n      cols.forEach(col => {\n        const provKey = `__EMPTY_${col}`;\n        const filaProv = datos[indiceBase];\n        \n        // Si en esta fila hay un proveedor o alg칰n texto\n        if (\n          filaProv &&\n          typeof filaProv[provKey] === 'string' &&\n          filaProv[provKey].length > 2\n        ) {\n          // Determinar el d칤a real\n          const diaOk = getDayForColumn(col);\n          if (!diaOk || !mallaEstructurada.dias[diaOk]) {\n            return; // si no coincide con ninguno, saltamos\n          }\n          \n          // Recuperar valores para proveedor, ordenCompra y dem치s\n          const filaOrden = datos[indiceBase + 1];\n          const filaDet = datos[indiceBase + 2];\n          \n          const proveedor = filaProv[provKey] || \"\";\n          const ordenCompra = filaOrden && filaOrden[provKey] ? filaOrden[provKey] : \"\";\n          const peso = filaDet && filaDet[provKey] ? filaDet[provKey] : \"\";\n          const cat  = filaDet && filaDet[`__EMPTY_${col + 1}`] ? filaDet[`__EMPTY_${col + 1}`] : \"\";\n          const und  = filaDet && filaDet[`__EMPTY_${col + 2}`] ? filaDet[`__EMPTY_${col + 2}`] : \"\";\n          \n          // Antes pon칤amos estado=\"ocupado\" directamente\n          // Ahora verificamos si el texto contiene \"reagendado\", \"cancelado\" o \"fuera de servicio\".\n          const nuevoEstado = determinarEstadoOcupado(proveedor, ordenCompra, peso, cat, und);\n          \n          // Asignamos los datos\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].estado = nuevoEstado;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].proveedor = proveedor;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].ordenCompra = ordenCompra;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].peso = peso;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].categoria = cat;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].unidades = und;\n        }\n      });\n    };\n    \n    if (muellesInfo.muelle1) {\n      asignarCita('muelle1', muellesInfo.muelle1);\n    }\n    if (muellesInfo.muelle2) {\n      asignarCita('muelle2', muellesInfo.muelle2);\n    }\n  });\n}\n\n// -------------------------------------------------------------\n// 2) FUNCIONES PARA CONSULTAR LA MALLA\n// -------------------------------------------------------------\nfunction buscarFranjasDisponibles(categoria, duracionHoras) {\n  const muelle = \"muelle1\"; // Ajusta si usas \"categoria -> muelle\" real\n  \n  const franjasDisponibles = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const libres = [];\n    for (let i = 0; i <= mallaEstructurada.franjas.length - duracionHoras; i++) {\n      let disponible = true;\n      for (let h = 0; h < duracionHoras; h++) {\n        const idxF = i + h;\n        const horaAct = mallaEstructurada.franjas[idxF].hora;\n        if (\n          mallaEstructurada.dias[dia][muelle][horaAct].estado !== 'disponible'\n        ) {\n          disponible = false;\n          break;\n        }\n      }\n      if (disponible) {\n        libres.push({\n          horaInicio: mallaEstructurada.franjas[i].hora,\n          duracion: duracionHoras\n        });\n      }\n    }\n    if (libres.length > 0) {\n      franjasDisponibles.push({ dia, franjas: libres });\n    }\n  });\n  return franjasDisponibles;\n}\n\nfunction buscarCitasProveedor(nombreProveedor) {\n  const citas = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const muelle1 = mallaEstructurada.dias[dia].muelle1;\n    const muelle2 = mallaEstructurada.dias[dia].muelle2;\n    mallaEstructurada.franjas.forEach(f => {\n      const hora = f.hora;\n      // muelle1\n      if (normalizarTexto(muelle1[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 01\",\n          ordenCompra: muelle1[hora].ordenCompra,\n          peso: muelle1[hora].peso,\n          categoria: muelle1[hora].categoria,\n          unidades: muelle1[hora].unidades,\n          estado: muelle1[hora].estado\n        });\n      }\n      // muelle2\n      if (normalizarTexto(muelle2[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 02\",\n          ordenCompra: muelle2[hora].ordenCompra,\n          peso: muelle2[hora].peso,\n          categoria: muelle2[hora].categoria,\n          unidades: muelle2[hora].unidades,\n          estado: muelle2[hora].estado\n        });\n      }\n    });\n  });\n  return citas;\n}\n\nfunction consultarFranjasDisponibles(categoria, duracionHoras) {\n  return buscarFranjasDisponibles(categoria, duracionHoras);\n}\n\nfunction consultarCitasProveedor(nombreProveedor) {\n  return buscarCitasProveedor(nombreProveedor);\n}\n\nfunction obtenerInfoMalla() {\n  return {\n    titulo: mallaEstructurada.titulo,\n    a침o: mallaEstructurada.a침o,\n    semana: mallaEstructurada.semana,\n    rangoDias: mallaEstructurada.rangoDias,\n    franjas: mallaEstructurada.franjas.map(f => f.hora)\n  };\n}\n\nfunction estaDisponible(dia, hora, muelle) {\n  const info = mallaEstructurada.dias[dia]?.[muelle]?.[hora];\n  return info ? (info.estado === 'disponible') : false;\n}\n\nfunction obtenerCoordenadasCita(dia, hora, muelle) {\n  // Ajustar con tu mapeo de celdas en Excel\n  return {\n    proveedor: `${dia}_${hora}_${muelle}_proveedor`,\n    ordenCompra: `${dia}_${hora}_${muelle}_ordenCompra`,\n    peso: `${dia}_${hora}_${muelle}_peso`,\n    categoria: `${dia}_${hora}_${muelle}_categoria`,\n    unidades: `${dia}_${hora}_${muelle}_unidades`\n  };\n}\n\n// -------------------------------------------------------------\n// 3) EJECUTAR TODO Y RETORNAR\n// -------------------------------------------------------------\n// Procesar todos los datos\nconst malla = procesarDatos(excelData);\n\n// Aplicar el filtro de d칤as v치lidos seg칰n la hora actual\nconst diasPermitidos = diasValidosSemanaActual(diaSemanaActual, pasoLimiteDia);\nObject.keys(malla.dias).forEach(dia => {\n  if (!diasPermitidos.includes(dia)) {\n    delete malla.dias[dia]; // eliminar d칤as no v치lidos\n  }\n});\n\nconst resultado = {\n  datosMalla: malla,\n  funciones: {\n    consultarFranjasDisponibles,\n    consultarCitasProveedor,\n    obtenerInfoMalla,\n    estaDisponible,\n    obtenerCoordenadasCita\n  }\n};\n\nreturn [resultado];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        1104
      ],
      "id": "bd0bdb6e-0511-47ac-8680-d239a2da173e",
      "name": "Estructuraci칩n, Datos, Consulta, Citas"
    },
    {
      "parameters": {
        "jsCode": "// Obtener todos los items de la entrada\nconst items = $input.all();\nconst datosProveedores = [];\n\n// Recorrer cada 칤tem de la entrada\nfor (const item of items) {\n  // Ahora sabemos exactamente c칩mo se llaman los campos en el JSON original\n  const originalData = item.json;\n  \n  // Crear objeto con los campos normalizados\n  const nuevoObjeto = {\n    // Los campos principales que siempre deben estar presentes\n    proveedor: originalData.PROVEEDOR || \"\",\n    rotacion: originalData.ROTACION || \"\",\n    unidadesPorHora: originalData[\"UNIDADES X HORA\"] || 0,\n    \n    // Los campos que tienen espacios al final en los nombres\n    // Nota: \"Tipo de Proveedor \" tiene un espacio al final\n    tipoProveedor: originalData[\"Tipo de Proveedor \"] || \"\",\n    \n    // \"Dia \" tambi칠n tiene un espacio al final\n    dia: originalData[\"Dia \"] || \"\",\n    \n    // Este campo tiene un espacio en medio y otro al final\n    numeroDia: originalData[\"Dia _1\"] || 0,\n    \n    // Este campo no tiene espacios extras\n    hora: originalData.Hora || 0,\n    \n    // Campos adicionales que podr칤an ser 칰tiles\n    cantidadSedes: originalData[\"Cantidad de Sedes\"] || 0\n  };\n  \n  // A침adir el nuevo objeto al array de resultados\n  datosProveedores.push(nuevoObjeto);\n}\n\n// Retornar un 칰nico objeto que contiene el array de datos de proveedores\n// dentro de un par치metro global llamado \"datosproveedor\"\nreturn [\n  {\n    json: {\n      datosproveedor: datosProveedores\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        1456
      ],
      "id": "ae423538-cc63-451d-8e44-d7cfbc437334",
      "name": "Estructuraci칩n, Consulta, Datos Proveedor"
    },
    {
      "parameters": {
        "numberInputs": 4
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        2224,
        1376
      ],
      "id": "15d55fa3-f604-4dc9-8dab-c29211a86311",
      "name": "Merge datos Excel"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "MallaFija",
        "options": {
          "sheetName": "Categorias"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1664,
        1680
      ],
      "id": "456a6f25-0832-4ed2-aeae-a72487dc8308",
      "name": "Extract from Categorias"
    },
    {
      "parameters": {
        "jsCode": "// Obtener todos los items de la entrada\nconst items = $input.all();\nconst categorias = [];\n\n// Mapa para verificar categor칤as duplicadas\nconst categoriasMap = new Map();\n\n// Recorrer cada 칤tem de la entrada de categor칤as\nfor (const item of items) {\n  // Obtener los datos originales\n  const originalData = item.json;\n  \n  // Extraer categor칤a y muelle\n  const categoria = originalData.CATEGORIA || \"\";\n  const muelle = originalData.MUELLE || \"\";\n  \n  // Solo procesar si tanto la categor칤a como el muelle tienen valor\n  if (categoria && muelle) {\n    // Verificar si esta categor칤a ya existe en nuestro mapa\n    if (categoriasMap.has(categoria)) {\n      console.log(`Advertencia: La categor칤a \"${categoria}\" est치 duplicada. Se ignorar치 la segunda aparici칩n.`);\n      continue; // Saltar este elemento\n    }\n    \n    // Agregar al mapa para control de duplicados\n    categoriasMap.set(categoria, muelle);\n    \n    // Agregar el objeto al array de categor칤as\n    categorias.push({\n      \"CATEGORIA\": categoria,\n      \"MUELLE\": muelle\n    });\n  } else {\n    console.log(`Advertencia: Elemento ignorado por falta de categor칤a o muelle: ${JSON.stringify(originalData)}`);\n  }\n}\n\n// Retornar un 칰nico objeto que contiene el array de categor칤as\n// dentro de un par치metro global llamado \"datoscategorias\"\nreturn [\n  {\n    json: {\n      datoscategorias: categorias\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        1680
      ],
      "id": "62cf5a77-64aa-4a28-bd37-1c5cb369233c",
      "name": "Estructuraci칩n, Consulta, Datos Categorias"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    datosMalla: $items(\"Merge datos Excel\")[0].json.datosMalla,\n    datosMallaProxSemana: $items(\"Merge datos Excel\")[1].json.datosMallaProxSemana,\n    datosproveedor: $items(\"Merge datos Excel\")[2].json.datosproveedor,\n    datoscategorias: $items(\"Merge datos Excel\")[3].json.datoscategorias,\n    hojaSeleccionada: $items(\"Merge datos Excel\")[0].json.datosMalla.semana\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2480,
        1408
      ],
      "id": "2783b807-f7b1-44b6-8455-f449041f04d9",
      "name": "Unificaci칩n y consistencia de datos1"
    },
    {
      "parameters": {
        "collection": "workflow_context",
        "options": {
          "limit": 1
        },
        "query": "{\"workflow_id\": \"Bot_Almacenamiento_Bodega_Manual\"}"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [
        -10304,
        5312
      ],
      "id": "397602a7-222d-403e-8d61-a249ab7e3d7d",
      "name": "MongoDB Consulta Contexto",
      "credentials": {
        "mongoDb": {
          "id": "xbHZAvR77GefTd6B",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Combinar datos del contexto MongoDB con los datos existentes\nconst datosUnificados = $('Unificaci칩n y consistencia de datos1').first().json;\nconst contextoMongo = $('MongoDB Consulta Contexto').first().json;\n\n// Crear objeto con contexto completo\nconst contextoCompleto = {\n  ...datosUnificados,\n  workflowContext: contextoMongo || {\n    capabilities: ['CREAR_CITA', 'EDITAR_CITA', 'CANCELAR_CITA', 'CONSULTAR_MALLA', 'SALUDO', 'CONFIRMACION_CITA', 'PREGUNTA_GENERAL', 'ELIMINAR_MENSAJES', 'RESPUESTA_FUERA_CONTEXTO'],\n    required_fields: {\n      'CREAR_CITA': ['proveedor', 'categoria', 'fecha', 'hora', 'peso', 'unidades', 'orden_compra'],\n      'EDITAR_CITA': ['id_cita', 'nuevos_datos'],\n      'CANCELAR_CITA': ['id_cita']\n    },\n    validation_rules: {\n      fecha_minima: '2_horas_anticipacion',\n      dias_habiles: ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'],\n      horarios_disponibles: ['06:00-18:00']\n    }\n  }\n};\n\nreturn [{ json: contextoCompleto }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10016,
        5312
      ],
      "id": "a9555bf0-ad83-4f12-a259-64ca11397db6",
      "name": "Combinar Contexto MongoDB"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -9888,
        5552
      ],
      "id": "b075b32e-baa2-4acb-907b-0c0dd0532563",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# SISTEMA INTELIGENTE CON CONTEXTO COMPLETO\nEres un asistente especializado en log칤stica y gesti칩n de citas en bodega con **conocimiento completo del flujo**. Tu tarea es clasificar la intenci칩n principal del mensaje recibido por un proveedor que se comunica por WhatsApp, con base en el mensaje actual, el historial completo Y el contexto del flujo.\n\n## 游 CONTEXTO DEL FLUJO (CONOCIMIENTO INTERNO)\n**Capacidades del sistema:**\n{{ $json.workflowContext.capabilities.join(', ') }}\n\n**Campos requeridos por intenci칩n:**\n{{ JSON.stringify($json.workflowContext.required_fields, null, 2) }}\n\n**Reglas de validaci칩n:**\n{{ JSON.stringify($json.workflowContext.validation_rules, null, 2) }}\n\n## REGLA DE PRIORIDAD M츼XIMA\n**SI EL MENSAJE CONTIENE LA PALABRA EXACTA \"ELIMINAR_MENSAJES\" EN MAY칔SCULAS, LA INTENCI칍N ES SIEMPRE \"ELIMINAR_MENSAJES\", SIN IMPORTAR CUALQUIER OTRO CONTENIDO.**\n\n## POSIBLES INTENCIONES (en orden de prioridad)\n1.  **ELIMINAR_MENSAJES**  Cuando el mensaje contiene exactamente la palabra \"ELIMINAR_MENSAJES\" en may칰sculas.\n2.  **RESPUESTA_FUERA_CONTEXTO**  Cuando el mensaje es completamente irrelevante al contexto de log칤stica/citas (ej: \"quiero que seas mi esposa\", \"cu칠ntame un chiste\", \"쯖칩mo est치 el clima?\", conversaciones personales, temas rom치nticos, etc.).\n3.  **SALUDO**  Cuando el proveedor dice \"Hola\", \"Buenos d칤as\", etc. sin contexto adicional.\n4.  **CREAR_CITA**  Cuando desea agendar una cita de entrega o est치 proporcionando datos para una nueva cita, **incluso si cambia de opini칩n sobre los datos varias veces.**\n5.  **EDITAR_CITA**  Cuando quiere modificar una cita que **ya tiene programada** usando palabras clave como reagendar, reprogramar, posponer, aplazar, modificar fecha/cita/entrega, cambiar fecha/hora, O menciona su ID espec칤fico.\n6.  **CANCELAR_CITA**  Cuando quiere anular una cita **agendada y menciona su ID de cita**.\n7.  **CONSULTAR_MALLA**  Cuando pregunta por disponibilidad de horarios o franjas.\n8.  **PREGUNTA_GENERAL**  Cuando hace una pregunta relacionada con el negocio pero no sobre citas espec칤ficas.\n9.  **CONFIRMACION_CITA**  Cuando selecciona una franja horaria espec칤fica de opciones previamente ofrecidas.\n\n## DATOS DE ENTRADA\n**Mensaje actual del proveedor:**\n```\n{{ $json.infoMensaje.mensajeActual }}\n```\n\n**Historial completo de conversaci칩n:**\n```\n{{ $json.infoMensaje.historialMensajes }}\n```\n\n**Historial de citas del proveedor (si aplica):**\n```\n{{ $json.infoMensajecita.historialCitas }}\n\n## INSTRUCCIONES DE CLASIFICACI칍N\n\n### PASO 1: VERIFICACI칍N DE ELIMINAR_MENSAJES\nBusca PRIMERO si el mensaje actual contiene exactamente \"ELIMINAR_MENSAJES\" en may칰sculas.\n- Si la encuentra  INTENCI칍N: ELIMINAR_MENSAJES (termina aqu칤)\n- Si no la encuentra  contin칰a con el PASO 2\n\n### PASO 2: VERIFICACI칍N DE CONTEXTO EMPRESARIAL\nAntes de clasificar, verifica si el mensaje est치 relacionado con:\n- Log칤stica, entregas, citas, horarios, proveedores\n- Consultas sobre disponibilidad, fechas, productos\n- Confirmaciones, cancelaciones, modificaciones de citas\n- Preguntas sobre el servicio de bodega\n\n**Si el mensaje NO est치 relacionado con estos temas empresariales:**\n- Ejemplos: \"quiero que seas mi esposa\", \"cu칠ntame un chiste\", \"쯦e gusta la m칰sica?\", \"hablemos de deportes\", \"eres bonita\", conversaciones rom치nticas o personales\n-  INTENCI칍N: RESPUESTA_FUERA_CONTEXTO (termina aqu칤)\n\n### PASO 3: AN츼LISIS CONTEXTUAL INTELIGENTE\n1. Lee TODO el historial de conversaci칩n para establecer el contexto.\n2. **Diferencia clave:** 쮼l usuario ha mencionado un ID de cita existente (ej: \"cita 12345\") O usa palabras clave de reagendamiento/modificaci칩n?\n   - **Si S칈 ha mencionado un ID:** El contexto es `EDITAR_CITA` o `CANCELAR_CITA`.\n   - **Si usa palabras clave de reagendamiento** (reagendar, reprogramar, posponer, aplazar, modificar fecha/cita/entrega, cambiar fecha/hora, nueva fecha/hora) **Y existe historial de citas:** El contexto es `EDITAR_CITA`.\n   - **Si NO ha mencionado un ID ni palabras clave de reagendamiento:** El contexto es `CREAR_CITA`, incluso si cambia de opini칩n sobre la fecha/hora.\n\n### CRITERIOS ESPEC칈FICOS POR INTENCI칍N\n\n<!-- CAMBIO CLAVE: Se redefine CREAR_CITA para ser m치s tolerante a los cambios de opini칩n. -->\n**CREAR_CITA:**\n- Expresa deseo de agendar una cita nueva (sin mencionar ID de cita existente).\n- Proporciona datos iniciales (nombre, categor칤a, peso).\n- **Cambia de opini칩n sobre la fecha, hora o cualquier otro dato durante el proceso de creaci칩n.** Mientras no se haya confirmado una cita y generado un ID, sigue siendo parte del flujo de CREACI칍N.\n- Completa informaci칩n faltante para una nueva cita.\n\n**EDITAR_CITA:**\n- **PALABRAS CLAVE PRINCIPALES:** reagendar, reprogramar, posponer, aplazar, modificar fecha, modificar entrega, modificar cita, cambiar fecha, cambiar hora, nueva fecha, nueva hora, proponer fecha para cita existente, reagendamiento, reprogramaci칩n.\n- **REQUISITO:** El usuario menciona un ID de cita existente O usa palabras clave de modificaci칩n/reagendamiento junto con historial de citas existentes.\n- Proveedor solicita reprogramar/modificar una cita ya confirmada.\n- Proporciona nuevos datos (fecha/hora) para una cita existente.\n- Responde a solicitudes del sistema para la reprogramaci칩n de una cita espec칤fica.\n- **IMPORTANTE:** Si el usuario usa palabras como \"reagendar\", \"reprogramar\", \"posponer\", \"aplazar\", \"modificar fecha/hora/cita\" y existe historial de citas, SIEMPRE clasificar como EDITAR_CITA.\n\n**CONFIRMACION_CITA:**\n- SOLO cuando el sistema present칩 una lista numerada de horarios o una 칰nica opci칩n para confirmar.\n- El mensaje del proveedor es una elecci칩n clara de esas opciones (ej: \"la 2\", \"confirmo\", \"s칤, esa est치 bien\").\n- **NO es una confirmaci칩n si el usuario propone una fecha/hora completamente nueva.**\n\n**CANCELAR_CITA:**\n- **REQUISITO INDISPENSABLE: El usuario debe mencionar un ID de cita existente.**\n- Solicita expl칤citamente cancelar/anular una cita.\n- Menciona que no podr치 asistir a una cita programada, haciendo referencia a ella.\n\n**CONSULTAR_MALLA:**\n- Pregunta por disponibilidad sin datos espec칤ficos.\n- Solicita ver horarios disponibles.\n\n**RESPUESTA_FUERA_CONTEXTO:**\n- Mensajes rom치nticos o personales (\"quiero que seas mi esposa\", \"eres hermosa\")\n- Solicitudes de entretenimiento (\"cu칠ntame un chiste\", \"canta una canci칩n\")\n- Temas completamente ajenos al negocio (deportes, pol칤tica, clima personal)\n- Conversaciones filos칩ficas o existenciales\n- Cualquier mensaje que no tenga relaci칩n con log칤stica, citas o el servicio de bodega\n\n**PREGUNTA_GENERAL:**\n- Preguntas sobre ubicaci칩n, tel칠fono, otros procesos relacionados con el negocio.\n- Cualquier tema relacionado con el servicio pero no sobre citas espec칤ficas.\n\n**SALUDO:**\n- Saludos sin contexto adicional.\n- Primera interacci칩n sin m치s informaci칩n.\n\n## REGLAS IMPORTANTES\n1. La palabra \"ELIMINAR_MENSAJES\" tiene prioridad absoluta.\n2. **RESPUESTA_FUERA_CONTEXTO tiene segunda prioridad** - siempre clasifica as칤 los mensajes no relacionados con el negocio.\n3. **DETECCI칍N DE REAGENDAMIENTO:** Si el usuario usa palabras como \"reagendar\", \"reprogramar\", \"posponer\", \"aplazar\", \"modificar fecha/cita/entrega\", \"cambiar fecha/hora\" Y existe historial de citas, SIEMPRE clasificar como EDITAR_CITA.\n4. Si el mensaje es ambiguo, usa SIEMPRE el contexto del historial para determinar si ya se est치 trabajando sobre una cita con ID (EDITAR) o si es una nueva (CREAR).\n5. **Un cambio de fecha/hora SIN palabras de reagendamiento y sin mencionar un ID de cita es parte de `CREAR_CITA`.**\n6. Una vez establecido un contexto (ej. reprogramar la cita 12345), mant칠n ese contexto hasta cambio expl칤cito de tema.\n7. Solo clasifica, no valides ni interpretes emociones.\n\n## FORMATO DE RESPUESTA\nEscribe 칔NICAMENTE la intenci칩n detectada en este formato:\nINTENCION: [NOMBRE_INTENCION]\n\n### EJEMPLOS\n\n**Ejemplo 1 - ELIMINAR_MENSAJES**\nMensaje: \"Hola, necesito ELIMINAR_MENSAJES por favor\"\nRespuesta: INTENCION: ELIMINAR_MENSAJES\n\n**Ejemplo 2 - RESPUESTA_FUERA_CONTEXTO**\nMensaje: \"Quiero que seas mi esposa\"\nRespuesta: INTENCION: RESPUESTA_FUERA_CONTEXTO\n\n**Ejemplo 3 - RESPUESTA_FUERA_CONTEXTO**\nMensaje: \"Cu칠ntame un chiste\"\nRespuesta: INTENCION: RESPUESTA_FUERA_CONTEXTO\n\n**Ejemplo 4 - EDITAR_CITA (Correcto)**\nHistorial: Usuario dijo \"quiero reprogramar mi cita 12345\"\nMensaje actual: \"Mi orden es ABC123\"\nRespuesta: INTENCION: EDITAR_CITA\n\n<!-- CAMBIO CLAVE: Se ajusta el ejemplo para reflejar la nueva l칩gica. -->\n**Ejemplo 3 - CREAR_CITA (con cambio de opini칩n)**\nHistorial: Bot ofrece alternativas para el 17 de julio.\nMensaje actual: \"No mejor quiero la cita para el 18 de julio\"\nAn치lisis: No hay ID de cita. El usuario sigue definiendo los datos para una NUEVA cita.\nRespuesta: INTENCION: CREAR_CITA\n\n**Ejemplo 4 - CONFIRMACION_CITA**\nHistorial: Sistema ofreci칩 \"1) 9:00 AM, 2) 10:00 AM, 3) 11:00 AM\"\nMensaje actual: \"La 2\"\nRespuesta: INTENCION: CONFIRMACION_CITA\n\n**Ejemplo 5 - SALUDO**\nMensaje: \"Buenos d칤as\"\nRespuesta: INTENCION: SALUDO\n\n**Ejemplo 6 - EDITAR_CITA (Reagendar sin ID)**\nHistorial: Usuario tiene citas programadas\nMensaje actual: \"Necesito reagendar mi cita de entrega\"\nAn치lisis: Usa palabra clave \"reagendar\" y existe historial de citas.\nRespuesta: INTENCION: EDITAR_CITA\n\n**Ejemplo 7 - EDITAR_CITA (Reprogramar sin ID)**\nHistorial: Usuario tiene citas programadas\nMensaje actual: \"Quiero reprogramar para el viernes\"\nAn치lisis: Usa palabra clave \"reprogramar\" y existe historial de citas.\nRespuesta: INTENCION: EDITAR_CITA\n\n**Ejemplo 8 - EDITAR_CITA (Posponer sin ID)**\nHistorial: Usuario tiene citas programadas\nMensaje actual: \"Necesito posponer mi entrega\"\nAn치lisis: Usa palabra clave \"posponer\" y existe historial de citas.\nRespuesta: INTENCION: EDITAR_CITA\n\n**Ejemplo 9 - EDITAR_CITA (Modificar fecha sin ID)**\nHistorial: Usuario tiene citas programadas\nMensaje actual: \"Quiero modificar la fecha de entrega\"\nAn치lisis: Usa palabras clave \"modificar fecha\" y existe historial de citas.\nRespuesta: INTENCION: EDITAR_CITA\n\n## RECORDATORIO FINAL\n1. Busca PRIMERO \"ELIMINAR_MENSAJES\" en may칰sculas.\n2. Luego verifica si es RESPUESTA_FUERA_CONTEXTO (no relacionado con el negocio).\n3. **PRIORIDAD ALTA:** Si detectas palabras clave de reagendamiento (reagendar, reprogramar, posponer, aplazar, modificar fecha/cita/entrega, cambiar fecha/hora) Y existe historial de citas, SIEMPRE clasificar como EDITAR_CITA.\n4. Si est치 relacionado con el negocio, analiza el contexto completo. **La presencia de un ID de cita O palabras clave de reagendamiento son factores decisivos para EDITAR_CITA.**\n5. Clasifica seg칰n el flujo en curso, permitiendo cambios de opini칩n dentro del flujo de `CREAR_CITA`.\n6. Responde SOLO con el formato indicado."
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        -9776,
        5312
      ],
      "id": "dd8d67a1-72a4-4fd7-abd6-455342214a9e",
      "name": "Basic LLM CLASIFICADOR"
    },
    {
      "parameters": {
        "jsCode": "// Nodo de respuesta anticipada inteligente\nconst intencion = $('Almacenar la intenci칩n detectada').first().json.intencionDetectada;\nconst mensajeActual = $('Combinar Contexto MongoDB').first().json.infoMensaje.mensajeActual;\nconst workflowContext = $('Combinar Contexto MongoDB').first().json.workflowContext;\n\n// Funci칩n para detectar si faltan campos requeridos\nfunction detectarCamposFaltantes(intencion, mensaje) {\n  const camposRequeridos = workflowContext.required_fields[intencion] || [];\n  const camposFaltantes = [];\n  \n  // An치lisis simple del mensaje para detectar campos\n  const texto = mensaje.toLowerCase();\n  \n  if (intencion === 'CREAR_CITA') {\n    if (!texto.includes('proveedor') && !texto.includes('empresa') && !texto.includes('nombre')) {\n      camposFaltantes.push('proveedor');\n    }\n    if (!texto.includes('categor칤a') && !texto.includes('categoria') && !texto.includes('tipo')) {\n      camposFaltantes.push('categoria');\n    }\n    if (!texto.includes('fecha') && !texto.includes('d칤a') && !texto.includes('dia')) {\n      camposFaltantes.push('fecha');\n    }\n    if (!texto.includes('hora') && !texto.includes('horario')) {\n      camposFaltantes.push('hora');\n    }\n    if (!texto.includes('peso') && !texto.includes('kilos') && !texto.includes('toneladas')) {\n      camposFaltantes.push('peso');\n    }\n    if (!texto.includes('unidades') && !texto.includes('cantidad')) {\n      camposFaltantes.push('unidades');\n    }\n    if (!texto.includes('orden') && !texto.includes('compra')) {\n      camposFaltantes.push('orden_compra');\n    }\n  }\n  \n  return camposFaltantes;\n}\n\n// Determinar si se puede responder anticipadamente\nconst camposFaltantes = detectarCamposFaltantes(intencion, mensajeActual);\nconst puedeResponderAnticipadamente = camposFaltantes.length > 0 && intencion === 'CREAR_CITA';\n\n// Generar respuesta anticipada si es posible\nlet respuestaAnticipada = null;\nif (puedeResponderAnticipadamente) {\n  const categoriasDisponibles = $('Combinar Contexto MongoDB').first().json.datoscategorias?.map(c => c.CATEGORIA).join(', ') || 'ARENAS, GRAVAS, CEMENTO, ADITIVOS';\n  \n  respuestaAnticipada = `춰Hola! Veo que quieres agendar una cita de entrega. Para ayudarte mejor, necesito que me proporciones la siguiente informaci칩n:\\n\\n`;\n  \n  if (camposFaltantes.includes('proveedor')) {\n    respuestaAnticipada += ` **Nombre del proveedor** (ejemplo: SPB COLOMBIA S.A.S)\\n`;\n  }\n  if (camposFaltantes.includes('categoria')) {\n    respuestaAnticipada += ` **Categor칤a del material** (${categoriasDisponibles})\\n`;\n  }\n  if (camposFaltantes.includes('fecha')) {\n    respuestaAnticipada += ` **Fecha de entrega** (ejemplo: 25 de junio)\\n`;\n  }\n  if (camposFaltantes.includes('hora')) {\n    respuestaAnticipada += ` **Hora de entrega** (ejemplo: 9:00 AM)\\n`;\n  }\n  if (camposFaltantes.includes('peso')) {\n    respuestaAnticipada += ` **Peso de la mercanc칤a** (ejemplo: 300 kilos)\\n`;\n  }\n  if (camposFaltantes.includes('unidades')) {\n    respuestaAnticipada += ` **Cantidad de unidades** (ejemplo: 600 unidades)\\n`;\n  }\n  if (camposFaltantes.includes('orden_compra')) {\n    respuestaAnticipada += ` **N칰mero de orden de compra** (ejemplo: ARGM47896)\\n`;\n  }\n  \n  respuestaAnticipada += `\\nPor favor, proporciona estos datos para completar tu solicitud.`;\n}\n\nreturn [{\n  json: {\n    puedeResponderAnticipadamente,\n    respuestaAnticipada,\n    camposFaltantes,\n    intencion,\n    mensajeOriginal: mensajeActual\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9296,
        5312
      ],
      "id": "6693338a-eb7e-494f-b013-bb3b7e806ced",
      "name": "Respuesta Anticipada Inteligente"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "decision-anticipada",
              "leftValue": "={{ $json.puedeResponderAnticipadamente }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8960,
        5312
      ],
      "id": "33f7b02f-5d96-438d-9269-6d77bcb4f9b1",
      "name": "쯋sar Respuesta Anticipada?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Respuesta Anticipada Inteligente').first().json.respuestaAnticipada }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -8752,
        5200
      ],
      "id": "b3f531bc-5c9b-4ba8-b985-a6378aa61435",
      "name": "Enviar Respuesta Anticipada"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -8544,
        5200
      ],
      "id": "7909a1c2-2670-41b4-bb9b-8278883b102d",
      "name": "Finalizar Respuesta Anticipada"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "SALUDO",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "9dcab097-7554-4462-a979-fdf8536d0486"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SALUDO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e006f52b-8954-4501-a9bb-a1afd0d9ded9",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "CREAR_CITA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CREAR_CITA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "2d70e739-97ca-4370-90d6-a54d59aa360e",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "CONFIRMACION_CITA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CONFIRMACION_CITA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "73fa4c42-bcd5-4680-87bd-b90baa1c4fce",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "EDITAR_CITA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EDITAR_CITA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "029fb8dc-7e9f-4dfa-bec0-a933c7d06c53",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "CANCELAR_CITA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CANCELAR_CITA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e38bba1f-bf89-4389-b6dc-b8093dc344e1",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "CONSULTAR_MALLA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CONSULTAR_MALLA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e6ea3bd9-d425-42e2-8f6b-69342b093cff",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "PREGUNTA_GENERAL",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PREGUNTA_GENERAL"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "63eae036-bb70-4b9a-a67a-7fe6e2886456",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "ELIMINAR_MENSAJES",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ELIMINAR_MENSAJES"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "RESPUESTA_FUERA_CONTEXTO",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "RESPUESTA_FUERA_CONTEXTO"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -7248,
        5152
      ],
      "id": "12c2184b-3314-4a0d-9e49-1602d0c319fd",
      "name": "Switch basado en intenci칩n"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1200,
        368
      ],
      "id": "4471f1f2-2ec1-41c1-be5a-e70cc9a26f1a",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    intencionDetectada: $json.text ? $json.text.replace(\"INTENCION: \", \"\").trim() : \"\"\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8672,
        5424
      ],
      "id": "8cb624e9-3446-46f7-a667-9e023f369717",
      "name": "Almacenar la intenci칩n detectada"
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=### SISTEMA - COMUNICACI칍N WHATSAPP UX\n\nEres un asistente especializado en log칤stica de bodegas para **Konf칤e IA Logistics**, experto en comunicaci칩n WhatsApp profesional. Tu funci칩n es generar mensajes de saludo con excelente UX: formato visual claro, emojis estrat칠gicos, y tono formal pero humano.\n\n**OBLIGATORIO aplicar formato WhatsApp:**\n- *Negrita* para informaci칩n importante\n- Emojis profesionales para guiar la vista\n- Estructura visual clara\n- Tono cordial sin exagerar\n\nTu tarea es responder cuando el proveedor inicia la conversaci칩n con un saludo.\n\n---\n\n### REGLAS DE RESPUESTA\n\n1.  **Saludo por Hora:** Usa la hora del mensaje actual ({{ $('Unificaci칩n y consistencia de datos').item.json.infoMensaje.horaMensajeActual }}) para el saludo:\n    -   06:00 a 11:59  \"Buenos d칤as\"\n    -   12:00 a 17:59  \"Buenas tardes\"\n    -   18:00 a 05:59  \"Buenas noches\"\n\n2.  **Verificaci칩n de Citas Activas:** Revisa el `HISTORIAL DE CITAS DEL PROVEEDOR`.\n    -   **SI el historial contiene informaci칩n de citas (es decir, NO est치 vac칤o o no dice 'Sin citas')**, entonces debes a침adir esta frase a tu saludo: \"Veo que ya tienes citas agendadas con nosotros. Si deseas hacer alg칰n ajuste o consultar algo, estoy para ayudarte.\"\n    -   **SI el historial est치 VAC칈O o dice 'Sin citas', NO menciones NADA sobre citas existentes.** Simplemente pres칠ntate y ofrece las opciones generales.\n\n3.  **Capacidades del Asistente:** Siempre explica que puedes ayudar a:\n    -   Agendar una nueva cita para descarga.\n    -   Consultar disponibilidad de franjas.\n    -   Editar una cita ya programada.\n    -   Cancelar una entrega programada.\n\n4.  **No solicitar datos:** En este primer mensaje, no solicites ninguna informaci칩n. Mant칠n la conversaci칩n abierta.\n\n---\n\n### 游 MENSAJE ACTUAL DEL PROVEEDOR:\n{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.mensajeActual }}\n\n---\n\n### 游듹勇 HISTORIAL DE MENSAJES:\n{{ $node[\"Unificaci칩n y consistencia de datos\"].json[\"infoMensaje\"][\"historialMensajes\"] }}\n\n---\n\n### 游늱 HISTORIAL DE CITAS DEL PROVEEDOR:\n{{ $node[\"Unificaci칩n y consistencia de datos\"].json[\"infoMensajecita\"][\"historialCitas\"] }}\n\n---\n\n### 游 FORMATO DE RESPUESTA (JSON v치lido)\n\n**EJEMPLO DE SALUDO CON FORMATO UX:**\n```\n游깬 *춰Buenos d칤as!* \n\nSoy el asistente virtual de *Konf칤e IA Logistics* 游끽\n\n游녦 Estoy aqu칤 para ayudarte con:\n 游늰 *Agendar* una nueva cita de descarga\n 游댌 *Consultar* disponibilidad de franjas\n 九勇 *Modificar* una cita programada  \n 仇 *Cancelar* una entrega\n\n游눫 쮼n qu칠 puedo asistirte hoy?\n```\n\n**Respuesta JSON:**\n{\n  \"mensajeSistema\": \"Mensaje de saludo aplicando OBLIGATORIAMENTE el formato WhatsApp con *negritas*, emojis estrat칠gicos, estructura visual clara y tono profesional cordial.\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        1280,
        160
      ],
      "id": "79116cd7-7368-4fb5-8d6d-b4c0e5761049",
      "name": "Basic LLM CONVERSACI칍N (SALUDO)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Actualizar estado a SALUDANDO despu칠s de procesar saludo\nUPDATE EstadoConversacional \nSET estado_actual = 'SALUDANDO', \n    contexto_proceso = '{\"descripcion\": \"Procesando saludo del usuario\", \"accion_completada\": \"saludo_procesado\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}';\n\n-- Si no existe el registro, crear uno nuevo\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $('Parametrizaci칩n').first().json.message.chat.id }}', \n        'SALUDANDO', \n        '{\"descripcion\": \"Procesando saludo del usuario\", \"accion_completada\": \"saludo_procesado\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\n-- Confirmar actualizaci칩n\nSELECT \n  'SALUDANDO' as nuevo_estado,\n  'SALUDO_PROCESADO' as tipo_actualizacion,\n  '{{ $('Parametrizaci칩n').first().json.message.chat.id }}' as chat_id,\n  GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        1664,
        160
      ],
      "id": "b4ca121f-8f91-4b08-b8f3-a2ff3332db6a",
      "name": "Estado SQL - SALUDANDO",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3296,
        1584
      ],
      "id": "c270848d-a673-42c4-9ba5-4503511b9934",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# Prompt para el Asistente de Log칤stica de Bodegas\n\n## SISTEMA\nEres un asistente experto en log칤stica de bodegas, especializado en comunicar informaci칩n sobre citas de descarga de mercanc칤a. Tu funci칩n ahora es:\n\n1. **Interpretar los resultados de la validaci칩n** que ya fue realizada por el nodo de c칩digo JavaScript.\n2. **Generar mensajes humanos, claros y amables** para comunicarse con los proveedores.\n3. **NO repetir el procesamiento de validaci칩n** ya que esto se hizo en el nodo de c칩digo anterior.\n4. **Mantener el formato de salida JSON** requerido por el sistema.\n\n## DETECCI칍N DE DATOS CONTRADICTORIOS\nSi detectas m칰ltiples fechas/horas diferentes en el historial que contradicen el mensaje actual:\n- Identifica inconsistencias en los datos proporcionados\n- Prioriza SIEMPRE la informaci칩n m치s reciente del usuario  \n- Si hay confusi칩n excesiva (3+ cambios de fecha), marca como \"datos_contradictorios\"\n\n---\n### 游늵 RESULTADOS DE LA VALIDACI칍N:\n```json\n{{ JSON.stringify($node[\"Code RECOLECCI칍N\"].json, null, 2) }}\n```\n\n### 游늶 CATEGOR칈AS DISPONIBLES (USAR SOLO ESTAS):\n```json\n{{ $items(\"Estructuraci칩n, Consulta, Datos Categorias\")[0].json.datoscategorias.map(cat => cat.CATEGORIA) }}\n```\n\n### 游 MENSAJE ACTUAL DEL PROVEEDOR:\n{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.mensajeActual }}\n\n### 游뎹 FECHA Y HORA ACTUAL (BOGOT츼, COLOMBIA):\n{{ new Date().toLocaleString(\"es-CO\", { timeZone: \"America/Bogota\", hour12: true }) }}\n\n### 游닇 INSTRUCCIONES PARA GENERAR RESPUESTAS:\n\n**REGLA CR칈TICA PARA NOMBRES DE PROVEEDORES:**\n- Al mencionar el nombre del proveedor en el mensajeSistema, NUNCA agregues puntos, comas o signos de puntuaci칩n adicionales al final del nombre\n- El nombre del proveedor debe aparecer exactamente como est치 en la base de datos, sin modificaciones de puntuaci칩n\n- Ejemplo correcto: \"SPB COLOMBIA S.A.S\" (sin punto adicional)\n- Ejemplo incorrecto: \"SPB COLOMBIA S.A.S.\" (con punto adicional)\n\n#### 1. SI TODO EST츼 CORRECTO (`todoCorrecto: true`):\n- Genera un mensaje confirmando que la cita ha sido registrada exitosamente.\n- Incluye todos los detalles identificados: proveedor completo, fecha, hora, categor칤a, peso, unidades, n칰mero de orden.\n- Usa un tono profesional y amable, agradeciendo por la informaci칩n completa.\n- Ejemplo: \"He registrado tu cita para SPB COLOMBIA S.A.S el d칤a 14 de abril a las 10:00 AM, categor칤a ARENAS, 300 kilos, 900 unidades con n칰mero de orden ARGM47896. Tu cita ha sido registrada con 칠xito.\"\n- IMPORTANTE: NO solicites confirmaciones innecesarias cuando todos los datos est칠n correctos.\n\n#### 2. SI HAY DATOS PREVIAMENTE CONFIRMADOS (`datosPreviamenteConfirmados: true`):\n- Genera un mensaje final confirmando que la cita ha sido registrada con 칠xito.\n- Incluye todos los detalles ya confirmados: proveedor, fecha, hora, etc.\n- Usa un tono de cierre, agradeciendo por la confirmaci칩n.\n- Ejemplo: \"춰Perfecto! He confirmado tu cita para SPB COLOMBIA S.A.S el d칤a 14 de abril a las 10:00 AM. Tu cita ha sido registrada con 칠xito.\"\n\n#### 3. SI HAY PROVEEDORES SIMILARES QUE REQUIEREN CONFIRMACI칍N:\n- Cuando `proveedoresSimilares` no est칠 vac칤o, genera un mensaje pidiendo confirmaci칩n espec칤fica del proveedor.\n- Lista las opciones de proveedores de forma clara y ordenada.\n- Incluye los dem치s datos ya confirmados (fecha, hora, categor칤a, etc.).\n- Ejemplo: \"He identificado varios proveedores que coinciden con tu solicitud. Por favor, confirma cu치l deseas usar:\\n- SPB COLOMBIA S.A.S\\n- SOPORTE PRODUCTIVO S.A.S.\\nLos dem치s datos de tu cita (14 de abril a las 10:00 AM, categor칤a ARENAS, 300 kilos, 900 unidades) ya est치n registrados.\"\n\n#### 4. SI HAY CATEGOR칈AS SIMILARES QUE REQUIEREN CONFIRMACI칍N:\n- Cuando `categoriasSimilares` no est칠 vac칤o, genera un mensaje pidiendo confirmaci칩n espec칤fica de la categor칤a.\n- Lista las opciones de categor칤as de forma clara y ordenada.\n- Incluye los dem치s datos ya confirmados (proveedor, fecha, hora, etc.).\n\n#### 5. SI FALTAN CAMPOS OBLIGATORIOS:\n- Cuando `camposFaltantes` no est칠 vac칤o, genera un mensaje solicitando espec칤ficamente los campos faltantes.\n- **USA EL FORMATO AMIGABLE Y ESTRUCTURADO** con lista para cada campo faltante.\n- **IMPORTANTE: SIEMPRE usa las categor칤as del nodo de datos, NUNCA uses ejemplos hardcodeados**.\n- Proporciona ejemplos claros para cada campo.\n- Template de respuesta:\n```\nGracias por tu solicitud. Para poder agendar tu cita de entrega, necesito que me proporciones la siguiente informaci칩n:\n[SI FALTA PROVEEDOR]  El nombre del proveedor (proporcionar el nombre lo m치s completo posible)\n[SI FALTA CATEGOR칈A]  La categor칤a del material (los cuales pueden ser: {{ $items(\"Estructuraci칩n, Consulta, Datos Categorias\")[0].json.datoscategorias.map(cat => cat.CATEGORIA).map(cat => cat.toUpperCase()).join(', ') }})\n[SI FALTA FECHA]  La fecha de entrega (ejemplo: 25 de junio)\n[SI FALTA HORA]  La hora de entrega (ejemplo: 9:00 AM)\n[SI FALTA PESO]  El peso de la mercanc칤a (ejemplo: 300 kilos)\n[SI FALTA UNIDADES]  La cantidad de unidades a descargar (ejemplo: 600 unidades)\n[SI FALTA ORDEN]  El n칰mero de orden de compra (ejemplo: ARGM47896)\n\nPor favor, proporciona estos datos para completar tu solicitud.\n```\n\n#### 6. NUEVAS VERIFICACIONES DE FECHA Y HORA:\n- Si `fechaValida` es `false` o `horaValida` es `false`, debes comunicar al usuario el problema espec칤fico.\n- Utiliza el mensaje que viene en `mensajeValidacionTemporal` para explicar el motivo del rechazo.\n- Solicita al usuario que proporcione una fecha u hora v치lida seg칰n corresponda.\n\n#### 7. SI LA FECHA SOLICITADA ES PARA UN D칈A NO H츼BIL:\n- Si `diaHabil` es `false`, debes informar al usuario que solo se pueden agendar citas en d칤as h치biles (lunes a viernes).\n- Sugiere al usuario que elija una fecha en d칤a h치bil cercano.\n\n#### 8. SI EL NODO DE VALIDACI칍N DETECT칍 UNA FECHA \"MA칌ANA\" PERO LA INTERPRET칍 INCORRECTAMENTE:\n- Si el mensaje actual contiene la palabra \"ma침ana\" pero la fecha validada no corresponde al d칤a siguiente, debes corregirlo.\n- Verifica que, si el usuario dice \"ma침ana\", la fecha debe ser el d칤a siguiente al actual.\n\n### 丘멆잺 REGLAS CR칈TICAS SOBRE CATEGOR칈AS:\n\n1. **NUNCA uses categor칤as de ejemplo o hardcodeadas**. SIEMPRE obt칠n las categor칤as del nodo: {{ $items(\"Estructuraci칩n, Consulta, Datos Categorias\")[0].json.datoscategorias.map(cat => cat.CATEGORIA) }}\n\n2. **Para mostrar categor칤as en negrilla sin asteriscos visibles**, usa uno de estos formatos:\n   - En texto plano: simplemente lista las categor칤as en MAY칔SCULAS separadas por comas\n   - Con vi침etas: usa el s칤mbolo  antes de cada elemento\n\n3. **Elimina TODOS los ejemplos de categor칤as hardcodeadas** del prompt. Solo usa las categor칤as din치micas.\n\n### 丘멆잺 OTRAS REGLAS IMPORTANTES:\n\n1. **NUNCA pidas confirmaci칩n cuando el nodo de c칩digo ya determin칩 que todo est치 correcto** (`todoCorrecto: true`).\n\n2. **NUNCA pidas confirmaci칩n para datos que ya fueron correctamente identificados**.\n\n3. **Usa un lenguaje humano, amable y natural**, evitando tecnicismos.\n\n4. **No repitas datos innecesariamente** ni hagas preguntas redundantes.\n\n5. **No permitas citas para el mismo d칤a con menos de 2 horas de anticipaci칩n**.\n\n6. **Rechaza expl칤citamente las citas para d칤as no h치biles** (fines de semana).\n\n7. **SIEMPRE obt칠n las categor칤as disponibles del nodo correspondiente**.\n\n### 游늶 EJEMPLOS DE RESPUESTAS (IMPORTANTE: NO uses las categor칤as de estos ejemplos):\n\n#### EJEMPLO 1 - TODO CORRECTO:\n```json\n{\n  \"todoCorrecto\": true,\n  \"datosPreviamenteConfirmados\": false,\n  \"camposFaltantes\": [],\n  \"proveedoresSimilares\": [],\n  \"categoriasSimilares\": [],\n  \"fechaSolicitada\": \"14 de abril de 2025\",\n  \"horaSolicitada\": \"10:00 AM\",\n  \"mensajeSistema\": \"He registrado tu cita para [PROVEEDOR] el d칤a [FECHA] a las [HORA], categor칤a [CATEGOR칈A REAL DEL NODO], con un peso de [PESO] kilos y [UNIDADES] unidades. Tu n칰mero de orden de compra [ORDEN] ha sido registrado. Tu cita ha sido confirmada exitosamente.\",\n  \"mensajeEstado\": \"datos_completos\",\n  \"motivoRechazo\": \"\"\n}\n```\n\n#### EJEMPLO 2 - FALTA INFORMACI칍N COMPLETA:\n```json\n{\n  \"todoCorrecto\": false,\n  \"datosPreviamenteConfirmados\": false,\n  \"camposFaltantes\": [\"proveedor\", \"categor칤a\", \"fecha\", \"hora\", \"peso\", \"unidades\", \"orden de compra\"],\n  \"proveedoresSimilares\": [],\n  \"categoriasSimilares\": [],\n  \"fechaSolicitada\": \"\",\n  \"horaSolicitada\": \"\",\n  \"mensajeSistema\": \"Gracias por tu solicitud. Para poder agendar tu cita de entrega, necesito que me proporciones la siguiente informaci칩n:\\n El nombre del proveedor (proporcionar el nombre lo m치s completo posible)\\n La categor칤a del material (los cuales pueden ser: [USAR CATEGOR칈AS REALES DEL NODO])\\n La fecha y hora de entrega (ejemplo: 25 de junio a las 9:00 AM)\\n El peso de la mercanc칤a (ejemplo: 300 kilos)\\n La cantidad de unidades a descargar (ejemplo: 600 unidades)\\n El n칰mero de orden de compra (ejemplo: ARGM47896)\\n\\nPor favor, proporciona estos datos para completar tu solicitud.\",\n  \"mensajeEstado\": \"datos_incompletos\",\n  \"motivoRechazo\": \"\"\n}\n```\n\n#### EJEMPLO 3 - DATOS CONTRADICTORIOS:\n```json\n{\n  \"todoCorrecto\": false,\n  \"datosPreviamenteConfirmados\": false,\n  \"camposFaltantes\": [],\n  \"proveedoresSimilares\": [],\n  \"categoriasSimilares\": [],\n  \"fechaSolicitada\": \"\",\n  \"horaSolicitada\": \"\",\n  \"mensajeSistema\": \"He detectado m칰ltiples cambios en las fechas solicitadas. Para evitar confusiones, por favor proporciona todos los datos completos en un solo mensaje.\",\n  \"mensajeEstado\": \"datos_contradictorios\",\n  \"motivoRechazo\": \"Usuario ha proporcionado fechas contradictorias m칰ltiples veces\"\n}\n```\n\n### 游닋 FORMATO DE TU RESPUESTA:\nIMPORTANTE: Debes responder EXCLUSIVAMENTE en formato JSON con la siguiente estructura:\n\n```json\n{\n  \"todoCorrecto\": true | false,\n  \"datosPreviamenteConfirmados\": true | false,\n  \"camposFaltantes\": [\"campo1\", \"campo2\", ...],\n  \"proveedoresSimilares\": [\"Proveedor 1\", \"Proveedor 2\", ...],\n  \"categoriasSimilares\": [\"Categor칤a 1\", \"Categor칤a 2\", ...],\n  \"fechaSolicitada\": \"Fecha exacta que el proveedor solicit칩\",\n  \"horaSolicitada\": \"Hora exacta que el proveedor solicit칩\",\n  \"mensajeSistema\": \"Texto humano, amable y claro para el proveedor\",\n  \"mensajeEstado\": \"datos_completos\" | \"datos_incompletos\" | \"datos_contradictorios\",\n  \"motivoRechazo\": \"Descripci칩n del motivo si aplica\"\n}\n```\n\nLa respuesta NO debe incluir explicaciones, razonamientos o texto adicional fuera del objeto JSON."
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        3376,
        1376
      ],
      "id": "eb01f970-2d1b-4af7-9c2c-f1273980cb89",
      "name": "Basic LLM Chain RECOLECCI칍N"
    },
    {
      "parameters": {
        "jsCode": "const rawText = $json.text;\n\n// Eliminar bloques ```json y otros caracteres extra si existen\nconst clean = rawText\n  .replace(/```json/g, '')\n  .replace(/```/g, '')\n  .trim();\n\nlet parsed;\ntry {\n  parsed = JSON.parse(clean);\n} catch (e) {\n  parsed = {\n    todoCorrecto: false,\n    camposFaltantes: [\"error_json\"],\n    mensajeSistema: \"Hubo un error al interpretar los datos del modelo IA.\"\n  };\n}\n\n// Detectar retractaciones y forzar reset\nif (parsed.mensajeEstado === \"datos_contradictorios\") {\n  return [{ \n    json: { \n      forzarReset: true, \n      mensaje: \"游댃 **M칰ltiples cambios detectados**\\n\\nPara evitar errores, proporciona todos los datos en un solo mensaje completo.\" \n    } \n  }];\n}\n\nreturn [{ json: parsed }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3728,
        1376
      ],
      "id": "81d7dc10-78c2-46b5-a2d8-9be486b12806",
      "name": "Code (Formatear JSON RECOLECCI칍N)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Actualizar estado a CREANDO_CITA cuando se est치 procesando la creaci칩n de nueva cita\nUPDATE EstadoConversacional \nSET estado_actual = 'CREANDO_CITA', \n    contexto_proceso = '{{ JSON.stringify({\n        descripcion: \"Procesando creaci칩n de nueva cita\",\n        datos_cita: {\n            proveedor: $(\"Code Datos Insert Cita\").first().json.proveedor,\n            orden_compra: $(\"Code Datos Insert Cita\").first().json.orden_compra,\n            fecha: $(\"Code Datos Insert Cita\").first().json.fecha_cita,\n            hora_inicio: $(\"Code Datos Insert Cita\").first().json.hora_inicio,\n            muelle: $(\"Code Datos Insert Cita\").first().json.muelle\n        },\n        accion: \"creacion_en_proceso\",\n        timestamp: new Date().toISOString()\n    }) }}',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $(\"Parametrizaci칩n\").first().json.message.chat.id }}';\n\n-- Si no existe el registro, crear uno nuevo\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $(\"Parametrizaci칩n\").first().json.message.chat.id }}', \n        'CREANDO_CITA', \n        '{{ JSON.stringify({\n            descripcion: \"Procesando creaci칩n de nueva cita\",\n            datos_cita: {\n                proveedor: $(\"Code Datos Insert Cita\").first().json.proveedor,\n                orden_compra: $(\"Code Datos Insert Cita\").first().json.orden_compra,\n                fecha: $(\"Code Datos Insert Cita\").first().json.fecha_cita,\n                hora_inicio: $(\"Code Datos Insert Cita\").first().json.hora_inicio,\n                muelle: $(\"Code Datos Insert Cita\").first().json.muelle\n            },\n            accion: \"creacion_en_proceso\",\n            timestamp: new Date().toISOString()\n        }) }}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\n-- Confirmar actualizaci칩n\nSELECT \n  'CREANDO_CITA' as nuevo_estado,\n  'CREACION_EN_PROCESO' as tipo_actualizacion,\n  '{{ $(\"Parametrizaci칩n\").first().json.message.chat.id }}' as chat_id,\n  GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        6624,
        2448
      ],
      "id": "1b160cb2-9367-400c-bafc-fe162a1fc1e6",
      "name": "Estado SQL - CREANDO_CITA",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9fb4ec76-c88a-4b6e-ac86-10bd802e5e8a",
              "leftValue": "={{ $json.todoCorrecto }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3952,
        1376
      ],
      "id": "63d500cb-93be-4431-bb28-df1267d79b9d",
      "name": "IF Datos Completos"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Actualizar estado a SOLICITANDO_DATOS_CREAR cuando faltan datos para crear cita\nUPDATE EstadoConversacional \nSET estado_actual = 'SOLICITANDO_DATOS_CREAR', \n    contexto_proceso = '{\"descripcion\": \"Solicitando datos faltantes para crear nueva cita\", \"datos_requeridos\": [\"nombre\", \"orden_compra\", \"peso\", \"unidades\", \"fecha\", \"hora\"], \"accion\": \"recopilacion_datos\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}';\n\n-- Si no existe el registro, crear uno nuevo\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $('Parametrizaci칩n').first().json.message.chat.id }}', \n        'SOLICITANDO_DATOS_CREAR', \n        '{\"descripcion\": \"Solicitando datos faltantes para crear nueva cita\", \"datos_requeridos\": [\"nombre\", \"orden_compra\", \"peso\", \"unidades\", \"fecha\", \"hora\"], \"accion\": \"recopilacion_datos\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\n-- Confirmar actualizaci칩n\nSELECT \n  'SOLICITANDO_DATOS_CREAR' as nuevo_estado,\n  'RECOPILACION_DATOS' as tipo_actualizacion,\n  '{{ $('Parametrizaci칩n').first().json.message.chat.id }}' as chat_id,\n  GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        4304,
        1584
      ],
      "id": "c2a23334-01b2-4cd0-a812-781825c03380",
      "name": "Estado SQL - SOLICITANDO_DATOS_CREAR",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    text: $('Code (Formatear JSON RECOLECCI칍N)').first().json.mensajeSistema\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4544,
        1584
      ],
      "id": "a24ff810-f504-47e3-883d-84cbcecb6794",
      "name": "Code Respuesta Faltantes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "07f5d304-964c-4736-94aa-a05d439dcf6e",
              "name": "estadoConversacion",
              "value": "RECOLECCI칍N",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4816,
        1584
      ],
      "id": "38ed43dd-febb-4202-8647-2f930e0ad1c9",
      "name": "Setear estado conversacional"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Code Respuesta Faltantes').item.json.text.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6592,
        1648
      ],
      "id": "33c80d4c-5933-4162-a885-1fa81e8e0de9",
      "name": "Validaci칩n de longitud de caracteres"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6896,
        1648
      ],
      "id": "cd59f344-799d-4561-a218-490481bf1b86",
      "name": "Organiza variables del mensaje"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"partes\": [\n    \"Primera parte del mensaje\",\n    \"Segunda parte del mensaje (si aplica)\",\n    \"Tercera parte del mensaje (si aplica)\",\n    \"Cuarta parte del mensaje (si aplica)\",\n    \"Quinta parte del mensaje (si aplica)\"\n  ]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        28512,
        8624
      ],
      "id": "b3fadc5f-030d-4db0-aafe-386a4c083894",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        28304,
        8624
      ],
      "id": "b137560a-13aa-4363-9f45-3f963d91a13f",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        7072,
        1440
      ],
      "id": "cfd9528e-9ace-4af9-92a5-41766f92166e",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6896,
        1440
      ],
      "id": "76ad34a5-dbd1-4307-830f-fdbe1490d168",
      "name": "HTTP Request Enviar Mensaje por WhatsApp"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensaje.ia }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=Divide inteligentemente mensajes largos para WhatsApp preservando coherencia y legibilidad.\n\nAN츼LISIS PREVIO:\n1. Identifica el tipo de contenido: confirmaci칩n de cita, cancelaci칩n, informaci칩n, etc.\n2. Detecta estructura: p치rrafos naturales, listas, citas del cliente, respuestas del sistema\n3. Respeta SIEMPRE los saltos de l칤nea existentes (\\n)\n\nREGLAS ESTRICTAS:\n游늺 L칈MITES:\n- Si 곣1500 caracteres  NO dividir, devuelve el texto completo\n- Cada parte: 800-1500 caracteres (preferir ~1200)\n- M치ximo 5 partes\n\n九勇 D칍NDE CORTAR (orden de prioridad):\n1. Entre bloques tem치ticos diferentes (ej: solicitud del cliente / respuesta del sistema)\n2. Despu칠s de p치rrafos completos (busca \\n\\n o doble salto)\n3. Despu칠s de puntos finales de oraciones\n4. PROHIBIDO cortar: en medio de oraciones, datos importantes, citas\n\n游댕 MANTENER SIEMPRE JUNTOS:\n- Solicitud completa del cliente con TODOS sus datos\n- Confirmaci칩n del sistema con detalles del muelle y horario\n- Advertencias o recordatorios importantes completos\n- Datos relacionados: fecha+hora+lugar+cantidades\n\n游닇 FORMATO:\n- Preserva emojis, negritas (**), saltos de l칤nea\n- NO agregues texto extra como \"Parte 1:\" o n칰meros\n- Si una idea contin칰a, termina con \"...\"\n- Si es continuaci칩n, empieza naturalmente\n\nEJEMPLO REAL DE BUENA DIVISI칍N:\nInput: \"Hola, deseo agendar una cita de entrega para el jueves 19, el nombre del proveedor es spb, categor칤a arenas, con un peso de 300 kilos, a las 6 de la ma침ana, 600 unidades, el n칰mero de orden de compra es ARGM47896\\n\\n춰Genial! Viendo el cronograma me registra que s칤 hay espacio para agendar esta cita, ser칤a para el 19 de junio de 2025, desde las 06:00 AM hasta las 08:00 AM, ya que por la cantidad de unidades y peso en promedio va a tardar 2 horas el descargue en el MUELLE 1. El sistema pide una confirmaci칩n de tu parte para que la cita se genere en el cronograma, por favor responde confirmando la cita y recuerda que el sistema nos da 5 minutos para confirmar la cita o de lo contrario no se puede garantizar el cupo solicitado en el cronograma.\"\n\nOutput correcto:\n{\"partes\":[\"Hola, deseo agendar una cita de entrega para el jueves 19, el nombre del proveedor es spb, categor칤a arenas, con un peso de 300 kilos, a las 6 de la ma침ana, 600 unidades, el n칰mero de orden de compra es ARGM47896\\n\\n춰Genial! Viendo el cronograma me registra que s칤 hay espacio para agendar esta cita, ser칤a para el 19 de junio de 2025, desde las 06:00 AM hasta las 08:00 AM, ya que por la cantidad de unidades y peso en promedio va a tardar 2 horas el descargue en el MUELLE 1.\",\"El sistema pide una confirmaci칩n de tu parte para que la cita se genere en el cronograma, por favor responde confirmando la cita y recuerda que el sistema nos da 5 minutos para confirmar la cita o de lo contrario no se puede garantizar el cupo solicitado en el cronograma.\"]}\n\nDivide mensajes largos para WhatsApp.\n\nREGLAS:\n- Si 곣1500 caracteres: NO dividir\n- Cada parte: 800-1500 caracteres m치ximo\n- M치ximo 5 partes\n- Mantener juntos: datos relacionados, p치rrafos completos\n- Preservar emojis y formato\n\nRESPUESTA OBLIGATORIA (solo JSON sin explicaciones):\n{\"partes\":[\"parte1\",\"parte2\"]}\n\nTexto a dividir:\n{{ $json.mensaje.ia }}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.5,
      "position": [
        28368,
        8416
      ],
      "id": "e6849ea4-d139-40f2-b679-95f4db88f9d8",
      "name": "Basic LLM Separaci칩n de Mensaje"
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.partes",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        28832,
        8416
      ],
      "id": "d2c5ebb1-7ed2-48f0-a432-ee69b2bb652b",
      "name": "Split Out Separa el Mensaje"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        29168,
        8416
      ],
      "id": "4ab6d79a-d48a-45c7-8de1-e91c8776394f",
      "name": "Loop Over Items Recorre las Partes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7e24e44a-14df-4559-b8f0-5a714b4e28ee",
              "name": "Mensaje",
              "value": "={{ $json['output.partes'] }}",
              "type": "string"
            },
            {
              "id": "9a3b644f-ccc6-4f2a-ac00-909990c06524",
              "name": "longitud",
              "value": "={{ $json['output.partes'].length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        29952,
        8768
      ],
      "id": "4b9858c3-472f-45b0-a928-c3a542a78b43",
      "name": "Recuento de Caracteres"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.longitud }}",
                    "rightValue": 121,
                    "operator": {
                      "type": "number",
                      "operation": "lt"
                    },
                    "id": "b5afcf0e-93bb-4d29-9b45-faa775511ba5"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Corto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ddc297e5-bff7-4b9d-812d-9131fc251995",
                    "leftValue": "={{ $json.longitud }}",
                    "rightValue": 181,
                    "operator": {
                      "type": "number",
                      "operation": "lt"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Medio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "35e399f9-47fb-4402-8e74-17602592c599",
                    "leftValue": "={{ $json.longitud }}",
                    "rightValue": 182,
                    "operator": {
                      "type": "number",
                      "operation": "gte"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Largo"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        30160,
        8768
      ],
      "id": "2188f500-bada-4da0-a332-e3874f3768c6",
      "name": "Switch"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $json.Mensaje }}"
            },
            {
              "name": "delay",
              "value": "={{3000}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        30464,
        8512
      ],
      "id": "552ca43f-f309-420f-828d-8c726b24ebb2",
      "name": "HTTP Request Enviar Mensaje por WhatsApp1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $json.Mensaje }}"
            },
            {
              "name": "delay",
              "value": "={{ 4000 }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        30464,
        8736
      ],
      "id": "45fee823-c963-43dd-a34a-6f5463b0644a",
      "name": "HTTP Request Enviar Mensaje por WhatsApp2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $json.Mensaje }}"
            },
            {
              "name": "delay",
              "value": "={{ 6000 }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        30464,
        8928
      ],
      "id": "387ccb94-0779-4c48-9f2f-d086156d8632",
      "name": "HTTP Request Enviar Mensaje por WhatsApp3"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO MensajesWhatsApp (message_id, contenido, fecha, chat_id, instance)\nVALUES (\n  '{{ $('Parametrizaci칩n').first().json.message.id }}',\n  '{{ $json.message.conversation.replace(/'/g, \"''\") }}',\n  FORMAT(SWITCHOFFSET(GETDATE(), '-05:00'), 'yyyy-MM-dd HH:mm:ss'),\n  'agenteAI',\n  '{{ $('Parametrizaci칩n').first().json.message.chat.instance }}'\n);"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        30768,
        8736
      ],
      "id": "d4f8cc9a-2b28-4219-aed6-bd21b7171556",
      "name": "Microsoft SQL",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO MensajesWhatsApp (message_id, contenido, fecha, chat_id, instance)\nVALUES (\n  '{{ $('Parametrizaci칩n').first().json.message.id }}',\n  '{{ $json.message.conversation.replace(/'/g, \"''\") }}',\n  FORMAT(SWITCHOFFSET(GETDATE(), '-05:00'), 'yyyy-MM-dd HH:mm:ss'),\n  'agenteAI',\n  '{{ $('Parametrizaci칩n').first().json.message.chat.instance }}'\n);"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        30768,
        8512
      ],
      "id": "ef14dc33-7e45-46cc-8017-7820d195a836",
      "name": "Microsoft SQL1",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO MensajesWhatsApp (message_id, contenido, fecha, chat_id, instance)\nVALUES (\n  '{{ $('Parametrizaci칩n').first().json.message.id }}',\n  '{{ $json.message.conversation.replace(/'/g, \"''\") }}',\n  FORMAT(SWITCHOFFSET(GETDATE(), '-05:00'), 'yyyy-MM-dd HH:mm:ss'),\n  'agenteAI',\n  '{{ $('Parametrizaci칩n').first().json.message.chat.instance }}'\n);"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        30768,
        8928
      ],
      "id": "0d909ccb-d131-4b47-9f3e-84bd8b1c1096",
      "name": "Microsoft SQL2",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "amount": 0
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        31088,
        8976
      ],
      "id": "95ced9d4-685b-4c27-870f-a8b3cc8ad8c7",
      "name": "Wait",
      "webhookId": "2d0cc5ee-b809-403d-8de5-06a71a8a40e9"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "ExcelMallaRecibido2025",
        "options": {
          "sheetName": "={{    (function() {     const semanaActual = $('Unificaci칩n y consistencia de datos').item.json.hojaSeleccionada;     const numeroSemana = parseInt(semanaActual.replace(\"SEMANA \", \"\"));     return `SEMANA ${numeroSemana + 1}`;   })() }}"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1664,
        1296
      ],
      "id": "12489b18-b7a1-42b4-ae01-4e6574dab1d0",
      "name": "Extract MALLA DE RECIBO Semana Siguiente",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Si el nodo anterior no devolvi칩 datos (por error al no existir la hoja), retornamos estructura vac칤a con mensaje\n// Obtener los datos del Excel\nconst excelData = $input.all();\n\n// Mejora en la detecci칩n de errores: verificar si hay error expl칤cito o si los datos no son v치lidos\nconst hayError = excelData.some(item => item.json && item.json.error);\nconst datosInvalidos = !excelData || excelData.length === 0 || hayError;\n\nif (datosInvalidos) {\n  return [{\n    datosMallaProxSemana: {\n      titulo: \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\",\n      a침o: \"\",\n      semana: \"\",\n      rangoDias: \"\",\n      franjas: [],\n      dias: {\n        lunes: { muelle1: {}, muelle2: {} },\n        martes: { muelle1: {}, muelle2: {} },\n        mi칠rcoles: { muelle1: {}, muelle2: {} },\n        jueves: { muelle1: {}, muelle2: {} },\n        viernes: { muelle1: {}, muelle2: {} }\n      }\n    },\n    funciones: {\n      consultarFranjasDisponibles: \"function not available\",\n      consultarCitasProveedor: \"function not available\",\n      obtenerInfoMalla: \"function not available\",\n      estaDisponible: \"function not available\",\n      obtenerCoordenadasCita: \"function not available\"\n    }\n  }];\n}\n\n// El resto del c칩digo permanece igual...\nconst hojaSeleccionada = $('Unificaci칩n y consistencia de datos').first().json.hojaSeleccionada;\n\n// Definir estructura de la semana y los d칤as\nconst diasSemana = ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'];\n\n// Objeto para almacenar la malla estructurada\nconst mallaEstructurada = {\n  titulo: \"\",\n  a침o: \"\",\n  semana: \"\",\n  rangoDias: \"\",\n  franjas: [],\n  dias: {}\n};\n\n// Tabla de meses y d칤as. Ajusta si necesitas contemplar bisiestos, etc.\nconst meses = {\n  \"enero\": 1,\n  \"febrero\": 2,\n  \"marzo\": 3,\n  \"abril\": 4,\n  \"mayo\": 5,\n  \"junio\": 6,\n  \"julio\": 7,\n  \"agosto\": 8,\n  \"septiembre\": 9,\n  \"octubre\": 10,\n  \"noviembre\": 11,\n  \"diciembre\": 12\n};\n\nconst nombreMes = {\n  1: \"enero\",\n  2: \"febrero\",\n  3: \"marzo\",\n  4: \"abril\",\n  5: \"mayo\",\n  6: \"junio\",\n  7: \"julio\",\n  8: \"agosto\",\n  9: \"septiembre\",\n  10: \"octubre\",\n  11: \"noviembre\",\n  12: \"diciembre\"\n};\n\n/**\n * Funci칩n para determinar si un a침o es bisiesto\n * Un a침o es bisiesto si es divisible por 4, excepto aquellos divisibles por 100 \n * que no son divisibles por 400\n */\nfunction esBisiesto(year) {\n  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n}\n\n/**\n * Funci칩n para obtener el n칰mero de d칤as en un mes, considerando a침os bisiestos\n */\nfunction getDiasMes(mes, a침o) {\n  const diasPorMes = {\n    1: 31, // enero\n    2: esBisiesto(a침o) ? 29 : 28, // febrero - ajustado para a침o bisiesto\n    3: 31, // marzo\n    4: 30, // abril\n    5: 31, // mayo\n    6: 30, // junio\n    7: 31, // julio\n    8: 31, // agosto\n    9: 30, // septiembre\n    10: 31, // octubre\n    11: 30, // noviembre\n    12: 31  // diciembre\n  };\n  \n  return diasPorMes[mes];\n}\n\n/**\n * Funci칩n para eliminar acentos y pasar a min칰sculas (para buscar palabras clave sin importar tildes ni may칰sculas).\n */\nfunction normalizarTexto(texto) {\n  if (typeof texto !== 'string') return \"\";\n  // Normaliza (NFD) y elimina diacr칤ticos, luego pasa a min칰sculas.\n  return texto\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase();\n}\n\n/**\n * Dada la informaci칩n de proveedor, ordenCompra, peso, categor칤a y unidades,\n * revisa si existe la palabra 'fuera de servicio', 'cancelado' o 'reagendado'\n * en cualquiera de esos campos. De ser as칤, retorna ese estado especial;\n * de lo contrario, retorna 'ocupado'.\n * \n * Se ignoran may칰sculas, min칰sculas y tildes.\n */\nfunction determinarEstadoOcupado(proveedor, ordenCompra, peso, categoria, unidades) {\n  const conjunto = `${proveedor} ${ordenCompra} ${peso} ${categoria} ${unidades}`;\n  const texto = normalizarTexto(conjunto);\n\n  if (texto.includes(\"fuera de servicio\")) {\n    return \"fuera de servicio\";\n  }\n  if (texto.includes(\"cancelado\")) {\n    return \"cancelado\";\n  }\n  if (texto.includes(\"reagendado\")) {\n    return \"reagendado\";\n  }\n  return \"ocupado\";  \n}\n\n// -------------------------------------------------------------\n// 1) PROCESAR DATOS (Cabecera, Horas, Muelles, etc.)\n// -------------------------------------------------------------\nfunction procesarDatos(excelData) {\n  // Verificaci칩n adicional de datos v치lidos\n  if (!excelData || !Array.isArray(excelData) || excelData.length === 0) {\n    return {\n      titulo: \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\",\n      a침o: \"\",\n      semana: \"\",\n      rangoDias: \"\",\n      franjas: [],\n      dias: {\n        lunes: { muelle1: {}, muelle2: {} },\n        martes: { muelle1: {}, muelle2: {} },\n        mi칠rcoles: { muelle1: {}, muelle2: {} },\n        jueves: { muelle1: {}, muelle2: {} },\n        viernes: { muelle1: {}, muelle2: {} }\n      }\n    };\n  }\n  \n  // Intentar mapear datos, con manejo de errores para cada item\n  const datos = excelData.map(item => {\n    try {\n      return item.json || {};\n    } catch (e) {\n      return {};\n    }\n  });\n  \n  // A) Cabecera (T칤tulo, A침o, Rango)\n  datos.forEach((dato, index) => {\n    // Buscar t칤tulo\n    if (dato.__EMPTY_2 === \"MALLA DE RECIBO CEDI KONFIE IA\") {\n      mallaEstructurada.titulo = dato.__EMPTY_2;\n      \n      // En la siguiente fila puede estar a침o, semana, rango\n      if (index + 1 < datos.length) {\n        const datoSiguiente = datos[index + 1];\n        if (datoSiguiente) {\n          // A침o\n          if (datoSiguiente.__EMPTY_2 && !isNaN(datoSiguiente.__EMPTY_2)) {\n            mallaEstructurada.a침o = datoSiguiente.__EMPTY_2;\n          }\n          // Semana\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"SEMANA\")) {\n              mallaEstructurada.semana = v;\n            }\n          });\n          // Rango: p.ej. \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"LUNES\") && v.includes(\"VIERNES\")) {\n              mallaEstructurada.rangoDias = v;\n            }\n          });\n        }\n      }\n    }\n  });\n  \n  // Si despu칠s de procesar no encontramos t칤tulo, es que no hay malla v치lida\n  if (!mallaEstructurada.titulo) {\n    mallaEstructurada.titulo = \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\";\n    return mallaEstructurada;\n  }\n  \n  // B) Detectar franjas horarias (.__EMPTY = fracci칩n de d칤a)\n  const franjasHorarias = [];\n  datos.forEach(dato => {\n    if (\n      dato.__EMPTY !== undefined &&\n      typeof dato.__EMPTY === 'number' &&\n      dato.__EMPTY > 0 &&\n      dato.__EMPTY < 1\n    ) {\n      const totalMin = Math.round(dato.__EMPTY * 24 * 60);\n      const hh = Math.floor(totalMin / 60);\n      const mm = totalMin % 60;\n      \n      let periodo = \"AM\";\n      let hora12 = hh;\n      if (hh >= 12) {\n        periodo = \"PM\";\n        hora12 = (hh === 12 ? 12 : hh - 12);\n      }\n      if (hh === 0) {\n        hora12 = 12;\n      }\n      \n      const horaStr = `${hora12}:${String(mm).padStart(2, '0')} ${periodo}`;\n      franjasHorarias.push({\n        hora: horaStr,\n        indice: datos.indexOf(dato) // fila base\n      });\n    }\n  });\n  franjasHorarias.sort((a, b) => a.indice - b.indice);\n  mallaEstructurada.franjas = franjasHorarias;\n  \n  // C) Detectar muelles (col)\n  const muellesInfo = {};\n  datos.forEach(dato => {\n    Object.entries(dato).forEach(([key, value]) => {\n      if (value === \"MUELLE 01\" || value === \"MUELLE 02\") {\n        const col = parseInt(key.replace(\"__EMPTY_\", \"\"), 10);\n        const muelleKey = (value === \"MUELLE 01\") ? 'muelle1' : 'muelle2';\n        if (!muellesInfo[muelleKey]) {\n          muellesInfo[muelleKey] = [];\n        }\n        muellesInfo[muelleKey].push(col);\n      }\n    });\n  });\n  if (muellesInfo.muelle1) muellesInfo.muelle1.sort((a, b) => a - b);\n  if (muellesInfo.muelle2) muellesInfo.muelle2.sort((a, b) => a - b);\n  \n  // D) Generar los 5 d칤as (lunes-viernes) con su fecha\n  parsearRangoDias();\n  \n  // E) Extraer Citas\n  extraerCitas(datos, muellesInfo);\n  \n  return mallaEstructurada;\n}\n\n/**\n * Parsea la cadena \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n * (o \"LUNES 31 AL VIERNES 04 DE ABRIL\") y maneja el cruce de mes.\n * Ej.: si dayStart=31 y dayEnd=4, la 1춹 fecha es 31 de MARZO,\n * luego 1,2,3,4 de ABRIL, en vez de 32,33, etc.\n */\nfunction parsearRangoDias() {\n  const texto = mallaEstructurada.rangoDias;\n  // Regex simple: p.ej. \"31 AL ... 4 DE ABRIL\"\n  // Captura: dayStart, dayEnd, mesFin\n  // Ojo: si dice \"LUNES 31 DE MARZO AL VIERNES 4 DE ABRIL\",\n  // quedar치: dayStart=31, dayEnd=4, month=ABRIL (al final).\n  const regex = /(\\d+)\\s+AL\\s+\\D+(\\d+)\\s+DE\\s+(\\w+)/i;\n  const match = regex.exec(texto);\n  \n  // Por defecto, creamos 5 d칤as vac칤os sin fecha\n  diasSemana.forEach(d => {\n    mallaEstructurada.dias[d] = {\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  if (!match) {\n    // Sin coincidencia, dejamos los d칤as sin fecha\n    return;\n  }\n  \n  const dayStart = parseInt(match[1], 10); // 31\n  const dayEnd   = parseInt(match[2], 10); // 4\n  const finalMonthName = match[3].toLowerCase(); // \"abril\"\n  \n  // Convertimos a n칰mero\n  const finalMonth = meses[finalMonthName] || 3; // fallback marzo\n  const yearNum = parseInt(mallaEstructurada.a침o, 10) || 2025;\n  \n  // Funci칩n para obtener la fecha formateada\n  function fechaFormateada(d, m, y) {\n    return `${d} de ${nombreMes[m]} de ${y}`;\n  }\n  \n  // Comprobamos cu치ntos d칤as tiene el mes final, considerando bisiestos\n  const diasMesFinal = getDiasMes(finalMonth, yearNum);\n  // y del mes previo\n  const monthPrev = (finalMonth === 1) ? 12 : finalMonth - 1;\n  const yearPrev = (finalMonth === 1) ? yearNum - 1 : yearNum;\n  \n  // Arreglo final con 5 fechas\n  const fechasDias = [];\n  \n  if (dayStart <= dayEnd) {\n    // Caso \"normal\": todo en el mismo mes\n    let d = dayStart;\n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: finalMonth,\n        yearNum: yearNum\n      });\n      d++;\n      if (d > diasMesFinal) {\n        d = 1;\n        const nextMonth = finalMonth % 12 + 1;\n        const nextYear = (nextMonth === 1) ? yearNum + 1 : yearNum;\n        fechasDias[fechasDias.length - 1].mesNum = nextMonth;\n        fechasDias[fechasDias.length - 1].yearNum = nextYear;\n      }\n    }\n  } else {\n    // Caso \"cruza de mes\": dayStart > dayEnd\n    let d = dayStart;\n    let m = monthPrev;\n    let y = yearPrev;\n    \n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: m,\n        yearNum: y\n      });\n      d++;\n      if (d > getDiasMes(m, y)) {\n        d = 1;\n        m = m % 12 + 1;\n        if (m === 1) {\n          y++;\n        }\n      }\n    }\n  }\n  \n  // Ahora volcamos esas 5 fechas en la estructura\n  fechasDias.forEach(fd => {\n    const { diaSem, diaNum, mesNum, yearNum } = fd;\n    mallaEstructurada.dias[diaSem] = {\n      fechaDia: fechaFormateada(diaNum, mesNum, yearNum),\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  // Inicializamos las franjas a 'disponible'\n  if (mallaEstructurada.franjas.length > 0) {\n    diasSemana.forEach(d => {\n      mallaEstructurada.franjas.forEach(f => {\n        mallaEstructurada.dias[d].muelle1[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n        mallaEstructurada.dias[d].muelle2[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n      });\n    });\n  }\n}\n\n/**\n * Funci칩n auxiliar: decide a qu칠 d칤a pertenece una columna,\n * corrigiendo 2 columnas de offset (porque 'Extract from XLSX'\n * deja todo desplazado).\n */\nfunction getDayForColumn(colNumber) {\n  // Ajuste de offset +2\n  const realCol = colNumber + 2;\n\n  // Rangos:\n  //  Lunes:      3..8\n  //  Martes:     9..14\n  //  Mi칠rcoles: 15..20\n  //  Jueves:    21..26\n  //  Viernes:   27..32\n  if (realCol >= 3 && realCol <= 8) {\n    return \"lunes\";\n  }\n  if (realCol >= 9 && realCol <= 14) {\n    return \"martes\";\n  }\n  if (realCol >= 15 && realCol <= 20) {\n    return \"mi칠rcoles\";\n  }\n  if (realCol >= 21 && realCol <= 26) {\n    return \"jueves\";\n  }\n  if (realCol >= 27 && realCol <= 32) {\n    return \"viernes\";\n  }\n  // Si nada coincide, devolvemos null\n  return null;\n}\n\n/**\n * Extraer las citas para cada franja:\n * - Para cada franja, miramos 3 filas:\n *    - Fila base => proveedor\n *    - Fila base+1 => orden\n *    - Fila base+2 => peso, categor칤a, unidades\n */\nfunction extraerCitas(datos, muellesInfo) {\n  mallaEstructurada.franjas.forEach(franja => {\n    const indiceBase = franja.indice;\n    if (indiceBase < 0 || indiceBase + 2 >= datos.length) {\n      return; // no hay suficientes filas\n    }\n    \n    // Recorremos muelle1, muelle2 y sus columnas\n    const asignarCita = (muelleKey, cols) => {\n      cols.forEach(col => {\n        const provKey = `__EMPTY_${col}`;\n        const filaProv = datos[indiceBase];\n        \n        // Si en esta fila hay un proveedor o alg칰n texto\n        if (\n          filaProv &&\n          typeof filaProv[provKey] === 'string' &&\n          filaProv[provKey].length > 2\n        ) {\n          // Determinar el d칤a real\n          const diaOk = getDayForColumn(col);\n          if (!diaOk || !mallaEstructurada.dias[diaOk]) {\n            return; // si no coincide con ninguno, saltamos\n          }\n          \n          // Recuperar valores para proveedor, ordenCompra y dem치s\n          const filaOrden = datos[indiceBase + 1];\n          const filaDet = datos[indiceBase + 2];\n          \n          const proveedor = filaProv[provKey] || \"\";\n          const ordenCompra = filaOrden && filaOrden[provKey] ? filaOrden[provKey] : \"\";\n          const peso = filaDet && filaDet[provKey] ? filaDet[provKey] : \"\";\n          const cat  = filaDet && filaDet[`__EMPTY_${col + 1}`] ? filaDet[`__EMPTY_${col + 1}`] : \"\";\n          const und  = filaDet && filaDet[`__EMPTY_${col + 2}`] ? filaDet[`__EMPTY_${col + 2}`] : \"\";\n          \n          // Antes pon칤amos estado=\"ocupado\" directamente\n          // Ahora verificamos si el texto contiene \"reagendado\", \"cancelado\" o \"fuera de servicio\".\n          const nuevoEstado = determinarEstadoOcupado(proveedor, ordenCompra, peso, cat, und);\n          \n          // Asignamos los datos\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].estado = nuevoEstado;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].proveedor = proveedor;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].ordenCompra = ordenCompra;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].peso = peso;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].categoria = cat;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].unidades = und;\n        }\n      });\n    };\n    \n    if (muellesInfo.muelle1) {\n      asignarCita('muelle1', muellesInfo.muelle1);\n    }\n    if (muellesInfo.muelle2) {\n      asignarCita('muelle2', muellesInfo.muelle2);\n    }\n  });\n}\n\n// -------------------------------------------------------------\n// 2) FUNCIONES PARA CONSULTAR LA MALLA\n// -------------------------------------------------------------\nfunction buscarFranjasDisponibles(categoria, duracionHoras) {\n  const muelle = \"muelle1\"; // Ajusta si usas \"categoria -> muelle\" real\n  \n  const franjasDisponibles = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const libres = [];\n    for (let i = 0; i <= mallaEstructurada.franjas.length - duracionHoras; i++) {\n      let disponible = true;\n      for (let h = 0; h < duracionHoras; h++) {\n        const idxF = i + h;\n        const horaAct = mallaEstructurada.franjas[idxF].hora;\n        if (\n          mallaEstructurada.dias[dia][muelle][horaAct].estado !== 'disponible'\n        ) {\n          disponible = false;\n          break;\n        }\n      }\n      if (disponible) {\n        libres.push({\n          horaInicio: mallaEstructurada.franjas[i].hora,\n          duracion: duracionHoras\n        });\n      }\n    }\n    if (libres.length > 0) {\n      franjasDisponibles.push({ dia, franjas: libres });\n    }\n  });\n  return franjasDisponibles;\n}\n\nfunction buscarCitasProveedor(nombreProveedor) {\n  const citas = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const muelle1 = mallaEstructurada.dias[dia].muelle1;\n    const muelle2 = mallaEstructurada.dias[dia].muelle2;\n    mallaEstructurada.franjas.forEach(f => {\n      const hora = f.hora;\n      // muelle1\n      if (normalizarTexto(muelle1[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 01\",\n          ordenCompra: muelle1[hora].ordenCompra,\n          peso: muelle1[hora].peso,\n          categoria: muelle1[hora].categoria,\n          unidades: muelle1[hora].unidades,\n          estado: muelle1[hora].estado\n        });\n      }\n      // muelle2\n      if (normalizarTexto(muelle2[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 02\",\n          ordenCompra: muelle2[hora].ordenCompra,\n          peso: muelle2[hora].peso,\n          categoria: muelle2[hora].categoria,\n          unidades: muelle2[hora].unidades,\n          estado: muelle2[hora].estado\n        });\n      }\n    });\n  });\n  return citas;\n}\n\nfunction consultarFranjasDisponibles(categoria, duracionHoras) {\n  return buscarFranjasDisponibles(categoria, duracionHoras);\n}\n\nfunction consultarCitasProveedor(nombreProveedor) {\n  return buscarCitasProveedor(nombreProveedor);\n}\n\nfunction obtenerInfoMalla() {\n  return {\n    titulo: mallaEstructurada.titulo,\n    a침o: mallaEstructurada.a침o,\n    semana: mallaEstructurada.semana,\n    rangoDias: mallaEstructurada.rangoDias,\n    franjas: mallaEstructurada.franjas.map(f => f.hora)\n  };\n}\n\nfunction estaDisponible(dia, hora, muelle) {\n  const info = mallaEstructurada.dias[dia]?.[muelle]?.[hora];\n  return info ? (info.estado === 'disponible') : false;\n}\n\nfunction obtenerCoordenadasCita(dia, hora, muelle) {\n  // Ajustar con tu mapeo de celdas en Excel\n  return {\n    proveedor: `${dia}_${hora}_${muelle}_proveedor`,\n    ordenCompra: `${dia}_${hora}_${muelle}_ordenCompra`,\n    peso: `${dia}_${hora}_${muelle}_peso`,\n    categoria: `${dia}_${hora}_${muelle}_categoria`,\n    unidades: `${dia}_${hora}_${muelle}_unidades`\n  };\n}\n\n// -------------------------------------------------------------\n// 3) EJECUTAR TODO Y RETORNAR\n// -------------------------------------------------------------\nconst malla = procesarDatos(excelData);\n\nconst resultado = {\n  datosMallaProxSemana: malla,\n  funciones: {\n    consultarFranjasDisponibles,\n    consultarCitasProveedor,\n    obtenerInfoMalla,\n    estaDisponible,\n    obtenerCoordenadasCita\n  }\n};\n\nreturn [resultado];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        1296
      ],
      "id": "dd3b4fae-9d66-4647-b80d-76010cae7f48",
      "name": "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3616,
        9680
      ],
      "id": "953a6e13-09f5-4b62-8244-d03878138131",
      "name": "OpenAI Chat Model6",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=### SISTEMA - EXPERTO EN UX WHATSAPP\nEres un asistente experto en log칤stica de bodegas para **Konf칤e IA Logistics**, especializado en comunicaci칩n WhatsApp profesional. Tu tarea es responder consultas de disponibilidad utilizando formato UX excelente: *negritas*, emojis estrat칠gicos, estructura visual clara y tono cordial profesional.\n\nDebes revisar cuidadosamente:\n- El mensaje actual del proveedor.\n- El historial de mensajes recientes.\n- El historial de citas del proveedor (si lo hay).\n- **IMPORTANTE: El d칤a y la hora actual de la consulta.**\n\nY con base en eso, generar una respuesta que sea:\n- **Amable, emp치tica, clara y conversacional.**\n- **Breve pero informativa**, explicando correctamente la disponibilidad general **seg칰n el momento de la consulta**.\n- Que explique que para ofrecer opciones reales y exactas se requiere **informaci칩n clave**.\n- Que **invite de forma cordial** a compartir los datos necesarios para avanzar.\n- Que **aclare al proveedor que si desea agendar la cita**, esos datos son obligatorios.\n\n**NUEVO: Considera el d칤a y la hora actual para determinar la disponibilidad general:**\n- **Entradas Requeridas (provistas por el sistema externo):**\n    - Hoy es `{{ new Date().toLocaleDateString(\"es-CO\", { timeZone: \"America/Bogota\", weekday: \"long\" }) }}`: D칤a de la semana actual (Lunes, Martes, Mi칠rcoles, Jueves, Viernes, S치bado, Domingo).\n    -La hora actual es `{{ new Date().toLocaleTimeString(\"es-CO\", { timeZone: \"America/Bogota\", hour: \"numeric\", minute: \"2-digit\", hour12: true }) }}`: Hora actual en formato HHMM (ej. 0900 para 9:00 AM, 1630 para 4:30 PM).\n- **Reglas de Disponibilidad General:**\n    - **Regla 1:** Si es **Lunes, Martes, Mi칠rcoles** O (es **Jueves** Y la hora es **antes de 1630**): Hay disponibilidad general para la semana **actual y la pr칩xima**.\n    - **Regla 2:** Si (es **Jueves** Y la hora es **1630 o posterior**) O es **Viernes**: La disponibilidad general es solo para la **pr칩xima semana**.\n    - **Regla 3:** Si es **S치bado o Domingo**: La disponibilidad general es solo para la **pr칩xima semana**.\n\n---\n### MENSAJE ACTUAL DEL PROVEEDOR:\n{{ $node[\"Unificaci칩n y consistencia de datos\"].json[\"infoMensaje\"][\"mensajeActual\"] }}\n---\n### HISTORIAL DE MENSAJES:\n{{ $node[\"Unificaci칩n y consistencia de datos\"].json[\"infoMensaje\"][\"historialMensajes\"] }}\n---\n### 游늱 HISTORIAL DE CITAS DEL PROVEEDOR:\n{{ $node[\"Unificaci칩n y consistencia de datos\"].json[\"infoMensajecita\"][\"historialCitas\"] }}\n---\n### CATEGOR칈AS:\n```json\n{{ JSON.stringify($json.datoscategorias, null, 2) }}\n```\n\n## 游꿢 OBJETIVO\nGenera una respuesta siguiendo estos pasos:\n\n### Saluda amablemente y explica la disponibilidad general APLICANDO LAS REGLAS de d칤a/hora:\n\n- **Si aplica la Regla 1** (Lunes-Mi칠rcoles, Jueves < 16:30): Usa una frase como:\n  > 춰Hola! Gracias por escribirnos 游땕. Te confirmo que tenemos disponibilidad general para agendar entregas tanto en la semana actual como en la pr칩xima. Para poder mostrarte los horarios espec칤ficos y ayudarte a programar tu cita, necesito que me confirmes algunos datos clave.\n\n- **Si aplica la Regla 2** (Jueves >= 16:30, Viernes): Usa una frase adaptada al d칤a.\n  - Si es Jueves tarde:\n    > 춰Hola! Gracias por escribirnos 游땕. Te comento que, por la hora, la disponibilidad de citas ya es para la pr칩xima semana. Para poder mostrarte los horarios espec칤ficos y ayudarte a programar tu cita, necesito que me confirmes algunos datos clave.\n  - Si es Viernes:\n    > 춰Hola! Gracias por escribirnos 游땕. Te comento que, al ser hoy viernes, la disponibilidad de citas ya es para la pr칩xima semana. Para poder mostrarte los horarios espec칤ficos y ayudarte a programar tu cita, necesito que me confirmes algunos datos clave.\n\n- **Si aplica la Regla 3** (S치bado, Domingo): Usa una frase como:\n  > 춰Hola! Gracias por escribirnos 游땕. Ya que nos contactas en fin de semana, la disponibilidad de citas es a partir de la pr칩xima semana. Para poder mostrarte los horarios espec칤ficos y ayudarte a programar tu cita, necesito que me confirmes algunos datos clave.\n\n### Despu칠s de la frase de disponibilidad, muestra en forma de mini lista amigable estructurada los datos requeridos para agendar:\n\n> 游닇 Por favor ind칤came la siguiente informaci칩n:\n>  Nombre del proveedor (En lo posible nombre completo y legible)\n>  Fecha deseada para la entrega (ej. 16 de abril)\n>  Hora de entrega (ej. 9:00 AM, 10:00 AM)\n>  Categor칤a del producto (puedes elegir entre las siguientes disponibles: {{ $json.datoscategorias.map(cat => cat.CATEGORIA).join(', ') }})\n>  Peso estimado en kilos\n>  N칰mero de unidades (en n칰mero entero)\n>  N칰mero de orden de compra\n\n### Cierra el mensaje con una frase amable que motive a continuar:\n\n> Con esta informaci칩n, el sistema podr치 mostrarte las franjas disponibles y ayudarte a agendar tu cita r치pidamente. Estoy aqu칤 para ayudarte en todo el proceso. 游눩\n---\n### 游늷 FORMATO DE RESPUESTA UX WHATSAPP\n\n**EJEMPLO CON FORMATO UX MEJORADO:**\n```\n游녦 *춰Hola!* Gracias por contactarnos 游땕\n\n九 *Disponibilidad confirmada* para esta semana y la pr칩xima.\n\nPara mostrarte *horarios espec칤ficos* y proceder con tu cita, necesito algunos datos:\n\n游닇 *Informaci칩n requerida:*\n 游녻 *Nombre del proveedor*\n 游늰 *Fecha deseada* (ej. 16 de abril)\n 낋 *Hora preferida* (ej. 9:00 AM)\n 游닍 *Categor칤a del producto*\n 丘뒲잺 *Peso estimado* (en kilos)\n 游늵 *N칰mero de unidades*\n 游낑勇 *Orden de compra*\n\n游 Con estos datos te mostrar칠 las *franjas disponibles* al instante.\n\n游눫 쯊ienes esta informaci칩n lista?\n```\n\n**Respuesta JSON:**\n```json\n{\n  \"mensajeSistema\": \"Mensaje aplicando OBLIGATORIAMENTE formato WhatsApp UX con *negritas*, emojis estrat칠gicos, estructura visual clara y tono profesional cordial seg칰n las reglas de disponibilidad.\"\n}\n```"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        3696,
        9488
      ],
      "id": "e53888e3-6733-4473-88d8-53a9c9b39e6c",
      "name": "Basic LLM CONSULTAR MALLA"
    },
    {
      "parameters": {
        "url": "https://graph.microsoft.com/v1.0/drives/b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8/items/01PPLUUYTWY3753ZJ6ERAZ6LQBYUR2JOTY/content",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "MallaFija"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -144,
        9488
      ],
      "id": "f6edde78-a12a-4dcf-868d-ad27a3c4d660",
      "name": "HTTP Request Malla Fija1",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      }
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "MallaFija",
        "options": {
          "sheetName": "Categorias"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        3136,
        9488
      ],
      "id": "637e092a-f80e-491a-a275-ee88edcbcbc6",
      "name": "Extract from Categorias1"
    },
    {
      "parameters": {
        "jsCode": "// Obtener todos los items de la entrada\nconst items = $input.all();\nconst categorias = [];\n\n// Mapa para verificar categor칤as duplicadas\nconst categoriasMap = new Map();\n\n// Recorrer cada 칤tem de la entrada de categor칤as\nfor (const item of items) {\n  // Obtener los datos originales\n  const originalData = item.json;\n  \n  // Extraer categor칤a y muelle\n  const categoria = originalData.CATEGORIA || \"\";\n  const muelle = originalData.MUELLE || \"\";\n  \n  // Solo procesar si tanto la categor칤a como el muelle tienen valor\n  if (categoria && muelle) {\n    // Verificar si esta categor칤a ya existe en nuestro mapa\n    if (categoriasMap.has(categoria)) {\n      console.log(`Advertencia: La categor칤a \"${categoria}\" est치 duplicada. Se ignorar치 la segunda aparici칩n.`);\n      continue; // Saltar este elemento\n    }\n    \n    // Agregar al mapa para control de duplicados\n    categoriasMap.set(categoria, muelle);\n    \n    // Agregar el objeto al array de categor칤as\n    categorias.push({\n      \"CATEGORIA\": categoria,\n      \"MUELLE\": muelle\n    });\n  } else {\n    console.log(`Advertencia: Elemento ignorado por falta de categor칤a o muelle: ${JSON.stringify(originalData)}`);\n  }\n}\n\n// Retornar un 칰nico objeto que contiene el array de categor칤as\n// dentro de un par치metro global llamado \"datoscategorias\"\nreturn [\n  {\n    json: {\n      datoscategorias: categorias\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3376,
        9488
      ],
      "id": "9ca91efb-e834-49fd-9ad8-0f3ef3862b3f",
      "name": "Estructuraci칩n, Consulta, Datos Categorias1"
    },
    {
      "parameters": {
        "jsCode": "// Obtener la respuesta generada por el LLM\nconst entrada = $input.item.json;\n\ntry {\n  // Extraer el bloque de texto generado\n  const texto = entrada.text;\n\n  // Buscar el contenido entre los delimitadores de bloque ```json\n  const match = texto.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n\n  if (match && match[1]) {\n    const jsonParsed = JSON.parse(match[1]);\n\n    return [\n      {\n        json: {\n          mensaje: jsonParsed.mensajeSistema || \"No se pudo obtener el mensaje.\"\n        }\n      }\n    ];\n  } else {\n    throw new Error(\"No se encontr칩 contenido JSON en el texto.\");\n  }\n} catch (error) {\n  return [\n    {\n      json: {\n        mensaje: \"Ocurri칩 un error al procesar la respuesta del asistente: \" + error.message\n      }\n    }\n  ];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4432,
        9488
      ],
      "id": "5ffdf3ac-e54d-482d-ae20-e6002ac549d3",
      "name": "Consistencia de datos, intenci칩n consultar malla"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b2110549-dd58-46b3-9707-dbbe0a5004f2",
              "leftValue": "={{ $('Consistencia de datos, intenci칩n consultar malla').item.json.mensaje.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4656,
        9488
      ],
      "id": "0e9e279b-d6a7-4c29-aef7-f08fe1e4c847",
      "name": "Validaci칩n de longitud de caracteres1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        5200,
        9408
      ],
      "id": "741673cf-4c4c-416c-a374-39a5b1e543ff",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Consistencia de datos, intenci칩n consultar malla').item.json.mensaje }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5008,
        9408
      ],
      "id": "81815f71-fc2f-4a19-9f77-b6c285df532b",
      "name": "HTTP Request Enviar Mensaje por WhatsApp4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Consistencia de datos, intenci칩n consultar malla').item.json.mensaje }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Consistencia de datos, intenci칩n consultar malla').item.json.mensaje.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5008,
        9600
      ],
      "id": "6f6f17a0-89be-43af-aaef-7074bb73c158",
      "name": "Organiza variables del mensaje1"
    },
    {
      "parameters": {
        "jsCode": "// Estructura el mensaje generado por el modelo LLM (SALUDO)\n// Este nodo espera que el campo `text` contenga un JSON v치lido con una clave `mensajeSistema`,\n// incluso si viene envuelto entre comillas invertidas y etiquetas de bloque tipo ```json ... ```\n\nconst items = $('Basic LLM CONVERSACI칍N (SALUDO)').all();\nconst output = [];\n\nfor (const item of items) {\n  try {\n    let raw = item.json.text.trim();\n\n    // Elimina etiquetas de bloque Markdown ```json y ```\n    raw = raw.replace(/```json\\s*|```/g, '');\n\n    // Intenta parsear el contenido limpio como JSON\n    const respuesta = JSON.parse(raw);\n\n    output.push({\n      json: {\n        mensajeParaEnviar: respuesta.mensajeSistema || \"춰Hola! Soy tu asistente para gesti칩n de citas en la bodega. 쮼n qu칠 puedo ayudarte?\",\n        tipo: \"saludo\",\n        accion: \"conversacion\",\n        origen: \"intencionSaludo\"\n      }\n    });\n\n  } catch (error) {\n    output.push({\n      json: {\n        error: true,\n        mensaje: \"Error al interpretar la respuesta del modelo LLM\",\n        detalle: error.message,\n        contenidoOriginal: item.json.text\n      }\n    });\n  }\n}\n\nreturn output;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1936,
        160
      ],
      "id": "332f5bc2-bac4-4115-bc81-336e0a15336e",
      "name": "Estructuraci칩n, Consulta, Datos Categorias2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b2110549-dd58-46b3-9707-dbbe0a5004f2",
              "leftValue": "={{ $('Estructuraci칩n, Consulta, Datos Categorias2').item.json.mensajeParaEnviar.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2208,
        160
      ],
      "id": "cbca5f6f-9b03-43b2-80ed-2cd682a9268a",
      "name": "Validaci칩n de longitud de caracteres2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2768,
        16
      ],
      "id": "b36b0ffb-81e7-4ba4-a5df-c544e8463ea1",
      "name": "No Operation, do nothing4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Estructuraci칩n, Consulta, Datos Categorias2').item.json.mensajeParaEnviar }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2576,
        16
      ],
      "id": "7e64a27e-6996-4815-acc3-02e41fb6d7eb",
      "name": "HTTP Request Enviar Mensaje por WhatsApp5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Estructuraci칩n, Consulta, Datos Categorias2').item.json.mensajeParaEnviar }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Estructuraci칩n, Consulta, Datos Categorias2').item.json.mensajeParaEnviar.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7040,
        144
      ],
      "id": "52cda6eb-cc94-4be2-9d55-5b8ce0cecdc0",
      "name": "Organiza variables del mensaje2"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5408,
        1216
      ],
      "id": "5853cd16-d865-457e-aee6-0e7133e9f7ed",
      "name": "OpenAI Chat Model7",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# SISTEMA\n\nEres un asistente experto en log칤stica de bodegas, especializado en verificar disponibilidad de franjas horarias para citas de descarga de mercanc칤a. Tu funci칩n es:\n\n1. **Utilizar los datos estructurados** proporcionados por el nodo anterior.\n2. **Validar y corregir posibles inconsistencias** en los datos recibidos.\n3. **Analizar la informaci칩n del proveedor y sus caracter칤sticas** (rotaci칩n, unidades por hora, etc.).\n4. **Verificar las franjas disponibles** y alternativas presentadas.\n5. **Generar un mensaje claro, amable y conversacional** informando el resultado de la verificaci칩n.\n6. **Presentar la respuesta en una estructura JSON espec칤fica** que ser치 procesada por el siguiente nodo.\n\n---\n\n## 游늷 DATOS DE ENTRADA (YA PROCESADOS):\n\n```json\n{{JSON.stringify($node[\"Code MOSTRAR_FRANJAS\"].json.output, null, 2)}}\n```\n\n## 游뎹 FECHA Y HORA ACTUAL (BOGOT츼, COLOMBIA):\n\n```\n{{new Date().toLocaleString(\"es-CO\", { timeZone: \"America/Bogota\", hour12: true })}}\n```\n\n## CANTIDAD DE FRAJAS DE LA MALLA DE LA SEMANA ACTUAL:\n\n```\n{{ $('Unificaci칩n y consistencia de datos1').item.json.datosMalla.franjas.length }}\n```\n\n## CANTIDAD DE FRAJAS DE LA MALLA DE LA PROXIMA SEMANA:\n\n```\n{{ $('Unificaci칩n y consistencia de datos1').item.json.datosMallaProxSemana.franjas.length }}\n```\n\n---\n\n## 游빑 VALIDACI칍N Y CORRECCI칍N DE DATOS DE ENTRADA:\n\n**Validaciones Generales:**\n\n- **Validar disponibilidadConfirmada:** Debe ser un booleano (true/false). Si es nulo o no est치 definido, asume false.\n- **Validar fecha:** Debe tener formato \"DD de mes de YYYY\". Si hay un formato diferente, mantenlo tal cual, pero aseg칰rate de generar un mensaje coherente.\n- **Validar horas:** Deben tener formato \"H:MM AM/PM\". Si hay formatos diferentes o inconsistentes entre horaInicio y horaFin, mantenlos tal cual pero genera un mensaje coherente.\n- **Validar duracionHoras:** Debe ser un n칰mero entero positivo. Si es decimal, redondea hacia arriba. Si falta, calcula aproximadamente bas치ndote en horaInicio y horaFin.\n- **Validar muelle:** Debe ser \"MUELLE X\" donde X es un n칰mero. Si tiene otro formato, mantenlo tal cual.\n- **Validar alternativasDisponibles:** Debe ser un array. Si es nulo, convi칠rtelo en array vac칤o [].\n- **Validar restriccionHoraSuperada:** Debe ser un booleano. Si es nulo, asume false.\n\nSi detectas errores graves en los datos de entrada (datos completamente faltantes o corruptos), genera un mensaje informando del problema y solicitando intentar nuevamente.\n\nSi se incluyen datos del proveedor, util칤zalos para personalizar el mensaje mencionando el nombre del proveedor y sus caracter칤sticas relevantes.\n\n---\n\n## 游딖勇 REGLAS PARA LA REDACCI칍N DEL MENSAJE:\n\n**IMPORTANTE:** Siempre comunica claramente que la cita NO est치 confirmada a칰n, sino que hay disponibilidad para agendarla pero requiere confirmaci칩n del usuario para que se genere oficialmente en el cronograma.\n\n### Para citas disponibles (disponibilidadConfirmada = true) - FORMATO UX WHATSAPP OBLIGATORIO:\n\n**APLICAR FORMATO VISUAL:**\n- 九 Inicia con emoji y expresi칩n positiva: \"九 *춰Excelente! Hay espacio disponible*\"\n- Usa *negritas* para informaci칩n cr칤tica: fechas, horarios, tiempo l칤mite\n- Estructura la informaci칩n con emojis y formato jer치rquico\n- 游늰 **Fecha:** formato destacado con emoji\n- 낋 **Horario:** formato destacado (ej: *9:00 AM - 10:00 AM*)\n- 游뛀 **Muelle:** destacado apropiadamente\n- 낌勇 **Tiempo estimado:** si hay duraci칩n, mostrar tiempo de descargue\n- 游댒 Especifica que se *requiere confirmaci칩n* para generar oficialmente\n- 丘멆잺 **CR칈TICO:** Destaca la *urgencia de 5 minutos* con formato visual llamativo\n- 游녤 Solicitud clara de acci칩n: \"*쮺onfirmas esta cita?*\"\n\n**ESTRUCTURA VISUAL OBLIGATORIA:**\n\"九 *춰Excelente! Hay espacio disponible*\n\n游늰 *Fecha:* [fecha]\n낋 *Horario:* [hora inicio] - [hora fin]\n游뛀 *Muelle:* [muelle]\n낌勇 *Tiempo estimado:* [duraci칩n] de descargue\n\n游댒 Para que tu cita se *genere oficialmente* en el cronograma, necesito tu confirmaci칩n.\n\n丘멆잺 *IMPORTANTE:* Tienes *5 minutos* para confirmar o no podremos garantizar este espacio.\n\n游녤 *쮺onfirmas esta cita?*\"\n\n### Para citas con restricci칩n de hora (restriccionHoraSuperada = true):\n\n- Explica amablemente la restricci칩n (no agendar para el d칤a siguiente despu칠s de 4:30 PM)\n- Presenta todas las alternativas organizadas por d칤a\n- **MODIFICADO:** Muestra cada alternativa en una l칤nea separada, con emojis num칠ricos (1勇, 2勇, 3勇, etc.) para cada opci칩n\n- Especifica horas y muelle para cada alternativa\n- Agrega un salto de l칤nea doble despu칠s de listar todas las alternativas\n- Precede la solicitud de confirmaci칩n con el emoji 九勇끂n- Aclara que se necesita confirmaci칩n para apartar el espacio en el cronograma\n- Recuerda el l칤mite de 5 minutos para confirmar\n\n### Para citas con restricci칩n de hora (restriccionHoraSuperada = true):\n\n- Explica amablemente la restricci칩n (no agendar para el d칤a siguiente despu칠s de 4:30 PM)\n- Presenta todas las alternativas organizadas por d칤a\n- **MODIFICADO:** Muestra cada alternativa en una l칤nea separada, con emojis num칠ricos (1勇, 2勇, 3勇, etc.) para cada opci칩n\n- Especifica horas y muelle para cada alternativa\n- Agrega un salto de l칤nea doble despu칠s de listar todas las alternativas\n- Precede la solicitud de confirmaci칩n con el emoji 九勇끂n- Aclara que se necesita confirmaci칩n para apartar el espacio en el cronograma\n- Recuerda el l칤mite de 5 minutos para confirmar\n\n### Para citas no disponibles (disponibilidadConfirmada = false, restriccionHoraSuperada = false):\n\n**VERIFICA PRIMERO si es descarga sobredimensionada:**\n- Revisa el campo `descargaSobredimensionada` del objeto de entrada\n- Si `descargaSobredimensionada = true`, aplica el mensaje de \"descarga sobredimensionada\" (ver abajo) y NO muestres alternativas\n- Si `descargaSobredimensionada = false`, procede normalmente con las alternativas\n\n**Para descarga sobredimensionada (cuando descargaSobredimensionada = true):**\n- Informa que la franja solicitada no est치 disponible\n- Explica: **\"ya que la cantidad de mercanc칤a que se intenta descargar excede un d칤a entero de descargue\"**\n- **NO ofrezcas alternativas**\n- Recomienda contactar directamente con el 치rea de log칤stica\n- `disponibilidadConfirmada = false` y `alternativasDisponibles = []`\n\n**Para proceso normal (cuando descargaSobredimensionada = false):**\n- Lamenta que la franja solicitada no est칠 disponible\n- Presenta las alternativas despu칠s de un salto de l칤nea doble\n- **MODIFICADO:** Muestra cada alternativa en una l칤nea separada, con emojis num칠ricos (1勇, 2勇, 3勇, etc.) para cada opci칩n\n- **MODIFICADO:** El formato exacto para cada alternativa debe ser: \"[emoji num칠rico] [fecha], de [horaInicio] a [horaFin] en el [muelle]\"\n- Agrega un salto de l칤nea doble despu칠s de listar todas las alternativas\n- Precede la solicitud de confirmaci칩n con el emoji 九勇끂n- Aclara que se necesita confirmaci칩n para apartar el espacio en el cronograma\n- Recuerda el l칤mite de 5 minutos para confirmar\n\n\n\n### Para citas sin alternativas disponibles:\n\n- Si no hay alternativas, informa claramente la situaci칩n\n- Recomienda contactar directamente con el 치rea de log칤stica\n- Sugiere intentar en otro momento\n- Puedes apoyarte en tu respuesta a partir de la respuesta de la recolecci칩n de datos \"{{ $('Code RECOLECCI칍N').item.json.mensajeSistema }}\"\n\n### Personalizaci칩n del mensaje:\n\n- Si tienes datos del proveedor, menciona su nombre\n- Si tienes informaci칩n sobre las unidades a entregar, incl칰yela para explicar el tiempo asignado\n- Si conoces la categor칤a del producto, util칤zala para contextualizar\n\n### Tono y estilo:\n\n- Usa un tono conversacional, humano y cercano\n- Incluye frases como \"viendo el cronograma me registra que...\", \"por la cantidad de unidades y peso en promedio va a tardar...\"\n- Evita frases formales o r칤gidas como \"Se ha encontrado una franja disponible\"\n- Estructura el mensaje para que fluya naturalmente como una conversaci칩n\n\n### MODIFICADO - EJEMPLO DE FORMATO PARA ALTERNATIVAS (cuando disponibilidadConfirmada = false):\n\n\"Lamentablemente, la franja solicitada para el 06 de mayo de 2025, de 08:00 AM a 10:00 AM en el MUELLE 1 no est치 disponible. Sin embargo, tengo algunas alternativas para ti:\n\n1勇 06 de mayo de 2025, de 6:00 AM a 8:00 AM en el MUELLE 1\n2勇 06 de mayo de 2025, de 10:00 AM a 12:00 PM en el MUELLE 1\n3勇 06 de mayo de 2025, de 11:00 AM a 1:00 PM en el MUELLE 1\n4勇 06 de mayo de 2025, de 12:00 PM a 2:00 PM en el MUELLE 1\n\n九勇 Necesito tu confirmaci칩n para apartar el espacio en el cronograma, y recuerda que el sistema nos da 5 minutos para confirmar la cita o de lo contrario no se puede garantizar el cupo solicitado.\"\n\n---\n\n## 游 ESTRUCTURA DE SALIDA REQUERIDA\n\nDebes devolver una estructura JSON con exactamente estos campos:\n\n```json\n{\n  \"disponibilidadConfirmada\": boolean,\n  \"fecha\": string,\n  \"horaInicio\": string,\n  \"horaFin\": string,\n  \"muelle\": string,\n  \"duracionHoras\": number,\n  \"restriccionHoraSuperada\": boolean,\n  \"descargaSobredimensionada\": boolean,\n  \"alternativasDisponibles\": array,\n  \"mensajeSistema\": string\n}\n```\n\n---\n\n## 九 VALIDACIONES FINALES ANTES DE ENVIAR LA RESPUESTA:\n\n- Verifica que todos los campos obligatorios est칠n presentes en tu respuesta.\n- Aseg칰rate de que los tipos de datos sean correctos (boolean para booleanos, string para texto, number para n칰meros, array para arreglos).\n- Comprueba que la estructura JSON sea v치lida y est칠 correctamente formateada.\n- Verifica que el campo `mensajeSistema` sea coherente con los dem치s campos (ej: si disponibilidadConfirmada=true, el mensaje debe indicar que hay espacio disponible pero requiere confirmaci칩n, NO que la cita ya est치 programada).\n- Aseg칰rate de que `alternativasDisponibles` sea un array, incluso si est치 vac칤o.\n- **MODIFICADO:** Verifica que cuando existen alternativas, cada una aparezca en su propia l칤nea con el emoji num칠rico correspondiente.\n- **MODIFICADO:** Verifica que la solicitud de confirmaci칩n aparezca despu칠s de un salto de l칤nea doble y precedida por el emoji 九勇.\n- Si utilizas caracteres especiales o saltos de l칤nea en `mensajeSistema`, verifica que est칠n correctamente escapados en el JSON.\n- Revisa que el mensaje comunique claramente que la cita NO est치 confirmada a칰n.\n\n---\n\n## IMPORTANTE:\n\n- **NO uses bloques de c칩digo markdown** como ```json.\n- **NO agregues ning칰n texto** antes ni despu칠s.\n- **SOLO responde con un objeto JSON plano.**\n- El contenido debe empezar directamente con `{` y terminar con `}`.\n- El JSON debe cumplir con el siguiente formato y campos obligatorios:\n\n```json\n{\n  \"disponibilidadConfirmada\": boolean,\n  \"fecha\": string,\n  \"horaInicio\": string,\n  \"horaFin\": string,\n  \"muelle\": string,\n  \"duracionHoras\": number,\n  \"restriccionHoraSuperada\": boolean,\n  \"descargaSobredimensionada\": boolean,\n  \"alternativasDisponibles\": array,\n  \"mensajeSistema\": string\n}\n```\n\n---\n\n## EJEMPLO DE MENSAJE IDEAL PARA DISPONIBILIDAD CONFIRMADA (FORMATO UX WHATSAPP):\n\n\"九 *춰Excelente! Hay espacio disponible*\n\n游늰 *Fecha:* 15 de abril de 2025\n낋 *Horario:* 9:00 AM - 12:00 PM\n游뛀 *Muelle:* MUELLE 1\n낌勇 *Tiempo estimado:* 3 horas de descargue\n\n游댒 Para que tu cita se *genere oficialmente* en el cronograma, necesito tu confirmaci칩n.\n\n丘멆잺 *IMPORTANTE:* Tienes *5 minutos* para confirmar o no podremos garantizar este espacio.\n\n游녤 *쮺onfirmas esta cita?*\""
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        5488,
        1024
      ],
      "id": "6222abfc-5f3d-4bfd-96eb-e7d56c4f7185",
      "name": "Basic LLM Chain MOSTRAR_FRANJAS"
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=### SISTEMA\nEres un asistente especializado en extraer datos de citas de entrega de mercanc칤a a partir del historial de conversaciones entre un proveedor y un sistema de agendamiento. Tu funci칩n es:\n1. **Analizar el historial completo de mensajes** entre el proveedor y el sistema.\n2. **Identificar y extraer los datos finales validados** para la cita de entrega.\n3. **Estructurar estos datos** en un formato JSON claro y consistente para su procesamiento posterior.\n---\n### 游듹勇 HISTORIAL DE MENSAJES:\n{{ $node[\"Unificaci칩n y consistencia de datos\"].json[\"infoMensaje\"][\"historialMensajes\"] }}\n\n### 游닐 MENSAJE DE CONFIRMACI칍N DEL SISTEMA:\n{{ $json.mensajeSistema }}\n\n### 游뎹 FECHA Y HORA ACTUAL (BOGOT츼, COLOMBIA):\n{{ new Date().toLocaleString(\"es-CO\", { timeZone: \"America/Bogota\", hour12: true }) }}\n---\n### 九 DATOS A EXTRAER:\n\n**REGLA CR칈TICA PARA NOMBRES DE PROVEEDORES:**\n- Al mencionar el nombre del proveedor en el mensajeSistema, NUNCA agregues puntos, comas o signos de puntuaci칩n adicionales al final del nombre\n- El nombre del proveedor debe aparecer exactamente como est치 en la base de datos, sin modificaciones de puntuaci칩n\n- Ejemplo correcto: \"SPB COLOMBIA S.A.S\" (sin punto adicional)\n- Ejemplo incorrecto: \"SPB COLOMBIA S.A.S.\" (con punto adicional)\n\n- **Nombre del proveedor**: El nombre validado y confirmado (debe ser el nombre exacto que aparece en los registros).\n- **Fecha de la cita**: La fecha validada para la entrega (en formato \"DD de [mes] de YYYY\").\n- **Hora de la cita**: La hora validada para la entrega (en formato est치ndar, ej. \"10:00 AM\").\n- **Categor칤a del producto**: La categor칤a validada y confirmada.\n- **Peso estimado**: El peso en kilos.\n- **N칰mero de unidades**: La cantidad de unidades a entregar.\n- **N칰mero de orden de compra**: El n칰mero de referencia para la orden.\n\n### 游댌 JERARQU칈A DE FUENTES DE DATOS:\n1. **PRIORIDAD ALTA**: Usa siempre el mensaje de confirmaci칩n del sistema (mensajeSistema) como fuente principal, ya que contiene los datos completamente validados, normalizados y oficiales.\n2. **PRIORIDAD MEDIA**: Si alg칰n dato espec칤fico no est치 en el mensaje de confirmaci칩n del sistema, b칰scalo en los 칰ltimos mensajes del historial de conversaci칩n.\n3. **PRIORIDAD BAJA**: Solo como 칰ltimo recurso, usa los datos iniciales proporcionados por el usuario.\n\n### 游댃 ALGORITMO DE EXTRACCI칍N:\n1. **Primero, analiza el mensaje de confirmaci칩n del sistema** (mensajeSistema) ya que contiene los datos m치s precisos y validados.\n2. **Extrae de all칤 todos los datos disponibles**, prestando especial atenci칩n a:\n   - El nombre completo y oficial del proveedor (no abreviaturas)\n   - La categor칤a normalizada del producto\n   - Datos num칠ricos validados como peso y unidades\n3. **Solo si alg칰n dato no est치 disponible en el mensaje de confirmaci칩n**, revisa el historial completo de mensajes para encontrarlo.\n4. **Estructura todos los datos obtenidos** en el formato JSON requerido.\n\n### 游늷 RESPUESTA (EN FORMATO JSON V츼LIDO):\n```json\n{\n  \"proveedor\": \"Nombre exacto del proveedor validado\",\n  \"fecha\": \"DD de [mes] de YYYY\",\n  \"hora\": \"HH:MM AM/PM\",\n  \"categoria\": \"Categor칤a validada\",\n  \"peso\": 000,\n  \"unidades\": 000,\n  \"ordenCompra\": \"C칩digo de la orden de compra\"\n}\n```\n\n**REGLAS IMPORTANTES**:\n1. **SIEMPRE prioriza los datos del mensaje de confirmaci칩n del sistema** sobre los datos proporcionados inicialmente por el usuario.\n2. **Para el nombre del proveedor y la categor칤a**, usa SIEMPRE la versi칩n completa y normalizada que aparece en el mensaje de confirmaci칩n del sistema, ya que este contiene los nombres oficiales como est치n registrados en la base de datos.\n3. **Convierte todas las expresiones temporales** a fechas espec칤ficas (ej. \"ma침ana\"  \"15 de abril de 2025\").\n4. **Convierte valores num칠ricos** (peso, unidades) a formato num칠rico sin unidades (ej. \"300 kilos\"  300).\n5. **Estandariza el formato de hora** (ej. \"10 de la ma침ana\"  \"10:00 AM\").\n\n**EJEMPLO DE EXTRACCI칍N CORRECTO**:\n**Mensaje del usuario**:\n```\n\"Hola, deseo agendar una cita de entrega para ma침ana, el nombre del proveedor es spb, categor칤a arenas, con un peso de 300 kilos, a las 9 de la ma침ana, 900 unidades, el n칰mero de orden de compra es ARGM47896.\"\n```\n\n**Mensaje de confirmaci칩n del sistema**:\n```\n\"He registrado tu cita para SPB COLOMBIA S.A.S el d칤a 14 de abril a las 09:00 AM, categor칤a ARENAS, con un peso de 300 kilos y 900 unidades. Tu n칰mero de orden de compra ARGM47896 ha sido registrado. Tu cita ha sido confirmada exitosamente.\"\n```\n\n**Respuesta esperada**:\n```json\n{\n  \"proveedor\": \"SPB COLOMBIA S.A.S\",\n  \"fecha\": \"14 de abril de 2025\",\n  \"hora\": \"09:00 AM\",\n  \"categoria\": \"ARENAS\",\n  \"peso\": 300,\n  \"unidades\": 900,\n  \"ordenCompra\": \"ARGM47896\"\n}\n```\n\nIMPORTANTE: Tu tarea es SOLO extraer y estructurar los datos validados. No agregues explicaciones fuera del JSON requerido. Estos datos ser치n utilizados por otro nodo para verificar disponibilidad en las mallas de recibo.",
        "hasOutputParser": true
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        4368,
        1024
      ],
      "id": "ab0abfb2-072a-4cb0-b6fb-8d8df57d0f7b",
      "name": "Basic LLM Chain EXTRACCI칍N_DATOS_CITA"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        4352,
        1216
      ],
      "id": "25ced219-c0e8-4633-803e-c61732a0f50e",
      "name": "OpenAI Chat Model8",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"proveedor\": \"string\",\n  \"fecha\": \"string\",\n  \"hora\": \"string\",\n  \"categoria\": \"string\",\n  \"peso\": 0,\n  \"unidades\": 0,\n  \"ordenCompra\": \"string\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        4576,
        1280
      ],
      "id": "0f1f3477-3cca-495d-a40a-c7684f877259",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO MensajesWhatsApp (message_id, contenido, fecha, chat_id, instance)\nVALUES (\n  '{{ $('Parametrizaci칩n').first().json.message.id }}',\n  '{{ JSON.stringify($node[\"Basic LLM Chain EXTRACCI칍N_DATOS_CITA\"].json.output, null, 2).replace(/'/g, \"''\") }}',\n  FORMAT(SWITCHOFFSET(GETDATE(), '-05:00'), 'yyyy-MM-dd HH:mm:ss'),\n  'agenteAI',\n  '{{ $('Parametrizaci칩n').first().json.message.chat.instance }}'\n); "
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        4848,
        1024
      ],
      "id": "bcca4d86-4670-47c3-805c-659b8f4ca0f0",
      "name": "Microsoft SQL Guardar EXTRACCI칍N_DATOS_CITA",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extraer directamente el texto JSON desde el nodo LLM\nlet textoPlano = $node[\"Basic LLM Chain MOSTRAR_FRANJAS\"].json.text;\n\nlet llmResponse;\ntry {\n  llmResponse = JSON.parse(textoPlano.trim());\n} catch (error) {\n  throw new Error(\"仇 No se pudo parsear el JSON generado por el modelo. Revisa el formato.\\nTexto recibido:\\n\" + textoPlano);\n}\n\n// Convertir formato de fecha a ISO (YYYY-MM-DD)\nlet fechaFormateada = llmResponse.fecha;\nif (fechaFormateada && fechaFormateada.includes(\"de\")) {\n  const meses = {\n    \"enero\": \"01\", \"febrero\": \"02\", \"marzo\": \"03\", \"abril\": \"04\",\n    \"mayo\": \"05\", \"junio\": \"06\", \"julio\": \"07\", \"agosto\": \"08\",\n    \"septiembre\": \"09\", \"octubre\": \"10\", \"noviembre\": \"11\", \"diciembre\": \"12\"\n  };\n\n  const partes = fechaFormateada.split(\" de \");\n  if (partes.length === 3) {\n    const dia = partes[0].padStart(2, \"0\");\n    const mes = meses[partes[1].toLowerCase()];\n    const a침o = partes[2];\n    fechaFormateada = `${a침o}-${mes}-${dia}`;\n  }\n}\n\n// Preparar objeto estandarizado\nlet standardResponse = {\n  disponibilidadConfirmada: llmResponse.disponibilidadConfirmada,\n  fecha: llmResponse.fecha,\n  fechaFormateada: fechaFormateada,\n  horaInicio: llmResponse.horaInicio,\n  horaFin: llmResponse.horaFin,\n  muelle: llmResponse.muelle,\n  duracionHoras: llmResponse.duracionHoras,\n  alternativasDisponibles: Array.isArray(llmResponse.alternativasDisponibles) \n    ? llmResponse.alternativasDisponibles \n    : [],\n  mensajeSistema: llmResponse.mensajeSistema,\n  datosCita: {\n    proveedor: $node[\"Basic LLM Chain EXTRACCI칍N_DATOS_CITA\"].json.output.proveedor,\n    categoria: $node[\"Basic LLM Chain EXTRACCI칍N_DATOS_CITA\"].json.output.categoria,\n    peso: $node[\"Basic LLM Chain EXTRACCI칍N_DATOS_CITA\"].json.output.peso,\n    unidades: $node[\"Basic LLM Chain EXTRACCI칍N_DATOS_CITA\"].json.output.unidades,\n    ordenCompra: $node[\"Basic LLM Chain EXTRACCI칍N_DATOS_CITA\"].json.output.ordenCompra\n  },\n  timestamp: new Date().toISOString()\n};\n\n// Normalizar hora (por si empieza con cero innecesario)\nstandardResponse.horaInicio = standardResponse.horaInicio.replace(/^0(\\d:00 [AP]M)$/, \"$1\");\n\nreturn { standardResponse };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5936,
        1024
      ],
      "id": "96a0c488-d389-4b05-8f2a-5009f67e3e41",
      "name": "Code estandarizar respuestas MOSTRAR_FRANJAS"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO FranjasDisponiblesTemp \n(chat_id, franjas_json, timestamp_enviado, datos_cita_json, fecha_cita, hora_inicio, hora_fin) \nVALUES \n(\n    '{{$node[\"Organiza el Mensaje\"].json[\"infoMensaje\"][\"chat_id\"]}}', \n    '{{JSON.stringify($node[\"Code estandarizar respuestas MOSTRAR_FRANJAS\"].json.standardResponse).replace(/'/g, \"''\")}}', \n    GETDATE(), \n    '{{JSON.stringify($node[\"Code estandarizar respuestas MOSTRAR_FRANJAS\"].json.standardResponse.datosCita)}}', \n    CONVERT(DATETIME, '{{$node[\"Code estandarizar respuestas MOSTRAR_FRANJAS\"].json.standardResponse.fechaFormateada}}'), \n    FORMAT(CAST('{{$node[\"Code estandarizar respuestas MOSTRAR_FRANJAS\"].json.standardResponse.horaInicio}}' AS DATETIME), 'HH:mm'), \n    FORMAT(CAST('{{$node[\"Code estandarizar respuestas MOSTRAR_FRANJAS\"].json.standardResponse.horaFin}}' AS DATETIME), 'HH:mm')\n);"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        6208,
        1024
      ],
      "id": "43d89150-05ce-4436-b9a9-bc1a289281e1",
      "name": "Microsoft SQL Guardar MOSTRAR_FRANJAS",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-disponibilidad-confirmada",
              "leftValue": "={{ $('Code estandarizar respuestas MOSTRAR_FRANJAS').item.json.standardResponse.disponibilidadConfirmada }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6432,
        1024
      ],
      "id": "6c939cfa-9f57-43b8-afa4-f187aaf93154",
      "name": "IF Disponibilidad Confirmada"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE EstadoConversacional \nSET estado_actual = 'ESPERANDO_CONFIRMACION_CREAR', \n    contexto_proceso = '{{ JSON.stringify({\n        descripcion: \"Esperando confirmaci칩n del usuario para crear la cita\",\n        disponibilidad_encontrada: true,\n        fecha_cita: $(\"Code estandarizar respuestas MOSTRAR_FRANJAS\").item.json.standardResponse.fecha,\n        hora_cita: $(\"Code estandarizar respuestas MOSTRAR_FRANJAS\").item.json.standardResponse.horaInicio,\n        muelle: $(\"Code estandarizar respuestas MOSTRAR_FRANJAS\").item.json.standardResponse.muelle,\n        timestamp: new Date().toISOString()\n    }) }}',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $(\"Parametrizaci칩n\").first().json.message.chat.id }}';\n\n-- Si no existe el registro, crear uno nuevo\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $(\"Parametrizaci칩n\").first().json.message.chat.id }}', \n        'ESPERANDO_CONFIRMACION_CREAR', \n        '{{ JSON.stringify({\n            descripcion: \"Esperando confirmaci칩n del usuario para crear la cita\",\n            disponibilidad_encontrada: true,\n            fecha_cita: $(\"Code estandarizar respuestas MOSTRAR_FRANJAS\").item.json.standardResponse.fecha,\n            hora_cita: $(\"Code estandarizar respuestas MOSTRAR_FRANJAS\").item.json.standardResponse.horaInicio,\n            muelle: $(\"Code estandarizar respuestas MOSTRAR_FRANJAS\").item.json.standardResponse.muelle,\n            timestamp: new Date().toISOString()\n        }) }}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\n-- Confirmar actualizaci칩n\nSELECT \n  'ESPERANDO_CONFIRMACION_CREAR' as nuevo_estado,\n  'DISPONIBILIDAD_CONFIRMADA' as tipo_actualizacion,\n  '{{ $(\"Parametrizaci칩n\").first().json.message.chat.id }}' as chat_id,\n  GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        6784,
        896
      ],
      "id": "90788385-b0bb-4952-b6d0-d4e396b97ab3",
      "name": "Estado SQL - ESPERANDO_CONFIRMACION_CREAR",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE EstadoConversacional \nSET estado_actual = 'CONFIRMANDO_CANCELACION',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $node[\"Organiza el Mensaje\"].json[\"infoMensaje\"][\"chat_id\"] }}'"
      },
      "id": "0657c7e2-4924-46c5-80e9-7d1a659cd5c6",
      "name": "Estado SQL - CONFIRMANDO_CANCELACION",
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        4576,
        6176
      ],
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE EstadoConversacional \nSET estado_actual = 'SOLICITANDO_DATOS_EDITAR',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $node[\"Organiza el Mensaje\"].json[\"infoMensaje\"][\"chat_id\"] }}'"
      },
      "id": "97530b71-2e47-4ce5-8b75-c2c19ddf1cd7",
      "name": "Estado SQL - SOLICITANDO_DATOS_EDITAR",
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        416,
        5088
      ],
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Actualizar estado a ESPERANDO_CONFIRMACION_EDITAR cuando se presentan opciones para editar\nUPDATE EstadoConversacional \nSET estado_actual = 'ESPERANDO_CONFIRMACION_EDITAR', \n    contexto_proceso = '{\"descripcion\": \"Esperando confirmaci칩n de reprogramaci칩n\", \"opciones_presentadas\": true, \"accion\": \"confirmacion_edicion\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}';\n\n-- Si no existe el registro, crear uno nuevo\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $('Parametrizaci칩n').first().json.message.chat.id }}', \n        'ESPERANDO_CONFIRMACION_EDITAR', \n        '{\"descripcion\": \"Esperando confirmaci칩n de reprogramaci칩n\", \"opciones_presentadas\": true, \"accion\": \"confirmacion_edicion\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\n-- Confirmar actualizaci칩n\nSELECT \n  'ESPERANDO_CONFIRMACION_EDITAR' as nuevo_estado,\n  'ESPERANDO_CONFIRMACION_EDICION' as tipo_actualizacion,\n  '{{ $('Parametrizaci칩n').first().json.message.chat.id }}' as chat_id,\n  GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        880,
        5088
      ],
      "id": "5d45f00c-3846-4c72-996d-74d0e53ebf2b",
      "name": "Estado SQL - ESPERANDO_CONFIRMACION_EDITAR",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Actualizar estado a EDITANDO_CITA durante el procesamiento de edici칩n\nUPDATE EstadoConversacional \nSET estado_actual = 'EDITANDO_CITA', \n    contexto_proceso = '{\"descripcion\": \"Procesando reprogramaci칩n de cita existente\", \"accion\": \"editando_cita\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}';\n\n-- Si no existe el registro, crear uno nuevo\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $('Parametrizaci칩n').first().json.message.chat.id }}', \n        'EDITANDO_CITA', \n        '{\"descripcion\": \"Procesando reprogramaci칩n de cita existente\", \"accion\": \"editando_cita\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\n-- Confirmar actualizaci칩n\nSELECT \n  'EDITANDO_CITA' as nuevo_estado,\n  'PROCESANDO_EDICION_CITA' as tipo_actualizacion,\n  '{{ $('Parametrizaci칩n').first().json.message.chat.id }}' as chat_id,\n  GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        6928,
        3936
      ],
      "id": "0c3bf36c-54bd-42bf-b4a7-abb6fef5328b",
      "name": "Estado SQL - EDITANDO_CITA",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Actualizar estado a CONFIRMANDO_FRANJA cuando usuario selecciona opci칩n de franjas\nUPDATE EstadoConversacional \nSET estado_actual = 'CONFIRMANDO_FRANJA', \n    contexto_proceso = '{\"descripcion\": \"Seleccionando franja de opciones disponibles\", \"alternativas_presentadas\": true, \"accion\": \"confirmacion_franja\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}';\n\n-- Si no existe el registro, crear uno nuevo\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $('Parametrizaci칩n').first().json.message.chat.id }}', \n        'CONFIRMANDO_FRANJA', \n        '{\"descripcion\": \"Seleccionando franja de opciones disponibles\", \"alternativas_presentadas\": true, \"accion\": \"confirmacion_franja\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\n-- Confirmar actualizaci칩n\nSELECT \n  'CONFIRMANDO_FRANJA' as nuevo_estado,\n  'SELECCIONANDO_FRANJA_ALTERNATIVA' as tipo_actualizacion,\n  '{{ $('Parametrizaci칩n').first().json.message.chat.id }}' as chat_id,\n  GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        400,
        2864
      ],
      "id": "1c335b92-9abb-462c-97c1-926ddeb1be9a",
      "name": "Estado SQL - CONFIRMANDO_FRANJA",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Actualizar estado a RESPONDIENDO_PREGUNTA cuando se maneja pregunta general\nUPDATE EstadoConversacional \nSET estado_actual = 'RESPONDIENDO_PREGUNTA', \n    contexto_proceso = '{\"descripcion\": \"Respondiendo pregunta general del usuario\", \"tipo_pregunta\": \"general\", \"accion\": \"respondiendo_pregunta\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}';\n\n-- Si no existe el registro, crear uno nuevo\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $('Parametrizaci칩n').first().json.message.chat.id }}', \n        'RESPONDIENDO_PREGUNTA', \n        '{\"descripcion\": \"Respondiendo pregunta general del usuario\", \"tipo_pregunta\": \"general\", \"accion\": \"respondiendo_pregunta\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\n-- Confirmar actualizaci칩n\nSELECT \n  'RESPONDIENDO_PREGUNTA' as nuevo_estado,\n  'PROCESANDO_PREGUNTA_GENERAL' as tipo_actualizacion,\n  '{{ $('Parametrizaci칩n').first().json.message.chat.id }}' as chat_id,\n  GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        1328,
        10080
      ],
      "id": "ce0e62aa-95bd-42d1-8444-8d4e7d0d32d4",
      "name": "Estado SQL - RESPONDIENDO_PREGUNTA",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE EstadoConversacional \nSET estado_actual = 'CONSULTANDO_DISPONIBILIDAD',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $node[\"Organiza el Mensaje\"].json[\"infoMensaje\"][\"chat_id\"] }}'"
      },
      "id": "609083f3-2552-4847-8b13-684d2f8dfda4",
      "name": "Estado SQL - CONSULTANDO_DISPONIBILIDAD",
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        4160,
        9488
      ],
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para verificar disponibilidad de franjas horarias en n8n\n//  versi칩n corregida 2025-06-17  Busca por fecha exacta en fechaDia\n\n// Funci칩n ejecutada por el nodo Code\nfunction procesarVerificacionFranjas(items, runIndex) {\n  try {\n    // 0. Entradas provenientes de los nodos anteriores\n    const datosCita            = $node[\"Basic LLM Chain EXTRACCI칍N_DATOS_CITA\"].json.output;     // datos de la cita\n    const datosMalla           = $node[\"Unificaci칩n y consistencia de datos1\"].json.datosMalla;   // malla semana actual\n    const datosMallaProxSemana = $node[\"Unificaci칩n y consistencia de datos1\"].json.datosMallaProxSemana;\n    const datoscategorias      = $node[\"Unificaci칩n y consistencia de datos1\"].json.datoscategorias;\n    const datosproveedor       = $node[\"Unificaci칩n y consistencia de datos1\"].json.datosproveedor;\n\n    // 1. Agrupamos todo en un solo objeto\n    const datosEntrada = {\n      datosCita,\n      datosMalla,\n      datosMallaProxSemana,\n      datoscategorias,\n      datosproveedor\n    };\n\n    // 2. Ejecutamos la verificaci칩n\n    const resultado = verificarDisponibilidadFranjas(datosEntrada);\n\n    // 3. Devolvemos la salida en el formato que n8n espera\n    return [{ json: resultado }];\n  } catch (error) {\n    console.error(\"Error en procesamiento principal:\", error);\n    return [{ json: { error: error.message || \"Error en el procesamiento\" } }];\n  }\n}\n\n/* 轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n *  FUNCI칍N PRINCIPAL DE VERIFICACI칍N\n * 轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷 */\nfunction verificarDisponibilidadFranjas(datosEntrada) {\n  try {\n    console.log(`游 ===== INICIANDO VERIFICACI칍N DE DISPONIBILIDAD =====`);\n    \n    /* 較較較較較較較較較較較較較較較較較較較較較較較較較較較 1. DATOS B츼SICOS 較較較較較較較較較較較較較較較較較較較較較較較較較較較 */\n    const {\n      datosCita,\n      datosMalla:        mallaActual,\n      datosMallaProxSemana: mallaProxima,\n      datoscategorias:   categorias,\n      datosproveedor:    proveedores\n    } = datosEntrada;\n\n    const fechaHoraActual = new Date();\n\n    const proveedor       = datosCita.proveedor   || \"\";\n    const fechaSolicitada = datosCita.fecha       || \"\";\n    const horaSolicitada  = datosCita.hora        || \"\";\n    const categoria       = datosCita.categoria   || \"\";\n    const unidades        = Number.parseInt(String(datosCita.unidades || \"0\"), 10);\n    \n    console.log(`游늶 DATOS EXTRA칈DOS DE LA CITA:`);\n    console.log(`  Proveedor: \"${proveedor}\"`);\n    console.log(`  Fecha solicitada: \"${fechaSolicitada}\"`);\n    console.log(`  Hora solicitada: \"${horaSolicitada}\"`);\n    console.log(`  Categor칤a: \"${categoria}\"`);\n    console.log(`  Unidades: ${unidades}`);\n\n    /* Validaciones m칤nimas */\n    if (!proveedor)       return { error: \"Proveedor no especificado\" };\n    if (!fechaSolicitada) return { error: \"Fecha no especificada\" };\n    if (!horaSolicitada)  return { error: \"Hora no especificada\" };\n    if (!categoria)       return { error: \"Categor칤a no especificada\" };\n    if (Number.isNaN(unidades) || unidades <= 0) return { error: \"Cantidad de unidades inv치lida\" };\n\n    /* 較較較較較較較較較較較較較較較較較較較較較較較較較較 2. PROVEEDOR 較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較 */\n    const datosProveedor = buscarProveedor(proveedores, proveedor);\n    if (!datosProveedor) {\n      return { error: `No se encontr칩 el proveedor \"${proveedor}\" en la base de datos` };\n    }\n\n    const unidadesPorHora = datosProveedor.unidadesPorHora;\n    if (!unidadesPorHora || unidadesPorHora <= 0) {\n      return { error: `El proveedor \"${proveedor}\" no tiene definidas unidades por hora v치lidas` };\n    }\n\n    /* 較較較較較較較較較較較較較較較較較較較較較較較較較較 3. C츼LCULOS B츼SICOS 較較較較較較較較較較較較較較較較較較較較較較較較較 */\n    const horasNecesarias = Math.ceil(unidades / unidadesPorHora);\n    const restriccionHoraSuperada = verificarRestriccionHoraCitaManana(fechaHoraActual, fechaSolicitada);\n\n    /* 較較較較較較較較較較較較較較較較較較較較較較較較較較 4. VALIDACI칍N DESCARGA SOBREDIMENSIONADA 較較較較較較較較較較較 */\n    // Determinar qu칠 malla usar para obtener el n칰mero de franjas disponibles\n    let cantidadFranjasDiarias = 0;\n    \n    // Buscar en qu칠 malla est치 la fecha solicitada para obtener el n칰mero de franjas\n    const resultadoBusquedaMalla = buscarDiaPorFechaExacta(fechaSolicitada, mallaActual, mallaProxima);\n    if (resultadoBusquedaMalla && resultadoBusquedaMalla.malla && resultadoBusquedaMalla.malla.franjas) {\n      cantidadFranjasDiarias = resultadoBusquedaMalla.malla.franjas.length;\n    } else {\n      // Fallback: usar la malla actual si no se puede determinar\n      cantidadFranjasDiarias = mallaActual.franjas ? mallaActual.franjas.length : 8;\n    }\n    \n    // Verificar si la descarga es sobredimensionada\n    const descargaSobredimensionada = horasNecesarias > cantidadFranjasDiarias;\n    console.log(`Validaci칩n descarga sobredimensionada: horasNecesarias=${horasNecesarias}, cantidadFranjasDiarias=${cantidadFranjasDiarias}, sobredimensionada=${descargaSobredimensionada}`);\n\n    /* 較較較較較較較較較較較較較較較較較較較較較較較較較較 5. HORA NORMALIZADA 較較較較較較較較較較較較較較較較較較較較較較較較 */\n    const horaNormalizada = horaSolicitada.trim();\n\n    /* 較較較較較較較較較較較較較較較較較較較較較較較較較較 5. MUELLE POR CATEGOR칈A 較較較較較較較較較較較較較較較較較較較較 */\n    const muelleAsignado = determinarMuellePorCategoria(categorias, categoria);\n    if (!muelleAsignado) {\n      return { error: `No se encontr칩 un muelle asignado para la categor칤a \"${categoria}\"` };\n    }\n\n    /* 較較較較較較較較較較較較較較較較較較較較較較較較較較 6. DISPONIBILIDAD / ALTERNATIVAS 較較較較較較較較較較較 */\n    let resultado;\n\n    if (restriccionHoraSuperada) {\n      // Caso: contactaron despu칠s de las 4:30 p.m. y la cita es para ma침ana\n      const alternativas = buscarAlternativasDesdeDosDiasDespues(\n        fechaHoraActual,\n        mallaActual,\n        mallaProxima,\n        muelleAsignado,\n        horasNecesarias\n      );\n\n      resultado = {\n        disponibilidadConfirmada: false,\n        fecha:           fechaSolicitada,\n        horaInicio:      horaNormalizada,\n        horaFin:         calcularHoraFin(horaNormalizada, horasNecesarias),\n        muelle:          muelleAsignado,\n        duracionHoras:   horasNecesarias,\n        restriccionHoraSuperada: true,\n        descargaSobredimensionada: descargaSobredimensionada,\n        alternativasDisponibles: alternativas.slice(0, 10)\n      };\n    } else {\n      const disponible = verificarDisponibilidadHoraSolicitada(\n        fechaSolicitada,\n        horaNormalizada,\n        muelleAsignado,\n        horasNecesarias,\n        mallaActual,\n        mallaProxima\n      );\n\n      if (disponible) {\n        resultado = {\n          disponibilidadConfirmada: true,\n          fecha:           fechaSolicitada,\n          horaInicio:      horaNormalizada,\n          horaFin:         calcularHoraFin(horaNormalizada, horasNecesarias),\n          muelle:          muelleAsignado,\n          duracionHoras:   horasNecesarias,\n          restriccionHoraSuperada: false,\n          descargaSobredimensionada: descargaSobredimensionada,\n          alternativasDisponibles: []\n        };\n      } else {\n        const alternativasMismoDia = buscarAlternativasMismoDia(\n          fechaSolicitada,\n          muelleAsignado,\n          horasNecesarias,\n          mallaActual,\n          mallaProxima\n        );\n\n        const todasAlternativas = alternativasMismoDia.length > 0\n          ? alternativasMismoDia\n          : buscarAlternativasDiasPeriores(\n              fechaSolicitada,\n              muelleAsignado,\n              horasNecesarias,\n              mallaActual,\n              mallaProxima\n            );\n\n        resultado = {\n          disponibilidadConfirmada: false,\n          fecha:           fechaSolicitada,\n          horaInicio:      horaNormalizada,\n          horaFin:         calcularHoraFin(horaNormalizada, horasNecesarias),\n          muelle:          muelleAsignado,\n          duracionHoras:   horasNecesarias,\n          restriccionHoraSuperada: false,\n          descargaSobredimensionada: descargaSobredimensionada,\n          alternativasDisponibles: todasAlternativas\n        };\n      }\n    }\n\n    /* 較較較較較較較較較較較較較較較較較較較較較較較較較較 7. DATOS PROVEEDOR 較較較較較較較較較較較較較較較較較較較較較較較較較 */\n    resultado.datosProveedorEncontrado = {\n      nombre:           datosProveedor.proveedor,\n      unidadesPorHora:  datosProveedor.unidadesPorHora,\n      rotacion:         datosProveedor.rotacion,\n      tipoProveedor:    datosProveedor.tipoProveedor\n    };\n\n    return { output: resultado };\n  } catch (error) {\n    console.error(\"Error en verificaci칩n de disponibilidad:\", error);\n    return { error: `Error en la verificaci칩n: ${error.message}` };\n  }\n}\n\n/* 轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n *  FUNCIONES DE APOYO\n * 轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷 */\n\n// (1) B칰squeda de proveedor\nfunction buscarProveedor(listaProveedores, nombreProveedor) {\n  if (!Array.isArray(listaProveedores) || listaProveedores.length === 0) return null;\n  if (!nombreProveedor) return null;\n\n  const nombreLower = nombreProveedor.toLowerCase();\n  const exacta  = listaProveedores.find(p => (p.proveedor || \"\").toLowerCase() === nombreLower);\n  if (exacta) return exacta;\n\n  return listaProveedores.find(p => (p.proveedor || \"\").toLowerCase().includes(nombreLower));\n}\n\n// (2) Normalizador de hora para comparaciones\nfunction limpiarHora(h) {\n  return h ? h.trim().replace(/^0+/, \"\").toUpperCase() : \"\";\n}\n\n// (3) Determinar muelle por categor칤a\nfunction determinarMuellePorCategoria(categorias, categoriaProducto) {\n  if (!Array.isArray(categorias) || categorias.length === 0) return null;\n  const catLower = categoriaProducto.toLowerCase();\n\n  const exacta = categorias.find(c => (c.CATEGORIA || \"\").toLowerCase() === catLower);\n  if (exacta) return exacta.MUELLE;\n\n  const parcial = categorias.find(c => (c.CATEGORIA || \"\").toLowerCase().includes(catLower));\n  return parcial ? parcial.MUELLE : null;\n}\n\n// (4) Calcular hora de fin\nfunction calcularHoraFin(horaInicio, horasNecesarias) {\n  if (!horaInicio) return \"\";\n  const [horaTxt, meridiano] = horaInicio.trim().split(\" \");\n  let hora = parseInt(horaTxt, 10);\n  if (meridiano === \"PM\" && hora < 12) hora += 12;\n  if (meridiano === \"AM\" && hora === 12) hora = 0;\n  hora += horasNecesarias;\n  let nuevoMeridiano = \"AM\";\n  if (hora >= 12) {\n    nuevoMeridiano = \"PM\";\n    if (hora > 12) hora -= 12;\n  }\n  if (hora === 0) { hora = 12; nuevoMeridiano = \"AM\"; }\n  return `${hora}:00 ${nuevoMeridiano}`;\n}\n\n// (5) Restricci칩n 4:30 p.m.  cita ma침ana (CORREGIDO - ZONA HORARIA)\nfunction verificarRestriccionHoraCitaManana(fechaHoraActual, fechaSolicitada) {\n  // 1. Obtener la fecha y hora actual en la zona horaria de Bogot치.\n  //    Esto es CRUCIAL para que la comparaci칩n de las 4:30 PM funcione correctamente\n  //    independientemente de la zona horaria del servidor.\n  const ahoraEnBogota = new Date(new Date().toLocaleString(\"en-US\", { timeZone: \"America/Bogota\" }));\n\n  // 2. Verificar si la hora actual en Bogot치 es despu칠s de las 4:30 PM.\n  const horaBogota = ahoraEnBogota.getHours();\n  const minutosBogota = ahoraEnBogota.getMinutes();\n  const esDespuesDe430PM = horaBogota > 16 || (horaBogota === 16 && minutosBogota >= 30);\n\n  // 3. Parsear la fecha que el usuario solicit칩.\n  const fechaSolicitadaObj = parsearFechaEspanol(fechaSolicitada);\n  if (!fechaSolicitadaObj || isNaN(fechaSolicitadaObj.getTime())) {\n    console.error(\"Fecha solicitada inv치lida:\", fechaSolicitada);\n    return false;\n  }\n\n  // 4. Calcular la fecha de \"ma침ana\" bas치ndose en la fecha actual de Bogot치.\n  const fechaManana = new Date(ahoraEnBogota);\n  fechaManana.setDate(fechaManana.getDate() + 1);\n  \n  // 5. Comparar si la fecha solicitada es efectivamente \"ma침ana\".\n  //    Se compara a침o, mes y d칤a para evitar problemas con horas.\n  const esMa침ana = fechaSolicitadaObj.getFullYear() === fechaManana.getFullYear() &&\n                   fechaSolicitadaObj.getMonth() === fechaManana.getMonth() &&\n                   fechaSolicitadaObj.getDate() === fechaManana.getDate();\n\n  // 6. La restricci칩n se aplica solo si AMBAS condiciones son verdaderas.\n  return esMa침ana && esDespuesDe430PM;\n}\n\n\n// (6) Parsear fecha \"30 de abril de 2025\"\nfunction parsearFechaEspanol(fechaTexto) {\n  const [dia, , mesTxt, , anio] = fechaTexto.split(\" \");\n  return new Date(Number(anio), obtenerNumeroMes(mesTxt), Number(dia));\n}\n\n// (7) Obtener n칰mero de mes\nfunction obtenerNumeroMes(nombreMes) {\n  const meses = [\"enero\",\"febrero\",\"marzo\",\"abril\",\"mayo\",\"junio\",\"julio\",\"agosto\",\"septiembre\",\"octubre\",\"noviembre\",\"diciembre\"];\n  return meses.indexOf(nombreMes.toLowerCase());\n}\n\n// (7.5) FUNCI칍N: Normalizar fecha flexible - Interpreta CUALQUIER formato de fecha\n// ===================== INICIO DE LA SECCI칍N CORREGIDA =====================\nfunction normalizarFechaFlexible(fechaInput) {\n  if (!fechaInput) return \"\";\n  \n  let fecha = fechaInput.toString().trim().toLowerCase();\n  \n  const mesesMap = {\n    \"enero\": \"enero\", \"ene\": \"enero\", \"1\": \"enero\",\n    \"febrero\": \"febrero\", \"feb\": \"febrero\", \"2\": \"febrero\", \n    \"marzo\": \"marzo\", \"mar\": \"marzo\", \"3\": \"marzo\",\n    \"abril\": \"abril\", \"abr\": \"abril\", \"4\": \"abril\",\n    \"mayo\": \"mayo\", \"may\": \"mayo\", \"5\": \"mayo\",\n    \"junio\": \"junio\", \"jun\": \"junio\", \"6\": \"junio\",\n    \"julio\": \"julio\", \"jul\": \"julio\", \"7\": \"julio\",\n    \"agosto\": \"agosto\", \"ago\": \"agosto\", \"8\": \"agosto\",\n    \"septiembre\": \"septiembre\", \"sep\": \"septiembre\", \"sept\": \"septiembre\", \"9\": \"septiembre\",\n    \"octubre\": \"octubre\", \"oct\": \"octubre\", \"10\": \"octubre\",\n    \"noviembre\": \"noviembre\", \"nov\": \"noviembre\", \"11\": \"noviembre\",\n    \"diciembre\": \"diciembre\", \"dic\": \"diciembre\", \"12\": \"diciembre\"\n  };\n  \n  let dia, mes, anio;\n  const anioActual = new Date().getFullYear();\n  \n  console.log(`游댢 Normalizando fecha flexible: \"${fechaInput}\"  entrada limpia: \"${fecha}\"`);\n  \n  // PATR칍N 1: \"05 de agosto de 2025\" o \"5 de agosto de 2025\"\n  let match = fecha.match(/(\\d{1,2})\\s*de\\s*(\\w+)\\s*de\\s*(\\d{4})/);\n  if (match) {\n    dia = parseInt(match[1]);\n    mes = mesesMap[match[2]] || match[2];\n    anio = parseInt(match[3]);\n    console.log(`九 Patr칩n \"DD de MMMM de YYYY\": dia=${dia}, mes=${mes}, anio=${anio}`);\n    return `${dia} de ${mes} de ${anio}`;\n  }\n  \n  // PATR칍N 2: \"05 agosto 2025\" o \"5 agosto 2025\"\n  match = fecha.match(/(\\d{1,2})\\s+(\\w+)\\s+(\\d{4})/);\n  if (match) {\n    dia = parseInt(match[1]);\n    mes = mesesMap[match[2]] || match[2];\n    anio = parseInt(match[3]);\n    console.log(`九 Patr칩n \"DD MMMM YYYY\": dia=${dia}, mes=${mes}, anio=${anio}`);\n    return `${dia} de ${mes} de ${anio}`;\n  }\n  \n  // PATR칍N 3: \"05 de agosto\" o \"5 de agosto\" (a침o actual)\n  match = fecha.match(/(\\d{1,2})\\s*de\\s*(\\w+)/);\n  if (match) {\n    dia = parseInt(match[1]);\n    mes = mesesMap[match[2]] || match[2];\n    anio = anioActual;\n    console.log(`九 Patr칩n \"DD de MMMM\": dia=${dia}, mes=${mes}, anio=${anio} (a침o actual)`);\n    return `${dia} de ${mes} de ${anio}`;\n  }\n  \n  // PATR칍N 4: \"05 agosto\" o \"5 agosto\" (a침o actual)\n  match = fecha.match(/(\\d{1,2})\\s+(\\w+)/);\n  if (match && mesesMap[match[2]]) {\n    dia = parseInt(match[1]);\n    mes = mesesMap[match[2]];\n    anio = anioActual;\n    console.log(`九 Patr칩n \"DD MMMM\": dia=${dia}, mes=${mes}, anio=${anio} (a침o actual)`);\n    return `${dia} de ${mes} de ${anio}`;\n  }\n  \n  // PATR칍N 5: \"05-08-2025\" o \"5-8-2025\"\n  match = fecha.match(/(\\d{1,2})-(\\d{1,2})-(\\d{4})/);\n  if (match) {\n    dia = parseInt(match[1]);\n    const numeroMes = parseInt(match[2]);\n    const mesesArray = [\"enero\",\"febrero\",\"marzo\",\"abril\",\"mayo\",\"junio\",\"julio\",\"agosto\",\"septiembre\",\"octubre\",\"noviembre\",\"diciembre\"];\n    mes = mesesArray[numeroMes - 1] || \"enero\";\n    anio = parseInt(match[3]);\n    console.log(`九 Patr칩n \"DD-MM-YYYY\": dia=${dia}, mes=${mes}, anio=${anio}`);\n    return `${dia} de ${mes} de ${anio}`;\n  }\n  \n  // PATR칍N 6: \"05-08\" o \"5-8\" (a침o actual)\n  match = fecha.match(/(\\d{1,2})-(\\d{1,2})/);\n  if (match) {\n    dia = parseInt(match[1]);\n    const numeroMes = parseInt(match[2]);\n    const mesesArray = [\"enero\",\"febrero\",\"marzo\",\"abril\",\"mayo\",\"junio\",\"julio\",\"agosto\",\"septiembre\",\"octubre\",\"noviembre\",\"diciembre\"];\n    mes = mesesArray[numeroMes - 1] || \"enero\";\n    anio = anioActual;\n    console.log(`九 Patr칩n \"DD-MM\": dia=${dia}, mes=${mes}, anio=${anio} (a침o actual)`);\n    return `${dia} de ${mes} de ${anio}`;\n  }\n  \n  // PATR칍N 7: \"05/08/2025\" o \"5/8/2025\"\n  match = fecha.match(/(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})/);\n  if (match) {\n    dia = parseInt(match[1]);\n    const numeroMes = parseInt(match[2]);\n    const mesesArray = [\"enero\",\"febrero\",\"marzo\",\"abril\",\"mayo\",\"junio\",\"julio\",\"agosto\",\"septiembre\",\"octubre\",\"noviembre\",\"diciembre\"];\n    mes = mesesArray[numeroMes - 1] || \"enero\";\n    anio = parseInt(match[3]);\n    console.log(`九 Patr칩n \"DD/MM/YYYY\": dia=${dia}, mes=${mes}, anio=${anio}`);\n    return `${dia} de ${mes} de ${anio}`;\n  }\n  \n  // PATR칍N 8: \"05/08\" o \"5/8\" (a침o actual)\n  match = fecha.match(/(\\d{1,2})\\/(\\d{1,2})/);\n  if (match) {\n    dia = parseInt(match[1]);\n    const numeroMes = parseInt(match[2]);\n    const mesesArray = [\"enero\",\"febrero\",\"marzo\",\"abril\",\"mayo\",\"junio\",\"julio\",\"agosto\",\"septiembre\",\"octubre\",\"noviembre\",\"diciembre\"];\n    mes = mesesArray[numeroMes - 1] || \"enero\";\n    anio = anioActual;\n    console.log(`九 Patr칩n \"DD/MM\": dia=${dia}, mes=${mes}, anio=${anio} (a침o actual)`);\n    return `${dia} de ${mes} de ${anio}`;\n  }\n  \n  // PATR칍N 9: Solo n칰mero \"5\" (asumir mes actual)\n  match = fecha.match(/^(\\d{1,2})$/);\n  if (match) {\n    dia = parseInt(match[1]);\n    const mesActual = new Date().getMonth();\n    const mesesArray = [\"enero\",\"febrero\",\"marzo\",\"abril\",\"mayo\",\"junio\",\"julio\",\"agosto\",\"septiembre\",\"octubre\",\"noviembre\",\"diciembre\"];\n    mes = mesesArray[mesActual];\n    anio = anioActual;\n    console.log(`九 Patr칩n \"DD solo\": dia=${dia}, mes=${mes} (mes actual), anio=${anio} (a침o actual)`);\n    return `${dia} de ${mes} de ${anio}`;\n  }\n  \n  console.log(`仇 No se pudo normalizar la fecha: \"${fechaInput}\"`);\n  return fechaInput;\n}\n// ===================== FIN DE LA SECCI칍N CORREGIDA =====================\n\n// (8) NUEVA FUNCI칍N: Buscar d칤a por fecha exacta en todas las mallas\nfunction buscarDiaPorFechaExacta(fechaSolicitada, mallaActual, mallaProxima) {\n  console.log(`游댌 BUSCANDO FECHA EXACTA: \"${fechaSolicitada}\"`);\n  \n  const mallas = [\n    { malla: mallaActual, nombre: \"actual\" },\n    { malla: mallaProxima, nombre: \"proxima\" }\n  ];\n\n  for (const { malla, nombre } of mallas) {\n    console.log(`  游늶 Revisando malla \"${nombre}\"`);\n    \n    if (!malla) {\n      console.log(`    仇 Malla \"${nombre}\" es nula`);\n      continue;\n    }\n    \n    if (!malla.dias) {\n      console.log(`    仇 Malla \"${nombre}\" no tiene d칤as`);\n      continue;\n    }\n    \n    console.log(`    九 Malla \"${nombre}\" tiene ${Object.keys(malla.dias).length} d칤as`);\n\n    // Recorrer todos los d칤as de la malla\n    for (const [nombreDia, datosDia] of Object.entries(malla.dias)) {\n      if (!datosDia) {\n        console.log(`      丘멆잺 D칤a \"${nombreDia}\" tiene datos nulos`);\n        continue;\n      }\n      \n      // NORMALIZAR AMBAS FECHAS PARA COMPARACI칍N FLEXIBLE\n      const fechaMallaNormalizada = normalizarFechaFlexible(datosDia.fechaDia || \"\");\n      const fechaSolicitadaNormalizada = normalizarFechaFlexible(fechaSolicitada);\n      \n      console.log(`      游딉勇 Comparando d칤a \"${nombreDia}\": fechaDia=\"${datosDia.fechaDia}\" (norm: \"${fechaMallaNormalizada}\") vs fechaSolicitada=\"${fechaSolicitada}\" (norm: \"${fechaSolicitadaNormalizada}\")`);\n      \n      if (fechaMallaNormalizada === fechaSolicitadaNormalizada) {\n        console.log(`      游꿀 FECHA ENCONTRADA! D칤a \"${nombreDia}\" en malla \"${nombre}\"`);\n        return {\n          malla: malla,\n          nombreDia: nombreDia,\n          datosDia: datosDia,\n          mallaUsada: nombre\n        };\n      }\n    }\n    \n    console.log(`    仇 Fecha \"${fechaSolicitada}\" NO encontrada en malla \"${nombre}\"`);\n  }\n\n  console.log(`仇 Fecha \"${fechaSolicitada}\" NO encontrada en NINGUNA malla`);\n  return null;\n}\n\n// (9) Verificar disponibilidad de la hora solicitada (NUEVA L칍GICA)\nfunction verificarDisponibilidadHoraSolicitada(\n  fechaSolicitada,\n  horaSolicitada,\n  muelle,\n  horasNecesarias,\n  mallaActual,\n  mallaProxima\n) {\n  try {\n    console.log(`游댌 INICIANDO VERIFICACI칍N DE DISPONIBILIDAD`);\n    console.log(`  Fecha solicitada: \"${fechaSolicitada}\"`);\n    console.log(`  Hora solicitada: \"${horaSolicitada}\"`);\n    console.log(`  Muelle: \"${muelle}\"`);\n    console.log(`  Horas necesarias: ${horasNecesarias}`);\n\n    /* 較較 Buscar el d칤a por fecha exacta 較較 */\n    console.log(`游댌 Buscando fecha exacta: \"${fechaSolicitada}\"`);\n    const resultadoBusqueda = buscarDiaPorFechaExacta(fechaSolicitada, mallaActual, mallaProxima);\n    \n    if (!resultadoBusqueda) {\n      console.log(`仇 No se encontr칩 la fecha \"${fechaSolicitada}\" en ninguna malla`);\n      return false;\n    }\n\n    const { malla, nombreDia, datosDia } = resultadoBusqueda;\n    console.log(`九 Fecha encontrada en malla. D칤a: \"${nombreDia}\", fechaDia: \"${datosDia.fechaDia}\"`);\n\n    /* 較較 Verificar muelle 較較 */\n    const nombreMuelle = muelle.toLowerCase().replace(/\\s+/g, \"\"); // \"MUELLE 1\"  \"muelle1\"\n    console.log(`游댌 Transformando muelle: \"${muelle}\"  \"${nombreMuelle}\"`);\n    \n    if (!datosDia[nombreMuelle]) {\n      console.log(`仇 No se encontr칩 el muelle \"${nombreMuelle}\" para el d칤a ${nombreDia}`);\n      console.log(`  Muelles disponibles:`, Object.keys(datosDia).filter(k => k !== 'fechaDia'));\n      return false;\n    }\n    console.log(`九 Muelle \"${nombreMuelle}\" encontrado`);\n\n    /* 較較 Verificar franjas 較較 */\n    if (!malla.franjas || !Array.isArray(malla.franjas) || malla.franjas.length === 0) {\n      console.log(`仇 No hay franjas definidas en la malla`);\n      return false;\n    }\n\n    const franjas = malla.franjas.map(f => f.hora);\n    console.log(`游댌 Franjas disponibles:`, franjas);\n    console.log(`游댌 Buscando hora \"${horaSolicitada}\" (limpia: \"${limpiarHora(horaSolicitada)}\")`);\n    \n    const indiceInicio = franjas.findIndex(h => {\n      const horaLimpia = limpiarHora(h);\n      const horaSolicitadaLimpia = limpiarHora(horaSolicitada);\n      console.log(`  Comparando: \"${h}\" (${horaLimpia}) vs \"${horaSolicitada}\" (${horaSolicitadaLimpia})`);\n      return horaLimpia === horaSolicitadaLimpia;\n    });\n    \n    if (indiceInicio === -1) {\n      console.log(`仇 No se encontr칩 la hora \"${horaSolicitada}\" en las franjas disponibles`);\n      console.log(`  Franjas disponibles:`, franjas);\n      return false;\n    }\n    console.log(`九 Hora encontrada en 칤ndice ${indiceInicio}`);\n    \n    if (indiceInicio + horasNecesarias > franjas.length) {\n      console.log(`仇 No hay suficientes franjas consecutivas disponibles (necesita ${horasNecesarias})`);\n      return false;\n    }\n\n    /* 較較 Verificar disponibilidad de todas las franjas necesarias 較較 */\n    console.log(`游댌 Verificando disponibilidad de ${horasNecesarias} franja(s) consecutiva(s)`);\n    for (let i = 0; i < horasNecesarias; i++) {\n      const horaFranja = franjas[indiceInicio + i];\n      const franja = datosDia[nombreMuelle][horaFranja];\n      \n      console.log(`  Revisando franja ${i + 1}/${horasNecesarias}: \"${horaFranja}\"`);\n      \n      if (!franja) {\n        console.log(`仇 No se encontr칩 la franja \"${horaFranja}\" en \"${nombreMuelle}\"`);\n        return false;\n      }\n      \n      const estadoFranja = (franja.estado || \"\").toLowerCase().trim();\n      console.log(`    Estado: \"${franja.estado}\"  \"${estadoFranja}\"`);\n      \n      if (estadoFranja !== \"disponible\") {\n        console.log(`仇 La franja \"${horaFranja}\" no est치 disponible. Estado: \"${franja.estado}\"`);\n        return false;\n      }\n      console.log(`    九 Franja \"${horaFranja}\" est치 disponible`);\n    }\n    \n    console.log(`游꿀 TODAS las franjas est치n disponibles para ${fechaSolicitada} ${horaSolicitada}`);\n    return true;\n  } catch (error) {\n    console.error(`仇 Error verificando disponibilidad: ${error.message}`);\n    console.error(error.stack);\n    return false;\n  }\n}\n\n// (10) Formatear fecha en formato espa침ol\nfunction formatearFechaEspanol(fecha) {\n  if (!fecha || !(fecha instanceof Date)) {\n    return \"\";\n  }\n  \n  const dia = fecha.getDate();\n  const meses = [\n    \"enero\", \"febrero\", \"marzo\", \"abril\", \"mayo\", \"junio\",\n    \"julio\", \"agosto\", \"septiembre\", \"octubre\", \"noviembre\", \"diciembre\"\n  ];\n  const mes = meses[fecha.getMonth()];\n  const anio = fecha.getFullYear();\n  \n  return `${dia} de ${mes} de ${anio}`;\n}\n\n/* 較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較 */\n/* FUNCIONES PARA BUSCAR ALTERNATIVAS                                        */\n/* 較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較較 */\n\n// Buscar alternativas desde dos d칤as despu칠s\nfunction buscarAlternativasDesdeDosDiasDespues(\n  fechaActual,\n  mallaActual,\n  mallaProxima,\n  muelle,\n  horasNecesarias\n) {\n  try {\n    const fechaDosDiasDespues = new Date(fechaActual);\n    fechaDosDiasDespues.setDate(fechaDosDiasDespues.getDate() + 2);\n    \n    // Ajustar si cae en fin de semana\n    if (fechaDosDiasDespues.getDay() === 0) { // Domingo\n      fechaDosDiasDespues.setDate(fechaDosDiasDespues.getDate() + 1);\n    } else if (fechaDosDiasDespues.getDay() === 6) { // S치bado\n      fechaDosDiasDespues.setDate(fechaDosDiasDespues.getDate() + 2);\n    }\n    \n    const fechaDosDiasDespuesStr = formatearFechaEspanol(fechaDosDiasDespues);\n    const alternativas = buscarAlternativasParaDiaConFechaExacta(\n      fechaDosDiasDespuesStr,\n      muelle,\n      horasNecesarias,\n      mallaActual,\n      mallaProxima\n    );\n    \n    // Solo devolver m치ximo 10 alternativas de ese d칤a\n    return alternativas.slice(0, 10);\n  } catch (error) {\n    console.error(`Error buscando alternativas: ${error.message}`);\n    return [];\n  }\n}\n\n// Buscar alternativas para un d칤a espec칤fico usando fecha exacta\nfunction buscarAlternativasParaDiaConFechaExacta(\n  fechaTexto,\n  muelle,\n  horasNecesarias,\n  mallaActual,\n  mallaProxima\n) {\n  try {\n    const alternativas = [];\n    \n    const resultadoBusqueda = buscarDiaPorFechaExacta(fechaTexto, mallaActual, mallaProxima);\n    if (!resultadoBusqueda) {\n      return alternativas;\n    }\n\n    const { malla, datosDia } = resultadoBusqueda;\n    const nombreMuelle = muelle.toLowerCase().replace(/\\s+/g, \"\");\n    \n    if (!datosDia[nombreMuelle]) {\n      return alternativas;\n    }\n    \n    if (!malla.franjas || !Array.isArray(malla.franjas) || malla.franjas.length === 0) {\n      return alternativas;\n    }\n    \n    const franjasHorario = malla.franjas.map(f => f.hora);\n    \n    // Verificar cada posible hora de inicio\n    for (let i = 0; i <= franjasHorario.length - horasNecesarias; i++) {\n      const horaInicio = franjasHorario[i];\n      let todasDisponibles = true;\n      \n      // Verificar disponibilidad de todas las franjas consecutivas\n      for (let j = 0; j < horasNecesarias; j++) {\n        const horaActual = franjasHorario[i + j];\n        const franja = datosDia[nombreMuelle][horaActual];\n        \n        if (!franja || (franja.estado || \"\").toLowerCase().trim() !== \"disponible\") {\n          todasDisponibles = false;\n          break;\n        }\n      }\n      \n      // Si todas las franjas est치n disponibles, agregar como alternativa\n      if (todasDisponibles) {\n        const horaFin = calcularHoraFin(horaInicio, horasNecesarias);\n        alternativas.push({\n          fecha: fechaTexto,\n          horaInicio: horaInicio,\n          horaFin: horaFin,\n          muelle: muelle\n        });\n      }\n    }\n    \n    return alternativas;\n  } catch (error) {\n    console.error(`Error buscando alternativas para d칤a: ${error.message}`);\n    return [];\n  }\n}\n\n// Buscar alternativas en el mismo d칤a\nfunction buscarAlternativasMismoDia(\n  fechaSolicitada,\n  muelle,\n  horasNecesarias,\n  mallaActual,\n  mallaProxima\n) {\n  const alternativas = buscarAlternativasParaDiaConFechaExacta(\n    fechaSolicitada,\n    muelle,\n    horasNecesarias,\n    mallaActual,\n    mallaProxima\n  );\n  \n  // Limitar a m치ximo 8 alternativas del mismo d칤a\n  return alternativas.slice(0, 8);\n}\n\n// Buscar alternativas en d칤as posteriores\nfunction buscarAlternativasDiasPeriores(\n  fechaSolicitada,\n  muelle,\n  horasNecesarias,\n  mallaActual,\n  mallaProxima\n) {\n  try {\n    const fechaSolicitadaObj = parsearFechaEspanol(fechaSolicitada);\n    const fechaSiguiente = new Date(fechaSolicitadaObj);\n    fechaSiguiente.setDate(fechaSiguiente.getDate() + 1);\n    \n    // Solo buscar en el d칤a siguiente\n    const fechaSiguienteStr = formatearFechaEspanol(fechaSiguiente);\n    const alternativasDiaSiguiente = buscarAlternativasParaDiaConFechaExacta(\n      fechaSiguienteStr,\n      muelle,\n      horasNecesarias,\n      mallaActual,\n      mallaProxima\n    );\n    \n    // Limitar a m치ximo 8 alternativas del d칤a siguiente\n    return alternativasDiaSiguiente.slice(0, 8);\n  } catch (error) {\n    console.error(`Error buscando alternativas posteriores: ${error.message}`);\n    return [];\n  }\n}\n\n// Aseguramos que n8n ejecute la funci칩n principal\nreturn procesarVerificacionFranjas(items, 0);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5168,
        1024
      ],
      "id": "6d0bd367-883f-4c76-adf1-7db2e3cb6bba",
      "name": "Code MOSTRAR_FRANJAS"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Sistema de Validaci칩n de Datos para Citas de Log칤stica\n * VERSI칍N 5.3  2025-04-25\n * - Aplana proveedores y categor칤as que vienen dentro de \"datosproveedor\" /\n *   \"datoscategorias\"\n * - Mantiene la l칩gica de coincidencias para abreviaturas (\"spb\") y variantes\n *   sing/plural (\"arena\"뇦"ARENAS\")\n * - Incluye guard-rails para evitar undefined\n */\n\n/*較較較較較較較較較較較較較較較較較較較較較較 UTILIDAD GEN칄RICA 較較較較較較較較較較較較較較較較較較較較較較*/\nfunction getNodeItems(nodeName) {\n  try {\n    return $items(nodeName).map(i => i.json) || [];\n  } catch (e) {          //  con (e) o (error)\n    return [];\n  }\n}\n\n/*較較較較較較較較較較較較較較較較較較較較較較 CARGA Y APLANADO 較較較較較較較較較較較較較較較較較較較較較較較*/\nfunction procesarValidacionCita() {\n  try {   \n// 游댃 Carga cruda\nlet proveedoresRaw  = getNodeItems(\"Estructuraci칩n, Consulta, Datos Proveedor\");\nlet categoriasRaw   = getNodeItems(\"Estructuraci칩n, Consulta, Datos Categorias\");\n\n// 游댃 Aplanar proveedores\nlet datosproveedor = [];\nfor (const itm of proveedoresRaw) {\n  if (Array.isArray(itm.datosproveedor))  datosproveedor.push(...itm.datosproveedor);\n  else if (itm.proveedor)                 datosproveedor.push(itm);\n}\n\n// 游댃 Aplanar categor칤as\nlet datoscategorias = [];\nfor (const itm of categoriasRaw) {\n  if (Array.isArray(itm.datoscategorias)) datoscategorias.push(...itm.datoscategorias);\n  else if (itm.CATEGORIA)                 datoscategorias.push(itm);\n}\n\n// Fallbacks (por compatibilidad con Merge datos Excel)\nif (!datosproveedor.length  && $node[\"Merge datos Excel\"]?.json?.datosproveedor)\n  datosproveedor  = $node[\"Merge datos Excel\"].json.datosproveedor;\nif (!datoscategorias.length && $node[\"Merge datos Excel\"]?.json?.datoscategorias)\n  datoscategorias = $node[\"Merge datos Excel\"].json.datoscategorias;\n\n/*較較較較較較較較較較較較較較較較較較較較 DATOS DEL LLM Y CONTEXTO 較較較較較較較較較較較較較較較較較*/\nconst datosLLM          = $node[\"Basic LLM Chain RECOLECCI칍N1\"].json.output;\nconst mensajeActual     = $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.mensajeActual;\nconst historialMensajes = $node[\"Unificaci칩n y consistencia de datos\"].json.infoMensaje.historialMensajes;\nconst mallaProximaSemana= $('Estructuraci칩n, Datos, Consulta, Citas Proxima Semana').first().json;\nconst mallaProximaNoExiste = verificarMallaProximaNoExiste(mallaProximaSemana);\nconst fechaActualObj    = new Date();\n    \n    // Inicializar el objeto de respuesta\n    const resultado = {\n      todoCorrecto: false,\n      datosPreviamenteConfirmados: false,\n      camposFaltantes: [],\n      proveedoresSimilares: [],\n      categoriasSimilares: [],\n      fechaSolicitada: \"\",\n      horaSolicitada: \"\",\n      proveedorIdentificado: \"\",\n      categoriaIdentificada: \"\",\n      pesoIdentificado: 0,\n      unidadesIdentificadas: 0,\n      ordenCompraIdentificada: \"\",\n      mensajeSistema: \"\",\n      mensajesCamposFaltantes: {},\n      mallaProximaDisponible: !mallaProximaNoExiste,\n      fechaValida: true,\n      horaValida: true,\n      diaHabil: true,\n      mensajeValidacionTemporal: \"\"\n    };\n\n    // Si la malla pr칩xima no existe, agregar un mensaje informativo\n    if (mallaProximaNoExiste) {\n      resultado.mensajeSistema = \"Te informo que la malla de la pr칩xima semana a칰n no ha sido creada o no est치 disponible. Solo puedo mostrarte disponibilidad para la semana actual.\";\n    }\n\n    // 1. VERIFICAR SI ES UNA CONFIRMACI칍N DIRECTA DE TODOS LOS DATOS\n    const confirmacionPrevia = verificarConfirmacionPrevia(historialMensajes, mensajeActual);\n    if (confirmacionPrevia.confirmado) {\n      resultado.datosPreviamenteConfirmados = true;\n      resultado.todoCorrecto = true;\n      resultado.proveedorIdentificado = confirmacionPrevia.proveedor;\n      resultado.fechaSolicitada = confirmacionPrevia.fecha;\n      resultado.horaSolicitada = confirmacionPrevia.hora;\n      resultado.categoriaIdentificada = confirmacionPrevia.categoria;\n      resultado.pesoIdentificado = confirmacionPrevia.peso;\n      resultado.unidadesIdentificadas = confirmacionPrevia.unidades;\n      resultado.ordenCompraIdentificada = confirmacionPrevia.ordenCompra;\n      \n      // Validar que la fecha y hora confirmadas no est칠n en el pasado\n      const validacionTemporal = validarFechaHora(resultado.fechaSolicitada, resultado.horaSolicitada, fechaActualObj);\n      resultado.fechaValida = validacionTemporal.fechaValida;\n      resultado.horaValida = validacionTemporal.horaValida;\n      resultado.diaHabil = validacionTemporal.diaHabil;\n      resultado.mensajeValidacionTemporal = validacionTemporal.mensaje;\n      \n      // Si hay problemas con la fecha/hora, la cita no est치 correcta\n      if (!validacionTemporal.fechaValida || !validacionTemporal.horaValida || !validacionTemporal.diaHabil) {\n        resultado.todoCorrecto = false;\n      }\n      \n      return resultado;\n    }\n\n    // 2. USAR DIRECTAMENTE LOS DATOS DEL LLM\n    // No intentar extraer datos del mensaje - confiar en lo que extrajo el LLM\n    resultado.fechaSolicitada = datosLLM.fecha || \"\";\n    resultado.horaSolicitada = datosLLM.hora || \"\";\n    resultado.pesoIdentificado = parseInt(datosLLM.peso) || 0;\n    resultado.unidadesIdentificadas = parseInt(datosLLM.unidades) || 0;\n    resultado.ordenCompraIdentificada = datosLLM.ordenCompra || \"\";\n\n    // 3. VALIDACI칍N DEL PROVEEDOR\n    if (datosLLM.proveedor) {\n      const resultadoProveedor = validarProveedor(datosLLM.proveedor, datosproveedor);\n      \n      if (resultadoProveedor.coincidenciaExacta) {\n        resultado.proveedorIdentificado = resultadoProveedor.nombreCompleto;\n      } else if (resultadoProveedor.coincidenciaParcialClara) {\n        resultado.proveedorIdentificado = resultadoProveedor.nombreCompleto;\n      } else if (resultadoProveedor.coincidenciasParciales && resultadoProveedor.coincidenciasParciales.length > 0) {\n        resultado.proveedoresSimilares = resultadoProveedor.coincidenciasParciales;\n      } else {\n        resultado.camposFaltantes.push(\"proveedor\");\n        resultado.mensajesCamposFaltantes[\"proveedor\"] = \"Por favor proporciona el nombre del proveedor ya que es necesario para buscarlo en nuestra base de datos y que el sistema pueda asociar la cita a ese nombre, trata de proporcionar el nombre lo m치s completo posible.\";\n      }\n    } else {\n      resultado.camposFaltantes.push(\"proveedor\");\n      resultado.mensajesCamposFaltantes[\"proveedor\"] = \"Por favor proporciona el nombre del proveedor ya que es necesario para buscarlo en nuestra base de datos y que el sistema pueda asociar la cita a ese nombre, trata de proporcionar el nombre lo m치s completo posible.\";\n    }\n\n    // 4. VALIDACI칍N DE LA CATEGOR칈A\n    if (datosLLM.categoria) {\n      const resultadoCategoria = validarCategoria(datosLLM.categoria, datoscategorias);\n      if (resultadoCategoria.coincidenciaExacta) {\n        resultado.categoriaIdentificada = resultadoCategoria.nombreCompleto;\n      } else if (resultadoCategoria.coincidenciaSimilar) {\n        // Si es \"arena\" para \"ARENAS\", por ejemplo\n        resultado.categoriaIdentificada = resultadoCategoria.nombreCompleto;\n      } else if (resultadoCategoria.categoriasSimilares && resultadoCategoria.categoriasSimilares.length > 0) {\n        resultado.categoriasSimilares = resultadoCategoria.categoriasSimilares;\n      } else {\n        resultado.camposFaltantes.push(\"categor칤a\");\n        \n        // Preparar la lista de categor칤as disponibles para el mensaje\n        let categoriasDisponibles = datoscategorias.map(cat => cat.CATEGORIA).join(\", \");\n        if (categoriasDisponibles.length > 100) {\n          // Si hay muchas categor칤as, mostrar solo las primeras\n          const primerasCategorias = datoscategorias.slice(0, 5).map(cat => cat.CATEGORIA);\n          categoriasDisponibles = primerasCategorias.join(\", \") + \", entre otras...\";\n        }\n        \n        resultado.mensajesCamposFaltantes[\"categor칤a\"] = `Por favor indica la categor칤a del material. Las categor칤as disponibles incluyen: ${categoriasDisponibles}`;\n      }\n    } else {\n      resultado.camposFaltantes.push(\"categor칤a\");\n      \n      // Preparar la lista de categor칤as disponibles para el mensaje\n      let categoriasDisponibles = datoscategorias.map(cat => cat.CATEGORIA).join(\", \");\n      if (categoriasDisponibles.length > 100) {\n        // Si hay muchas categor칤as, mostrar solo las primeras\n        const primerasCategorias = datoscategorias.slice(0, 5).map(cat => cat.CATEGORIA);\n        categoriasDisponibles = primerasCategorias.join(\", \") + \", entre otras...\";\n      }\n      \n      resultado.mensajesCamposFaltantes[\"categor칤a\"] = `Por favor indica la categor칤a del material. Las categor칤as disponibles incluyen: ${categoriasDisponibles}`;\n    }\n\n    // 5. VERIFICACI칍N DE CAMPOS OBLIGATORIOS FALTANTES\n    if (!resultado.fechaSolicitada) {\n      resultado.camposFaltantes.push(\"fecha\");\n      resultado.mensajesCamposFaltantes[\"fecha\"] = \"Por favor es necesaria la fecha de entrega para que el sistema pueda revisar el cronograma y entregarte informaci칩n precisa.\";\n    }\n    \n    if (!resultado.horaSolicitada) {\n      resultado.camposFaltantes.push(\"hora\");\n      resultado.mensajesCamposFaltantes[\"hora\"] = \"Por favor indica la hora preferida para la cita, es necesaria para verificar la disponibilidad en nuestro cronograma.\";\n    }\n    \n    if (!resultado.pesoIdentificado) {\n      resultado.camposFaltantes.push(\"peso\");\n      resultado.mensajesCamposFaltantes[\"peso\"] = \"Te falta el dato del peso de la mercanc칤a. Por favor proporcionar este dato ojal치 en kilos, es necesario para que el sistema calcule la duraci칩n del descargue de la mercanc칤a.\";\n    }\n    \n    if (!resultado.unidadesIdentificadas) {\n      resultado.camposFaltantes.push(\"unidades\");\n      resultado.mensajesCamposFaltantes[\"unidades\"] = \"Te falt칩 el dato de la cantidad de unidades a descargar. Este dato es importante para que el sistema pueda calcular el tiempo que se necesita para el descargue.\";\n    }\n    \n    if (!resultado.ordenCompraIdentificada) {\n      resultado.camposFaltantes.push(\"orden de compra\");\n      resultado.mensajesCamposFaltantes[\"orden de compra\"] = \"Falta el n칰mero de la orden de compra. Por favor proporcionar este dato ya que es necesario para que la cita en el cronograma quede relacionada a esta orden de compra por temas de trazabilidad en la operaci칩n.\";\n    }\n\n    // 6. VALIDACI칍N: Verificar que la fecha y hora sean v치lidas\n    if (resultado.fechaSolicitada && resultado.horaSolicitada) {\n      const validacionTemporal = validarFechaHora(resultado.fechaSolicitada, resultado.horaSolicitada, fechaActualObj);\n      resultado.fechaValida = validacionTemporal.fechaValida;\n      resultado.horaValida = validacionTemporal.horaValida;\n      resultado.diaHabil = validacionTemporal.diaHabil;\n      resultado.mensajeValidacionTemporal = validacionTemporal.mensaje;\n      \n      // Si la fecha u hora no son v치lidas, a침adir a campos faltantes\n      if (!validacionTemporal.fechaValida) {\n        if (!resultado.camposFaltantes.includes(\"fecha\")) {\n          resultado.camposFaltantes.push(\"fecha\");\n        }\n        resultado.mensajesCamposFaltantes[\"fecha\"] = validacionTemporal.mensaje;\n      }\n      \n      if (!validacionTemporal.horaValida) {\n        if (!resultado.camposFaltantes.includes(\"hora\")) {\n          resultado.camposFaltantes.push(\"hora\");\n        }\n        resultado.mensajesCamposFaltantes[\"hora\"] = validacionTemporal.mensaje;\n      }\n      \n      if (!validacionTemporal.diaHabil) {\n        if (!resultado.camposFaltantes.includes(\"fecha\")) {\n          resultado.camposFaltantes.push(\"fecha\");\n        }\n        resultado.mensajesCamposFaltantes[\"fecha\"] = validacionTemporal.mensaje;\n      }\n    }\n\n    // 7. DETERMINAR ESTADO FINAL\n    if (\n      resultado.camposFaltantes.length === 0 && \n      resultado.proveedoresSimilares.length === 0 && \n      resultado.categoriasSimilares.length === 0 &&\n      resultado.proveedorIdentificado && \n      resultado.categoriaIdentificada &&\n      resultado.fechaValida &&\n      resultado.horaValida &&\n      resultado.diaHabil\n    ) {\n      resultado.todoCorrecto = true;\n    }\n\n    return resultado;\n  } catch (e) {\n    console.error(\"Error en procesamiento de cita:\", e);\n    return {\n      error: e.message,\n      todoCorrecto: false,\n      mensajeSistema: \"Ocurri칩 un error durante el procesamiento de tu solicitud. Por favor, intenta nuevamente.\"\n    };\n  }\n}\n\n/**\n * Valida que la fecha y hora solicitadas sean v치lidas\n * (no en el pasado, d칤a h치bil, etc.)\n */\nfunction validarFechaHora(fechaStr, horaStr, fechaActualObj) {\n  const resultado = {\n    fechaValida: true,\n    horaValida: true,\n    diaHabil: true,\n    mensaje: \"\"\n  };\n  \n  try {\n    // Crear el objeto fecha a partir del string de fecha\n    let fechaSolicitadaObj = parsearFechaEspanol(fechaStr);\n    console.log(\"Fecha solicitada parseada:\", fechaSolicitadaObj);\n    \n    // Verificar si es un d칤a h치bil (L-V)\n    const diaSemana = fechaSolicitadaObj.getDay();\n    if (diaSemana === 0 || diaSemana === 6) { // 0 = domingo, 6 = s치bado\n      resultado.diaHabil = false;\n      resultado.mensaje = \"La fecha solicitada cae en fin de semana. Por favor elige un d칤a h치bil (lunes a viernes).\";\n      return resultado;\n    }\n    \n    // Verificar si la fecha es hoy\n    const esHoy = esMismaFecha(fechaSolicitadaObj, fechaActualObj);\n    console.log(\"쮼s hoy?\", esHoy);\n    \n    // Si es hoy, verificar que la hora sea futura y con al menos 2 horas de anticipaci칩n\n    if (esHoy) {\n      // Convertir la hora solicitada a un objeto Date\n      const horaSolicitadaObj = parsearHora(horaStr, fechaSolicitadaObj);\n      console.log(\"Hora solicitada parseada:\", horaSolicitadaObj);\n      \n      // Verificar que sea futura\n      if (horaSolicitadaObj < fechaActualObj) {\n        resultado.horaValida = false;\n        resultado.mensaje = \"La hora solicitada ya pas칩. Por favor elige una hora futura.\";\n        return resultado;\n      }\n      \n      // Verificar que haya al menos 2 horas de anticipaci칩n\n      const diferenciaMilis = horaSolicitadaObj - fechaActualObj;\n      const diferenciaHoras = diferenciaMilis / (1000 * 60 * 60);\n      console.log(\"Diferencia en horas:\", diferenciaHoras);\n      \n      if (diferenciaHoras < 2) {\n        resultado.horaValida = false;\n        resultado.mensaje = \"Necesitamos al menos 2 horas de anticipaci칩n para programar una cita. Por favor elige una hora posterior o una fecha futura.\";\n        return resultado;\n      }\n    }\n    \n    // Verificar que la fecha no sea pasada\n    if (fechaSolicitadaObj < fechaActualObj && !esHoy) {\n      resultado.fechaValida = false;\n      resultado.mensaje = \"La fecha solicitada ya pas칩. Por favor elige una fecha futura.\";\n      return resultado;\n    }\n    \n    // NO HAY RESTRICCI칍N DE HORARIO DE OPERACI칍N\n    \n    return resultado;\n  } catch (e) {\n    console.error(\"Error en validaci칩n de fecha/hora:\", e);\n    resultado.fechaValida = false;\n    resultado.mensaje = \"Error al validar la fecha y hora. Por favor verifica el formato.\";\n    return resultado;\n  }\n}\n\n/**\n * Parsea una fecha en espa침ol a un objeto Date\n */\nfunction parsearFechaEspanol(fechaStr) {\n  try {\n    // Verificar que la fecha no est칠 vac칤a\n    if (!fechaStr || typeof fechaStr !== 'string' || fechaStr.trim() === '') {\n      throw new Error(\"Fecha vac칤a o no v치lida: \" + fechaStr);\n    }\n    \n    console.log(\"[DEBUG] Fecha recibida para parsear:\", fechaStr);\n    \n    // Normalizar la fecha (quitar \"de\", etc. y limpiar espacios extra)\n    const fechaNormalizada = fechaStr.toLowerCase()\n      .trim()\n      .replace(/\\s+de\\s+/g, \" \")\n      .replace(/\\s+del\\s+/g, \" \")\n      .replace(/\\s+/g, \" \"); // Normalizar espacios m칰ltiples\n    \n    console.log(\"[DEBUG] Fecha normalizada:\", fechaNormalizada);\n    \n    // Mapeo de meses en espa침ol a n칰meros (incluir variaciones)\n    const meses = {\n      \"enero\": 0, \"febrero\": 1, \"marzo\": 2, \"abril\": 3, \"mayo\": 4, \"junio\": 5,\n      \"julio\": 6, \"agosto\": 7, \"septiembre\": 8, \"octubre\": 9, \"noviembre\": 10, \"diciembre\": 11,\n      // Variaciones comunes\n      \"ene\": 0, \"feb\": 1, \"mar\": 2, \"abr\": 3, \"may\": 4, \"jun\": 5,\n      \"jul\": 6, \"ago\": 7, \"sep\": 8, \"oct\": 9, \"nov\": 10, \"dic\": 11\n    };\n    \n    // Extraer d칤a, mes, a침o\n    const partes = fechaNormalizada.split(/\\s+/).filter(p => p.length > 0);\n    console.log(\"[DEBUG] Partes de la fecha:\", partes);\n    \n    let dia, mes, a침o;\n    \n    // Intentar diferentes formatos\n    if (partes.length >= 3) {\n      // Formato \"15 abril 2025\" o \"15 de abril 2025\"\n      dia = parseInt(partes[0]);\n      \n      // Buscar el mes en las partes (puede estar en posici칩n 1 o 2)\n      let mesEncontrado = false;\n      for (let i = 1; i < partes.length - 1; i++) {\n        if (meses.hasOwnProperty(partes[i])) {\n          mes = meses[partes[i]];\n          mesEncontrado = true;\n          break;\n        }\n      }\n      \n      if (!mesEncontrado) {\n        throw new Error(\"Mes no reconocido en: \" + fechaStr);\n      }\n      \n      a침o = parseInt(partes[partes.length - 1]);\n      \n    } else if (partes.length === 2) {\n      // Formato \"15 abril\" (asumimos a침o actual)\n      dia = parseInt(partes[0]);\n      \n      if (meses.hasOwnProperty(partes[1])) {\n        mes = meses[partes[1]];\n      } else {\n        throw new Error(\"Mes no reconocido: \" + partes[1]);\n      }\n      \n      a침o = new Date().getFullYear();\n      \n    } else if (partes.length === 1) {\n      // Intentar formato \"15/04/2025\" o \"15-04-2025\"\n      if (/^\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{2,4}$/.test(partes[0])) {\n        const partesNumero = partes[0].split(/[\\/\\-]/);\n        dia = parseInt(partesNumero[0]);\n        mes = parseInt(partesNumero[1]) - 1; // Restar 1 porque en JS los meses van de 0-11\n        a침o = parseInt(partesNumero[2]);\n        if (a침o < 100) a침o += 2000; // Ajustar a침os de 2 d칤gitos\n      } else {\n        throw new Error(\"Formato de fecha no reconocido: \" + fechaStr);\n      }\n    } else {\n      throw new Error(\"Formato de fecha no reconocido (partes insuficientes): \" + fechaStr);\n    }\n    \n    console.log(\"[DEBUG] Componentes extra칤dos - D칤a:\", dia, \"Mes:\", mes, \"A침o:\", a침o);\n    \n    // Verificar que los valores sean v치lidos\n    if (isNaN(dia) || mes === undefined || isNaN(mes) || isNaN(a침o)) {\n      throw new Error(\"Componentes de fecha no v치lidos - D칤a: \" + dia + \", Mes: \" + mes + \", A침o: \" + a침o + \" en: \" + fechaStr);\n    }\n    \n    // Validar rangos\n    if (dia < 1 || dia > 31) {\n      throw new Error(\"D칤a fuera de rango (1-31): \" + dia);\n    }\n    \n    if (mes < 0 || mes > 11) {\n      throw new Error(\"Mes fuera de rango (0-11): \" + mes);\n    }\n    \n    if (a침o < 1900 || a침o > 2100) {\n      throw new Error(\"A침o fuera de rango (1900-2100): \" + a침o);\n    }\n    \n    // Crear el objeto Date\n    const fechaResultado = new Date(a침o, mes, dia);\n    \n    // Verificar que la fecha se cre칩 correctamente\n    if (isNaN(fechaResultado.getTime())) {\n      throw new Error(\"Fecha inv치lida creada: \" + fechaResultado);\n    }\n    \n    console.log(\"[DEBUG] Fecha parseada exitosamente:\", fechaResultado);\n    return fechaResultado;\n    \n  } catch (e) {\n    console.error(\"[ERROR] Error al parsear fecha '\", fechaStr, \"':\", e.message);\n    throw e;\n  }\n}\n\n/**\n * Parsea una hora en formato espa침ol a un objeto Date\n */\nfunction parsearHora(horaStr, fechaBase) {\n  try {\n    // Normalizar la hora\n    const horaNormalizada = horaStr.toLowerCase().trim();\n    \n    // Extraer la hora y los minutos\n    let hora, minutos;\n    let esPM = false;\n    \n    // Verificar si es PM\n    if (horaNormalizada.includes(\"pm\") || \n        horaNormalizada.includes(\"p.m.\") || \n        horaNormalizada.includes(\"tarde\") ||\n        horaNormalizada.includes(\"noche\")) {\n      esPM = true;\n    }\n    \n    // Extraer la hora y minutos num칠ricos\n    const matchHora = horaNormalizada.match(/(\\d+)(?::(\\d+))?/);\n    if (matchHora) {\n      hora = parseInt(matchHora[1]);\n      minutos = matchHora[2] ? parseInt(matchHora[2]) : 0;\n      \n      // Convertir a formato 24 horas si es PM\n      if (esPM && hora < 12) {\n        hora += 12;\n      }\n      \n      // Convertir a formato 24 horas si es AM y son las 12\n      if (!esPM && hora === 12) {\n        hora = 0;\n      }\n    } else {\n      throw new Error(\"Formato de hora no reconocido: \" + horaStr);\n    }\n    \n    // Verificar que los valores sean v치lidos\n    if (isNaN(hora) || isNaN(minutos)) {\n      throw new Error(\"Formato de hora no reconocido: \" + horaStr);\n    }\n    \n    // Crear el objeto Date con la fecha base y la hora extra칤da\n    const resultado = new Date(fechaBase);\n    resultado.setHours(hora, minutos, 0, 0);\n    \n    return resultado;\n  } catch (e) {\n    console.error(\"Error al parsear hora:\", e);\n    throw e;\n  }\n}\n\n/**\n * Verifica si dos fechas corresponden al mismo d칤a\n */\nfunction esMismaFecha(fecha1, fecha2) {\n  return fecha1.getDate() === fecha2.getDate() &&\n         fecha1.getMonth() === fecha2.getMonth() &&\n         fecha1.getFullYear() === fecha2.getFullYear();\n}\n\n/**\n * Verifica si la malla de la pr칩xima semana no existe\n */\nfunction verificarMallaProximaNoExiste(mallaProximaSemana) {\n  // Verificar si la malla pr칩xima semana existe y tiene datos\n  if (!mallaProximaSemana || !mallaProximaSemana.datosMallaProxSemana) {\n    return true;\n  }\n  \n  // Verificar si contiene el mensaje de error espec칤fico en el t칤tulo\n  const titulo = mallaProximaSemana.datosMallaProxSemana.titulo;\n  if (titulo && (\n      titulo.includes(\"丘멆잺\") && \n      (titulo.includes(\"no existe\") || titulo.includes(\"a칰n no ha sido creada\"))\n    )) {\n    return true;\n  }\n  \n  return false;\n}\n\n/**\n * Verifica si ya hubo una confirmaci칩n previa en el historial\n */\nfunction verificarConfirmacionPrevia(historial, mensajeActual) {\n  // Si no hay historial, no puede haber confirmaci칩n previa\n  if (!historial) {\n    return { confirmado: false };\n  }\n\n  // Patrones para detectar solicitud de confirmaci칩n en historial\n  const patrones = [\n    /Por favor,?\\s?confirma/i,\n    /쮺onfirmas/i,\n    /confirma si esta/i,\n    /deseas proceder/i\n  ];\n  \n  // Patrones para detectar confirmaci칩n en mensaje actual\n  const patronesConfirmacion = [\n    /\\bsi\\b/i,\n    /confirmo/i,\n    /exacto/i,\n    /\\bese\\b/i,\n    /correcto/i,\n    /afirmativo/i,\n    /ok\\b/i,\n    /est치 bien/i\n  ];\n\n  // Buscar si hay solicitud de confirmaci칩n en historial\n  let solicitudConfirmacionEncontrada = false;\n  let detalles = {\n    proveedor: \"\",\n    fecha: \"\",\n    hora: \"\",\n    categoria: \"\",\n    peso: 0,\n    unidades: 0,\n    ordenCompra: \"\"\n  };\n\n  // Buscar el 칰ltimo mensaje que pidi칩 confirmaci칩n\n  const mensajes = historial.split(/\\n+/).filter(m => m.trim());\n  \n  for (let i = mensajes.length - 1; i >= 0; i--) {\n    const mensaje = mensajes[i];\n    \n    // Verificar si este mensaje pide confirmaci칩n\n    if (patrones.some(patron => patron.test(mensaje))) {\n      solicitudConfirmacionEncontrada = true;\n      \n      // Extraer proveedor\n      const matchProveedor = mensaje.match(/proveedor\\s+\\*?\\*?([^*\\n.]+)\\*?\\*?/i);\n      if (matchProveedor) {\n        detalles.proveedor = matchProveedor[1].trim();\n      }\n      \n      // Extraer fecha\n      const matchFecha = mensaje.match(/(el d칤a|el|d칤a)\\s+([^,]+?)(?=\\s+a las|\\s+con|\\s+en|\\s+y|$)/i);\n      if (matchFecha) {\n        detalles.fecha = matchFecha[2].trim();\n      }\n      \n      // Extraer hora\n      const matchHora = mensaje.match(/a las\\s+([^,]+?)(?=\\s+con|\\s+en|\\s+y|$)/i);\n      if (matchHora) {\n        detalles.hora = matchHora[1].trim();\n      }\n      \n      // Extraer categor칤a\n      const matchCategoria = mensaje.match(/categor칤a\\s+\\*?\\*?([^*\\n,]+)\\*?\\*?/i);\n      if (matchCategoria) {\n        detalles.categoria = matchCategoria[1].trim();\n      }\n      \n      // Extraer peso\n      const matchPeso = mensaje.match(/(\\d+)\\s+kilos/i);\n      if (matchPeso) {\n        detalles.peso = parseInt(matchPeso[1]);\n      }\n      \n      // Extraer unidades\n      const matchUnidades = mensaje.match(/(\\d+)\\s+unidades/i);\n      if (matchUnidades) {\n        detalles.unidades = parseInt(matchUnidades[1]);\n      }\n      \n      // Extraer orden de compra\n      const matchOrden = mensaje.match(/orden\\s+(?:de compra)?\\s*\\*?\\*?([^*\\n.]+)\\*?\\*?/i);\n      if (matchOrden) {\n        detalles.ordenCompra = matchOrden[1].trim();\n      }\n      \n      break;\n    }\n  }\n\n  // Si encontramos una solicitud de confirmaci칩n, verificar si el mensaje actual es una confirmaci칩n\n  if (solicitudConfirmacionEncontrada) {\n    const esConfirmacion = patronesConfirmacion.some(patron => patron.test(mensajeActual));\n    return {\n      confirmado: esConfirmacion,\n      proveedor: detalles.proveedor,\n      fecha: detalles.fecha,\n      hora: detalles.hora,\n      categoria: detalles.categoria,\n      peso: detalles.peso,\n      unidades: detalles.unidades,\n      ordenCompra: detalles.ordenCompra\n    };\n  }\n\n  return { confirmado: false };\n}\n\n/**\n * Valida el proveedor contra la lista de proveedores disponibles\n */\nfunction validarProveedor(proveedorInput, listaProveedores) {\n  if (!proveedorInput || !listaProveedores || listaProveedores.length === 0) {\n    return {\n      coincidenciaExacta: false,\n      coincidenciaParcialClara: false,\n      coincidenciasParciales: []\n    };\n  }\n\n  // Normalizar entrada (quitar puntos, comas, convertir a min칰sculas)\n  const proveedorNormalizado = normalizarTexto(proveedorInput);\n  \n  // Si el input es demasiado corto y gen칠rico (menos de 3 caracteres), exigir m치s informaci칩n\n  if (proveedorNormalizado.length < 2) {\n    return {\n      coincidenciaExacta: false,\n      coincidenciaParcialClara: false,\n      coincidenciasParciales: []\n    };\n  }\n  \n  console.log(\"Proveedor normalizado:\", proveedorNormalizado);\n  \n  // Buscar coincidencia exacta (ignorando may칰sculas/min칰sculas)\n  const coincidenciaExacta = listaProveedores.find(p => \n    normalizarTexto(p.proveedor) === proveedorNormalizado\n  );\n  \n  if (coincidenciaExacta) {\n    return {\n      coincidenciaExacta: true,\n      coincidenciaParcialClara: false,\n      coincidenciasParciales: [],\n      nombreCompleto: coincidenciaExacta.proveedor\n    };\n  }\n\n  // Buscar primero coincidencias donde el input es un prefijo exacto\n  const coincidenciasPrefijo = listaProveedores\n    .filter(p => {\n      const nombreNormalizado = normalizarTexto(p.proveedor);\n      // Verificar si el nombre del proveedor comienza con el input exacto\n      return nombreNormalizado.startsWith(proveedorNormalizado);\n    })\n    .map(p => p.proveedor);\n  \n  console.log(\"Coincidencias por prefijo:\", coincidenciasPrefijo);\n    \n  // Si solo hay una coincidencia por prefijo, es una coincidencia clara\n  if (coincidenciasPrefijo.length === 1) {\n    const proveedor = listaProveedores.find(p => p.proveedor === coincidenciasPrefijo[0]);\n    return {\n      coincidenciaExacta: false,\n      coincidenciaParcialClara: true,\n      coincidenciasParciales: [],\n      nombreCompleto: proveedor.proveedor\n    };\n  }\n  \n  // Si hay m칰ltiples coincidencias por prefijo, solicitar clarificaci칩n espec칤fica\n  if (coincidenciasPrefijo.length > 1) {\n    return {\n      coincidenciaExacta: false,\n      coincidenciaParcialClara: false,\n      coincidenciasParciales: coincidenciasPrefijo\n    };\n  }\n\n  // Si no hay coincidencias por prefijo, buscar coincidencias parciales m치s generales\n  const coincidenciasParciales = listaProveedores\n    .filter(p => {\n      const nombreNormalizado = normalizarTexto(p.proveedor);\n      // Verificar si el input est치 contenido en el nombre del proveedor\n      return nombreNormalizado.includes(proveedorNormalizado) || \n             // O si las primeras palabras coinciden\n             nombreNormalizado.split(' ').some((palabra, index, arr) => {\n               if (index < 3) { // Solo considerar las primeras 3 palabras\n                 return proveedorNormalizado.includes(palabra) || \n                        palabra.includes(proveedorNormalizado);\n               }\n               return false;\n             });\n    })\n    .map(p => p.proveedor);\n\n  console.log(\"Coincidencias parciales generales:\", coincidenciasParciales);\n\n  // Si hay solo una coincidencia parcial y es claramente identificable\n  if (coincidenciasParciales.length === 1) {\n    const proveedor = listaProveedores.find(p => p.proveedor === coincidenciasParciales[0]);\n    const nombreNormalizado = normalizarTexto(proveedor.proveedor);\n    \n    // Calcular similitud\n    const palabrasInput = proveedorNormalizado.split(' ');\n    const palabrasProveedor = nombreNormalizado.split(' ');\n    \n    // Si el input tiene al menos 2 palabras y ambas est치n en el nombre del proveedor, considerarlo como claro\n    const palabrasCoincidentes = palabrasInput.filter(palabra => \n      palabrasProveedor.some(p => p.includes(palabra))\n    );\n    \n    const esClaramenteIdentificable = \n      // Si el input es un acr칩nimo que coincide con las iniciales del proveedor\n      (proveedorNormalizado.length <= 5 && esAcronimo(proveedorNormalizado, proveedor.proveedor)) ||\n      // O si hay suficiente coincidencia de palabras\n      (palabrasInput.length >= 2 && palabrasCoincidentes.length >= 2) ||\n      // O si el input es una parte sustancial del nombre del proveedor\n      (nombreNormalizado.startsWith(proveedorNormalizado) && proveedorNormalizado.length >= 3) ||\n      // Casos especiales para mejorar la coincidencia\n      (proveedorNormalizado.includes(\"spb\") && nombreNormalizado.includes(\"spb colombia\"));\n    \n    if (esClaramenteIdentificable) {\n      return {\n        coincidenciaExacta: false,\n        coincidenciaParcialClara: true,\n        coincidenciasParciales: [],\n        nombreCompleto: proveedor.proveedor\n      };\n    }\n  }\n\n  // En caso de m칰ltiples coincidencias o una coincidencia no clara\n  return {\n    coincidenciaExacta: false,\n    coincidenciaParcialClara: false,\n    coincidenciasParciales: coincidenciasParciales\n  };\n}\n\n/**\n * Valida la categor칤a contra la lista de categor칤as disponibles\n */\nfunction validarCategoria(categoriaInput, listaCategorias) {\n  if (!categoriaInput || !listaCategorias || listaCategorias.length === 0) {\n    return {\n      coincidenciaExacta: false,\n      coincidenciaSimilar: false,\n      categoriasSimilares: []\n    };\n  }\n\n  // Normalizar entrada\n  const categoriaNormalizada = normalizarTexto(categoriaInput);\n  \n  // Buscar coincidencia exacta (ignorando may칰sculas/min칰sculas)\n  const coincidenciaExacta = listaCategorias.find(c => \n    normalizarTexto(c.CATEGORIA) === categoriaNormalizada\n  );\n  \n  if (coincidenciaExacta) {\n    return {\n      coincidenciaExacta: true,\n      coincidenciaSimilar: false,\n      categoriasSimilares: [],\n      nombreCompleto: coincidenciaExacta.CATEGORIA\n    };\n  }\n\n  // Caso especial para \"arena\" = \"ARENAS\"\n  if (categoriaNormalizada === \"arena\" && listaCategorias.some(c => normalizarTexto(c.CATEGORIA) === \"arenas\")) {\n    const categoriaArenas = listaCategorias.find(c => normalizarTexto(c.CATEGORIA) === \"arenas\");\n    return {\n      coincidenciaExacta: false,\n      coincidenciaSimilar: true,\n      categoriasSimilares: [],\n      nombreCompleto: categoriaArenas.CATEGORIA\n    };\n  }\n\n  // Buscar variantes similares (singular/plural)\n  for (const categoria of listaCategorias) {\n    const categoriaNombre = normalizarTexto(categoria.CATEGORIA);\n    \n    // Verificar si es una variante singular/plural\n    if (\n      // Si la categor칤a termina en S y sin la S coincide con el input\n      (categoriaNombre.endsWith(\"s\") && categoriaNombre.slice(0, -1) === categoriaNormalizada) ||\n      // O si el input termina en S y sin la S coincide con la categor칤a\n      (categoriaNormalizada.endsWith(\"s\") && categoriaNormalizada.slice(0, -1) === categoriaNombre)\n    ) {\n      return {\n        coincidenciaExacta: false,\n        coincidenciaSimilar: true,\n        categoriasSimilares: [],\n        nombreCompleto: categoria.CATEGORIA\n      };\n    }\n  }\n\n  // Buscar coincidencias parciales\n  const categoriasSimilares = listaCategorias\n    .filter(c => {\n      const nombreNormalizado = normalizarTexto(c.CATEGORIA);\n      return nombreNormalizado.includes(categoriaNormalizada) || \n             categoriaNormalizada.includes(nombreNormalizado);\n    })\n    .map(c => c.CATEGORIA);\n\n  // Si hay solo una coincidencia parcial, considerarla v치lida\n  if (categoriasSimilares.length === 1) {\n    return {\n      coincidenciaExacta: false,\n      coincidenciaSimilar: true,\n      categoriasSimilares: [],\n      nombreCompleto: categoriasSimilares[0]\n    };\n  }\n\n  // En caso de m칰ltiples coincidencias o ninguna coincidencia\n  return {\n    coincidenciaExacta: false,\n    coincidenciaSimilar: false,\n    categoriasSimilares: categoriasSimilares\n  };\n}\n\n/**\n * Funciones auxiliares\n */\n\n// Normaliza texto para comparaciones\nfunction normalizarTexto(texto) {\n  if (!texto) return \"\";\n  \n  return texto\n    .toLowerCase()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // Eliminar acentos\n    .replace(/[^\\w\\s]/g, \"\") // Eliminar puntuaci칩n\n    .trim();\n}\n\n// Verifica si un texto es un acr칩nimo de otro\nfunction esAcronimo(acronimo, textoCompleto) {\n  if (!acronimo || !textoCompleto || typeof textoCompleto !== \"string\") {\n    return false;                                   \n  }\n\n  acronimo = acronimo.replace(/\\./g, \"\").toLowerCase();\n\n  const palabras = textoCompleto.split(/\\s+/);\n  const iniciales = palabras.map(p => p.charAt(0).toLowerCase()).join(\"\");\n\n  const inicialesSignificativas = palabras\n    .filter(p => p.length > 2 && !/^(de|la|el|los|las|y|a|en|con|por|para)$/i.test(p))\n    .map(p => p.charAt(0).toLowerCase())\n    .join(\"\");\n\n  return iniciales.includes(acronimo) ||\n         inicialesSignificativas.includes(acronimo);\n}\n\n\n// Esta es la ejecuci칩n principal\n// Debe estar al final del archivo\nreturn procesarValidacionCita();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3152,
        1376
      ],
      "id": "1d472b84-247b-4746-9242-37270d3873a7",
      "name": "Code RECOLECCI칍N"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b2110549-dd58-46b3-9707-dbbe0a5004f2",
              "leftValue": "={{ $('Code estandarizar respuestas MOSTRAR_FRANJAS').item.json.standardResponse.mensajeSistema.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7120,
        1040
      ],
      "id": "c91f63d5-1aa3-4033-a4bd-7d2cb666db76",
      "name": "Validaci칩n de longitud de caracteres3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        7680,
        944
      ],
      "id": "e081ecac-6192-4496-b430-7bea90bb25a8",
      "name": "No Operation, do nothing5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Consistencia de datos, intenci칩n consultar malla').item.json.mensaje }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7488,
        944
      ],
      "id": "98254bcd-1389-4ac5-a7ee-8339a12b6772",
      "name": "HTTP Request Enviar Mensaje por WhatsApp6"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Code estandarizar respuestas MOSTRAR_FRANJAS').item.json.standardResponse.mensajeSistema }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Code estandarizar respuestas MOSTRAR_FRANJAS').item.json.standardResponse.mensajeSistema.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7488,
        1136
      ],
      "id": "b2bf36fc-c2e9-4150-9f1b-ef204909f1b0",
      "name": "Organiza variables del mensaje3"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT TOP 1 *\nFROM FranjasDisponiblesTemp\nWHERE chat_id = '{{$node[\"Organiza el Mensaje\"].json[\"infoMensaje\"][\"chat_id\"]}}'\nORDER BY timestamp_enviado DESC;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        176,
        2864
      ],
      "id": "e7ef7aba-7a51-4e38-b814-6d84dd1c2e6a",
      "name": "Microsoft SQL Obtener Alternativas",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Versi칩n corregida para la estructura real que estamos recibiendo\nconst resultadosSQL = $node[\"Microsoft SQL Obtener Alternativas\"].json;\n\n// Preparar respuesta por defecto\nlet respuesta = {\n  estado: \"error\",\n  mensaje: \"No se pudo procesar la confirmaci칩n.\",\n  tiempoExpirado: false,\n  alternativasDisponibles: null\n};\n\n// Verificar si hay resultados v치lidos\nif (!resultadosSQL) {\n  respuesta.mensaje = \"No encontramos alternativas disponibles para confirmar. Por favor, inicia el proceso de agendamiento nuevamente.\";\n  return { respuesta };\n}\n\ntry {\n  // Obtener timestamp enviado\n  const timestampEnviado = new Date(resultadosSQL.timestamp_enviado);\n  const ahora = new Date();\n  const tiempoTranscurrido = ahora.getTime() - timestampEnviado.getTime();\n  const tiempoLimiteMs = 5 * 60 * 1000; // 5 minutos en milisegundos\n\n  // Verificar si han pasado m치s de 5 minutos\n  if (tiempoTranscurrido > tiempoLimiteMs) {\n    respuesta.estado = \"expirado\";\n    respuesta.tiempoExpirado = true;\n    respuesta.mensaje = \"Lo sentimos, el tiempo para confirmar ha expirado (m치ximo 5 minutos). Por favor, iniciemos el proceso nuevamente para verificar la disponibilidad actual.\";\n    return { respuesta };\n  }\n\n  // Parsear datos de las franjas\n  const franjasJSON = resultadosSQL.franjas_json;\n  const franjas = JSON.parse(franjasJSON);\n  \n  // Todo est치 bien, actualizar la respuesta\n  respuesta.estado = \"ok\";\n  respuesta.tiempoExpirado = false;\n  respuesta.alternativasDisponibles = franjas;\n  \n  // Obtener datos adicionales importantes\n  if (resultadosSQL.datos_cita_json) {\n    respuesta.datosCita = JSON.parse(resultadosSQL.datos_cita_json);\n  }\n  \n  return { respuesta };\n} catch (error) {\n  console.log('Error al procesar datos:', error);\n  respuesta.mensaje = \"Ocurri칩 un error al procesar los datos. Por favor, inicia el proceso nuevamente.\";\n  return { respuesta };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        2864
      ],
      "id": "52644651-b453-4240-81d8-2227982800fa",
      "name": "Code Verificar Tiempo Transcurrido"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9f152a09-44e9-4eaf-9c88-2b0f1e377191",
              "leftValue": "={{ $json.respuesta.tiempoExpirado }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        864,
        2864
      ],
      "id": "df61be4b-aec1-4b07-bdd3-9cb260f866f2",
      "name": "If Verificar Expiraci칩n"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2128,
        2368
      ],
      "id": "50b5484d-9c58-4043-8c02-27b4e7530a42",
      "name": "OpenAI Chat Model9",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=Eres un asistente de un sistema de agendamiento de citas. Debes notificar que el tiempo para confirmar una cita ha expirado.\n\nGenera un mensaje directo aplicando estos principios de UX para WhatsApp:\n\n**FORMATO Y ESTRUCTURA:**\n1. Usa *negritas* para informaci칩n cr칤tica como tiempos y acciones requeridas\n2. Usa emojis estrat칠gicos: 낋 (tiempo), 丘멆잺 (advertencia), 游댃 (reiniciar proceso)\n3. Estructura la informaci칩n de forma jer치rquica y visual\n4. Destaca el tiempo l칤mite de *5 minutos* con formato apropiado\n\n**CONTENIDO REQUERIDO:**\n1. 낋 Indica claramente que el tiempo de *5 minutos* para confirmar ha expirado\n2. 丘멆잺 Explica brevemente que esta restricci칩n garantiza disponibilidad real y trazabilidad\n3. 游댃 Menciona que es necesario *reiniciar el proceso* debido a cambios constantes en el cronograma\n4. 游닇 Solicita que proporcione *toda la informaci칩n requerida* nuevamente\n5. 游똂 Agradece la comprensi칩n de manera emp치tica\n\n**TONO:** Profesional pero humano, emp치tico reconociendo el inconveniente pero explicando claramente la necesidad del proceso.\n\n**EJEMPLO DE ESTRUCTURA ESPERADA:**\n낋 *Tiempo de confirmaci칩n expirado*\n\n丘멆잺 El sistema no puede confirmar tu cita porque han transcurrido m치s de *5 minutos* desde que te presentamos las opciones disponibles.\n\nEsta restricci칩n nos permite garantizar...\n游댃 Por favor, *reinicia el proceso* proporcionando...\n\n游똂 Agradecemos tu comprensi칩n..."
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        2208,
        2160
      ],
      "id": "82d35922-3439-4b91-a1fc-78d8a2178646",
      "name": "Basic LLM Notificar No Disponibilidad"
    },
    {
      "parameters": {
        "url": "https://graph.microsoft.com/v1.0/sites/a592f886-4560-4e62-9646-1eee7add7abe/drives/b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8/items/01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME/content",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "ExcelMallaRecibido2025"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1152,
        2880
      ],
      "id": "c66a2884-814e-43d4-bf27-468dfa113efb",
      "name": "HTTP Request MALLA DE RECIBO ",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      }
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "ExcelMallaRecibido2025",
        "options": {
          "sheetName": "={{ $('Unificaci칩n y consistencia de datos').item.json.hojaSeleccionada }}"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1408,
        2768
      ],
      "id": "cf2d8157-5966-4531-b2d2-8c0f1b778bd2",
      "name": "Extract MALLA DE RECIBO "
    },
    {
      "parameters": {
        "jsCode": "// Obtener los datos del Excel\nconst excelData = $input.all();\nconst hojaSeleccionada = $('Unificaci칩n y consistencia de datos').first().json.hojaSeleccionada;\n\n// Obtener hora local en Bogot치\nconst ahora = new Date(new Date().toLocaleString(\"en-US\", { timeZone: \"America/Bogota\" }));\nconst diaSemanaActual = ahora.getDay(); // 0=domingo, 1=lunes, ..., 5=viernes\nconst horaActual = ahora.getHours();\nconst minutosActual = ahora.getMinutes();\n// Determinar si es despu칠s de las 16:30\nconst pasoLimiteDia = horaActual > 16 || (horaActual === 16 && minutosActual >= 30);\n\n// Definir estructura de la semana y los d칤as\nconst diasSemana = ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'];\n\n// Mapeo para saber qu칠 d칤as incluir si hoy es x d칤a y pas칩 el l칤mite\n/**\n * Dado el d칤a de la semana actual (0=domingo ... 6=s치bado),\n * devuelve qu칠 d칤as de la semana actual deben incluirse seg칰n si pas칩 el l칤mite.\n */\nfunction diasValidosSemanaActual(diaSemanaActual, pasoLimite) {\n  const mapa = {\n    1: ['martes', 'mi칠rcoles', 'jueves', 'viernes'],   // lunes\n    2: ['mi칠rcoles', 'jueves', 'viernes'],             // martes\n    3: ['jueves', 'viernes'],                          // mi칠rcoles\n    4: ['viernes'],                                     // jueves\n    5: []                                               // viernes (muy tarde para s치bado)\n  };\n  if (diaSemanaActual < 1 || diaSemanaActual > 5) {\n    return []; // s치bado o domingo no se agendan en semana actual\n  }\n  if (!pasoLimite) {\n    // a칰n est치 antes de las 4:30 p.m., se puede incluir el d칤a siguiente\n    const siguiente = diasSemana[diaSemanaActual];\n    return [siguiente, ...mapa[diaSemanaActual]];\n  }\n  return mapa[diaSemanaActual];\n}\n\n// Objeto para almacenar la malla estructurada\nconst mallaEstructurada = {\n  titulo: \"\",\n  a침o: \"\",\n  semana: \"\",\n  rangoDias: \"\",\n  franjas: [],\n  dias: {}\n};\n\n// Tabla de meses y d칤as. Ajusta si necesitas contemplar bisiestos, etc.\nconst meses = {\n  \"enero\": 1,\n  \"febrero\": 2,\n  \"marzo\": 3,\n  \"abril\": 4,\n  \"mayo\": 5,\n  \"junio\": 6,\n  \"julio\": 7,\n  \"agosto\": 8,\n  \"septiembre\": 9,\n  \"octubre\": 10,\n  \"noviembre\": 11,\n  \"diciembre\": 12\n};\n\nconst nombreMes = {\n  1: \"enero\",\n  2: \"febrero\",\n  3: \"marzo\",\n  4: \"abril\",\n  5: \"mayo\",\n  6: \"junio\",\n  7: \"julio\",\n  8: \"agosto\",\n  9: \"septiembre\",\n  10: \"octubre\",\n  11: \"noviembre\",\n  12: \"diciembre\"\n};\n\n/**\n * Funci칩n para determinar si un a침o es bisiesto\n * Un a침o es bisiesto si es divisible por 4, excepto aquellos divisibles por 100 \n * que no son divisibles por 400\n */\nfunction esBisiesto(year) {\n  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n}\n\n/**\n * Funci칩n para obtener el n칰mero de d칤as en un mes, considerando a침os bisiestos\n */\nfunction getDiasMes(mes, a침o) {\n  const diasPorMes = {\n    1: 31, // enero\n    2: esBisiesto(a침o) ? 29 : 28, // febrero - ajustado para a침o bisiesto\n    3: 31, // marzo\n    4: 30, // abril\n    5: 31, // mayo\n    6: 30, // junio\n    7: 31, // julio\n    8: 31, // agosto\n    9: 30, // septiembre\n    10: 31, // octubre\n    11: 30, // noviembre\n    12: 31  // diciembre\n  };\n  \n  return diasPorMes[mes];\n}\n\n/**\n * Funci칩n para eliminar acentos y pasar a min칰sculas (para buscar palabras clave sin importar tildes ni may칰sculas).\n */\nfunction normalizarTexto(texto) {\n  if (typeof texto !== 'string') return \"\";\n  // Normaliza (NFD) y elimina diacr칤ticos, luego pasa a min칰sculas.\n  return texto\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase();\n}\n\n/**\n * Dada la informaci칩n de proveedor, ordenCompra, peso, categor칤a y unidades,\n * revisa si existe la palabra 'fuera de servicio', 'cancelado' o 'reagendado'\n * en cualquiera de esos campos. De ser as칤, retorna ese estado especial;\n * de lo contrario, retorna 'ocupado'.\n * \n * Se ignoran may칰sculas, min칰sculas y tildes.\n */\nfunction determinarEstadoOcupado(proveedor, ordenCompra, peso, categoria, unidades) {\n  const conjunto = `${proveedor} ${ordenCompra} ${peso} ${categoria} ${unidades}`;\n  const texto = normalizarTexto(conjunto);\n\n  if (texto.includes(\"fuera de servicio\")) {\n    return \"fuera de servicio\";\n  }\n  if (texto.includes(\"cancelado\")) {\n    return \"cancelado\";\n  }\n  if (texto.includes(\"reagendado\")) {\n    return \"reagendado\";\n  }\n  return \"ocupado\";  \n}\n\n// -------------------------------------------------------------\n// 1) PROCESAR DATOS (Cabecera, Horas, Muelles, etc.)\n// -------------------------------------------------------------\nfunction procesarDatos(excelData) {\n  const datos = excelData.map(item => item.json);\n  \n  // A) Cabecera (T칤tulo, A침o, Rango)\n  datos.forEach((dato, index) => {\n    // Buscar t칤tulo\n    if (dato.__EMPTY_2 === \"MALLA DE RECIBO CEDI KONFIE IA\") {\n      mallaEstructurada.titulo = dato.__EMPTY_2;\n      \n      // En la siguiente fila puede estar a침o, semana, rango\n      if (index + 1 < datos.length) {\n        const datoSiguiente = datos[index + 1];\n        if (datoSiguiente) {\n          // A침o\n          if (datoSiguiente.__EMPTY_2 && !isNaN(datoSiguiente.__EMPTY_2)) {\n            mallaEstructurada.a침o = datoSiguiente.__EMPTY_2;\n          }\n          // Semana\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"SEMANA\")) {\n              mallaEstructurada.semana = v;\n            }\n          });\n          // Rango: p.ej. \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"LUNES\") && v.includes(\"VIERNES\")) {\n              mallaEstructurada.rangoDias = v;\n            }\n          });\n        }\n      }\n    }\n  });\n  \n  // B) Detectar franjas horarias (.__EMPTY = fracci칩n de d칤a)\n  const franjasHorarias = [];\n  datos.forEach(dato => {\n    if (\n      dato.__EMPTY !== undefined &&\n      typeof dato.__EMPTY === 'number' &&\n      dato.__EMPTY > 0 &&\n      dato.__EMPTY < 1\n    ) {\n      const totalMin = Math.round(dato.__EMPTY * 24 * 60);\n      const hh = Math.floor(totalMin / 60);\n      const mm = totalMin % 60;\n      \n      let periodo = \"AM\";\n      let hora12 = hh;\n      if (hh >= 12) {\n        periodo = \"PM\";\n        hora12 = (hh === 12 ? 12 : hh - 12);\n      }\n      if (hh === 0) {\n        hora12 = 12;\n      }\n      \n      const horaStr = `${hora12}:${String(mm).padStart(2, '0')} ${periodo}`;\n      franjasHorarias.push({\n        hora: horaStr,\n        indice: datos.indexOf(dato) // fila base\n      });\n    }\n  });\n  franjasHorarias.sort((a, b) => a.indice - b.indice);\n  mallaEstructurada.franjas = franjasHorarias;\n  \n  // C) Detectar muelles (col)\n  const muellesInfo = {};\n  datos.forEach(dato => {\n    Object.entries(dato).forEach(([key, value]) => {\n      if (value === \"MUELLE 01\" || value === \"MUELLE 02\") {\n        const col = parseInt(key.replace(\"__EMPTY_\", \"\"), 10);\n        const muelleKey = (value === \"MUELLE 01\") ? 'muelle1' : 'muelle2';\n        if (!muellesInfo[muelleKey]) {\n          muellesInfo[muelleKey] = [];\n        }\n        muellesInfo[muelleKey].push(col);\n      }\n    });\n  });\n  if (muellesInfo.muelle1) muellesInfo.muelle1.sort((a, b) => a - b);\n  if (muellesInfo.muelle2) muellesInfo.muelle2.sort((a, b) => a - b);\n  \n  // D) Generar los 5 d칤as (lunes-viernes) con su fecha\n  parsearRangoDias();\n  \n  // E) Extraer Citas\n  extraerCitas(datos, muellesInfo);\n  \n  return mallaEstructurada;\n}\n\n/**\n * Parsea la cadena \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n * (o \"LUNES 31 AL VIERNES 04 DE ABRIL\") y maneja el cruce de mes.\n * Ej.: si dayStart=31 y dayEnd=4, la 1춹 fecha es 31 de MARZO,\n * luego 1,2,3,4 de ABRIL, en vez de 32,33, etc.\n */\nfunction parsearRangoDias() {\n  const texto = mallaEstructurada.rangoDias;\n  // Regex simple: p.ej. \"31 AL ... 4 DE ABRIL\"\n  // Captura: dayStart, dayEnd, mesFin\n  // Ojo: si dice \"LUNES 31 DE MARZO AL VIERNES 4 DE ABRIL\",\n  // quedar치: dayStart=31, dayEnd=4, month=ABRIL (al final).\n  const regex = /(\\d+)\\s+AL\\s+\\D+(\\d+)\\s+DE\\s+(\\w+)/i;\n  const match = regex.exec(texto);\n  \n  // Por defecto, creamos 5 d칤as vac칤os sin fecha\n  diasSemana.forEach(d => {\n    mallaEstructurada.dias[d] = {\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  if (!match) {\n    // Sin coincidencia, dejamos los d칤as sin fecha\n    return;\n  }\n  \n  const dayStart = parseInt(match[1], 10); // 31\n  const dayEnd   = parseInt(match[2], 10); // 4\n  const finalMonthName = match[3].toLowerCase(); // \"abril\"\n  \n  // Convertimos a n칰mero\n  const finalMonth = meses[finalMonthName] || 3; // fallback marzo\n  const yearNum = parseInt(mallaEstructurada.a침o, 10) || 2025;\n  \n  // Funci칩n para obtener la fecha formateada\n  function fechaFormateada(d, m, y) {\n    return `${d} de ${nombreMes[m]} de ${y}`;\n  }\n  \n  // Comprobamos cu치ntos d칤as tiene el mes final, considerando bisiestos\n  const diasMesFinal = getDiasMes(finalMonth, yearNum);\n  // y del mes previo\n  const monthPrev = (finalMonth === 1) ? 12 : finalMonth - 1;\n  const yearPrev = (finalMonth === 1) ? yearNum - 1 : yearNum;\n  \n  // Arreglo final con 5 fechas\n  const fechasDias = [];\n  \n  if (dayStart <= dayEnd) {\n    // Caso \"normal\": todo en el mismo mes\n    let d = dayStart;\n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: finalMonth,\n        yearNum: yearNum\n      });\n      d++;\n      if (d > diasMesFinal) {\n        d = 1;\n        const nextMonth = finalMonth % 12 + 1;\n        const nextYear = (nextMonth === 1) ? yearNum + 1 : yearNum;\n        fechasDias[fechasDias.length - 1].mesNum = nextMonth;\n        fechasDias[fechasDias.length - 1].yearNum = nextYear;\n      }\n    }\n  } else {\n    // Caso \"cruza de mes\": dayStart > dayEnd\n    let d = dayStart;\n    let m = monthPrev;\n    let y = yearPrev;\n    \n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: m,\n        yearNum: y\n      });\n      d++;\n      if (d > getDiasMes(m, y)) {\n        d = 1;\n        m = m % 12 + 1;\n        if (m === 1) {\n          y++;\n        }\n      }\n    }\n  }\n  \n  // Ahora volcamos esas 5 fechas en la estructura\n  fechasDias.forEach(fd => {\n    const { diaSem, diaNum, mesNum, yearNum } = fd;\n    mallaEstructurada.dias[diaSem] = {\n      fechaDia: fechaFormateada(diaNum, mesNum, yearNum),\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  // Inicializamos las franjas a 'disponible'\n  if (mallaEstructurada.franjas.length > 0) {\n    diasSemana.forEach(d => {\n      mallaEstructurada.franjas.forEach(f => {\n        mallaEstructurada.dias[d].muelle1[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n        mallaEstructurada.dias[d].muelle2[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n      });\n    });\n  }\n}\n\n/**\n * Funci칩n auxiliar: decide a qu칠 d칤a pertenece una columna,\n * corrigiendo 2 columnas de offset (porque 'Extract from XLSX'\n * deja todo desplazado).\n */\nfunction getDayForColumn(colNumber) {\n  // Ajuste de offset +2\n  const realCol = colNumber + 2;\n\n  // Rangos:\n  //  Lunes:      3..8\n  //  Martes:     9..14\n  //  Mi칠rcoles: 15..20\n  //  Jueves:    21..26\n  //  Viernes:   27..32\n  if (realCol >= 3 && realCol <= 8) {\n    return \"lunes\";\n  }\n  if (realCol >= 9 && realCol <= 14) {\n    return \"martes\";\n  }\n  if (realCol >= 15 && realCol <= 20) {\n    return \"mi칠rcoles\";\n  }\n  if (realCol >= 21 && realCol <= 26) {\n    return \"jueves\";\n  }\n  if (realCol >= 27 && realCol <= 32) {\n    return \"viernes\";\n  }\n  // Si nada coincide, devolvemos null\n  return null;\n}\n\n/**\n * Extraer las citas para cada franja:\n * - Para cada franja, miramos 3 filas:\n *    - Fila base => proveedor\n *    - Fila base+1 => orden\n *    - Fila base+2 => peso, categor칤a, unidades\n */\nfunction extraerCitas(datos, muellesInfo) {\n  mallaEstructurada.franjas.forEach(franja => {\n    const indiceBase = franja.indice;\n    if (indiceBase < 0 || indiceBase + 2 >= datos.length) {\n      return; // no hay suficientes filas\n    }\n    \n    // Recorremos muelle1, muelle2 y sus columnas\n    const asignarCita = (muelleKey, cols) => {\n      cols.forEach(col => {\n        const provKey = `__EMPTY_${col}`;\n        const filaProv = datos[indiceBase];\n        \n        // Si en esta fila hay un proveedor o alg칰n texto\n        if (\n          filaProv &&\n          typeof filaProv[provKey] === 'string' &&\n          filaProv[provKey].length > 2\n        ) {\n          // Determinar el d칤a real\n          const diaOk = getDayForColumn(col);\n          if (!diaOk || !mallaEstructurada.dias[diaOk]) {\n            return; // si no coincide con ninguno, saltamos\n          }\n          \n          // Recuperar valores para proveedor, ordenCompra y dem치s\n          const filaOrden = datos[indiceBase + 1];\n          const filaDet = datos[indiceBase + 2];\n          \n          const proveedor = filaProv[provKey] || \"\";\n          const ordenCompra = filaOrden && filaOrden[provKey] ? filaOrden[provKey] : \"\";\n          const peso = filaDet && filaDet[provKey] ? filaDet[provKey] : \"\";\n          const cat  = filaDet && filaDet[`__EMPTY_${col + 1}`] ? filaDet[`__EMPTY_${col + 1}`] : \"\";\n          const und  = filaDet && filaDet[`__EMPTY_${col + 2}`] ? filaDet[`__EMPTY_${col + 2}`] : \"\";\n          \n          // Antes pon칤amos estado=\"ocupado\" directamente\n          // Ahora verificamos si el texto contiene \"reagendado\", \"cancelado\" o \"fuera de servicio\".\n          const nuevoEstado = determinarEstadoOcupado(proveedor, ordenCompra, peso, cat, und);\n          \n          // Asignamos los datos\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].estado = nuevoEstado;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].proveedor = proveedor;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].ordenCompra = ordenCompra;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].peso = peso;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].categoria = cat;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].unidades = und;\n        }\n      });\n    };\n    \n    if (muellesInfo.muelle1) {\n      asignarCita('muelle1', muellesInfo.muelle1);\n    }\n    if (muellesInfo.muelle2) {\n      asignarCita('muelle2', muellesInfo.muelle2);\n    }\n  });\n}\n\n// -------------------------------------------------------------\n// 2) FUNCIONES PARA CONSULTAR LA MALLA\n// -------------------------------------------------------------\nfunction buscarFranjasDisponibles(categoria, duracionHoras) {\n  const muelle = \"muelle1\"; // Ajusta si usas \"categoria -> muelle\" real\n  \n  const franjasDisponibles = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const libres = [];\n    for (let i = 0; i <= mallaEstructurada.franjas.length - duracionHoras; i++) {\n      let disponible = true;\n      for (let h = 0; h < duracionHoras; h++) {\n        const idxF = i + h;\n        const horaAct = mallaEstructurada.franjas[idxF].hora;\n        if (\n          mallaEstructurada.dias[dia][muelle][horaAct].estado !== 'disponible'\n        ) {\n          disponible = false;\n          break;\n        }\n      }\n      if (disponible) {\n        libres.push({\n          horaInicio: mallaEstructurada.franjas[i].hora,\n          duracion: duracionHoras\n        });\n      }\n    }\n    if (libres.length > 0) {\n      franjasDisponibles.push({ dia, franjas: libres });\n    }\n  });\n  return franjasDisponibles;\n}\n\nfunction buscarCitasProveedor(nombreProveedor) {\n  const citas = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const muelle1 = mallaEstructurada.dias[dia].muelle1;\n    const muelle2 = mallaEstructurada.dias[dia].muelle2;\n    mallaEstructurada.franjas.forEach(f => {\n      const hora = f.hora;\n      // muelle1\n      if (normalizarTexto(muelle1[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 01\",\n          ordenCompra: muelle1[hora].ordenCompra,\n          peso: muelle1[hora].peso,\n          categoria: muelle1[hora].categoria,\n          unidades: muelle1[hora].unidades,\n          estado: muelle1[hora].estado\n        });\n      }\n      // muelle2\n      if (normalizarTexto(muelle2[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 02\",\n          ordenCompra: muelle2[hora].ordenCompra,\n          peso: muelle2[hora].peso,\n          categoria: muelle2[hora].categoria,\n          unidades: muelle2[hora].unidades,\n          estado: muelle2[hora].estado\n        });\n      }\n    });\n  });\n  return citas;\n}\n\nfunction consultarFranjasDisponibles(categoria, duracionHoras) {\n  return buscarFranjasDisponibles(categoria, duracionHoras);\n}\n\nfunction consultarCitasProveedor(nombreProveedor) {\n  return buscarCitasProveedor(nombreProveedor);\n}\n\nfunction obtenerInfoMalla() {\n  return {\n    titulo: mallaEstructurada.titulo,\n    a침o: mallaEstructurada.a침o,\n    semana: mallaEstructurada.semana,\n    rangoDias: mallaEstructurada.rangoDias,\n    franjas: mallaEstructurada.franjas.map(f => f.hora)\n  };\n}\n\nfunction estaDisponible(dia, hora, muelle) {\n  const info = mallaEstructurada.dias[dia]?.[muelle]?.[hora];\n  return info ? (info.estado === 'disponible') : false;\n}\n\nfunction obtenerCoordenadasCita(dia, hora, muelle) {\n  // Ajustar con tu mapeo de celdas en Excel\n  return {\n    proveedor: `${dia}_${hora}_${muelle}_proveedor`,\n    ordenCompra: `${dia}_${hora}_${muelle}_ordenCompra`,\n    peso: `${dia}_${hora}_${muelle}_peso`,\n    categoria: `${dia}_${hora}_${muelle}_categoria`,\n    unidades: `${dia}_${hora}_${muelle}_unidades`\n  };\n}\n\n// -------------------------------------------------------------\n// 3) EJECUTAR TODO Y RETORNAR\n// -------------------------------------------------------------\n// Procesar todos los datos\nconst malla = procesarDatos(excelData);\n\n// Aplicar el filtro de d칤as v치lidos seg칰n la hora actual\nconst diasPermitidos = diasValidosSemanaActual(diaSemanaActual, pasoLimiteDia);\nObject.keys(malla.dias).forEach(dia => {\n  if (!diasPermitidos.includes(dia)) {\n    delete malla.dias[dia]; // eliminar d칤as no v치lidos\n  }\n});\n\nconst resultado = {\n  datosMalla: malla,\n  funciones: {\n    consultarFranjasDisponibles,\n    consultarCitasProveedor,\n    obtenerInfoMalla,\n    estaDisponible,\n    obtenerCoordenadasCita\n  }\n};\n\nreturn [resultado];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        2768
      ],
      "id": "1c2a0f71-5bc6-4e3a-a73d-d62b120a01c9",
      "name": "Estructuraci칩n, Datos, Consulta, Citas1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        1968,
        2864
      ],
      "id": "34eb5ead-36cc-41aa-9dc6-6c20bc313ff2",
      "name": "Merge datos Excel1"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    datosMalla: $items(\"Merge datos Excel1\")[0].json.datosMalla,\n    datosMallaProxSemana: $items(\"Merge datos Excel1\")[1].json.datosMallaProxSemana,\n    hojaSeleccionada: $items(\"Merge datos Excel1\")[0].json.datosMalla.semana\n  }\n}];\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2224,
        2864
      ],
      "id": "092eb4e9-6e4a-4697-a96a-8bb3d30f4096",
      "name": "Unificaci칩n y consistencia de datos2"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "ExcelMallaRecibido2025",
        "options": {
          "sheetName": "={{    (function() {     const semanaActual = $('Unificaci칩n y consistencia de datos').item.json.hojaSeleccionada;     const numeroSemana = parseInt(semanaActual.replace(\"SEMANA \", \"\"));     return `SEMANA ${numeroSemana + 1}`;   })() }}"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1408,
        2960
      ],
      "id": "70f7ed3a-d8ab-444c-bec0-c47c571bbb95",
      "name": "Extract MALLA DE RECIBO Semana Siguiente1",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Si el nodo anterior no devolvi칩 datos (por error al no existir la hoja), retornamos estructura vac칤a con mensaje\n// Obtener los datos del Excel\nconst excelData = $input.all();\n\n// Mejora en la detecci칩n de errores: verificar si hay error expl칤cito o si los datos no son v치lidos\nconst hayError = excelData.some(item => item.json && item.json.error);\nconst datosInvalidos = !excelData || excelData.length === 0 || hayError;\n\nif (datosInvalidos) {\n  return [{\n    datosMallaProxSemana: {\n      titulo: \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\",\n      a침o: \"\",\n      semana: \"\",\n      rangoDias: \"\",\n      franjas: [],\n      dias: {\n        lunes: { muelle1: {}, muelle2: {} },\n        martes: { muelle1: {}, muelle2: {} },\n        mi칠rcoles: { muelle1: {}, muelle2: {} },\n        jueves: { muelle1: {}, muelle2: {} },\n        viernes: { muelle1: {}, muelle2: {} }\n      }\n    },\n    funciones: {\n      consultarFranjasDisponibles: \"function not available\",\n      consultarCitasProveedor: \"function not available\",\n      obtenerInfoMalla: \"function not available\",\n      estaDisponible: \"function not available\",\n      obtenerCoordenadasCita: \"function not available\"\n    }\n  }];\n}\n\n// El resto del c칩digo permanece igual...\nconst hojaSeleccionada = $('Unificaci칩n y consistencia de datos').first().json.hojaSeleccionada;\n\n// Definir estructura de la semana y los d칤as\nconst diasSemana = ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'];\n\n// Objeto para almacenar la malla estructurada\nconst mallaEstructurada = {\n  titulo: \"\",\n  a침o: \"\",\n  semana: \"\",\n  rangoDias: \"\",\n  franjas: [],\n  dias: {}\n};\n\n// Tabla de meses y d칤as. Ajusta si necesitas contemplar bisiestos, etc.\nconst meses = {\n  \"enero\": 1,\n  \"febrero\": 2,\n  \"marzo\": 3,\n  \"abril\": 4,\n  \"mayo\": 5,\n  \"junio\": 6,\n  \"julio\": 7,\n  \"agosto\": 8,\n  \"septiembre\": 9,\n  \"octubre\": 10,\n  \"noviembre\": 11,\n  \"diciembre\": 12\n};\n\nconst nombreMes = {\n  1: \"enero\",\n  2: \"febrero\",\n  3: \"marzo\",\n  4: \"abril\",\n  5: \"mayo\",\n  6: \"junio\",\n  7: \"julio\",\n  8: \"agosto\",\n  9: \"septiembre\",\n  10: \"octubre\",\n  11: \"noviembre\",\n  12: \"diciembre\"\n};\n\n/**\n * Funci칩n para determinar si un a침o es bisiesto\n * Un a침o es bisiesto si es divisible por 4, excepto aquellos divisibles por 100 \n * que no son divisibles por 400\n */\nfunction esBisiesto(year) {\n  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n}\n\n/**\n * Funci칩n para obtener el n칰mero de d칤as en un mes, considerando a침os bisiestos\n */\nfunction getDiasMes(mes, a침o) {\n  const diasPorMes = {\n    1: 31, // enero\n    2: esBisiesto(a침o) ? 29 : 28, // febrero - ajustado para a침o bisiesto\n    3: 31, // marzo\n    4: 30, // abril\n    5: 31, // mayo\n    6: 30, // junio\n    7: 31, // julio\n    8: 31, // agosto\n    9: 30, // septiembre\n    10: 31, // octubre\n    11: 30, // noviembre\n    12: 31  // diciembre\n  };\n  \n  return diasPorMes[mes];\n}\n\n/**\n * Funci칩n para eliminar acentos y pasar a min칰sculas (para buscar palabras clave sin importar tildes ni may칰sculas).\n */\nfunction normalizarTexto(texto) {\n  if (typeof texto !== 'string') return \"\";\n  // Normaliza (NFD) y elimina diacr칤ticos, luego pasa a min칰sculas.\n  return texto\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase();\n}\n\n/**\n * Dada la informaci칩n de proveedor, ordenCompra, peso, categor칤a y unidades,\n * revisa si existe la palabra 'fuera de servicio', 'cancelado' o 'reagendado'\n * en cualquiera de esos campos. De ser as칤, retorna ese estado especial;\n * de lo contrario, retorna 'ocupado'.\n * \n * Se ignoran may칰sculas, min칰sculas y tildes.\n */\nfunction determinarEstadoOcupado(proveedor, ordenCompra, peso, categoria, unidades) {\n  const conjunto = `${proveedor} ${ordenCompra} ${peso} ${categoria} ${unidades}`;\n  const texto = normalizarTexto(conjunto);\n\n  if (texto.includes(\"fuera de servicio\")) {\n    return \"fuera de servicio\";\n  }\n  if (texto.includes(\"cancelado\")) {\n    return \"cancelado\";\n  }\n  if (texto.includes(\"reagendado\")) {\n    return \"reagendado\";\n  }\n  return \"ocupado\";  \n}\n\n// -------------------------------------------------------------\n// 1) PROCESAR DATOS (Cabecera, Horas, Muelles, etc.)\n// -------------------------------------------------------------\nfunction procesarDatos(excelData) {\n  // Verificaci칩n adicional de datos v치lidos\n  if (!excelData || !Array.isArray(excelData) || excelData.length === 0) {\n    return {\n      titulo: \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\",\n      a침o: \"\",\n      semana: \"\",\n      rangoDias: \"\",\n      franjas: [],\n      dias: {\n        lunes: { muelle1: {}, muelle2: {} },\n        martes: { muelle1: {}, muelle2: {} },\n        mi칠rcoles: { muelle1: {}, muelle2: {} },\n        jueves: { muelle1: {}, muelle2: {} },\n        viernes: { muelle1: {}, muelle2: {} }\n      }\n    };\n  }\n  \n  // Intentar mapear datos, con manejo de errores para cada item\n  const datos = excelData.map(item => {\n    try {\n      return item.json || {};\n    } catch (e) {\n      return {};\n    }\n  });\n  \n  // A) Cabecera (T칤tulo, A침o, Rango)\n  datos.forEach((dato, index) => {\n    // Buscar t칤tulo\n    if (dato.__EMPTY_2 === \"MALLA DE RECIBO CEDI KONFIE IA\") {\n      mallaEstructurada.titulo = dato.__EMPTY_2;\n      \n      // En la siguiente fila puede estar a침o, semana, rango\n      if (index + 1 < datos.length) {\n        const datoSiguiente = datos[index + 1];\n        if (datoSiguiente) {\n          // A침o\n          if (datoSiguiente.__EMPTY_2 && !isNaN(datoSiguiente.__EMPTY_2)) {\n            mallaEstructurada.a침o = datoSiguiente.__EMPTY_2;\n          }\n          // Semana\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"SEMANA\")) {\n              mallaEstructurada.semana = v;\n            }\n          });\n          // Rango: p.ej. \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"LUNES\") && v.includes(\"VIERNES\")) {\n              mallaEstructurada.rangoDias = v;\n            }\n          });\n        }\n      }\n    }\n  });\n  \n  // Si despu칠s de procesar no encontramos t칤tulo, es que no hay malla v치lida\n  if (!mallaEstructurada.titulo) {\n    mallaEstructurada.titulo = \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\";\n    return mallaEstructurada;\n  }\n  \n  // B) Detectar franjas horarias (.__EMPTY = fracci칩n de d칤a)\n  const franjasHorarias = [];\n  datos.forEach(dato => {\n    if (\n      dato.__EMPTY !== undefined &&\n      typeof dato.__EMPTY === 'number' &&\n      dato.__EMPTY > 0 &&\n      dato.__EMPTY < 1\n    ) {\n      const totalMin = Math.round(dato.__EMPTY * 24 * 60);\n      const hh = Math.floor(totalMin / 60);\n      const mm = totalMin % 60;\n      \n      let periodo = \"AM\";\n      let hora12 = hh;\n      if (hh >= 12) {\n        periodo = \"PM\";\n        hora12 = (hh === 12 ? 12 : hh - 12);\n      }\n      if (hh === 0) {\n        hora12 = 12;\n      }\n      \n      const horaStr = `${hora12}:${String(mm).padStart(2, '0')} ${periodo}`;\n      franjasHorarias.push({\n        hora: horaStr,\n        indice: datos.indexOf(dato) // fila base\n      });\n    }\n  });\n  franjasHorarias.sort((a, b) => a.indice - b.indice);\n  mallaEstructurada.franjas = franjasHorarias;\n  \n  // C) Detectar muelles (col)\n  const muellesInfo = {};\n  datos.forEach(dato => {\n    Object.entries(dato).forEach(([key, value]) => {\n      if (value === \"MUELLE 01\" || value === \"MUELLE 02\") {\n        const col = parseInt(key.replace(\"__EMPTY_\", \"\"), 10);\n        const muelleKey = (value === \"MUELLE 01\") ? 'muelle1' : 'muelle2';\n        if (!muellesInfo[muelleKey]) {\n          muellesInfo[muelleKey] = [];\n        }\n        muellesInfo[muelleKey].push(col);\n      }\n    });\n  });\n  if (muellesInfo.muelle1) muellesInfo.muelle1.sort((a, b) => a - b);\n  if (muellesInfo.muelle2) muellesInfo.muelle2.sort((a, b) => a - b);\n  \n  // D) Generar los 5 d칤as (lunes-viernes) con su fecha\n  parsearRangoDias();\n  \n  // E) Extraer Citas\n  extraerCitas(datos, muellesInfo);\n  \n  return mallaEstructurada;\n}\n\n/**\n * Parsea la cadena \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n * (o \"LUNES 31 AL VIERNES 04 DE ABRIL\") y maneja el cruce de mes.\n * Ej.: si dayStart=31 y dayEnd=4, la 1춹 fecha es 31 de MARZO,\n * luego 1,2,3,4 de ABRIL, en vez de 32,33, etc.\n */\nfunction parsearRangoDias() {\n  const texto = mallaEstructurada.rangoDias;\n  // Regex simple: p.ej. \"31 AL ... 4 DE ABRIL\"\n  // Captura: dayStart, dayEnd, mesFin\n  // Ojo: si dice \"LUNES 31 DE MARZO AL VIERNES 4 DE ABRIL\",\n  // quedar치: dayStart=31, dayEnd=4, month=ABRIL (al final).\n  const regex = /(\\d+)\\s+AL\\s+\\D+(\\d+)\\s+DE\\s+(\\w+)/i;\n  const match = regex.exec(texto);\n  \n  // Por defecto, creamos 5 d칤as vac칤os sin fecha\n  diasSemana.forEach(d => {\n    mallaEstructurada.dias[d] = {\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  if (!match) {\n    // Sin coincidencia, dejamos los d칤as sin fecha\n    return;\n  }\n  \n  const dayStart = parseInt(match[1], 10); // 31\n  const dayEnd   = parseInt(match[2], 10); // 4\n  const finalMonthName = match[3].toLowerCase(); // \"abril\"\n  \n  // Convertimos a n칰mero\n  const finalMonth = meses[finalMonthName] || 3; // fallback marzo\n  const yearNum = parseInt(mallaEstructurada.a침o, 10) || 2025;\n  \n  // Funci칩n para obtener la fecha formateada\n  function fechaFormateada(d, m, y) {\n    return `${d} de ${nombreMes[m]} de ${y}`;\n  }\n  \n  // Comprobamos cu치ntos d칤as tiene el mes final, considerando bisiestos\n  const diasMesFinal = getDiasMes(finalMonth, yearNum);\n  // y del mes previo\n  const monthPrev = (finalMonth === 1) ? 12 : finalMonth - 1;\n  const yearPrev = (finalMonth === 1) ? yearNum - 1 : yearNum;\n  \n  // Arreglo final con 5 fechas\n  const fechasDias = [];\n  \n  if (dayStart <= dayEnd) {\n    // Caso \"normal\": todo en el mismo mes\n    let d = dayStart;\n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: finalMonth,\n        yearNum: yearNum\n      });\n      d++;\n      if (d > diasMesFinal) {\n        d = 1;\n        const nextMonth = finalMonth % 12 + 1;\n        const nextYear = (nextMonth === 1) ? yearNum + 1 : yearNum;\n        fechasDias[fechasDias.length - 1].mesNum = nextMonth;\n        fechasDias[fechasDias.length - 1].yearNum = nextYear;\n      }\n    }\n  } else {\n    // Caso \"cruza de mes\": dayStart > dayEnd\n    let d = dayStart;\n    let m = monthPrev;\n    let y = yearPrev;\n    \n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: m,\n        yearNum: y\n      });\n      d++;\n      if (d > getDiasMes(m, y)) {\n        d = 1;\n        m = m % 12 + 1;\n        if (m === 1) {\n          y++;\n        }\n      }\n    }\n  }\n  \n  // Ahora volcamos esas 5 fechas en la estructura\n  fechasDias.forEach(fd => {\n    const { diaSem, diaNum, mesNum, yearNum } = fd;\n    mallaEstructurada.dias[diaSem] = {\n      fechaDia: fechaFormateada(diaNum, mesNum, yearNum),\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  // Inicializamos las franjas a 'disponible'\n  if (mallaEstructurada.franjas.length > 0) {\n    diasSemana.forEach(d => {\n      mallaEstructurada.franjas.forEach(f => {\n        mallaEstructurada.dias[d].muelle1[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n        mallaEstructurada.dias[d].muelle2[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n      });\n    });\n  }\n}\n\n/**\n * Funci칩n auxiliar: decide a qu칠 d칤a pertenece una columna,\n * corrigiendo 2 columnas de offset (porque 'Extract from XLSX'\n * deja todo desplazado).\n */\nfunction getDayForColumn(colNumber) {\n  // Ajuste de offset +2\n  const realCol = colNumber + 2;\n\n  // Rangos:\n  //  Lunes:      3..8\n  //  Martes:     9..14\n  //  Mi칠rcoles: 15..20\n  //  Jueves:    21..26\n  //  Viernes:   27..32\n  if (realCol >= 3 && realCol <= 8) {\n    return \"lunes\";\n  }\n  if (realCol >= 9 && realCol <= 14) {\n    return \"martes\";\n  }\n  if (realCol >= 15 && realCol <= 20) {\n    return \"mi칠rcoles\";\n  }\n  if (realCol >= 21 && realCol <= 26) {\n    return \"jueves\";\n  }\n  if (realCol >= 27 && realCol <= 32) {\n    return \"viernes\";\n  }\n  // Si nada coincide, devolvemos null\n  return null;\n}\n\n/**\n * Extraer las citas para cada franja:\n * - Para cada franja, miramos 3 filas:\n *    - Fila base => proveedor\n *    - Fila base+1 => orden\n *    - Fila base+2 => peso, categor칤a, unidades\n */\nfunction extraerCitas(datos, muellesInfo) {\n  mallaEstructurada.franjas.forEach(franja => {\n    const indiceBase = franja.indice;\n    if (indiceBase < 0 || indiceBase + 2 >= datos.length) {\n      return; // no hay suficientes filas\n    }\n    \n    // Recorremos muelle1, muelle2 y sus columnas\n    const asignarCita = (muelleKey, cols) => {\n      cols.forEach(col => {\n        const provKey = `__EMPTY_${col}`;\n        const filaProv = datos[indiceBase];\n        \n        // Si en esta fila hay un proveedor o alg칰n texto\n        if (\n          filaProv &&\n          typeof filaProv[provKey] === 'string' &&\n          filaProv[provKey].length > 2\n        ) {\n          // Determinar el d칤a real\n          const diaOk = getDayForColumn(col);\n          if (!diaOk || !mallaEstructurada.dias[diaOk]) {\n            return; // si no coincide con ninguno, saltamos\n          }\n          \n          // Recuperar valores para proveedor, ordenCompra y dem치s\n          const filaOrden = datos[indiceBase + 1];\n          const filaDet = datos[indiceBase + 2];\n          \n          const proveedor = filaProv[provKey] || \"\";\n          const ordenCompra = filaOrden && filaOrden[provKey] ? filaOrden[provKey] : \"\";\n          const peso = filaDet && filaDet[provKey] ? filaDet[provKey] : \"\";\n          const cat  = filaDet && filaDet[`__EMPTY_${col + 1}`] ? filaDet[`__EMPTY_${col + 1}`] : \"\";\n          const und  = filaDet && filaDet[`__EMPTY_${col + 2}`] ? filaDet[`__EMPTY_${col + 2}`] : \"\";\n          \n          // Antes pon칤amos estado=\"ocupado\" directamente\n          // Ahora verificamos si el texto contiene \"reagendado\", \"cancelado\" o \"fuera de servicio\".\n          const nuevoEstado = determinarEstadoOcupado(proveedor, ordenCompra, peso, cat, und);\n          \n          // Asignamos los datos\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].estado = nuevoEstado;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].proveedor = proveedor;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].ordenCompra = ordenCompra;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].peso = peso;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].categoria = cat;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].unidades = und;\n        }\n      });\n    };\n    \n    if (muellesInfo.muelle1) {\n      asignarCita('muelle1', muellesInfo.muelle1);\n    }\n    if (muellesInfo.muelle2) {\n      asignarCita('muelle2', muellesInfo.muelle2);\n    }\n  });\n}\n\n// -------------------------------------------------------------\n// 2) FUNCIONES PARA CONSULTAR LA MALLA\n// -------------------------------------------------------------\nfunction buscarFranjasDisponibles(categoria, duracionHoras) {\n  const muelle = \"muelle1\"; // Ajusta si usas \"categoria -> muelle\" real\n  \n  const franjasDisponibles = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const libres = [];\n    for (let i = 0; i <= mallaEstructurada.franjas.length - duracionHoras; i++) {\n      let disponible = true;\n      for (let h = 0; h < duracionHoras; h++) {\n        const idxF = i + h;\n        const horaAct = mallaEstructurada.franjas[idxF].hora;\n        if (\n          mallaEstructurada.dias[dia][muelle][horaAct].estado !== 'disponible'\n        ) {\n          disponible = false;\n          break;\n        }\n      }\n      if (disponible) {\n        libres.push({\n          horaInicio: mallaEstructurada.franjas[i].hora,\n          duracion: duracionHoras\n        });\n      }\n    }\n    if (libres.length > 0) {\n      franjasDisponibles.push({ dia, franjas: libres });\n    }\n  });\n  return franjasDisponibles;\n}\n\nfunction buscarCitasProveedor(nombreProveedor) {\n  const citas = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const muelle1 = mallaEstructurada.dias[dia].muelle1;\n    const muelle2 = mallaEstructurada.dias[dia].muelle2;\n    mallaEstructurada.franjas.forEach(f => {\n      const hora = f.hora;\n      // muelle1\n      if (normalizarTexto(muelle1[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 01\",\n          ordenCompra: muelle1[hora].ordenCompra,\n          peso: muelle1[hora].peso,\n          categoria: muelle1[hora].categoria,\n          unidades: muelle1[hora].unidades,\n          estado: muelle1[hora].estado\n        });\n      }\n      // muelle2\n      if (normalizarTexto(muelle2[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 02\",\n          ordenCompra: muelle2[hora].ordenCompra,\n          peso: muelle2[hora].peso,\n          categoria: muelle2[hora].categoria,\n          unidades: muelle2[hora].unidades,\n          estado: muelle2[hora].estado\n        });\n      }\n    });\n  });\n  return citas;\n}\n\nfunction consultarFranjasDisponibles(categoria, duracionHoras) {\n  return buscarFranjasDisponibles(categoria, duracionHoras);\n}\n\nfunction consultarCitasProveedor(nombreProveedor) {\n  return buscarCitasProveedor(nombreProveedor);\n}\n\nfunction obtenerInfoMalla() {\n  return {\n    titulo: mallaEstructurada.titulo,\n    a침o: mallaEstructurada.a침o,\n    semana: mallaEstructurada.semana,\n    rangoDias: mallaEstructurada.rangoDias,\n    franjas: mallaEstructurada.franjas.map(f => f.hora)\n  };\n}\n\nfunction estaDisponible(dia, hora, muelle) {\n  const info = mallaEstructurada.dias[dia]?.[muelle]?.[hora];\n  return info ? (info.estado === 'disponible') : false;\n}\n\nfunction obtenerCoordenadasCita(dia, hora, muelle) {\n  // Ajustar con tu mapeo de celdas en Excel\n  return {\n    proveedor: `${dia}_${hora}_${muelle}_proveedor`,\n    ordenCompra: `${dia}_${hora}_${muelle}_ordenCompra`,\n    peso: `${dia}_${hora}_${muelle}_peso`,\n    categoria: `${dia}_${hora}_${muelle}_categoria`,\n    unidades: `${dia}_${hora}_${muelle}_unidades`\n  };\n}\n\n// -------------------------------------------------------------\n// 3) EJECUTAR TODO Y RETORNAR\n// -------------------------------------------------------------\nconst malla = procesarDatos(excelData);\n\nconst resultado = {\n  datosMallaProxSemana: malla,\n  funciones: {\n    consultarFranjasDisponibles,\n    consultarCitasProveedor,\n    obtenerInfoMalla,\n    estaDisponible,\n    obtenerCoordenadasCita\n  }\n};\n\nreturn [resultado];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        2960
      ],
      "id": "68371a73-9c18-4dcc-bbb5-638d3e526a6e",
      "name": "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana1"
    },
    {
      "parameters": {
        "jsCode": "// =========  VALIDACI칍N DE CITA EN CRONOGRAMA  =========\n// Valida que la franja siga libre justo despu칠s de la confirmaci칩n del proveedor\n\n// NUEVO: Detectar retractaci칩n al inicio\nconst validacionSeleccion = $input.first().json.output;\n\nif (validacionSeleccion.esRetractacion === true) {\n  return [{\n    json: {\n      franjaDisponible: false,\n      esRetractacion: true,\n      forzarReset: true,\n      motivoRetractacion: validacionSeleccion.motivoRetractacion,\n      mensajeReset: \"游댃 **Proceso reiniciado por cambios m칰ltiples**\\n\\nPara evitar errores, cuando te presento opciones, por favor elige una de la lista.\\n\\n游닇 Proporciona todos los datos completos en un solo mensaje:\\n Proveedor\\n Fecha\\n Hora\\n Categor칤a\\n Peso\\n Unidades\\n Orden de compra\"\n    }\n  }];\n}\n\nfunction validarDisponibilidadCitaEnCronograma(items) {\n  try {\n    /* 1. --- Datos que vienen del nodo de verificaci칩n de tiempo --- */\n    const resp = $node[\"Code Verificar Tiempo Transcurrido\"].json.respuesta.alternativasDisponibles;\n    if (!resp) {\n      return [{ json:{ franjaDisponible:false, mensaje:\"No se encontr칩 la cita a validar.\" } }];\n    }\n\n    /* 2. --- 쮼l proveedor eligi칩 una alternativa? ------------------ */\n    const salidaLLM      = items[0].json.output ?? items[0].json;   // el LLM suele venir como root\n    const tieneAlt       = salidaLLM?.seleccionaAlternativa === true;\n    const datosValidar   = tieneAlt && salidaLLM.datosSeleccionados\n      ? salidaLLM.datosSeleccionados\n      : {\n          fecha           : resp.fecha,\n          fechaFormateada : resp.fechaFormateada,\n          horaInicio      : resp.horaInicio,\n          horaFin         : resp.horaFin,\n          muelle          : resp.muelle,\n          duracionHoras   : resp.duracionHoras       // puede venir undefined\n        };\n\n    /* --- Si no lleg칩 duracionHoras, la calculamos ------------------ */\n    if (!datosValidar.duracionHoras) {\n      datosValidar.duracionHoras = calcularDuracionAproximada(\n        datosValidar.horaInicio, datosValidar.horaFin\n      );\n    }\n\n    /* 3. --- Mallas de la semana actual y pr칩xima ------------------- */\n    const nodoDatos = $node[\"Unificaci칩n y consistencia de datos2\"].json;\n    const datosMalla = nodoDatos.datosMalla;\n    const datosMallaProxSemana = nodoDatos.datosMallaProxSemana;\n    \n    if (!datosMalla || !datosMallaProxSemana) {\n      return [{ json:{ franjaDisponible:false, mensaje:\"No lleg칩 la malla horaria.\" } }];\n    }\n\n    /* 4. --- Validaci칩n propiamente dicha --------------------------- */\n    // Variable para almacenar qu칠 malla se utiliz칩 en la verificaci칩n\n  let mallaUtilizada = null;\n  \n  const disponible = verificarDisponibilidadHoraSolicitada(\n      datosValidar.fecha,\n      datosValidar.horaInicio,\n      datosValidar.muelle,\n      datosValidar.duracionHoras,\n      datosMalla,\n      datosMallaProxSemana,\n      (malla) => { mallaUtilizada = malla; } // Callback para capturar la malla usada\n    );\n\n    // Obtener el n칰mero de semana de la malla utilizada para la validaci칩n\n    const nombreHoja = disponible && mallaUtilizada ? mallaUtilizada.semana : null;\n    \n    const respuesta = {\n      franjaDisponible : disponible,\n      mensaje : disponible\n        ? `춰Genial! Hay espacio para el ${datosValidar.fecha}, de ` +\n          `${datosValidar.horaInicio} a ${datosValidar.horaFin} en ${datosValidar.muelle}.`\n        : \"Lo siento, la franja horaria seleccionada ya no est치 disponible. \" +\n          \"Por favor elige otra opci칩n.\",\n      datosValidados : {\n        ...datosValidar,\n        disponibilidadConfirmada : disponible\n      },\n      nombreHoja : nombreHoja // Agregamos el nombre de la hoja donde se debe insertar la cita\n    };\n\n    return [{ json: respuesta }];\n\n  } catch (err) {\n    console.error(\"Error en validaci칩n:\", err);\n    return [{ json:{ franjaDisponible:false, mensaje:`Error al validar: ${err.message}` } }];\n  }\n}\n\n/* 轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎\n *  UTILIDADES \n * 轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎 */\n\nfunction verificarDisponibilidadHoraSolicitada(\n  fechaSolicitada, horaSolicitada, muelle, horasNecesarias,\n  mallaActual, mallaProxima, callbackMalla = null\n){\n  try {\n    // --- Normalizamos -------------------------------------------------\n    if (!fechaSolicitada || !horaSolicitada || !muelle) return false;\n\n    const fechaObj  = parsearFechaEspanol(fechaSolicitada);\n    const malla     = seleccionarMallaParaFecha(fechaObj, mallaActual, mallaProxima);\n    if (!malla) return false;\n    \n    // Si se proporcion칩 una funci칩n callback, llamarla con la malla seleccionada\n    if (typeof callbackMalla === 'function') {\n      callbackMalla(malla);\n    }\n\n    const diaSem    = obtenerDiaSemanaEspanol(fechaObj);\n    const keyMuelle = normalizarMuelle(muelle);\n\n    if (!malla.dias[diaSem] || !malla.dias[diaSem][keyMuelle]) return false;\n\n    if (!malla.franjas || !Array.isArray(malla.franjas)) return false;\n    const franjas   = malla.franjas.map(f => f.hora);\n    const idxInicio = franjas.findIndex(h => limpiarHora(h) === limpiarHora(horaSolicitada));\n    \n    if (idxInicio === -1 || idxInicio + horasNecesarias > franjas.length) return false;\n\n    for (let i = 0; i < horasNecesarias; i++) {\n      const hora = franjas[idxInicio + i];\n      const fr   = malla.dias[diaSem][keyMuelle][hora];\n      if (!fr || (fr.estado ?? \"\").toLowerCase() !== \"disponible\") return false;\n    }\n    return true;\n  } catch(e){ \n    console.error(\"Error en verificarDisponibilidadHoraSolicitada:\", e); \n    return false; \n  }\n}\n\n/* ---------- Helpers de normalizaci칩n ------------------------------ */\nconst limpiarHora = h => h.trim().replace(/^0+(?=\\d)/, \"\").toUpperCase();\n\nfunction normalizarMuelle(txt = \"\") {\n  return txt\n    .toLowerCase()\n    .normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\") // sin tildes\n    .replace(/\\s+/g, \"\");\n}\n\n/* ---- FIX: elegir malla correcta cuando el rango cruza de mes ----- */\nfunction seleccionarMallaParaFecha(fechaObj, mallaActual, mallaProxima){\n  const dentro = (malla) => {\n    if (!malla) return false;\n    const r = rangoDesdeDias(malla);\n    if (!r) return false;\n    \n    // Simplificar comparaci칩n ignorando horas/minutos/segundos\n    const fechaSimple = new Date(fechaObj.getFullYear(), fechaObj.getMonth(), fechaObj.getDate());\n    const inicioSimple = new Date(r.inicio.getFullYear(), r.inicio.getMonth(), r.inicio.getDate());\n    const finSimple = new Date(r.fin.getFullYear(), r.fin.getMonth(), r.fin.getDate());\n    \n    return fechaSimple >= inicioSimple && fechaSimple <= finSimple;\n  };\n  \n  if (dentro(mallaActual)) return mallaActual;\n  if (dentro(mallaProxima)) return mallaProxima;\n  return null;\n}\n\n/* Rango basado en las fechas reales de cada d칤a (m칤n-m치x) */\nfunction rangoDesdeDias(malla){\n  if (!malla || !malla.dias) return null;\n  let min=null, max=null;\n  for (const d of Object.values(malla.dias)){\n    if (d && d.fechaDia){\n      const f = parsearFechaEspanol(d.fechaDia);\n      if (!min || f < min) min=f;\n      if (!max || f > max) max=f;\n    }\n  }\n  return (min && max) ? {inicio:min, fin:max} : null;\n}\n\n// Funci칩n para calcular la duraci칩n aproximada en horas basada en las horas de inicio y fin\nfunction calcularDuracionAproximada(horaInicio, horaFin) {\n  try {\n    if (!horaInicio || !horaFin) {\n      return 3; // Valor por defecto si no se puede calcular\n    }\n    \n    // Verificar si las horas est치n en formato AM/PM\n    const esFormatoAMPM = /AM|PM/i.test(horaInicio) && /AM|PM/i.test(horaFin);\n    \n    if (esFormatoAMPM) {\n      // Convertir horas de formato AM/PM a 24 horas\n      const horaInicioObj = convertirHoraAMPMA24H(horaInicio);\n      const horaFinObj = convertirHoraAMPMA24H(horaFin);\n      \n      // Calcular diferencia en horas\n      let diferenciaHoras = horaFinObj.hora - horaInicioObj.hora;\n      \n      // Ajustar por diferencia en minutos\n      if (horaFinObj.minutos < horaInicioObj.minutos) {\n        diferenciaHoras--;\n      }\n      \n      // Si la diferencia es negativa, asumimos que cruza la medianoche\n      if (diferenciaHoras < 0) {\n        diferenciaHoras += 24;\n      }\n      \n      return diferenciaHoras;\n    } else {\n      // Formato 24 horas\n      const [horasInicio] = horaInicio.split(':').map(Number);\n      const [horasFin] = horaFin.split(':').map(Number);\n      \n      let diferenciaHoras = horasFin - horasInicio;\n      if (diferenciaHoras < 0) {\n        diferenciaHoras += 24;\n      }\n      \n      return diferenciaHoras;\n    }\n  } catch (error) {\n    console.error(`Error calculando duraci칩n:`, error);\n    return 3; // Valor por defecto\n  }\n}\n\n// Funci칩n auxiliar para convertir hora de formato AM/PM a formato 24 horas\nfunction convertirHoraAMPMA24H(horaAMPM) {\n  try {\n    const [tiempo, periodo] = horaAMPM.split(/\\s+/);\n    let [horas, minutos] = tiempo.split(':').map(Number);\n    \n    // Ajustar horas para formato de 24 horas\n    if (periodo.toUpperCase() === 'PM' && horas < 12) {\n      horas += 12;\n    } else if (periodo.toUpperCase() === 'AM' && horas === 12) {\n      horas = 0;\n    }\n    \n    return {\n      hora: horas,\n      minutos: minutos || 0\n    };\n  } catch (error) {\n    console.error(`Error convirtiendo hora:`, error);\n    return { hora: 0, minutos: 0 }; // Fallback\n  }\n}\n\n// Funci칩n auxiliar para calcular la hora de fin basada en la hora de inicio y la duraci칩n\nfunction calcularHoraFin(horaInicio, duracionHoras) {\n  try {\n    // Verificar si la hora de inicio tiene formato AM/PM\n    const esFormatoAMPM = /AM|PM/i.test(horaInicio);\n    \n    if (esFormatoAMPM) {\n      // Convertir hora formato AM/PM\n      const [tiempo, periodo] = horaInicio.split(/\\s+/);\n      let [horas, minutos] = tiempo.split(':').map(Number);\n      \n      // Ajustar horas para formato de 24 horas\n      if (periodo.toUpperCase() === 'PM' && horas < 12) {\n        horas += 12;\n      } else if (periodo.toUpperCase() === 'AM' && horas === 12) {\n        horas = 0;\n      }\n      \n      // A침adir duraci칩n\n      horas += duracionHoras;\n      \n      // Convertir de vuelta a AM/PM\n      let nuevoPeriodo = 'AM';\n      if (horas >= 12) {\n        nuevoPeriodo = 'PM';\n        if (horas > 12) {\n          horas -= 12;\n        }\n      }\n      if (horas === 0) {\n        horas = 12;\n        nuevoPeriodo = 'AM';\n      }\n      \n      // Formatear resultado\n      return `${horas}:${minutos.toString().padStart(2, '0')} ${nuevoPeriodo}`;\n    } else {\n      // Formato 24 horas\n      const [horas, minutos] = horaInicio.split(':').map(Number);\n      const nuevasHoras = (horas + duracionHoras) % 24;\n      return `${nuevasHoras}:${minutos.toString().padStart(2, '0')}`;\n    }\n  } catch (error) {\n    console.error(`Error calculando hora fin:`, error);\n    return \"\"; // Fallback\n  }\n}\n\n// Convertir fecha en formato espa침ol a formato ISO (YYYY-MM-DD)\nfunction convertirFechaAFormatoISO(fechaTexto) {\n  try {\n    if (!fechaTexto || typeof fechaTexto !== 'string') {\n      throw new Error(\"Texto de fecha inv치lido\");\n    }\n    \n    // Formato esperado: \"dd de mes de yyyy\"\n    const partes = fechaTexto.split(\" de \");\n    if (partes.length !== 3) {\n      throw new Error(`Formato de fecha inv치lido: ${fechaTexto}`);\n    }\n    \n    const dia = parseInt(partes[0], 10);\n    if (isNaN(dia) || dia < 1 || dia > 31) {\n      throw new Error(`D칤a inv치lido: ${partes[0]}`);\n    }\n    \n    const mes = obtenerNumeroMes(partes[1]);\n    if (mes === -1) {\n      throw new Error(`Mes inv치lido: ${partes[1]}`);\n    }\n    \n    const anio = parseInt(partes[2], 10);\n    if (isNaN(anio) || anio < 2000 || anio > 2100) {\n      throw new Error(`A침o inv치lido: ${partes[2]}`);\n    }\n    \n    // Formatear como YYYY-MM-DD\n    const mesStr = (mes + 1).toString().padStart(2, '0');\n    const diaStr = dia.toString().padStart(2, '0');\n    \n    return `${anio}-${mesStr}-${diaStr}`;\n  } catch (error) {\n    console.error(`Error convirtiendo fecha: ${error.message}`);\n    return \"\"; // Cadena vac칤a como fallback\n  }\n}\n\n// Obtener n칰mero de mes a partir del nombre en espa침ol\nfunction obtenerNumeroMes(nombreMes) {\n  if (!nombreMes || typeof nombreMes !== 'string') {\n    return -1;\n  }\n  \n  const nombreMesLower = nombreMes.toLowerCase();\n  const meses = [\n    \"enero\", \"febrero\", \"marzo\", \"abril\", \"mayo\", \"junio\",\n    \"julio\", \"agosto\", \"septiembre\", \"octubre\", \"noviembre\", \"diciembre\"\n  ];\n  \n  return meses.indexOf(nombreMesLower);\n}\n\n// Convertir fecha en formato espa침ol a objeto Date\nfunction parsearFechaEspanol(fechaTexto) {\n  try {\n    if (!fechaTexto || typeof fechaTexto !== 'string') {\n      throw new Error(\"Texto de fecha inv치lido\");\n    }\n    \n    // Formato esperado: \"dd de mes de yyyy\"\n    const partes = fechaTexto.split(\" de \");\n    if (partes.length !== 3) {\n      throw new Error(`Formato de fecha inv치lido: ${fechaTexto}`);\n    }\n    \n    const dia = parseInt(partes[0], 10);\n    if (isNaN(dia) || dia < 1 || dia > 31) {\n      throw new Error(`D칤a inv치lido: ${partes[0]}`);\n    }\n    \n    const mes = obtenerNumeroMes(partes[1]);\n    if (mes === -1) {\n      throw new Error(`Mes inv치lido: ${partes[1]}`);\n    }\n    \n    const anio = parseInt(partes[2], 10);\n    if (isNaN(anio) || anio < 2000 || anio > 2100) {\n      throw new Error(`A침o inv치lido: ${partes[2]}`);\n    }\n    \n    return new Date(anio, mes, dia);\n  } catch (error) {\n    console.error(`Error parseando fecha: ${error.message}`);\n    return new Date(); // Fecha actual como fallback\n  }\n}\n\n// Obtener d칤a de la semana en espa침ol\nfunction obtenerDiaSemanaEspanol(fecha) {\n  if (!fecha || !(fecha instanceof Date)) {\n    console.error(\"Fecha inv치lida para obtener d칤a de semana\");\n    return \"\";\n  }\n  \n  const diaSemana = fecha.getDay();\n  \n  // El c칩digo original usa d칤as laborables (lunes a viernes)\n  // 0 = domingo, 1 = lunes, ..., 6 = s치bado\n  if (diaSemana === 0 || diaSemana === 6) {\n    console.error(\"La fecha corresponde a un fin de semana (s치bado o domingo)\");\n    return \"\";\n  }\n  \n  const diasSemana = [\"domingo\", \"lunes\", \"martes\", \"mi칠rcoles\", \"jueves\", \"viernes\", \"s치bado\"];\n  return diasSemana[diaSemana];\n}\n\n// Parsear rango de d칤as de una malla\nfunction parsearRangoDias(rangoTexto) {\n  try {\n    if (!rangoTexto || typeof rangoTexto !== 'string') {\n      throw new Error(\"Texto de rango inv치lido\");\n    }\n    \n    // Formato esperado: \"LUNES DD AL VIERNES DD DE MES\"\n    const partes = rangoTexto.toUpperCase().split(\" \");\n    \n    // Buscar d칤a inicial\n    let diaInicio = null;\n    let indexAL = -1;\n    \n    for (let i = 0; i < partes.length; i++) {\n      if (partes[i] === \"AL\") {\n        indexAL = i;\n        break;\n      }\n      \n      // Intentar convertir a n칰mero\n      const posibleDia = parseInt(partes[i], 10);\n      if (!isNaN(posibleDia)) {\n        diaInicio = posibleDia;\n      }\n    }\n    \n    if (diaInicio === null || indexAL === -1) {\n      throw new Error(\"No se pudo identificar el d칤a de inicio o la palabra 'AL'\");\n    }\n    \n    // Buscar d칤a final\n    let diaFin = null;\n    let mesIndex = -1;\n    \n    for (let i = indexAL + 1; i < partes.length; i++) {\n      if (partes[i] === \"DE\") {\n        mesIndex = i;\n        break;\n      }\n      \n      // Intentar convertir a n칰mero\n      const posibleDia = parseInt(partes[i], 10);\n      if (!isNaN(posibleDia)) {\n        diaFin = posibleDia;\n      }\n    }\n    \n    if (diaFin === null || mesIndex === -1 || mesIndex + 1 >= partes.length) {\n      throw new Error(\"No se pudo identificar el d칤a final o el mes\");\n    }\n    \n    const nombreMes = partes[mesIndex + 1].toLowerCase();\n    const mes = obtenerNumeroMes(nombreMes);\n    \n    if (mes === -1) {\n      throw new Error(`Mes inv치lido: ${nombreMes}`);\n    }\n    \n    const anio = new Date().getFullYear();\n    \n    return {\n      inicio: new Date(anio, mes, diaInicio),\n      fin: new Date(anio, mes, diaFin)\n    };\n  } catch (error) {\n    console.error(`Error parseando rango: ${error.message}`);\n    \n    // Rango amplio como fallback\n    const hoy = new Date();\n    const finDeMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);\n    \n    return {\n      inicio: hoy,\n      fin: finDeMes\n    };\n  }\n}\n\n// Devolver la funci칩n principal para n8n\nreturn validarDisponibilidadCitaEnCronograma(items);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2896,
        2864
      ],
      "id": "4bf7ecfb-474c-4338-8dfa-e91a6229e89d",
      "name": "Code VALIDACI칍N DE CITA EN CRONOGRAMA"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "15af6812-2871-4888-9658-c24f185bcbd4",
              "leftValue": "={{ $json.franjaDisponible }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "032ef339-3304-444d-89eb-26aa314e06b8",
              "leftValue": "={{ $json.forzarReset }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3136,
        2864
      ],
      "id": "b558cebe-130e-4cdd-9e43-e15cce384435",
      "name": "If CREACION DE CITA EN CRONOGRAMA"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        4400,
        3408
      ],
      "id": "7902ec5b-3645-458b-abcd-f315a29080e0",
      "name": "OpenAI Chat Model10",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=Eres un asistente de un sistema de agendamiento de citas para la entrega de mercanc칤a en la bodega. Debes notificar que, mientras el cliente decid칤a confirmar la cita, otro proveedor ocup칩 esa franja horaria.\n\nGenera un mensaje directo aplicando estos principios de UX para WhatsApp:\n\n**FORMATO Y ESTRUCTURA:**\n1. Usa *negritas* para informaci칩n cr칤tica como el estado de la cita y acciones requeridas\n2. Usa emojis estrat칠gicos: 游뛂 (no disponible), 丘 (tiempo real), 游댃 (reiniciar), 좶잺 (informaci칩n)\n3. Estructura la informaci칩n de forma jer치rquica y clara\n4. Destaca que la franja se *asign칩 a otro proveedor* con formato apropiado\n\n**CONTENIDO REQUERIDO:**\n1. 游뛂 Indica claramente que la *cita no pudo confirmarse* porque otro proveedor ocup칩 la franja\n2. 丘 Explica que las franjas se confirman en *tiempo real* y pueden cambiar constantemente\n3. 游댃 Solicita *reiniciar el proceso* para revisar nuevas opciones disponibles\n4. 좶잺 Destaca la importancia de informaci칩n *actualizada* para garantizar disponibilidad\n5. 游똂 Agradece la comprensi칩n de manera emp치tica\n\n**TONO:** Profesional pero emp치tico, reconociendo el inconveniente y explicando la naturaleza din치mica del sistema de citas en tiempo real.\n\n**EJEMPLO DE ESTRUCTURA ESPERADA:**\n游뛂 *Franja horaria no disponible*\n\n仇 No pudimos confirmar tu cita porque *otro proveedor ocup칩 esta franja* mientras decid칤as.\n\n丘 Las franjas se asignan en *tiempo real* y cambian constantemente...\n游댃 Para revisar *nuevas opciones*, necesito que reinicies el proceso...\n\n游똂 Agradecemos tu comprensi칩n..."
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        4480,
        3200
      ],
      "id": "674d84ee-5c28-4697-bc90-d55a56d1a962",
      "name": "Basic LLM Notificar No Disponibilidad1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Basic LLM Notificar No Disponibilidad').item.json.text.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3328,
        2144
      ],
      "id": "44b54783-7966-4439-bd5e-9ba44555f5fb",
      "name": "Validaci칩n de longitud de caracteres4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad').item.json.text }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad').item.json.text.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6448,
        1968
      ],
      "id": "545bc13c-df33-4fd4-b0dd-e28f380d91fa",
      "name": "Organiza variables del mensaje4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3808,
        1936
      ],
      "id": "0f726cc3-2385-4b46-a152-ffdcc83c59e6",
      "name": "No Operation, do nothing6"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3632,
        1936
      ],
      "id": "a022dca6-d9d2-479d-bcf2-254258ea57e6",
      "name": "HTTP Request Enviar Mensaje por WhatsApp7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Basic LLM Notificar No Disponibilidad1').item.json.text.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6336,
        3424
      ],
      "id": "473dc0bf-4d21-4822-b2ef-c804bd5f9daa",
      "name": "Validaci칩n de longitud de caracteres5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad1').item.json.text }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad1').item.json.text.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7552,
        3456
      ],
      "id": "1e232871-1b61-474b-939d-778053e8f342",
      "name": "Organiza variables del mensaje5"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        6816,
        3216
      ],
      "id": "8633e5c8-2200-4cd2-bd24-b15e105635e4",
      "name": "No Operation, do nothing7"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6640,
        3216
      ],
      "id": "99dd88cf-1898-4bef-945d-aad2e7ce5bdb",
      "name": "HTTP Request Enviar Mensaje por WhatsApp8"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2416,
        3056
      ],
      "id": "6c3a1a53-90b4-4de6-93e2-3505f24d4c30",
      "name": "OpenAI Chat Model11",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=## Prompt para nodo \"Basic LLM\" - Validaci칩n de selecci칩n de alternativa\n\n## ROL Y CONTEXTO\nEres un asistente especializado en interpretar mensajes de usuarios para un sistema de agendamiento de citas log칤sticas. Tu tarea es determinar si el usuario est치 eligiendo una alternativa de horario cuando la cita original no est치 disponible, o si est치 haciendo algo diferente (como retractarse o cambiar de opini칩n).\n\n## CONTEXTO DEL SISTEMA\nEl sistema de agendamiento funciona as칤:\n1. El sistema verifica si un horario solicitado est치 disponible\n2. Si est치 disponible, muestra un mensaje de confirmaci칩n\n3. Si NO est치 disponible, presenta alternativas numeradas\n4. El usuario debe responder eligiendo una de esas alternativas\n5. El formato de elecci칩n puede variar: \"elijo la 1\", \"opci칩n 2\", \"la primera\", \"la del 17 de julio a las 7am\", etc.\n\n## DATOS DISPONIBLES\n\n### Respuesta del sistema y alternativas presentadas:\n```json\n{{ JSON.stringify($node[\"Code Verificar Tiempo Transcurrido\"].json.respuesta.alternativasDisponibles, null, 2) }}\n```\n\n### Mensaje actual del usuario:\n```\n{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.mensajeActual }}\n```\n\n### Historial de conversaci칩n:\n```\n{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.historialMensajes }}\n```\n\n## L칍GICA DE AN츼LISIS\n\n### PASO 1: VERIFICACI칍N DE DISPONIBILIDAD CONFIRMADA\nPrimero, verifica el campo \"disponibilidadConfirmada\" en los datos disponibles:\n- Si **disponibilidadConfirmada = true**: El horario original estaba disponible y se confirm칩. El usuario solo debe confirmar (ej: \"s칤\", \"ok\", \"perfecto\").\n- Si **disponibilidadConfirmada = false**: El horario no estaba disponible y se presentaron alternativas numeradas.\n\n### PASO 2: DETECCI칍N CR칈TICA DE RETRACTACIONES\nAntes de analizar cualquier selecci칩n, detecta si el usuario est치:\n\n#### 九 COMPORTAMIENTO ESPERADO:\n- Confirmando la opci칩n principal cuando disponibilidadConfirmada = true\n- Eligiendo una alternativa numerada cuando se presentaron opciones\n- Usando frases como: \"la 1\", \"opci칩n 2\", \"la primera\", \"elijo la del 17 a las 7am\"\n\n#### 仇 RETRACTACI칍N DETECTADA:\n- Usuario menciona fecha/hora diferente a las opciones presentadas\n- Usuario dice \"mejor el [otra fecha]\", \"cambio de opini칩n\", \"prefiero el [otra fecha]\"\n- Usuario proporciona datos completamente nuevos (nuevo proveedor, nueva categor칤a, etc.)\n- Usuario contradice las opciones que acaba de recibir del sistema\n\n### PASO 3: AN츼LISIS CONTEXTUAL\nRevisa el historial para detectar patrones de indecisi칩n:\n- 쮿a cambiado de fecha m칰ltiples veces?\n- 쯃as fechas mencionadas coinciden con las opciones presentadas?\n- 쮼l mensaje actual es consistente con las alternativas ofrecidas?\n\n## FORMATO DE RESPUESTA\n\n### Para disponibilidadConfirmada = true (confirmaci칩n directa):\n```json\n{\n  \"seleccionaAlternativa\": false,\n  \"indiceSeleccionado\": null,\n  \"esRetractacion\": false,\n  \"tipoRespuesta\": \"confirmacion_directa\",\n  \"datosSeleccionados\": null,\n  \"motivoRetractacion\": null\n}\n```\n\n### Para selecci칩n v치lida de alternativa:\n```json\n{\n  \"seleccionaAlternativa\": true,\n  \"indiceSeleccionado\": 2,\n  \"esRetractacion\": false,\n  \"tipoRespuesta\": \"seleccion_alternativa\",\n  \"datosSeleccionados\": {\n    \"fecha\": \"17 de julio de 2025\",\n    \"fechaFormateada\": \"2025-07-17\",\n    \"horaInicio\": \"09:00 AM\",\n    \"horaFin\": \"1:00 PM\",\n    \"muelle\": \"MUELLE 2\",\n    \"duracionHoras\": 4\n  },\n  \"motivoRetractacion\": null\n}\n```\n\n### Para retractaci칩n detectada:\n```json\n{\n  \"seleccionaAlternativa\": false,\n  \"indiceSeleccionado\": null,\n  \"esRetractacion\": true,\n  \"tipoRespuesta\": \"retractacion\",\n  \"datosSeleccionados\": null,\n  \"motivoRetractacion\": \"Usuario mencion칩 fecha diferente a las opciones presentadas\"\n}\n```\n\n### Para respuesta ambigua o no clara:\n```json\n{\n  \"seleccionaAlternativa\": false,\n  \"indiceSeleccionado\": null,\n  \"esRetractacion\": false,\n  \"tipoRespuesta\": \"respuesta_unclear\",\n  \"datosSeleccionados\": null,\n  \"motivoRetractacion\": null\n}\n```\n\n## REGLAS IMPORTANTES\n\n1. **Para calcular duracionHoras**: Extrae el tiempo en horas entre horaInicio y horaFin. Si no puedes calcularlo con precisi칩n, usa 4 como valor predeterminado.\n\n2. **Para fechaFormateada**: Convierte siempre al formato \"YYYY-MM-DD\".\n\n3. **Para indiceSeleccionado**: Usa base 1 (la primera alternativa es 1, no 0).\n\n4. **Detecci칩n de retractaci칩n**: Si el usuario menciona fechas que NO est치n en las alternativas presentadas, marca `esRetractacion: true`.\n\n5. **Campo motivoRetractacion**: Solo llenar cuando `esRetractacion: true`, explicar brevemente el motivo.\n\n6. **Prioridad de detecci칩n**: \n   - Primero: 쮼s retractaci칩n?\n   - Segundo: 쮼s confirmaci칩n directa?\n   - Tercero: 쮼s selecci칩n de alternativa?\n\n## EJEMPLOS\n\n### Ejemplo 1 - Selecci칩n v치lida:\n**Alternativas presentadas**: 1) 17 de julio 9:00 AM, 2) 17 de julio 10:00 AM\n**Mensaje usuario**: \"elijo la 2\"\n**Respuesta**: \n```json\n{\n  \"seleccionaAlternativa\": true,\n  \"indiceSeleccionado\": 2,\n  \"esRetractacion\": false,\n  \"tipoRespuesta\": \"seleccion_alternativa\",\n  \"datosSeleccionados\": {...},\n  \"motivoRetractacion\": null\n}\n```\n\n### Ejemplo 2 - Retractaci칩n:\n**Alternativas presentadas**: 1) 17 de julio 9:00 AM, 2) 17 de julio 10:00 AM  \n**Mensaje usuario**: \"mejor para el 18 de julio\"\n**Respuesta**: \n```json\n{\n  \"seleccionaAlternativa\": false,\n  \"indiceSeleccionado\": null,\n  \"esRetractacion\": true,\n  \"tipoRespuesta\": \"retractacion\",\n  \"datosSeleccionados\": null,\n  \"motivoRetractacion\": \"Usuario solicita fecha diferente (18 de julio) a las opciones presentadas\"\n}\n```\n\n### Ejemplo 3 - Confirmaci칩n directa:\n**disponibilidadConfirmada**: true\n**Mensaje usuario**: \"perfecto, confirmo\"\n**Respuesta**: \n```json\n{\n  \"seleccionaAlternativa\": false,\n  \"indiceSeleccionado\": null,\n  \"esRetractacion\": false,\n  \"tipoRespuesta\": \"confirmacion_directa\",\n  \"datosSeleccionados\": null,\n  \"motivoRetractacion\": null\n}\n```\n\n## INSTRUCCIONES FINALES\n1. Analiza cuidadosamente el contexto antes de responder\n2. Prioriza la detecci칩n de retractaciones para evitar loops de indecisi칩n\n3. Solo devuelve el objeto JSON v치lido, sin explicaciones adicionales\n4. Aseg칰rate de incluir todos los campos requeridos en cada respuesta",
        "hasOutputParser": true
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        2496,
        2864
      ],
      "id": "e660d2de-acdf-4696-a766-51c819a2620d",
      "name": "Basic LLM Validar selecci칩n alternativa"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"seleccionaAlternativa\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica si el usuario seleccion칩 una alternativa\"\n    },\n    \"indiceSeleccionado\": {\n      \"type\": [\"number\", \"null\"],\n      \"description\": \"칈ndice de la alternativa seleccionada (1-basado) o null\"\n    },\n    \"esRetractacion\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica si el usuario est치 retract치ndose o cambiando de opini칩n\"\n    },\n    \"tipoRespuesta\": {\n      \"type\": \"string\",\n      \"description\": \"Tipo de respuesta del usuario\",\n      \"enum\": [\"confirmacion_directa\", \"seleccion_alternativa\", \"retractacion\", \"respuesta_unclear\"]\n    },\n    \"datosSeleccionados\": {\n      \"type\": [\"object\", \"null\"],\n      \"properties\": {\n        \"fecha\": {\n          \"type\": \"string\",\n          \"description\": \"Fecha en formato texto (dd de mes de yyyy)\"\n        },\n        \"fechaFormateada\": {\n          \"type\": \"string\",\n          \"description\": \"Fecha en formato ISO (YYYY-MM-DD)\"\n        },\n        \"horaInicio\": {\n          \"type\": \"string\",\n          \"description\": \"Hora de inicio de la cita\"\n        },\n        \"horaFin\": {\n          \"type\": \"string\",\n          \"description\": \"Hora de fin de la cita\"\n        },\n        \"muelle\": {\n          \"type\": \"string\",\n          \"description\": \"Identificador del muelle\"\n        },\n        \"duracionHoras\": {\n          \"type\": \"number\",\n          \"description\": \"Duraci칩n de la cita en horas\"\n        }\n      },\n      \"description\": \"Datos de la alternativa seleccionada o null\"\n    },\n    \"motivoRetractacion\": {\n      \"type\": [\"string\", \"null\"],\n      \"description\": \"Descripci칩n del motivo de la retractaci칩n si aplica\"\n    }\n  },\n  \"required\": [\"seleccionaAlternativa\", \"indiceSeleccionado\", \"esRetractacion\", \"tipoRespuesta\", \"datosSeleccionados\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        2640,
        3088
      ],
      "id": "7c5587b5-c893-4727-9820-cd686760540a",
      "name": "Structured Output Parser2"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para preparar la actualizaci칩n de Excel con citas\n// Este nodo SOLO prepara el formato para enviarlos a Microsoft Graph\n\n// Obtener datos de entrada: datos validados y datos de la cita\nconst datosValidados = $input.first().json.datosValidados;\nconst datosCita = $('Code Verificar Tiempo Transcurrido').first().json.respuesta.datosCita;\nconst datosMalla = $('Unificaci칩n y consistencia de datos2').first().json.datosMalla;\n\n// Extraer la informaci칩n relevante\nconst {\n  fecha,\n  fechaFormateada,\n  horaInicio,\n  horaFin,\n  muelle,\n  duracionHoras\n} = datosValidados;\n\nconst {\n  proveedor = \"\",\n  ordenCompra = \"\",\n  peso = \"\",\n  categoria = \"\",\n  unidades = \"\"\n} = datosCita;\n\n// Obtener el d칤a de la semana a partir de la fecha\nfunction obtenerDiaSemana(fechaStr) {\n  // Extrae el d칤a, mes y a침o de la cadena\n  const regex = /(\\d+)\\s+de\\s+(\\w+)\\s+de\\s+(\\d+)/;\n  const match = regex.exec(fechaStr);\n  \n  if (!match) return null;\n  \n  const dia = parseInt(match[1], 10);\n  const mesStr = match[2].toLowerCase();\n  const a침o = parseInt(match[3], 10);\n  \n  // Mapeo de nombres de meses a n칰meros\n  const meses = {\n    \"enero\": 0,\n    \"febrero\": 1,\n    \"marzo\": 2,\n    \"abril\": 3,\n    \"mayo\": 4,\n    \"junio\": 5,\n    \"julio\": 6,\n    \"agosto\": 7,\n    \"septiembre\": 8,\n    \"octubre\": 9,\n    \"noviembre\": 10,\n    \"diciembre\": 11\n  };\n  \n  const mesNum = meses[mesStr];\n  \n  if (mesNum === undefined) return null;\n  \n  // Crear objeto Date\n  const fecha = new Date(a침o, mesNum, dia);\n  \n  // Obtener d칤a de la semana (0=domingo, 1=lunes, ..., 6=s치bado)\n  const diaSemana = fecha.getDay();\n  \n  // Convertir a nombre en espa침ol\n  const diasSemana = [\"domingo\", \"lunes\", \"martes\", \"mi칠rcoles\", \"jueves\", \"viernes\"];\n  \n  return diasSemana[diaSemana];\n}\n\n// Determinar el d칤a de la semana\nconst diaSemana = obtenerDiaSemana(fecha);\n\n// Determinar el muelle (muelle1 o muelle2)\nconst muelleKey = muelle.toLowerCase().includes(\"1\") ? \"muelle1\" : \"muelle2\";\n\n// Mapeo correcto de columnas para cada d칤a y muelle seg칰n lo proporcionado\nconst mapeoColumnas = {\n  'lunes': {\n    'muelle1': 'C', \n    'muelle2': 'F' \n  },\n  'martes': {\n    'muelle1': 'I', \n    'muelle2': 'L'  \n  },\n  'mi칠rcoles': {\n    'muelle1': 'O', \n    'muelle2': 'R'  \n  },\n  'jueves': {\n    'muelle1': 'U', \n    'muelle2': 'X' \n  },\n  'viernes': {\n    'muelle1': 'AA', \n    'muelle2': 'AD'  \n  }\n};\n\n// Verificar si tenemos mapeo para este d칤a\nif (!mapeoColumnas[diaSemana]) {\n  console.log(`D칤a no soportado: ${diaSemana}`);\n  return {\n    json: {\n      success: false,\n      mensaje: `D칤a no soportado: ${diaSemana}`,\n      error: \"DIA_NO_SOPORTADO\"\n    }\n  };\n}\n\n// Obtener la columna base para el d칤a y muelle espec칤ficos\nconst columnaBase = mapeoColumnas[diaSemana][muelleKey];\nif (!columnaBase) {\n  console.log(`Configuraci칩n no soportada: d칤a=${diaSemana}, muelle=${muelleKey}`);\n  return {\n    json: {\n      success: false,\n      mensaje: `Configuraci칩n no soportada: d칤a=${diaSemana}, muelle=${muelleKey}`,\n      error: \"CONFIGURACION_NO_SOPORTADA\"\n    }\n  };\n}\n\n// Calcular la siguiente columna en Excel\nfunction siguienteColumna(columna) {\n  if (columna.length === 1) {\n    // Para columnas de una letra (A-Z)\n    return String.fromCharCode(columna.charCodeAt(0) + 1);\n  } else {\n    // Para columnas de dos letras (AA-ZZ)\n    const primerChar = columna.charAt(0);\n    const segundoChar = columna.charAt(1);\n    \n    if (segundoChar === 'Z') {\n      // Si es 'Z', pasar a la siguiente letra para el primer car치cter\n      return String.fromCharCode(primerChar.charCodeAt(0) + 1) + 'A';\n    } else {\n      // Incrementar solo el segundo car치cter\n      return primerChar + String.fromCharCode(segundoChar.charCodeAt(0) + 1);\n    }\n  }\n}\n\n// Funci칩n para comparar horas de forma flexible\nfunction horasIguales(h1, h2) {\n  const normalizar = (h) =>\n    h\n      .toString()\n      .trim()\n      .toLowerCase()\n      .replace(/\\./g, '')            // quita puntos (por si viene \"a.m.\")\n      .replace(/\\s+/g, '')           // quita espacios\n      .replace(/^0+/, '');           // quita ceros a la izquierda\n  return normalizar(h1) === normalizar(h2);\n}\n\n// Ordenar franjas por hora\nfunction obtenerFranjasOrdenadas(franjas) {\n  return [...franjas].sort((a, b) => {\n    // Convertir horas a formato comparable (n칰mero de minutos desde medianoche)\n    function horaAMinutos(hora) {\n      const match = hora.match(/(\\d+):(\\d+)\\s*([AP]M)/i);\n      if (!match) return 0;\n      \n      let horas = parseInt(match[1], 10);\n      const minutos = parseInt(match[2], 10);\n      const periodo = match[3].toUpperCase();\n      \n      // Convertir a formato 24 horas\n      if (periodo === 'PM' && horas !== 12) {\n        horas += 12;\n      } else if (periodo === 'AM' && horas === 12) {\n        horas = 0;\n      }\n      \n      return horas * 60 + minutos;\n    }\n    \n    return horaAMinutos(a.hora) - horaAMinutos(b.hora);\n  });\n}\n\n// Obtener la posici칩n de la franja en el array ordenado\nfunction obtenerPosicionFranja(hora, franjas) {\n  const franjasOrdenadas = obtenerFranjasOrdenadas(franjas);\n  return franjasOrdenadas.findIndex(f => horasIguales(f.hora, hora));\n}\n\n// Funci칩n corregida para calcular la fila Excel basada en la posici칩n de la franja\nfunction calcularFilaExcel(hora, franjas) {\n  const posicion = obtenerPosicionFranja(hora, franjas);\n  \n  if (posicion === -1) {\n    console.log(`No se encontr칩 la posici칩n para la hora ${hora}`);\n    return null;\n  }\n  \n  // Mapeo de posiciones a filas base en Excel\n  // Basado en las observaciones del Excel:\n  const FILA_PRIMERA_FRANJA = 12;  // 6:00 AM\n  const INCREMENTO_ESTANDAR = 3;   // Incremento est치ndar entre franjas\n  \n  // Caso especial para 9:00 AM\n  if (posicion === 3) {\n    return 21;  // Fila exacta para 9:00 AM\n  } else if (posicion === 4) {\n    return 24;  // Fila exacta para 10:00 AM\n  } else if (posicion === 5) {\n    return 27;  // Fila exacta para 11:00 AM\n  } else if (posicion < 3) {\n    // Para posiciones antes de 9:00 AM, usamos el incremento est치ndar\n    return FILA_PRIMERA_FRANJA + (posicion * INCREMENTO_ESTANDAR);\n  } else {\n    // Para posiciones despu칠s de 11:00 AM, calculamos a partir de 11:00 AM\n    return 27 + ((posicion - 5) * INCREMENTO_ESTANDAR);\n  }\n}\n\n// Funci칩n para encontrar la franja horaria siguiente\nfunction encontrarSiguienteFranja(horaActual, franjas) {\n  const franjasOrdenadas = obtenerFranjasOrdenadas(franjas);\n  const posicionActual = franjasOrdenadas.findIndex(f => horasIguales(f.hora, horaActual));\n  \n  if (posicionActual === -1 || posicionActual >= franjasOrdenadas.length - 1) {\n    return null; // No hay siguiente franja\n  }\n  \n  return franjasOrdenadas[posicionActual + 1];\n}\n\n// Encontrar informaci칩n de la franja horaria inicial en los datos de la malla\nconst franjaInicio = datosMalla.franjas.find(f => horasIguales(f.hora, horaInicio));\nif (!franjaInicio) {\n  console.log(`No se encontr칩 la franja de inicio: ${horaInicio}`);\n  return {\n    json: {\n      success: false,\n      mensaje: `No se encontr칩 la franja de inicio: ${horaInicio}`,\n      error: \"FRANJA_NO_ENCONTRADA\"\n    }\n  };\n}\n\n// Array para almacenar todas las actualizaciones\nlet todasLasActualizaciones = [];\n\n// Procesar cada hora de la cita (seg칰n duracionHoras)\nlet horaActual = horaInicio;\nlet horasRestantes = duracionHoras;\n\nwhile (horasRestantes > 0) {\n  // Encontrar la franja actual\n  const franjaActual = datosMalla.franjas.find(f => horasIguales(f.hora, horaActual));\n  \n  if (!franjaActual) {\n    console.log(`No se encontr칩 informaci칩n para la franja: ${horaActual}`);\n    break;\n  }\n  \n  // Calcular la fila base de forma din치mica\n  const filaBase = calcularFilaExcel(horaActual, datosMalla.franjas);\n  \n  if (!filaBase) {\n    console.log(`No se pudo determinar la fila para la franja: ${horaActual}`);\n    break;\n  }\n  \n  console.log(`Calculando celdas para: ${horaActual}, fila base: ${filaBase}`);\n  \n  const columnaLineas = siguienteColumna(columnaBase);\n  const columnaUnd = siguienteColumna(columnaLineas);\n  \n  // Calcular las celdas para esta franja\n  const rangoCeldas = {\n    proveedor: `${columnaBase}${filaBase}`,\n    ordenCompra: `${columnaBase}${filaBase + 1}`,\n    peso: `${columnaBase}${filaBase + 2}`,\n    categoria: `${columnaLineas}${filaBase + 2}`,\n    unidades: `${columnaUnd}${filaBase + 2}`\n  };\n  \n  console.log(`Celdas para ${horaActual}, ${diaSemana}, ${muelleKey}:`, JSON.stringify(rangoCeldas));\n  \n  // Agregar actualizaciones para esta franja horaria\n  todasLasActualizaciones.push(\n    {\n      celda: rangoCeldas.proveedor,\n      valor: proveedor\n    },\n    {\n      celda: rangoCeldas.ordenCompra,\n      valor: ordenCompra\n    },\n    {\n      celda: rangoCeldas.peso,\n      valor: peso\n    },\n    {\n      celda: rangoCeldas.categoria,\n      valor: categoria\n    },\n    {\n      celda: rangoCeldas.unidades,\n      valor: unidades\n    }\n  );\n  \n  // Preparar para la siguiente hora\n  horasRestantes--;\n  \n  if (horasRestantes > 0) {\n    const siguienteFranja = encontrarSiguienteFranja(horaActual, datosMalla.franjas);\n    \n    if (siguienteFranja) {\n      horaActual = siguienteFranja.hora;\n    } else {\n      console.log(`No se encontr칩 la siguiente franja horaria despu칠s de ${horaActual}`);\n      break;\n    }\n  }\n}\n\n// Preparar el formato final para la petici칩n a Microsoft Graph\nconst actualizacionesGraph = todasLasActualizaciones.map(act => ({\n  address: act.celda,\n  values: [[act.valor]]\n}));\n\n// Usar el nombre correcto de la hoja desde datosMalla\nconst nombreHojaExcel = $('Code VALIDACI칍N DE CITA EN CRONOGRAMA').first().json.nombreHoja;\n\n// Preparar el resultado para el siguiente nodo\nreturn {\n  json: {\n    success: true,\n    mensaje: `Preparadas ${todasLasActualizaciones.length} actualizaciones para la cita del ${fecha} de ${horaInicio} a ${horaFin} en ${muelle} (${duracionHoras} horas)`,\n    nombreHoja: nombreHojaExcel,\n    // Datos para Microsoft Graph API\n    graphRequestData: {\n      updates: actualizacionesGraph\n    },\n    // Informaci칩n m치s detallada para debugging o uso interno\n    detalles: {\n      actualizacionesDetalladas: todasLasActualizaciones,\n      diaSemana,\n      informacionCita: {\n        fecha,\n        horaInicio,\n        horaFin,\n        muelle,\n        proveedor,\n        ordenCompra,\n        peso,\n        categoria,\n        unidades,\n        duracionHoras\n      }\n    }\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3632,
        2528
      ],
      "id": "241900ec-d2cb-402f-bdb9-e971039a46a0",
      "name": "Code (Preparar Cuerpo de Petici칩n)"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo modificado para \"Code Agrupar Franjas\"\n// Ahora devuelve los valores individuales en lugar de franjas agrupadas\n// pero conservando la informaci칩n de indice, nombreHoja e informacionCita\nconst input = $input.first().json;\n\n// Verificar que tenemos la estructura esperada\nif (!input || !input.graphRequestData || !input.graphRequestData.updates) {\n  console.log('Estructura de datos de entrada no v치lida');\n  return {\n    json: {\n      error: \"FORMATO_INVALIDO\",\n      mensaje: \"La estructura de datos de entrada no es v치lida\"\n    }\n  };\n}\n\nconst updates = input.graphRequestData.updates;\nconst UPDATES_PER_FRANJA = 5;\nconst numFranjas = Math.ceil(updates.length / UPDATES_PER_FRANJA);\nconst resultados = [];\n\n// Primero, creamos todas las franjas como en el c칩digo original\nconst franjas = [];\nfor (let i = 0; i < numFranjas; i++) {\n  const inicio = i * UPDATES_PER_FRANJA;\n  const fin = Math.min(inicio + UPDATES_PER_FRANJA, updates.length);\n  \n  // Obtener las actualizaciones de esta franja\n  const actualizacionesFranja = updates.slice(inicio, fin);\n  \n  franjas.push({\n    indice: i + 1,\n    nombreHoja: input.nombreHoja,\n    updates: actualizacionesFranja,\n    informacionCita: input.detalles?.informacionCita\n  });\n}\n\n// Ahora, recorremos cada franja y extraemos los valores individuales\n// pero conservando la informaci칩n adicional\nfranjas.forEach(franja => {\n  franja.updates.forEach(update => {\n    if (update.values && update.values.length > 0 && update.values[0].length > 0) {\n      const valor = update.values[0][0];\n      \n      // Creamos un objeto que contiene el valor y la informaci칩n adicional\n      resultados.push({\n        json: {\n          valor: valor,\n          indice: franja.indice,\n          nombreHoja: franja.nombreHoja,\n          address: update.address,\n          informacionCita: franja.informacionCita\n        }\n      });\n    }\n  });\n});\n\nconsole.log(`Se extrajeron ${resultados.length} valores individuales para inserci칩n en orden`);\nreturn resultados;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3840,
        2528
      ],
      "id": "13932a8f-dc04-4ecf-99a4-195f46138560",
      "name": "Code Agrupar Franjas"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4128,
        2528
      ],
      "id": "6d632807-9953-4d2f-a96d-5440e3ab122e",
      "name": "Loop Over Uno a Uno"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para preparar cada inserci칩n para Microsoft Graph API mediante $batch\n// Basado en el flujo de trabajo original y adaptado para procesar elementos individuales\nconst input = $input.first().json;\n\n// Constantes para los IDs de SharePoint/OneDrive\nconst siteId = \"gexpresscargo.sharepoint.com,a592f886-4560-4e62-9646-1eee7add7abe,8b514073-41ae-4619-8f76-724bd912bc65\";\nconst driveId = \"b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8\";\nconst itemId = \"01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME\";\n\n// Verificar que tenemos la estructura esperada\nif (!input || input.valor === undefined || !input.address || !input.nombreHoja) {\n  console.log('Estructura de datos de entrada no v치lida para la inserci칩n');\n  return {\n    json: {\n      error: \"FORMATO_INVALIDO\",\n      mensaje: \"La estructura de datos de entrada no es v치lida para la inserci칩n\"\n    }\n  };\n}\n\n// Preparar el valor para la actualizaci칩n seg칰n su tipo\nlet valorFormateado;\nif (typeof input.valor === 'number') {\n  valorFormateado = [[input.valor]]; // Para n칰meros mantenemos el tipo\n} else {\n  valorFormateado = [[input.valor.toString()]]; // Para otros tipos convertimos a string\n}\n\n// Generar un ID 칰nico para esta solicitud\nconst requestId = `${input.address}_${input.indice}_${Date.now()}`;\n\n// Crear la estructura de solicitud para Microsoft Graph $batch\nconst requestBody = {\n  requests: [\n    {\n      id: requestId,\n      method: \"PATCH\",\n      url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(input.nombreHoja)}/range(address='${input.address}')`,\n      body: {\n        values: valorFormateado\n      },\n      headers: {\n        \"Content-Type\": \"application/json\"\n      }\n    }\n  ],\n  _metadata: {\n    celda: input.address,\n    valor: input.valor,\n    indice: input.indice,\n    informacionCita: input.informacionCita || {}\n  }\n};\n\nconsole.log(`Preparada solicitud ${requestId} para insertar valor \"${input.valor}\" en la celda ${input.address} de la hoja \"${input.nombreHoja}\"`);\n\n// Retornar el objeto request listo para ser enviado a Microsoft Graph $batch\nreturn {\n  json: requestBody\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4400,
        2624
      ],
      "id": "efdab619-cf92-41a9-b12f-cdf86cd1ceba",
      "name": "Code Preparar cada Insercion"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.microsoft.com/v1.0/$batch",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4656,
        2624
      ],
      "id": "c5b0c061-4018-43dc-ba0f-849d1bec0716",
      "name": "HTTP Request Actualizar Excel1",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para verificar si la inserci칩n fue exitosa (sin acciones correctivas)\nconst input = $input.first().json;\n\n// Verificar que tenemos la estructura esperada en la respuesta\nif (!input || !input.responses || !Array.isArray(input.responses) || input.responses.length === 0) {\n  console.log('Estructura de datos de respuesta no v치lida');\n  return {\n    json: {\n      error: \"RESPUESTA_INVALIDA\",\n      mensaje: \"La estructura de datos de la respuesta no es v치lida\",\n      exito: false\n    }\n  };\n}\n\n// Obtener la primera respuesta\nconst response = input.responses[0];\n\n// Extraer informaci칩n de la solicitud original del ID\n// El formato del ID es: \"CELDA_INDICE_TIMESTAMP\"\nconst idPartes = response.id.split('_');\nconst celdaOriginal = idPartes[0];\nconst indice = idPartes[1];\n\n// Verificar que la respuesta tiene un cuerpo\nif (!response.body || !response.body.address) {\n  console.log(`Error: La respuesta no contiene informaci칩n sobre la direcci칩n de celda`);\n  return {\n    json: {\n      error: \"RESPUESTA_SIN_DIRECCION\",\n      mensaje: \"La respuesta no incluye informaci칩n sobre la direcci칩n de celda\",\n      requestId: response.id,\n      status: response.status,\n      celdaOriginal: celdaOriginal,\n      exito: false\n    }\n  };\n}\n\n// Extraer la direcci칩n de celda de la respuesta\nlet direccionRespuesta = \"\";\nif (response.body && response.body.address) {\n  const partesDireccion = response.body.address.split('!');\n  if (partesDireccion.length > 1) {\n    direccionRespuesta = partesDireccion[1];\n  }\n}\n\n// Obtener el valor insertado de la respuesta\nconst valorInsertado = response.body.values && response.body.values[0] && response.body.values[0][0];\n\n// Verificar si la inserci칩n se realiz칩 en la celda correcta\nconst insercionCorrecta = direccionRespuesta === celdaOriginal;\n\n// Verificar el c칩digo de estado HTTP\nconst estadoExitoso = response.status >= 200 && response.status < 300;\n\n// Crear objeto para almacenar el resultado de la verificaci칩n\nconst resultado = {\n  exito: insercionCorrecta && estadoExitoso,\n  celdaOriginal: celdaOriginal,\n  celdaInsertada: direccionRespuesta,\n  valorInsertado: valorInsertado,\n  statusCode: response.status,\n  requestId: response.id,\n  indice: indice,\n  celdasDiferentes: !insercionCorrecta && estadoExitoso,\n  falloEstado: !estadoExitoso\n};\n\nconst chatId = $('Organiza el Mensaje').first().json.infoMensaje.chat_id;\n\nif (!insercionCorrecta || !estadoExitoso) {\n  console.log(`Error en inserci칩n: celda original=${celdaOriginal}, celda insertada=${direccionRespuesta}, status=${response.status}`);\n} else {\n  console.log(`Inserci칩n correcta en celda ${celdaOriginal} con valor \"${valorInsertado}\"`);\n}\n\n// Incluir la respuesta original para tener toda la informaci칩n\nresultado.respuestaOriginal = response;\n\n// Retornar el resultado de la verificaci칩n\nreturn {\n  json: resultado, \n  chat_id: chatId\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4880,
        2624
      ],
      "id": "ae166798-3712-47c2-9130-a84b8a67dc78",
      "name": "Code Verificar Inserci칩n"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fb1eda05-eb5e-4683-8556-1cf2b5b8e4d5",
              "leftValue": "={{ $json.exito }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5120,
        2688
      ],
      "id": "e781b5a0-8b61-420a-a68c-b41d89d29d29",
      "name": "If Verificar Inserci칩n"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "15a95144-dd82-4ea5-b9ba-9eb924d2ae5c",
              "leftValue": "={{ $json.celdasDiferentes }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5328,
        2768
      ],
      "id": "f0d0f2bb-5b36-404a-b44f-b3dff693280c",
      "name": "If Diferente Caso"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para limpiar una celda donde se insert칩 incorrectamente un valor\nconst input = $input.first().json;\n\n// Constantes para los IDs de SharePoint/OneDrive\nconst siteId = \"gexpresscargo.sharepoint.com,a592f886-4560-4e62-9646-1eee7add7abe,8b514073-41ae-4619-8f76-724bd912bc65\";\nconst driveId = \"b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8\";\nconst itemId = \"01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME\";\n\n// Verificar que tenemos la informaci칩n necesaria\nif (!input || !input.celdaInsertada || !input.respuestaOriginal) {\n  console.log('Informaci칩n insuficiente para limpiar la celda incorrecta');\n  return {\n    json: {\n      error: \"INFORMACION_INSUFICIENTE\",\n      mensaje: \"No hay suficiente informaci칩n para limpiar la celda incorrecta\"\n    }\n  };\n}\n\n// Obtener la celda a limpiar y la informaci칩n de la hoja\nconst celdaALimpiar = input.celdaInsertada;\nlet hojaExcel = input.nombreHoja || \"\"; // Usar el nombreHoja del input\n\n// Intentar extraer el nombre de la hoja de la direcci칩n en la respuesta si no est치 disponible\nif ((!hojaExcel || hojaExcel === \"\") && input.respuestaOriginal.body && input.respuestaOriginal.body.address) {\n  const direccionCompleta = input.respuestaOriginal.body.address;\n  hojaExcel = direccionCompleta.split('!')[0].replace(/'/g, '');\n}\n\nconsole.log(`Limpiando celda incorrecta ${celdaALimpiar} en hoja ${hojaExcel}`);\n\n// Crear la solicitud para limpiar la celda\nconst requestBody = {\n  requests: [\n    {\n      id: `Limpiar_${celdaALimpiar}_${Date.now()}`,\n      method: \"PATCH\",\n      url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(hojaExcel)}/range(address='${celdaALimpiar}')`,\n      body: {\n        values: [[\"\"]] // Valor vac칤o para limpiar la celda\n      },\n      headers: {\n        \"Content-Type\": \"application/json\"\n      }\n    }\n  ],\n  _metadata: {\n    accion: \"limpiar\",\n    celda: celdaALimpiar,\n    hoja: hojaExcel,\n    datoOriginal: input\n  }\n};\n\n// Retornar el request para limpiar la celda\nreturn {\n  json: requestBody\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5632,
        2576
      ],
      "id": "038a69ad-6abc-4658-81ab-1afb9935fdbc",
      "name": "Code Limpiar Celda Incorrecta",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.microsoft.com/v1.0/$batch",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5856,
        2576
      ],
      "id": "ba0d5e69-95d4-4393-bdb4-16d66b55267c",
      "name": "HTTP Request Limpiar Celda",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e570827e-13d0-4d6f-b23e-184ca2d3368c",
              "leftValue": "={{ $json.falloEstado }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5792,
        2960
      ],
      "id": "05a321f4-923e-41c3-ab8d-cdbc13ec61b7",
      "name": "If fallo Estado"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para reintentar la inserci칩n en la celda correcta\nconst input = $input.first().json;\n\n// Constantes para los IDs de SharePoint/OneDrive\nconst siteId = \"gexpresscargo.sharepoint.com,a592f886-4560-4e62-9646-1eee7add7abe,8b514073-41ae-4619-8f76-724bd912bc65\";\nconst driveId = \"b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8\";\nconst itemId = \"01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME\";\n\n// Si el input viene del nodo anterior de limpiar celda, extraer el dato original\nconst datoOriginal = input._metadata?.datoOriginal || input;\n\n// Verificar que tenemos la informaci칩n necesaria\nif (!datoOriginal || !datoOriginal.celdaOriginal) {\n  console.log('Informaci칩n insuficiente para reintentar la inserci칩n');\n  return {\n    json: {\n      error: \"INFORMACION_INSUFICIENTE\",\n      mensaje: \"No hay suficiente informaci칩n para reintentar la inserci칩n\"\n    }\n  };\n}\n\n// Obtener la celda correcta donde insertar y el valor a insertar\nconst celdaCorrecta = datoOriginal.celdaOriginal;\n\n// Intentar obtener el valor correcto a insertar\nlet valorAInsertar;\n\n// Primero, verificar si tenemos el valor de la respuesta original\nif (datoOriginal.valorInsertado !== undefined) {\n  valorAInsertar = datoOriginal.valorInsertado;\n} \n// Si no, intentar obtenerlo del body de la respuesta\nelse if (datoOriginal.respuestaOriginal?.body?.values?.[0]?.[0] !== undefined) {\n  valorAInsertar = datoOriginal.respuestaOriginal.body.values[0][0];\n} \n// Como 칰ltimo recurso, usar un valor vac칤o\nelse {\n  valorAInsertar = \"\";\n  console.log('No se pudo determinar el valor a insertar, usando valor vac칤o');\n}\n\n// Determinar el tipo de valor y formatearlo adecuadamente\nlet valorFormateado;\nif (typeof valorAInsertar === 'number') {\n  valorFormateado = [[valorAInsertar]]; // Mantener el tipo num칠rico\n} else {\n  valorFormateado = [[valorAInsertar.toString()]]; // Convertir a string para otros tipos\n}\n\n// Obtener la hoja de Excel - primero del dato original\nlet hojaExcel = datoOriginal.nombreHoja || \"\"; \n\n// Si no est치 disponible en el objeto principal, intentar obtenerlo de otros lugares\nif (!hojaExcel || hojaExcel === \"\") {\n  // Verificar si est치 en el _metadata\n  hojaExcel = input._metadata?.hoja || \"\";\n  \n  // Como 칰ltimo recurso, extraer de la direcci칩n en la respuesta\n  if ((!hojaExcel || hojaExcel === \"\") && datoOriginal.respuestaOriginal?.body?.address) {\n    const direccionCompleta = datoOriginal.respuestaOriginal.body.address;\n    hojaExcel = direccionCompleta.split('!')[0].replace(/'/g, '');\n  }\n}\n\nconsole.log(`Reintentando inserci칩n en celda ${celdaCorrecta} de la hoja ${hojaExcel} con valor \"${valorAInsertar}\"`);\n\n// Crear la solicitud para reintentar la inserci칩n\nconst requestBody = {\n  requests: [\n    {\n      id: `Reintento_${celdaCorrecta}_${Date.now()}`,\n      method: \"PATCH\",\n      url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(hojaExcel)}/range(address='${celdaCorrecta}')`,\n      body: {\n        values: valorFormateado\n      },\n      headers: {\n        \"Content-Type\": \"application/json\"\n      }\n    }\n  ],\n  _metadata: {\n    accion: \"reintentar\",\n    celda: celdaCorrecta,\n    hoja: hojaExcel,\n    valor: valorAInsertar,\n    datoOriginal: datoOriginal,\n    intentos: (datoOriginal._metadata?.intentos || 0) + 1\n  }\n};\n\n// Retornar el request para reintentar la inserci칩n\nreturn {\n  json: requestBody\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6128,
        2640
      ],
      "id": "54577ce1-8032-4f26-8282-8db39ebc8369",
      "name": "Code Reintentar Inserci칩n",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.microsoft.com/v1.0/$batch",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6368,
        2768
      ],
      "id": "6976ebf5-c133-4bce-beb4-307e42dc8d76",
      "name": "HTTP Request Reintentar Inserci칩n",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para verificar si la inserci칩n fue exitosa (sin acciones correctivas)\nconst input = $input.first().json;\n\n// Verificar que tenemos la estructura esperada en la respuesta\nif (!input || !input.responses || !Array.isArray(input.responses) || input.responses.length === 0) {\n  console.log('Estructura de datos de respuesta no v치lida');\n  return {\n    json: {\n      error: \"RESPUESTA_INVALIDA\",\n      mensaje: \"La estructura de datos de la respuesta no es v치lida\",\n      exito: false\n    }\n  };\n}\n\n// Obtener la primera respuesta\nconst response = input.responses[0];\n\n// Extraer informaci칩n de la solicitud original del ID\n// El formato del ID es: \"CELDA_INDICE_TIMESTAMP\"\nconst idPartes = response.id.split('_');\nconst celdaOriginal = idPartes[0];\nconst indice = idPartes[1];\n\n// Verificar que la respuesta tiene un cuerpo\nif (!response.body || !response.body.address) {\n  console.log(`Error: La respuesta no contiene informaci칩n sobre la direcci칩n de celda`);\n  return {\n    json: {\n      error: \"RESPUESTA_SIN_DIRECCION\",\n      mensaje: \"La respuesta no incluye informaci칩n sobre la direcci칩n de celda\",\n      requestId: response.id,\n      status: response.status,\n      celdaOriginal: celdaOriginal,\n      exito: false\n    }\n  };\n}\n\n// Extraer la direcci칩n de celda de la respuesta\nlet direccionRespuesta = \"\";\nif (response.body && response.body.address) {\n  const partesDireccion = response.body.address.split('!');\n  if (partesDireccion.length > 1) {\n    direccionRespuesta = partesDireccion[1];\n  }\n}\n\n// Obtener el valor insertado de la respuesta\nconst valorInsertado = response.body.values && response.body.values[0] && response.body.values[0][0];\n\n// Verificar si la inserci칩n se realiz칩 en la celda correcta\nconst insercionCorrecta = direccionRespuesta === celdaOriginal;\n\n// Verificar el c칩digo de estado HTTP\nconst estadoExitoso = response.status >= 200 && response.status < 300;\n\n// Crear objeto para almacenar el resultado de la verificaci칩n\nconst resultado = {\n  exito: insercionCorrecta && estadoExitoso,\n  celdaOriginal: celdaOriginal,\n  celdaInsertada: direccionRespuesta,\n  valorInsertado: valorInsertado,\n  statusCode: response.status,\n  requestId: response.id,\n  indice: indice,\n  celdasDiferentes: !insercionCorrecta && estadoExitoso,\n  falloEstado: !estadoExitoso\n};\n\nif (!insercionCorrecta || !estadoExitoso) {\n  console.log(`Error en inserci칩n: celda original=${celdaOriginal}, celda insertada=${direccionRespuesta}, status=${response.status}`);\n} else {\n  console.log(`Inserci칩n correcta en celda ${celdaOriginal} con valor \"${valorInsertado}\"`);\n}\n\n// Incluir la respuesta original para tener toda la informaci칩n\nresultado.respuestaOriginal = response;\n\n// Retornar el resultado de la verificaci칩n\nreturn {\n  json: resultado\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6592,
        2768
      ],
      "id": "9ba98013-77d6-4444-a1bb-f327ac04a2d1",
      "name": "Code Volver a validar Inserci칩n",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f7205e4e-147c-4e77-8fa8-08d082980b48",
              "leftValue": "={{ $json.exito }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6816,
        2768
      ],
      "id": "6e1e3abc-8b69-417e-8177-671064bd6210",
      "name": "If Verificar Inserci칩n 2"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        5712,
        2768
      ],
      "id": "435f1a4c-ff0c-4d2a-9ea8-782f0583f17f",
      "name": "Wait2",
      "webhookId": "a4bbf2b1-ea0c-4b02-af2c-64b29f2bdb5c"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        7120,
        2944
      ],
      "id": "035d3c9e-0156-4cbd-9d94-35c2a23d19ee",
      "name": "Wait3",
      "webhookId": "9d944db7-9c4f-439e-9990-d9937f2fb18e"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        7552,
        3296
      ],
      "id": "f27b153f-3263-442a-98a0-81fa1b4c855d",
      "name": "OpenAI Chat Model12",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=Eres un asistente de un sistema de agendamiento de citas para la entrega de mercanc칤a en bodega. Debes notificar al cliente que ha ocurrido un error en el sistema durante el proceso de inserci칩n de la cita.\n\nGenera un mensaje directo aplicando estos principios de UX para WhatsApp:\n\n**FORMATO Y ESTRUCTURA:**\n1. Usa *negritas* para informaci칩n cr칤tica como tiempo l칤mite y acciones urgentes\n2. Usa emojis estrat칠gicos: 游뚿 (urgente), 丘멆잺 (error), 낋 (tiempo l칤mite), 游 (contacto), 游멆잺 (t칠cnico)\n3. Estructura la informaci칩n de forma jer치rquica y visual\n4. Destaca el tiempo l칤mite de *5 minutos* con formato apropiado\n\n**CONTENIDO REQUERIDO:**\n1. 游뚿 Comunica claramente que ocurri칩 un *error t칠cnico* al registrar la cita\n2. 낋 Indica urgentemente que se comunique con el 치rea de bodega en los pr칩ximos *5 minutos*\n3. 丘멆잺 Menciona el riesgo de *perder la franja horaria* por alta demanda de muelles\n4. 游멆잺 Aclara que es una situaci칩n *poco com칰n* por inconveniente t칠cnico\n5. 游똂 Pide disculpas y agradece la comprensi칩n\n\n**TONO:** Urgente pero profesional, enfatizando acci칩n inmediata para mantener la franja horaria.\n\n**EJEMPLO DE ESTRUCTURA ESPERADA:**\n游뚿 *Error t칠cnico en el sistema*\n\n丘멆잺 No pudimos registrar tu cita debido a un *inconveniente t칠cnico* en el sistema.\n\n낋 *URGENTE:* Comun칤cate con el 치rea de bodega en los pr칩ximos *5 minutos* para que puedan agendar tu cita manualmente.\n\n游뚿 Si no estableces contacto en ese tiempo, podr칤as *perder la franja horaria* seleccionada...\n\n游똂 Disculpas por los inconvenientes...\n"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        7632,
        3088
      ],
      "id": "40142989-368a-4db3-92fb-08a0afcf6a09",
      "name": "Basic LLM Notificar No Disponibilidad2",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Basic LLM Notificar No Disponibilidad2').item.json.text.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8032,
        3264
      ],
      "id": "2c714d36-92e6-4bde-9ec7-80211661a6b4",
      "name": "Validaci칩n de longitud de caracteres6"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad2').item.json.text }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad2').item.json.text.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8336,
        3280
      ],
      "id": "85e6f5f5-e549-429d-9f47-fdc68eca9362",
      "name": "Organiza variables del mensaje6"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        8512,
        3056
      ],
      "id": "8fbef71e-1f45-4ee3-a5f0-31a5888a44f3",
      "name": "No Operation, do nothing8"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8336,
        3056
      ],
      "id": "6fcded6f-3c50-40c4-83ee-061f36638dd7",
      "name": "HTTP Request Enviar Mensaje por WhatsApp9"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2640,
        1616
      ],
      "id": "05997df8-e4bd-4548-951f-d62047408ee1",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# Extracci칩n de informaci칩n para citas de log칤stica\n\nAnaliza TODOS los mensajes de la conversaci칩n (tanto el mensaje actual como el historial completo) para extraer la informaci칩n necesaria para agendar una cita de log칤stica. \n\n## Contexto \nLos usuarios pueden proporcionar informaci칩n de forma parcial a lo largo de varios mensajes. Tu tarea es acumular y consolidar toda esta informaci칩n. Debes extraer cualquier dato relevante sin importar en qu칠 mensaje aparezca (actual o hist칩rico).\n\n## Campos a extraer\n- Nombre del proveedor\n- Fecha de entrega (formato: DD de MMMM de YYYY)\n- Hora de entrega (formato: HH:MM AM/PM)\n- Categor칤a del material\n- Peso en kilos (extraer solo el valor num칠rico entero, ej: de '3.500 kilos' extraer 3500)\n- N칰mero de unidades (extraer solo el valor num칠rico entero, ej: de '7,000 unidades' extraer 7000)\n- N칰mero de orden de compra\n\n## Fuentes de informaci칩n\n- Mensaje actual: {{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.mensajeActual }}\n- Historial de mensajes: {{$node[\"Unificaci칩n y consistencia de datos\"].json.infoMensaje.historialMensajes}}\n- Hora actual: {{$node[\"Organiza el Mensaje\"].json.infoMensaje.horaMensajeActual}}\n- Fecha actual: {{$node[\"Organiza el Mensaje\"].json.infoMensaje.fechaMensajeActual}}\n\n## Instrucciones espec칤ficas para interpretaci칩n de fechas\n1. NUNCA interpretes fechas que est칠n en el pasado. Toda fecha debe ser igual o posterior a la fecha actual.\n2. Para fechas espec칤ficas num칠ricas:\n   - Si el usuario menciona \"30 de abril\" o \"el 30 de abril\", usa exactamente esa fecha.\n   - Si el usuario dice algo como \"para el 28\", interpreta como el d칤a 28 del mes actual seg칰n la fecha del sistema.\n3. Para fechas con d칤a de la semana y fecha num칠rica (ej: \"mi칠rcoles 30 de abril\"):\n   - Prioriza SIEMPRE la fecha num칠rica (30 de abril) aunque el d칤a de la semana mencionado sea incorrecto.\n4. Para fechas que solo mencionan el d칤a de la semana (ej: \"el martes\"):\n   - Si ese d칤a ya pas칩 en la semana actual, asume que se refiere a la pr칩xima semana.\n   - Ejemplo: Si hoy es jueves y dicen \"el mi칠rcoles\", debe interpretarse como el mi칠rcoles de la pr칩xima semana.\n5. Para expresiones relativas:\n   - \"hoy\" = fecha actual del sistema\n   - \"ma침ana\" = fecha actual + 1 d칤a\n   - \"pasado ma침ana\" = fecha actual + 2 d칤as\n6. Si hay informaci칩n contradictoria sobre la fecha en diferentes mensajes, prioriza la informaci칩n del mensaje m치s reciente.\n\n## Instrucciones espec칤ficas para interpretaci칩n de n칰meros\n1.  Los campos 'peso' y 'unidades' deben ser valores num칠ricos enteros.\n2.  Los usuarios pueden usar puntos (.) o comas (,) como separadores de miles. Tu tarea es ignorar estos separadores y extraer el n칰mero completo.\n3.  **Ejemplos de interpretaci칩n correcta:**\n    - \"3.500 kilos\" debe interpretarse como el n칰mero `3500`.\n    - \"3,500 kilos\" debe interpretarse como el n칰mero `3500`.\n    - \"3500 kilos\" debe interpretarse como el n칰mero `3500`.\n    - \"7.000 unidades\" debe interpretarse como el n칰mero `7000`.\n4.  Extrae 칰nicamente la parte num칠rica. Ignora texto como \"kilos\", \"unidades\", \"kg\", etc.\n\n## Instrucciones generales\n1. Analiza PRIMERO el historial de mensajes completo, luego el mensaje actual.\n2. Si un dato aparece en m칰ltiples mensajes, prioriza la versi칩n m치s reciente (mensaje actual).\n3. Si encuentras un mensaje que parece ser una respuesta directa a una pregunta sobre un dato espec칤fico (ej. \"쮺u치l es el peso?\"  \"300 kilos\"), considera esto como informaci칩n v치lida.\n4. NO generes ni inventes informaci칩n que no est칠 presente en los mensajes.\n5. Extrae solo la informaci칩n factual, no interpretes intenciones o deseos del usuario.\n6. NO incluyas notas, explicaciones o campos adicionales en el JSON final.\n7. Si un dato no se encuentra en ninguna parte de la conversaci칩n, d칠jalo en blanco o como valor predeterminado (0 para valores num칠ricos, \"\" para texto).\n\n## Formato de respuesta\nDevuelve 칔NICAMENTE un objeto JSON limpio con el siguiente formato exacto:\n\n{\n  \"proveedor\": \"\",\n  \"fecha\": \"\",\n  \"hora\": \"\",\n  \"categoria\": \"\",\n  \"peso\": 0,\n  \"unidades\": 0,\n  \"ordenCompra\": \"\"\n}",
        "hasOutputParser": true
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        2736,
        1408
      ],
      "id": "ec9c4b1b-8db3-400a-b8cf-d42e03ae91b1",
      "name": "Basic LLM Chain RECOLECCI칍N1"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"proveedor\": \"SPB COLOMBIA S.A.S.\",\n  \"fecha\": \"30 de abril de 2025\",\n  \"hora\": \"08:00 AM\",\n  \"categoria\": \"ARENAS\",\n  \"peso\": 300,\n  \"unidades\": 600,\n  \"ordenCompra\": \"ARGM47896\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        2848,
        1616
      ],
      "id": "465595eb-5ffa-481b-af2e-fd43b87e327c",
      "name": "Structured Output Parser3"
    },
    {
      "parameters": {
        "jsCode": "/*\n===========================================================\n  Nodo Code - VALIDAR INSERCIONES EN EXCEL (n8n)\n   Analiza la salida del Loop Over Uno a Uno.\n   Agrupa los 칤tems por franja (campo `indice` si existe;\n    de lo contrario, cada bloque de 5 칤tems forma una franja).\n   Verifica que cada inserci칩n tenga:\n        exito === true\n        statusCode === 200\n        falloEstado === false\n   Devuelve un 칰nico objeto JSON con:\n         Resumen global.\n         Detalle por franja (칠xitos / fallos y celdas con error).\n===========================================================\n*/\n\n// 1) Obtener todos los 칤tems que llegan al nodo\nconst items = $input.all();\n\n// 2) Funci칩n auxiliar para determinar el identificador de la franja\nfunction obtenerIdFranja(item, idx) {\n  // Si existe 'indice', 칰salo; de lo contrario agrupa cada 5 칤tems\n  if (item.json && item.json.indice !== undefined && item.json.indice !== null) {\n    return String(item.json.indice).trim();\n  }\n  // +1 para que las franjas queden 1-basadas\n  return String(Math.floor(idx / 5) + 1);\n}\n\n// 3) Agrupar 칤tems por franja\nconst franjas = {};\nitems.forEach((item, idx) => {\n  const idFranja = obtenerIdFranja(item, idx);\n  if (!franjas[idFranja]) {\n    franjas[idFranja] = { id: idFranja, items: [] };\n  }\n  franjas[idFranja].items.push(item.json);\n});\n\n// 4) Analizar cada franja y construir el detalle\nconst detallesPorFranja = Object.values(franjas).map(franja => {\n  const totalOps   = franja.items.length;\n  const exitosas   = franja.items.filter(i =>\n    i.exito === true &&\n    i.statusCode === 200 &&\n    i.falloEstado === false\n  ).length;\n\n  const fallidas   = totalOps - exitosas;\n  const exitoTotal = fallidas === 0;\n\n  // Celdas con error para un diagn칩stico claro\n  const celdasFallidas = franja.items\n    .filter(i => !(i.exito && i.statusCode === 200 && !i.falloEstado))\n    .map(i => ({\n      celdaOriginal   : i.celdaOriginal,\n      celdaInsertada  : i.celdaInsertada,\n      statusCode      : i.statusCode,\n      falloEstado     : i.falloEstado,\n      celdasDiferentes: i.celdasDiferentes,\n      mensaje         : 'Inserci칩n fallida'\n    }));\n\n  return {\n    idFranja                : franja.id,\n    exitoFranja             : exitoTotal,\n    operacionesTotales      : totalOps,\n    operacionesExitosas     : exitosas,\n    operacionesFallidas     : fallidas,\n    porcentajeExitosas      : ((exitosas / totalOps) * 100).toFixed(2) + '%',\n    celdasFallidas\n  };\n});\n\n// 5) Resumen global\nconst operacionesTotales   = items.length;\nconst operacionesExitosas  = detallesPorFranja.reduce((sum, f) => sum + f.operacionesExitosas, 0);\nconst operacionesFallidas  = operacionesTotales - operacionesExitosas;\n\nconst franjasTotales   = detallesPorFranja.length;\nconst franjasExitosas  = detallesPorFranja.filter(f => f.exitoFranja).length;\nconst franjasFallidas  = franjasTotales - franjasExitosas;\n\n\nconst resumen = {\n  estadoGeneral              : franjasFallidas === 0 ? '칄XITO_COMPLETO' : '칄XITO_PARCIAL',\n  franjasTotales,\n  franjasExitosas,\n  franjasFallidas,\n  porcentajeFranjasExitosas  : ((franjasExitosas / franjasTotales) * 100).toFixed(2) + '%',\n  operacionesTotales,\n  operacionesExitosas,\n  operacionesFallidas,\n  porcentajeOperacionesExitosas : ((operacionesExitosas / operacionesTotales) * 100).toFixed(2) + '%',\n  detallesPorFranja\n};\n\n// 6) Devolver un 칰nico 칤tem con el resumen\nreturn [\n  {\n    json: resumen\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4512,
        2416
      ],
      "id": "115f57cc-abf8-48cd-98f6-390dd5f34fa6",
      "name": "Code Validar inserciones"
    },
    {
      "parameters": {
        "jsCode": "// 1) Leer chat_id una sola vez\nconst chatId = $node[\"Organiza el Mensaje\"].json.infoMensaje.chat_id;\n\n// 2) Tomamos los datos de informacionCita una sola vez\nconst cita = $input.first().json.informacionCita || {};\nconst historialMensajes = $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.historialMensajes;\n\n// Funci칩n para convertir fechas en formato \"06 de mayo de 2025\" a \"YYYY-MM-DD HH:mm:ss\"\nfunction convertirFecha(fechaTexto) {\n  const meses = {\n    enero: '01', febrero: '02', marzo: '03', abril: '04', mayo: '05',\n    junio: '06', julio: '07', agosto: '08', septiembre: '09',\n    octubre: '10', noviembre: '11', diciembre: '12'\n  };\n\n  // Dividir la fecha y mapear el mes\n  const [dia, de, mes, deNuevo, anio] = fechaTexto.split(' ');\n  const mesNumerico = meses[mes.toLowerCase()]; // Convertir el mes a n칰mero\n  return `${anio}-${mesNumerico}-${dia.padStart(2, '0')} 00:00:00`; // Formato DATETIME\n}\n\n// Convertimos la fecha aqu칤\nconst fechaCitaConvertida = convertirFecha(cita.fecha);\n\n// 3) Retornamos un solo objeto con todos los datos necesarios\nreturn {\n  json: {\n    chat_id: chatId,\n    proveedor: cita.proveedor,\n    orden_compra: cita.ordenCompra,\n    peso: cita.peso,\n    unidades: cita.unidades,\n    categoria: cita.categoria,\n    muelle: cita.muelle,\n    fecha_cita: fechaCitaConvertida, // Fecha ya convertida\n    hora_inicio: cita.horaInicio,\n    hora_fin: cita.horaFin,\n    chat_historial: historialMensajes,\n    // Incluimos cualquier otro dato que necesites\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4256,
        2304
      ],
      "id": "ae18d372-7dd4-4fc5-b564-721863a87d09",
      "name": "Code Datos Insert Cita"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, chat_id, franjas_json\nFROM FranjasDisponiblesTemp\nWHERE chat_id = '{{ $json.chat_id }}'\nORDER BY timestamp_enviado ASC;\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        4512,
        2224
      ],
      "id": "2fc5ae6e-b5cd-4ed4-acdf-63d652923172",
      "name": "Microsoft SQL Franjas Temporales",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8c501d95-bdf3-4635-a037-224926c2528d",
              "leftValue": "={{ $json.estadoGeneral }}",
              "rightValue": "칄XITO_COMPLETO",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4848,
        2416
      ],
      "id": "b278d790-8664-432b-9711-efeb4cfb9efa",
      "name": "If Validar inserciones"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        5152,
        2304
      ],
      "id": "939e86c2-8572-4667-8e19-76aeb0984085",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Nodo Code  Unir Franjas en Historial렢n * Coloca este nodo inmediatamente despu칠s de Microsoft SQL Franjas Temporales.\n * No requiere par치metros adicionales.\n */\n\n// 1) Tomamos todos los 칤tems que llegan desde el nodo SQL\nconst items = $input.all();   //  cada item = { id, chat_id, franjas_json }\n\n// 2) Armamos la cadena tipo historial:  \"Franja 1: {...}\\n\\nFranja 2: {...}\\n\\n뵢"\nlet historial = '';\nitems.forEach((item, idx) => {\n  const numero = idx + 1;                                 // 1, 2, 3, 뵢n  const cuerpoFranja = JSON.stringify(JSON.parse(item.json.franjas_json), null, 2);    // viene como string desde SQL\n  historial += `Franja ${numero}: ${cuerpoFranja}\\n\\n`;\n});\n\n// 3) (Opcional) quitamos el 칰ltimo salto de l칤nea doble\nhistorial = historial.trimEnd();\n\n// 4) Devolvemos **UN** 칤tem con **UNA** propiedad (ajusta el nombre si quieres)\nreturn [\n  {\n    json: {\n      franjas_historial: historial            //  cadena final\n    }\n  }\n];\n\n/* -------------------------------------------------------------------------\n   Ejemplo de salida cuando hay 3 filas:\n\n   {\n     \"franjas_historial\": \"Franja 1: {\\\"disponibilidadConfirmada\\\":false,...}\\n\\n\n                           Franja 2: {\\\"disponibilidadConfirmada\\\":true,...}\\n\\n\n                           Franja 3: {...}\"\n   }\n--------------------------------------------------------------------------- */\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4848,
        2224
      ],
      "id": "1595c4be-f0b7-44a6-89bf-2426d6581f8a",
      "name": "Code Estructuraci칩n de franjas temporales"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        8000,
        2736
      ],
      "id": "03de0b1e-47b4-44fd-af57-5515e83ba85f",
      "name": "Merge1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO CitasRecepcion\n(\n    chat_id,\n    nombre,              \n    orden_compra,\n    peso,\n    unidades,\n    horas_entrega,\n    categoria,\n    muelle,\n    fecha_cita,\n    hora_inicio,\n    hora_fin,\n    estado,\n    fecha_creacion,\n    fecha_modificacion,\n    chat_historial,\n    chat_historial_datos\n)\n/* 較較較 AQU칈 較較較 */\nOUTPUT INSERTED.id          --    devolver치 el IDENTITY de la fila reci칠n insertada\nVALUES\n(\n    '{{ $('Code Datos Insert Cita').first().json.chat_id }}',\n    '{{ $('Code Datos Insert Cita').first().json.proveedor }}',\n    '{{ $('Code Datos Insert Cita').first().json.orden_compra }}',\n     {{ $('Code Datos Insert Cita').first().json.peso }},              \n     {{ $('Code Datos Insert Cita').first().json.unidades }},          {{ $('Code Agrupar Franjas').first().json.informacionCita.duracionHoras }},\n    '{{ $('Code Datos Insert Cita').first().json.categoria }}',\n    '{{ $('Code Datos Insert Cita').first().json.muelle }}',\n    '{{ $('Code Datos Insert Cita').first().json.fecha_cita }}',\n    '{{ $('Code Datos Insert Cita').first().json.hora_inicio }}',      \n    '{{ $('Code Datos Insert Cita').first().json.hora_fin }}',   \n      'PROGRAMADA',                   \n    (SYSDATETIMEOFFSET() AT TIME ZONE 'SA Pacific Standard Time'), \n    NULL,                            \n    '{{ $items(\"Code Datos Insert Cita\")\n        .map(i => i.json.chat_historial)\n        .join(\"\\n\")\n        .replace(/'/g,\"''\") }}',\n    '{{ $items('Merge')\n        .map(i => i.json.franjas_historial)\n        .join('\\n')\n        .replace(/'/g, \"''\") }}'\n);\n\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        6864,
        2448
      ],
      "id": "8e2d146c-f8fd-4d92-9c90-462c24118532",
      "name": "Microsoft SQL Insertar Cita",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "BEGIN TRANSACTION;\n\nDELETE FROM MensajesWhatsApp\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n   OR (chat_id = 'agenteAI'\n       AND message_id IN (\n           SELECT message_id \n           FROM MensajesWhatsApp\n           WHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n       )\n   );\n\nDELETE FROM FranjasDisponiblesTemp \nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\nCOMMIT;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        30416,
        7568
      ],
      "id": "aa846c4e-e4f9-4d2b-8902-0cd7611eccb8",
      "name": "Microsoft SQL Eliminar Mensajes",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        8320,
        2848
      ],
      "id": "89340251-684f-4327-93e4-7878b7909e98",
      "name": "OpenAI Chat Model13",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Basic LLM Notificar Cita Exitosa').item.json.text.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        9264,
        2768
      ],
      "id": "a37b0c76-6c5b-4dd6-aaf9-d898fc8495ef",
      "name": "Validaci칩n de longitud de caracteres7"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Basic LLM Notificar Cita Exitosa').item.json.text }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Basic LLM Notificar Cita Exitosa').item.json.text.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9568,
        2896
      ],
      "id": "0e82f5d3-2e1a-4316-b6a2-4b46a8e5a7d2",
      "name": "Organiza variables del mensaje7"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        9728,
        2672
      ],
      "id": "2a63eeed-e3b5-4b57-8987-8096948ac38e",
      "name": "No Operation, do nothing9"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        9552,
        2672
      ],
      "id": "cca3d914-dc53-4f0d-baff-72490012f1f2",
      "name": "HTTP Request Enviar Mensaje por WhatsApp10"
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# Rol\nEres el asistente virtual de Konf칤eLogistics.  \nTu objetivo es notificar al proveedor que su cita se registr칩 con 칠xito en el cronograma.\n\n# Datos disponibles\n- idCita           = {{ $(\"Microsoft SQL Insertar Cita\").first().json.id }}\n- fechaCita        = {{ $(\"Code Datos Insert Cita\").first().json.fecha_cita }}\n- horaInicio       = {{ $(\"Code Datos Insert Cita\").first().json.hora_inicio }}\n- horaFin          = {{ $(\"Code Datos Insert Cita\").first().json.hora_fin }}\n- muelle           = {{ $(\"Code Datos Insert Cita\").first().json.muelle }}\n- ordenCompra      = {{ $(\"Code Datos Insert Cita\").first().json.orden_compra }}\n- categoria        = {{ $(\"Code Datos Insert Cita\").first().json.categoria }}\n- pesoKg           = {{ $(\"Code Datos Insert Cita\").first().json.peso }}\n- unidades         = {{ $(\"Code Datos Insert Cita\").first().json.unidades }}\n\n# Instrucciones de redacci칩n\n1. Mant칠n un tono profesional, cordial y positivo (feliz pero sin exagerar).\n2. Empieza con una breve expresi칩n de entusiasmo por la confirmaci칩n exitosa (ej.: 럑멘xcelente! o 럑멖ita confirmada!).\n3. Muestra los detalles de la cita en una lista con vi침etas y emojis apropiados:\n    游 **N칰mero de cita:** res치ltalo con el emoji 游댔 antes del `idCita`  游댔슽{ $(\"Microsoft SQL Insertar Cita\").first().json.id }}\n    游늰 **Fecha:** {{ $(\"Code Datos Insert Cita\").first().json.fecha_cita.split(\" \")[0] }}\n    낋 **Horario:** {{ $(\"Code Datos Insert Cita\").first().json.hora_inicio }}슽{ $(\"Code Datos Insert Cita\").first().json.hora_fin }} \n    游뛀 **Muelle:** {{ $(\"Code Datos Insert Cita\").first().json.muelle }} \n    游낑勇 **O/C:** {{ $(\"Code Datos Insert Cita\").first().json.orden_compra }} \n    游닍 **Categor칤a:** {{ $(\"Code Datos Insert Cita\").first().json.categoria }}\n    丘뒲잺 **Peso:** {{ $(\"Code Datos Insert Cita\").first().json.peso }}슮g  \n    游닍 **Unidades:** {{ $(\"Code Datos Insert Cita\").first().json.unidades }}\n4. Reitera el n칰mero de cita con el emoji 游댔 y aclara que con ese n칰mero el proveedor podr치 **modificar o cancelar** la cita.\n5. Explica claramente la pol칤tica: Las modificaciones o cancelaciones deben solicitarse **hasta un슧칤a h치bil antes** y **antes de las4:30슳.슰.**; despu칠s de ese plazo no podremos realizar cambios.렢n6. Cierra agradeciendo su colaboraci칩n y confirmando que estaremos atentos a su llegada.\n7. Devuelve **solo** el mensaje final, sin encabezados ni explicaciones adicionales.\n\n# Salida esperada (ejemplo de estilo)\n九 *춰Cita confirmada con 칠xito!* 游꿀  \n游댔 Numero de la Cita:12345  \n游늰 El06슧e슰ayo슧e2025  \n낋슈 las 08:0010:00  \n游뛀슌n el Muelle1  \n游낑勇슖/C슈RGM47896  \n游닍슊ategor칤a슈renas  \n丘뒲잺300슮g | 游닍600슷\n\nGuarda tu n칰mero de cita 游댔12345 para futuras gestiones ya sea reprogramar o cancelar.  \nPodr치s modificarla o cancelarla hasta un d칤a h치bil antes y antes de las4:30슳.슰.  \n춰Muchas gracias por tu confianza!\n"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        8368,
        2640
      ],
      "id": "7516211d-07ae-4ebf-bb52-189b533a89b5",
      "name": "Basic LLM Notificar Cita Exitosa",
      "alwaysOutputData": true,
      "executeOnce": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "BEGIN TRANSACTION;\n\nDELETE FROM MensajesWhatsApp\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n   OR (chat_id = 'agenteAI'\n       AND message_id IN (\n           SELECT message_id \n           FROM MensajesWhatsApp\n           WHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n       )\n   );\n\nDELETE FROM FranjasDisponiblesTemp \nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\n-- Resetear estado conversacional a INICIAL despu칠s de cita creada exitosamente\nUPDATE EstadoConversacional \nSET estado_actual = 'INICIAL', \n    contexto_proceso = '{\"descripcion\": \"Cita creada exitosamente, conversaci칩n reiniciada\", \"ultima_accion\": \"cita_creada\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    contador_fuera_contexto = 0,\n    ultimo_mensaje_fuera_contexto = NULL,\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\n-- Si no existe el registro, crear uno en estado INICIAL\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}', \n        'INICIAL', \n        '{\"descripcion\": \"Cita creada exitosamente, conversaci칩n reiniciada\", \"ultima_accion\": \"cita_creada\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\nCOMMIT;\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        7440,
        2960
      ],
      "id": "57f2f443-9772-4f0c-9980-d6f096ddecc6",
      "name": "Microsoft SQL Eliminar Mensajes2",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -96,
        5280
      ],
      "id": "2fbfc60c-de0d-4914-9fb1-9ae52f51c1a6",
      "name": "OpenAI Chat Model14",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n\"idCita\": \"\",\n\"ordenCompra\": \"\",\n\"nuevaFecha\": \"\",\n\"nuevaHora\": \"\",\n\"camposFaltantes\": [],\n\"fechaActual\": \"\",\n\"horaActual\": \"\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        64,
        5280
      ],
      "id": "f816d2f4-36a1-495c-9e06-35e448a6aea3",
      "name": "Structured Output Parser4"
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# Extracci칩n de datos para edici칩n de citas\n\n## SISTEMA\nEres un asistente especializado en interpretar mensajes de usuarios para reprogramaci칩n de citas log칤sticas. Tu funci칩n es extraer los datos necesarios para reprogramar una cita existente (ID de cita, orden de compra, nueva fecha, nueva hora) y validar que sean coherentes.\n\n**Tu 칰nica responsabilidad es extraer datos, no validarlos ni tomar decisiones.**\n\n## DETECCI칍N DE RETRACTACIONES EN EDICI칍N\nSi detectas m칰ltiples cambios de fecha/hora contradictorios en el historial:\n- Verifica si el usuario ha mencionado diferentes fechas para la reprogramaci칩n\n- Si encuentra fechas contradictorias, marca como rechazado con motivo \"retractaciones_multiples\"\n- Sugiere reiniciar el proceso\n\n## Datos a extraer\n- ID de la cita (por ejemplo, \"Cita 12345\", \"N칰mero 12345\", etc.)\n- N칰mero de orden de compra asociado a la cita\n- Nueva fecha deseada\n- Nueva hora deseada\n\n## Fuentes de datos a analizar\n- Mensaje actual: {{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.mensajeActual }}\n- Historial de mensajes: {{ $node[\"Unificaci칩n y consistencia de datos\"].json[\"infoMensaje\"][\"historialMensajes\"] }}\n- Hora actual: {{$node[\"Organiza el Mensaje\"].json.infoMensaje.horaMensajeActual}}\n- Fecha actual: {{$node[\"Organiza el Mensaje\"].json.infoMensaje.fechaMensajeActual}}\n\n## Procesamiento del historial completo de mensajes\n1. IMPORTANTE: Analiza el historial COMPLETO de mensajes como una conversaci칩n\n2. Busca informaci칩n relevante a lo largo de TODOS los mensajes, no solo en el mensaje actual\n3. Considera que la informaci칩n puede estar distribuida en varios mensajes (por ejemplo, ID en un mensaje, orden de compra en otro, fecha en otro, hora en otro)\n4. Une la informaci칩n proporcionada en mensajes separados para construir la solicitud completa\n5. Si el mensaje actual contiene solo un dato (como \"a las 7am\"), con칠ctalo con datos previos de mensajes anteriores\n\n## Detecci칩n de retractaciones espec칤fica\n6. CR칈TICO: Detecta si el usuario ha proporcionado fechas contradictorias para la reprogramaci칩n:\n   - Ejemplo: Primer mensaje \"reprogramar para el 17 de julio\", segundo mensaje \"mejor para el 18 de julio\"\n   - Si detectas esto, marca motivoRechazo como \"retractaciones_multiples\"\n\n## Instrucciones espec칤ficas\n1. Busca PRIMERO el ID de la cita en formato num칠rico en CUALQUIER mensaje previo\n2. Busca el n칰mero de orden de compra en CUALQUIER mensaje previo\n3. Si encuentras ID y orden de compra, busca la fecha nueva que desea el proveedor en CUALQUIER mensaje previo o actual\n4. Si encuentras ID, orden de compra y fecha, busca la hora nueva que desea el proveedor en CUALQUIER mensaje previo o actual\n5. Si un mensaje solo menciona la hora (por ejemplo, \"7am\"), con칠ctalo con la fecha mencionada en mensajes anteriores\n6. Si un mensaje solo menciona una fecha (por ejemplo, \"jueves 8 de mayo\"), busca si hay informaci칩n sobre la hora en otros mensajes\n7. Considera expresiones como \"para ma침ana\", \"para el lunes\", \"para el 20\", etc. encontradas en CUALQUIER mensaje\n8. Normaliza la fecha al formato \"DD de [mes] de YYYY\" (usando el a침o actual si no se especifica)\n9. Normaliza la hora al formato \"HH:MM AM/PM\"\n10. NUEVO: Verifica si hay fechas contradictorias en diferentes mensajes del historial\n\n## Reglas de validaci칩n temporal\n1. Si la nueva fecha es anterior a la fecha actual  motivoRechazo: \"fecha_pasada\"\n2. Si la nueva fecha es para el mismo d칤a despu칠s de las 4:30 PM  motivoRechazo: \"mismo_dia_tarde\"\n3. Si la nueva fecha es para el d칤a siguiente y son m치s de las 4:30 PM  motivoRechazo: \"dia_siguiente_tarde\"\n4. Si hay m칰ltiples fechas contradictorias  motivoRechazo: \"retractaciones_multiples\"\n\n## Formato de respuesta (JSON)\n```json\n{\n  \"idCita\": \"12345\",\n  \"ordenCompra\": \"ARGM47896\", \n  \"nuevaFecha\": \"20 de mayo de 2025\",\n  \"nuevaHora\": \"10:00 AM\",\n  \"camposFaltantes\": [],\n  \"fechaActual\": \"19 de mayo de 2025\",\n  \"horaActual\": \"14:30\",\n  \"motivoRechazo\": \"retractaciones_multiples\",\n  \"mensajeParaUsuario\": \"\"\n}\n```\n\n## MENSAJES PARA USUARIO CON FORMATO WHATSAPP\n\n### Si falta idCita:\n```\n游늶 *Informaci칩n requerida*\n\n游댔 Necesito el *n칰mero de cita* que aparece en tu confirmaci칩n anterior.\n\n游눠 *Ejemplo:* \"Debes proporcionar el ID de la cita que se envi칩 cuando creaste la cita\"\n\n游닇 *Formato:* \"Quiero reagendar mi cita 12345 para [nueva fecha]\"\n```\n\n### Si falta ordenCompra:\n```\n游늶 *Informaci칩n requerida*\n\n游낑勇 Necesito el *n칰mero de orden de compra* para verificaci칩n.\n\n游눠 *Ejemplo:* ARGM47896, OC-12345\n\n游닇 *Formato:* \"Mi orden de compra es ARGM47896\"\n```\n\n### Si falta nuevaFecha:\n```\n游늶 *Informaci칩n requerida*\n\n游늰 Necesito la *fecha nueva* para tu entrega.\n\n游눠 *Ejemplo:* \"Debes proporcionar la fecha nueva para la entrega de esta forma: 15 de agosto\"\n\n游닇 *Formato:* \"Quiero reagendar para el 15 de agosto\"\n```\n\n### Si falta nuevaHora:\n```\n游늶 *Informaci칩n requerida*\n\n낋 Necesito la *hora nueva* para tu entrega.\n\n游눠 *Ejemplo:* \"10:00 AM\", \"2:30 PM\", \"en la ma침ana\"\n\n游닇 *Formato:* \"A las 10:00 AM\"\n```\n\n### Para retractaciones m칰ltiples:\n```\n丘멆잺 *Aclaraci칩n necesaria*\n\n游닇 He detectado *fechas diferentes* en tus mensajes.\n\n游뱂 Para evitar confusiones, confirma:\n\n仇 *쮺u치l es la fecha definitiva que prefieres?*\n\n游눠 *Ejemplo:* \"Confirmo que quiero reagendar para el 20 de mayo a las 10:00 AM\"\n```\n\n## Ejemplos de campos faltantes\n- Si no hay ID: camposFaltantes: [\"idCita\"]  \n- Si no hay orden: camposFaltantes: [\"ordenCompra\"]\n- Si no hay fecha: camposFaltantes: [\"nuevaFecha\"]\n- Si no hay hora: camposFaltantes: [\"nuevaHora\"]\n\n## Casos especiales de retractaci칩n\n- Usuario dice: \"reprogramar mi cita 123 para el 17\", luego \"mejor para el 18\"  motivoRechazo: \"retractaciones_multiples\"\n- Usuario cambia fecha m칰ltiples veces en la misma conversaci칩n  motivoRechazo: \"retractaciones_multiples\"\n\nIMPORTANTE: Solo extrae datos, no valides fechas pasadas ni horarios de oficina. Esa validaci칩n la hace otro nodo.",
        "hasOutputParser": true
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        -16,
        5088
      ],
      "id": "578c9e66-d60d-40d0-8204-1cf0cb2808e5",
      "name": "Basic LLM Extracci칩n y Validacion de Datos Editar Cita"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f0ba0488-a2ee-439f-ac12-ff4f15d14c58",
              "leftValue": "={{ $node[\"Code Validaci칩n de datos para reprogramaci칩n de citas\"].json.todoCorrecto }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1088,
        5088
      ],
      "id": "8e3e0f36-f243-4c78-ab6b-bf4721ac0461",
      "name": "If Validar si la operaci칩n es posible (todoCorrecto)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b8d93581-02fd-4502-8346-e5f35dd7a430",
              "leftValue": "={{ $('Code Validaci칩n de datos para reprogramaci칩n de citas').item.json.intentaModificarDatos }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1488,
        5264
      ],
      "id": "acc2ebf7-07f0-4ea1-afc9-bed8e2ebbfa0",
      "name": "If Verificar si se intenta modificar datos no permitidos"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "17546f72-2b59-46c3-b92b-e87f10cf0799",
              "leftValue": "={{ $('Code Validaci칩n de datos para reprogramaci칩n de citas').item.json.rechazoTemporal }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1744,
        5488
      ],
      "id": "1e76c6a4-a292-4241-baba-df4f1dd06cec",
      "name": "If Verificar si es un rechazo por motivos temporales"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "46e5638b-d64b-47e5-9cac-984fb79f107c",
              "leftValue": "={{ $('Code Validaci칩n de datos para reprogramaci칩n de citas').item.json.camposFaltantes.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2016,
        5696
      ],
      "id": "d6e7b277-79fd-475f-b946-fe8d19a1e4c8",
      "name": "If Verificar si faltan datos"
    },
    {
      "parameters": {
        "jsCode": "// Create a generic error message\nconst errorMessage = {\n  output: {\n    mensajeSistema: \"游뚿 *Error interno del sistema* 丘멆잺\\n\\n\" +\n                   \"游땬 Disculpa, ha ocurrido un error inesperado.\\n\\n\" +\n                   \"游댃 *Acci칩n requerida:*\\n\" +\n                   \"Por favor, inicia una *nueva conversaci칩n* y vuelve a solicitar la reprogramaci칩n de tu cita.\\n\\n\" +\n                   \"游똂 Gracias por tu comprensi칩n.\"\n  }\n};\n\n// Return the formatted message that can be used by your response node\nreturn errorMessage;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2224,
        5936
      ],
      "id": "0b2ba011-768f-4506-aa7c-66aa74429a75",
      "name": "Code Mensaje Error"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b2110549-dd58-46b3-9707-dbbe0a5004f2",
              "leftValue": "={{ $('Basic LLM Extracci칩n y Validacion de Datos Editar Cita').first().json.output.mensajeParaUsuario.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            },
            {
              "id": "f250763e-e4ab-4054-8bf5-84d61e39f87b",
              "leftValue": "={{ $('Code Validaci칩n de datos para reprogramaci칩n de citas').item.json.mensajeSistema.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2656,
        5344
      ],
      "id": "4ce60184-7bf0-418d-845b-35466d4e6b7e",
      "name": "Validaci칩n de longitud de caracteres8"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3168,
        5280
      ],
      "id": "324c3c8e-f156-493b-b38b-3acf0f984e21",
      "name": "No Operation, do nothing11"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Consistencia de datos, intenci칩n consultar malla').item.json.mensaje }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2992,
        5280
      ],
      "id": "460e7ccb-5c04-4944-93df-6566e03de4af",
      "name": "HTTP Request Enviar Mensaje por WhatsApp11"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Code Validaci칩n de datos para reprogramaci칩n de citas').item.json.mensajeSistema }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Code Validaci칩n de datos para reprogramaci칩n de citas').item.json.mensajeSistema.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2992,
        5488
      ],
      "id": "23aca304-e9f3-4fc2-be61-9ea8a9e56599",
      "name": "Organiza variables del mensaje8"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DECLARE @Id INT = {{ $node[\"Code Validaci칩n de datos para reprogramaci칩n de citas\"].json.idCita }};\n\nIF EXISTS (SELECT 1\n           FROM   CitasRecepcion\n           WHERE  id = @Id\n             AND  estado = 'PROGRAMADA')\nBEGIN\n    SELECT *\n    FROM   CitasRecepcion\n    WHERE  id = @Id\n      AND  estado = 'PROGRAMADA';\nEND\nELSE\nBEGIN\n    -- C칩digo 50001 y nivel 16: error de aplicaci칩n personalizado\n    THROW 50001, 'La cita no se encuentra en estado PROGRAMADA.', 16;\nEND"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        1312,
        4976
      ],
      "id": "a09f3d50-9020-4101-ba53-c542b7913f74",
      "name": "Microsoft SQL Obtener Cita",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0c011567-205a-4ff9-a41a-5c1cd00a6f04",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "07596852-0256-421d-be90-26f9e2e932ba",
              "leftValue": "={{ $json.chat_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1536,
        4976
      ],
      "id": "4daabdd7-2f6f-45b8-9f31-68bf3616cb13",
      "name": "If existe cita"
    },
    {
      "parameters": {
        "jsCode": "// Create a generic error message\nconst errorMessage = {\n  output: {\n    mensajeSistema: \"游뚿 *Cita no encontrada* 丘멆잺\\n\\n\" +\n                   \"El n칰mero de cita proporcionado *no existe* en el cronograma o corresponde a una cita ya *cancelada/reprogramada*.\\n\\n\" +\n                   \"游댃 *Acci칩n requerida:*\\n\" +\n                   \"Por temas de *trazabilidad*, necesitamos reiniciar el proceso.\\n\\n\" +\n                   \"游녤 Por favor, proporciona *nuevamente todos los datos* verificando que sean correctos.\\n\\n\" +\n                   \"游똂 Gracias por tu colaboraci칩n.\"\n  }\n};\n\n// Return the formatted message that can be used by your response node\nreturn errorMessage;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1968,
        5104
      ],
      "id": "704fb86e-496d-41ff-afef-f937897d944b",
      "name": "Code Mensaje Error1"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        29552,
        7568
      ],
      "id": "800c56c9-c7d5-4b83-8188-9ff43d2d0fd7",
      "name": "Merge2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        30608,
        7568
      ],
      "id": "d5b4c319-c68a-4eb2-ac21-4121b3eccc34",
      "name": "No Operation, do nothing10"
    },
    {
      "parameters": {
        "jsCode": "// Obtener todos los datos de entrada\nconst datosEntrada = $input.all();\n// Filtrar solo los objetos que contienen un mensaje, descartando estad칤sticas\nconst mensajes = datosEntrada.filter(item => item.json.message_id);\n\n// Extraer chat_id del primer mensaje del usuario (no del agente)\nconst userMessage = mensajes.find(item => item.json.chat_id !== 'agenteAI');\nconst chat_id = userMessage ? userMessage.json.chat_id : \"No hay chat_id disponible\";\n\n// Funci칩n para convertir la fecha a formato Colombia (UTC-5) en formato de 12 horas\nfunction convertirHoraColombia(fechaUTC) {\n    if (!fechaUTC) return \"[Hora no encontrada]\";\n    let fecha = new Date(fechaUTC);\n    fecha.setHours(fecha.getHours()); // Convertir a UTC-5\n    return fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', hour12: true });\n}\n// Funci칩n para dar formato de fecha en espa침ol sin hora\nfunction formatearFecha(fechaUTC) {\n    if (!fechaUTC) return \"[Fecha no encontrada]\";\n    let fecha = new Date(fechaUTC);\n    return fecha.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });\n}\n// Estructurar los mensajes en un formato claro para el agente IA\nconst mensajesEstructurados = mensajes.map((mensaje, index) => {\n    let fecha = mensaje.json.fecha ? formatearFecha(mensaje.json.fecha) : \"[Fecha no encontrada]\";\n    let hora = mensaje.json.fecha ? convertirHoraColombia(mensaje.json.fecha) : \"[Hora no encontrada]\";\n    let contenido = mensaje.json.contenido || \"[Sin contenido]\";\n    \n    // Determinar si el mensaje es del usuario o del agente IA\n    let remitente = mensaje.json.chat_id === 'agenteAI' ? 'El Agente ChatBot IA dice:' : 'El usuario dice:';\n    \n    return `Mensaje ${index + 1} enviado el ${fecha} a las ${hora}.\\n${remitente} \"${contenido}\".`;\n});\n// Unir todos los mensajes en un solo texto estructurado\nconst historialMensajes = mensajesEstructurados.join('\\n\\n');\n// Retornar los datos estructurados incluyendo chat_id\nreturn [{ chat_id, historialMensajes }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        29968,
        7568
      ],
      "id": "11bfe19d-e33e-45e8-8ba1-f87f5ece27e5",
      "name": "Code integracion de mensajes"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM MensajesWhatsApp\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n   OR (chat_id = 'agenteAI' AND message_id IN (\n       SELECT message_id \n       FROM MensajesWhatsApp \n       WHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n   ))\nORDER BY fecha ASC;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        29760,
        7568
      ],
      "id": "cbb6f239-a808-41b5-b48f-13eb0f76d558",
      "name": "Recupera todos los mensajes1",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE CitasRecepcion\nSET chat_historial = '{{ \n  $items(\"Code integracion de mensajes\")\n    .map(i => i.json.historialMensajes)\n    .join(\"\\n\")\n    .replace(/'/g, \"''\")\n}}'\nWHERE id = '{{ \n  $('Microsoft SQL Insertar Cita').isExecuted\n    ? $('Microsoft SQL Insertar Cita').first().json.id\n    : $('Microsoft SQL Insertar Cita1').isExecuted\n      ? $('Microsoft SQL Insertar Cita1').first().json.id\n      : $('Microsoft SQL Obtener Cita').isExecuted\n        ? $('Microsoft SQL Obtener Cita').first().json.id\n        : $('Code Datos Cancelar Cita').first().json.id \n}}';"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        30192,
        7568
      ],
      "id": "33a3f297-cd7f-4e51-846e-b1913ee104e4",
      "name": "Microsoft SQL Actualiza la Cita",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Nodo Code: Validaci칩n de datos para reprogramaci칩n de citas\n// Recibe los datos extra칤dos del nodo LLM y aplica las validaciones de negocio\n\n// Obtener los datos del nodo anterior usando la ruta espec칤fica\nconst datosExtraidos = $('Basic LLM Extracci칩n y Validacion de Datos Editar Cita').first().json.output;\n\n// Mostrar datos extra칤dos para debug\nconsole.log(\"Datos recibidos del nodo anterior:\", JSON.stringify(datosExtraidos, null, 2));\n\n// Funci칩n principal que procesa los datos de entrada\nfunction procesarDatosReprogramacion(datos) {\n  try {\n    // Estructura de respuesta final (siguiendo el formato del prompt original)\n    const respuesta = {\n      todoCorrecto: false,\n      datosPreviamenteConfirmados: false,\n      idCita: datos.idCita || \"\",\n      ordenCompra: datos.ordenCompra || \"\",\n      nuevaFecha: datos.nuevaFecha || \"\",\n      nuevaHora: datos.nuevaHora || \"\",\n      camposFaltantes: datos.camposFaltantes || [],\n      mensajeSistema: \"\",\n      rechazoTemporal: false,\n      motivoRechazo: \"\",\n      intentaModificarDatos: false\n    };\n\n    console.log(\"Datos iniciales en respuesta:\", JSON.stringify(respuesta, null, 2));\n\n    // 1. Verificar si hay campos faltantes\n    if (respuesta.camposFaltantes && respuesta.camposFaltantes.length > 0) {\n      respuesta.todoCorrecto = false;\n      respuesta.mensajeSistema = generarMensajeCamposFaltantes(respuesta.camposFaltantes);\n      return respuesta;\n    }\n\n    // 2. Validar las fechas y reglas temporales\n    const validacionTemporal = validarReglasTemporales(respuesta.nuevaFecha, datos.fechaActual, datos.horaActual);\n    console.log(\"Resultado de validaci칩n temporal:\", JSON.stringify(validacionTemporal, null, 2));\n    \n    if (validacionTemporal.esValido === false) {\n      respuesta.todoCorrecto = false;\n      respuesta.rechazoTemporal = true;\n      respuesta.motivoRechazo = validacionTemporal.motivoRechazo;\n      respuesta.mensajeSistema = validacionTemporal.mensaje;\n      return respuesta;\n    }\n\n    // 3. Si todo est치 correcto, preparar mensaje de confirmaci칩n\n    respuesta.todoCorrecto = true;\n    respuesta.mensajeSistema = `Entendido. Est치s solicitando reprogramar la cita 游댔 ${respuesta.idCita} con orden de compra ${respuesta.ordenCompra} para el ${respuesta.nuevaFecha} a las ${respuesta.nuevaHora}. Verificar칠 la disponibilidad para este horario.`;\n    \n    return respuesta;\n  } catch (error) {\n    console.error(\"Error al procesar datos de reprogramaci칩n:\", error);\n    return {\n      todoCorrecto: false,\n      datosPreviamenteConfirmados: false,\n      idCita: datos.idCita || \"\",\n      ordenCompra: datos.ordenCompra || \"\",\n      nuevaFecha: datos.nuevaFecha || \"\",\n      nuevaHora: datos.nuevaHora || \"\",\n      camposFaltantes: [\"error_procesamiento\"],\n      mensajeSistema: \"Ha ocurrido un error al procesar tu solicitud. Por favor, intenta nuevamente proporcionando todos los datos necesarios.\",\n      rechazoTemporal: false,\n      motivoRechazo: \"error_sistema\",\n      intentaModificarDatos: false\n    };\n  }\n}\n\n// Genera mensaje para campos faltantes\nfunction generarMensajeCamposFaltantes(camposFaltantes) {\n  let mensaje = \"Para poder reprogramar tu cita, necesito \";\n  \n  if (camposFaltantes.includes(\"idCita\")) {\n    mensaje += \"el n칰mero de cita 游댔 que aparece en tu confirmaci칩n anterior, \";\n  }\n  \n  if (camposFaltantes.includes(\"ordenCompra\")) {\n    mensaje += \"el n칰mero de orden de compra para verificaci칩n, \";\n  }\n  \n  if (camposFaltantes.includes(\"nuevaFecha\")) {\n    mensaje += \"la nueva fecha que prefieres, \";\n  }\n  \n  if (camposFaltantes.includes(\"nuevaHora\")) {\n    mensaje += \"la nueva hora que prefieres, \";\n  }\n  \n  mensaje = mensaje.slice(0, -2) + \". \";\n  mensaje += \"Por ejemplo: 'Quiero reprogramar mi cita 12345 con orden de compra ARGM47896 para el 20 de mayo a las 10:00 AM'.\";\n  \n  return mensaje;\n}\n\n// Validar reglas temporales (mismo d칤a, d칤a siguiente, etc.)\nfunction validarReglasTemporales(nuevaFecha, fechaActual, horaActual) {\n  try {\n    console.log(`Validando fechas - Nueva: ${nuevaFecha}, Actual: ${fechaActual}, Hora: ${horaActual}`);\n    \n    // Convertir fechas a objetos Date para comparaci칩n\n    const fechaNueva = parsearFecha(nuevaFecha);\n    const fechaHoy = parsearFechaActual(fechaActual);\n    \n    console.log(`Fechas parseadas - Nueva: ${fechaNueva.toISOString()}, Hoy: ${fechaHoy.toISOString()}`);\n    \n    // Calcular fecha de ma침ana\n    const fechaManana = new Date(fechaHoy);\n    fechaManana.setDate(fechaManana.getDate() + 1);\n    console.log(`Fecha ma침ana: ${fechaManana.toISOString()}`);\n    \n    // 1. Validar si es el mismo d칤a\n    if (\n      fechaNueva.getFullYear() === fechaHoy.getFullYear() &&\n      fechaNueva.getMonth() === fechaHoy.getMonth() &&\n      fechaNueva.getDate() === fechaHoy.getDate()\n    ) {\n      console.log(\"Es el mismo d칤a - RECHAZADO\");\n      return {\n        esValido: false,\n        motivoRechazo: \"mismo_dia\",\n        mensaje: \"Lo siento, pero no es posible reprogramar citas para el mismo d칤a. Por pol칤ticas internas, las modificaciones deben hacerse con al menos un d칤a de anticipaci칩n. Por favor, selecciona una fecha futura a partir de ma침ana.\"\n      };\n    }\n    \n    // 2. Validar si es el d칤a siguiente y es despu칠s de las 4:30 PM\n    const esMa침ana = \n      fechaNueva.getFullYear() === fechaManana.getFullYear() &&\n      fechaNueva.getMonth() === fechaManana.getMonth() &&\n      fechaNueva.getDate() === fechaManana.getDate();\n    \n    const esTarde = esHoraPosteriorA430PM(horaActual);\n    \n    console.log(`Es ma침ana: ${esMa침ana}, Es tarde (post 4:30pm): ${esTarde}`);\n    \n    if (esMa침ana && esTarde) {\n      console.log(\"Es para ma침ana despu칠s de las 4:30 PM - RECHAZADO\");\n      return {\n        esValido: false,\n        motivoRechazo: \"tarde_para_manana\",\n        mensaje: `Lo siento, pero no es posible reprogramar citas para ma침ana despu칠s de las 4:30 PM del d칤a actual. Por favor, selecciona una fecha a partir del ${formatearFecha(new Date(fechaManana.getTime() + 86400000))}. Las modificaciones para el d칤a siguiente solo pueden realizarse antes de las 4:30 PM.`\n      };\n    }\n    \n    // Si pasa todas las validaciones\n    console.log(\"Validaci칩n temporal APROBADA\");\n    return {\n      esValido: true\n    };\n  } catch (error) {\n    console.error(\"Error al validar reglas temporales:\", error);\n    return {\n      esValido: true // En caso de error, permitimos continuar para no bloquear al usuario\n    };\n  }\n}\n\n// Funciones auxiliares para manipulaci칩n de fechas\n\n// Parsea una fecha en formato \"DD de mes de YYYY\"\nfunction parsearFecha(fechaStr) {\n  try {\n    console.log(`Parseando fecha: \"${fechaStr}\"`);\n    const partes = fechaStr.split(\" de \");\n    \n    if (partes.length < 3) {\n      console.error(`Formato de fecha incorrecto: \"${fechaStr}\"`);\n      return new Date(); // Devolver fecha actual en caso de error de formato\n    }\n    \n    const dia = parseInt(partes[0], 10);\n    \n    const meses = {\n      \"enero\": 0, \"febrero\": 1, \"marzo\": 2, \"abril\": 3, \"mayo\": 4, \"junio\": 5,\n      \"julio\": 6, \"agosto\": 7, \"septiembre\": 8, \"octubre\": 9, \"noviembre\": 10, \"diciembre\": 11\n    };\n    \n    const mes = meses[partes[1].toLowerCase()];\n    const anio = parseInt(partes[2], 10);\n    \n    console.log(`D칤a: ${dia}, Mes: ${mes}, A침o: ${anio}`);\n    \n    if (isNaN(dia) || mes === undefined || isNaN(anio)) {\n      console.error(`Valores de fecha inv치lidos: d칤a=${dia}, mes=${mes}, a침o=${anio}`);\n      return new Date();\n    }\n    \n    return new Date(anio, mes, dia);\n  } catch (error) {\n    console.error(\"Error al parsear fecha:\", error);\n    return new Date(); // Devuelve fecha actual en caso de error\n  }\n}\n\n// Parsea la fecha actual en formato YYYY-MM-DD\nfunction parsearFechaActual(fechaStr) {\n  try {\n    console.log(`Parseando fecha actual: \"${fechaStr}\"`);\n    \n    if (!fechaStr || typeof fechaStr !== 'string') {\n      console.error(`Formato de fecha actual inv치lido: \"${fechaStr}\"`);\n      return new Date();\n    }\n    \n    const [anio, mes, dia] = fechaStr.split(\"-\").map(num => parseInt(num, 10));\n    \n    if (isNaN(anio) || isNaN(mes) || isNaN(dia)) {\n      console.error(`Valores de fecha actual inv치lidos: a침o=${anio}, mes=${mes}, d칤a=${dia}`);\n      return new Date();\n    }\n    \n    return new Date(anio, mes - 1, dia); // Restar 1 al mes porque en JS los meses van de 0-11\n  } catch (error) {\n    console.error(\"Error al parsear fecha actual:\", error);\n    return new Date(); // Devuelve fecha actual en caso de error\n  }\n}\n\n// Verifica si la hora es posterior a las 4:30 PM\nfunction esHoraPosteriorA430PM(horaStr) {\n  try {\n    console.log(`Verificando si hora es posterior a 4:30 PM: \"${horaStr}\"`);\n    \n    if (!horaStr || typeof horaStr !== 'string') {\n      console.error(`Formato de hora inv치lido: \"${horaStr}\"`);\n      return false;\n    }\n    \n    // Convierte la hora a minutos para facilitar la comparaci칩n\n    let horas = 0;\n    let minutos = 0;\n    \n    // Manejar varios formatos posibles de hora\n    if (horaStr.includes(\":\")) {\n      // Formato HH:MM (am/pm)\n      const [hora, resto] = horaStr.split(\":\");\n      horas = parseInt(hora, 10);\n      \n      // Extraer minutos y posible AM/PM\n      if (resto.toLowerCase().includes(\"p.m.\") || resto.toLowerCase().includes(\"pm\")) {\n        if (horas !== 12) horas += 12; // Convertir a formato 24h\n        minutos = parseInt(resto.replace(/[^\\d]/g, \"\"), 10);\n      } else {\n        if (horas === 12) horas = 0; // Mediod칤a en formato 12h es 0 en formato 24h\n        minutos = parseInt(resto.replace(/[^\\d]/g, \"\"), 10);\n      }\n    } else {\n      // Intentar otros formatos\n      const match = horaStr.match(/(\\d+)(?:\\D+)(\\d*)\\s*([ap]\\.?m\\.?)?/i);\n      if (match) {\n        horas = parseInt(match[1], 10);\n        minutos = match[2] ? parseInt(match[2], 10) : 0;\n        \n        const periodo = match[3] ? match[3].toLowerCase() : \"\";\n        if (periodo.includes(\"p\")) {\n          if (horas !== 12) horas += 12;\n        } else if (periodo.includes(\"a\") && horas === 12) {\n          horas = 0;\n        }\n      }\n    }\n    \n    // Convertir todo a minutos\n    const totalMinutos = horas * 60 + minutos;\n    console.log(`Hora convertida a minutos: ${totalMinutos} (${horas}:${minutos})`);\n    \n    // 4:30 PM = 16:30 = 990 minutos\n    return totalMinutos > 990;\n    \n  } catch (error) {\n    console.error(\"Error al evaluar la hora:\", error);\n    return false; // En caso de error, asumimos que no es despu칠s de las 4:30 PM\n  }\n}\n\n// Formatea una fecha como \"DD de mes de YYYY\"\nfunction formatearFecha(fecha) {\n  try {\n    const dia = fecha.getDate();\n    \n    const meses = [\n      \"enero\", \"febrero\", \"marzo\", \"abril\", \"mayo\", \"junio\",\n      \"julio\", \"agosto\", \"septiembre\", \"octubre\", \"noviembre\", \"diciembre\"\n    ];\n    \n    const mes = meses[fecha.getMonth()];\n    const anio = fecha.getFullYear();\n    \n    return `${dia} de ${mes} de ${anio}`;\n  } catch (error) {\n    console.error(\"Error al formatear fecha:\", error);\n    return \"\"; // Devuelve string vac칤o en caso de error\n  }\n}\n\n// Aplicar la funci칩n principal a los datos extra칤dos\nconst resultado = procesarDatosReprogramacion(datosExtraidos);\nconsole.log(\"Resultado final:\", JSON.stringify(resultado, null, 2));\n\n// Devolver el resultado procesado\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        5088
      ],
      "id": "7d479b90-5aff-4883-84ec-5b37023dc6a0",
      "name": "Code Validaci칩n de datos para reprogramaci칩n de citas"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        29680,
        7824
      ],
      "id": "d6fb6d23-f18a-484d-924a-0dae804c6044",
      "name": "Merge3"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "BEGIN TRANSACTION;\n\nDELETE FROM MensajesWhatsApp\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n   OR (chat_id = 'agenteAI'\n       AND message_id IN (\n           SELECT message_id \n           FROM MensajesWhatsApp\n           WHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n       )\n   );\n\nDELETE FROM FranjasDisponiblesTemp \nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\n\nCOMMIT;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        29888,
        7824
      ],
      "id": "2abbbcc1-348c-4f9f-b8e7-23c913dab03b",
      "name": "Microsoft SQL Eliminar Mensajes3",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        30112,
        7824
      ],
      "id": "5f17e181-7668-4b75-820d-e4137906f95a",
      "name": "No Operation, do nothing12"
    },
    {
      "parameters": {
        "url": "https://graph.microsoft.com/v1.0/sites/a592f886-4560-4e62-9646-1eee7add7abe/drives/b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8/items/01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME/content",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "ExcelMallaRecibido2025"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1872,
        4848
      ],
      "id": "6df2f03b-d51a-4cc8-a2a9-2b1827f4022b",
      "name": "HTTP Request MALLA DE RECIBO 2",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      }
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "ExcelMallaRecibido2025",
        "options": {
          "sheetName": "={{ $('Unificaci칩n y consistencia de datos').item.json.hojaSeleccionada }}"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        2128,
        4720
      ],
      "id": "7ab75f2a-f032-4db8-9867-64d0cc950fb9",
      "name": "Extract MALLA DE RECIBO 2"
    },
    {
      "parameters": {
        "jsCode": "// Obtener los datos del Excel\nconst excelData = $input.all();\nconst hojaSeleccionada = $('Unificaci칩n y consistencia de datos').first().json.hojaSeleccionada;\n\n// Obtener hora local en Bogot치\nconst ahora = new Date(new Date().toLocaleString(\"en-US\", { timeZone: \"America/Bogota\" }));\nconst diaSemanaActual = ahora.getDay(); // 0=domingo, 1=lunes, ..., 5=viernes\nconst horaActual = ahora.getHours();\nconst minutosActual = ahora.getMinutes();\n// Determinar si es despu칠s de las 16:30\nconst pasoLimiteDia = horaActual > 16 || (horaActual === 16 && minutosActual >= 30);\n\n// Definir estructura de la semana y los d칤as\nconst diasSemana = ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'];\n\n// Mapeo para saber qu칠 d칤as incluir si hoy es x d칤a y pas칩 el l칤mite\n/**\n * Dado el d칤a de la semana actual (0=domingo ... 6=s치bado),\n * devuelve qu칠 d칤as de la semana actual deben incluirse seg칰n si pas칩 el l칤mite.\n */\nfunction diasValidosSemanaActual(diaSemanaActual, pasoLimite) {\n  const mapa = {\n    1: ['martes', 'mi칠rcoles', 'jueves', 'viernes'],   // lunes\n    2: ['mi칠rcoles', 'jueves', 'viernes'],             // martes\n    3: ['jueves', 'viernes'],                          // mi칠rcoles\n    4: ['viernes'],                                     // jueves\n    5: []                                               // viernes (muy tarde para s치bado)\n  };\n  if (diaSemanaActual < 1 || diaSemanaActual > 5) {\n    return []; // s치bado o domingo no se agendan en semana actual\n  }\n  if (!pasoLimite) {\n    // a칰n est치 antes de las 4:30 p.m., se puede incluir el d칤a siguiente\n    const siguiente = diasSemana[diaSemanaActual];\n    return [siguiente, ...mapa[diaSemanaActual]];\n  }\n  return mapa[diaSemanaActual];\n}\n\n// Objeto para almacenar la malla estructurada\nconst mallaEstructurada = {\n  titulo: \"\",\n  a침o: \"\",\n  semana: \"\",\n  rangoDias: \"\",\n  franjas: [],\n  dias: {}\n};\n\n// Tabla de meses y d칤as. Ajusta si necesitas contemplar bisiestos, etc.\nconst meses = {\n  \"enero\": 1,\n  \"febrero\": 2,\n  \"marzo\": 3,\n  \"abril\": 4,\n  \"mayo\": 5,\n  \"junio\": 6,\n  \"julio\": 7,\n  \"agosto\": 8,\n  \"septiembre\": 9,\n  \"octubre\": 10,\n  \"noviembre\": 11,\n  \"diciembre\": 12\n};\n\nconst nombreMes = {\n  1: \"enero\",\n  2: \"febrero\",\n  3: \"marzo\",\n  4: \"abril\",\n  5: \"mayo\",\n  6: \"junio\",\n  7: \"julio\",\n  8: \"agosto\",\n  9: \"septiembre\",\n  10: \"octubre\",\n  11: \"noviembre\",\n  12: \"diciembre\"\n};\n\n/**\n * Funci칩n para determinar si un a침o es bisiesto\n * Un a침o es bisiesto si es divisible por 4, excepto aquellos divisibles por 100 \n * que no son divisibles por 400\n */\nfunction esBisiesto(year) {\n  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n}\n\n/**\n * Funci칩n para obtener el n칰mero de d칤as en un mes, considerando a침os bisiestos\n */\nfunction getDiasMes(mes, a침o) {\n  const diasPorMes = {\n    1: 31, // enero\n    2: esBisiesto(a침o) ? 29 : 28, // febrero - ajustado para a침o bisiesto\n    3: 31, // marzo\n    4: 30, // abril\n    5: 31, // mayo\n    6: 30, // junio\n    7: 31, // julio\n    8: 31, // agosto\n    9: 30, // septiembre\n    10: 31, // octubre\n    11: 30, // noviembre\n    12: 31  // diciembre\n  };\n  \n  return diasPorMes[mes];\n}\n\n/**\n * Funci칩n para eliminar acentos y pasar a min칰sculas (para buscar palabras clave sin importar tildes ni may칰sculas).\n */\nfunction normalizarTexto(texto) {\n  if (typeof texto !== 'string') return \"\";\n  // Normaliza (NFD) y elimina diacr칤ticos, luego pasa a min칰sculas.\n  return texto\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase();\n}\n\n/**\n * Dada la informaci칩n de proveedor, ordenCompra, peso, categor칤a y unidades,\n * revisa si existe la palabra 'fuera de servicio', 'cancelado' o 'reagendado'\n * en cualquiera de esos campos. De ser as칤, retorna ese estado especial;\n * de lo contrario, retorna 'ocupado'.\n * \n * Se ignoran may칰sculas, min칰sculas y tildes.\n */\nfunction determinarEstadoOcupado(proveedor, ordenCompra, peso, categoria, unidades) {\n  const conjunto = `${proveedor} ${ordenCompra} ${peso} ${categoria} ${unidades}`;\n  const texto = normalizarTexto(conjunto);\n\n  if (texto.includes(\"fuera de servicio\")) {\n    return \"fuera de servicio\";\n  }\n  if (texto.includes(\"cancelado\")) {\n    return \"cancelado\";\n  }\n  if (texto.includes(\"reagendado\")) {\n    return \"reagendado\";\n  }\n  return \"ocupado\";  \n}\n\n// -------------------------------------------------------------\n// 1) PROCESAR DATOS (Cabecera, Horas, Muelles, etc.)\n// -------------------------------------------------------------\nfunction procesarDatos(excelData) {\n  const datos = excelData.map(item => item.json);\n  \n  // A) Cabecera (T칤tulo, A침o, Rango)\n  datos.forEach((dato, index) => {\n    // Buscar t칤tulo\n    if (dato.__EMPTY_2 === \"MALLA DE RECIBO CEDI KONFIE IA\") {\n      mallaEstructurada.titulo = dato.__EMPTY_2;\n      \n      // En la siguiente fila puede estar a침o, semana, rango\n      if (index + 1 < datos.length) {\n        const datoSiguiente = datos[index + 1];\n        if (datoSiguiente) {\n          // A침o\n          if (datoSiguiente.__EMPTY_2 && !isNaN(datoSiguiente.__EMPTY_2)) {\n            mallaEstructurada.a침o = datoSiguiente.__EMPTY_2;\n          }\n          // Semana\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"SEMANA\")) {\n              mallaEstructurada.semana = v;\n            }\n          });\n          // Rango: p.ej. \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"LUNES\") && v.includes(\"VIERNES\")) {\n              mallaEstructurada.rangoDias = v;\n            }\n          });\n        }\n      }\n    }\n  });\n  \n  // B) Detectar franjas horarias (.__EMPTY = fracci칩n de d칤a)\n  const franjasHorarias = [];\n  datos.forEach(dato => {\n    if (\n      dato.__EMPTY !== undefined &&\n      typeof dato.__EMPTY === 'number' &&\n      dato.__EMPTY > 0 &&\n      dato.__EMPTY < 1\n    ) {\n      const totalMin = Math.round(dato.__EMPTY * 24 * 60);\n      const hh = Math.floor(totalMin / 60);\n      const mm = totalMin % 60;\n      \n      let periodo = \"AM\";\n      let hora12 = hh;\n      if (hh >= 12) {\n        periodo = \"PM\";\n        hora12 = (hh === 12 ? 12 : hh - 12);\n      }\n      if (hh === 0) {\n        hora12 = 12;\n      }\n      \n      const horaStr = `${hora12}:${String(mm).padStart(2, '0')} ${periodo}`;\n      franjasHorarias.push({\n        hora: horaStr,\n        indice: datos.indexOf(dato) // fila base\n      });\n    }\n  });\n  franjasHorarias.sort((a, b) => a.indice - b.indice);\n  mallaEstructurada.franjas = franjasHorarias;\n  \n  // C) Detectar muelles (col)\n  const muellesInfo = {};\n  datos.forEach(dato => {\n    Object.entries(dato).forEach(([key, value]) => {\n      if (value === \"MUELLE 01\" || value === \"MUELLE 02\") {\n        const col = parseInt(key.replace(\"__EMPTY_\", \"\"), 10);\n        const muelleKey = (value === \"MUELLE 01\") ? 'muelle1' : 'muelle2';\n        if (!muellesInfo[muelleKey]) {\n          muellesInfo[muelleKey] = [];\n        }\n        muellesInfo[muelleKey].push(col);\n      }\n    });\n  });\n  if (muellesInfo.muelle1) muellesInfo.muelle1.sort((a, b) => a - b);\n  if (muellesInfo.muelle2) muellesInfo.muelle2.sort((a, b) => a - b);\n  \n  // D) Generar los 5 d칤as (lunes-viernes) con su fecha\n  parsearRangoDias();\n  \n  // E) Extraer Citas\n  extraerCitas(datos, muellesInfo);\n  \n  return mallaEstructurada;\n}\n\n/**\n * Parsea la cadena \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n * (o \"LUNES 31 AL VIERNES 04 DE ABRIL\") y maneja el cruce de mes.\n * Ej.: si dayStart=31 y dayEnd=4, la 1춹 fecha es 31 de MARZO,\n * luego 1,2,3,4 de ABRIL, en vez de 32,33, etc.\n */\nfunction parsearRangoDias() {\n  const texto = mallaEstructurada.rangoDias;\n  // Regex simple: p.ej. \"31 AL ... 4 DE ABRIL\"\n  // Captura: dayStart, dayEnd, mesFin\n  // Ojo: si dice \"LUNES 31 DE MARZO AL VIERNES 4 DE ABRIL\",\n  // quedar치: dayStart=31, dayEnd=4, month=ABRIL (al final).\n  const regex = /(\\d+)\\s+AL\\s+\\D+(\\d+)\\s+DE\\s+(\\w+)/i;\n  const match = regex.exec(texto);\n  \n  // Por defecto, creamos 5 d칤as vac칤os sin fecha\n  diasSemana.forEach(d => {\n    mallaEstructurada.dias[d] = {\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  if (!match) {\n    // Sin coincidencia, dejamos los d칤as sin fecha\n    return;\n  }\n  \n  const dayStart = parseInt(match[1], 10); // 31\n  const dayEnd   = parseInt(match[2], 10); // 4\n  const finalMonthName = match[3].toLowerCase(); // \"abril\"\n  \n  // Convertimos a n칰mero\n  const finalMonth = meses[finalMonthName] || 3; // fallback marzo\n  const yearNum = parseInt(mallaEstructurada.a침o, 10) || 2025;\n  \n  // Funci칩n para obtener la fecha formateada\n  function fechaFormateada(d, m, y) {\n    return `${d} de ${nombreMes[m]} de ${y}`;\n  }\n  \n  // Comprobamos cu치ntos d칤as tiene el mes final, considerando bisiestos\n  const diasMesFinal = getDiasMes(finalMonth, yearNum);\n  // y del mes previo\n  const monthPrev = (finalMonth === 1) ? 12 : finalMonth - 1;\n  const yearPrev = (finalMonth === 1) ? yearNum - 1 : yearNum;\n  \n  // Arreglo final con 5 fechas\n  const fechasDias = [];\n  \n  if (dayStart <= dayEnd) {\n    // Caso \"normal\": todo en el mismo mes\n    let d = dayStart;\n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: finalMonth,\n        yearNum: yearNum\n      });\n      d++;\n      if (d > diasMesFinal) {\n        d = 1;\n        const nextMonth = finalMonth % 12 + 1;\n        const nextYear = (nextMonth === 1) ? yearNum + 1 : yearNum;\n        fechasDias[fechasDias.length - 1].mesNum = nextMonth;\n        fechasDias[fechasDias.length - 1].yearNum = nextYear;\n      }\n    }\n  } else {\n    // Caso \"cruza de mes\": dayStart > dayEnd\n    let d = dayStart;\n    let m = monthPrev;\n    let y = yearPrev;\n    \n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: m,\n        yearNum: y\n      });\n      d++;\n      if (d > getDiasMes(m, y)) {\n        d = 1;\n        m = m % 12 + 1;\n        if (m === 1) {\n          y++;\n        }\n      }\n    }\n  }\n  \n  // Ahora volcamos esas 5 fechas en la estructura\n  fechasDias.forEach(fd => {\n    const { diaSem, diaNum, mesNum, yearNum } = fd;\n    mallaEstructurada.dias[diaSem] = {\n      fechaDia: fechaFormateada(diaNum, mesNum, yearNum),\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  // Inicializamos las franjas a 'disponible'\n  if (mallaEstructurada.franjas.length > 0) {\n    diasSemana.forEach(d => {\n      mallaEstructurada.franjas.forEach(f => {\n        mallaEstructurada.dias[d].muelle1[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n        mallaEstructurada.dias[d].muelle2[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n      });\n    });\n  }\n}\n\n/**\n * Funci칩n auxiliar: decide a qu칠 d칤a pertenece una columna,\n * corrigiendo 2 columnas de offset (porque 'Extract from XLSX'\n * deja todo desplazado).\n */\nfunction getDayForColumn(colNumber) {\n  // Ajuste de offset +2\n  const realCol = colNumber + 2;\n\n  // Rangos:\n  //  Lunes:      3..8\n  //  Martes:     9..14\n  //  Mi칠rcoles: 15..20\n  //  Jueves:    21..26\n  //  Viernes:   27..32\n  if (realCol >= 3 && realCol <= 8) {\n    return \"lunes\";\n  }\n  if (realCol >= 9 && realCol <= 14) {\n    return \"martes\";\n  }\n  if (realCol >= 15 && realCol <= 20) {\n    return \"mi칠rcoles\";\n  }\n  if (realCol >= 21 && realCol <= 26) {\n    return \"jueves\";\n  }\n  if (realCol >= 27 && realCol <= 32) {\n    return \"viernes\";\n  }\n  // Si nada coincide, devolvemos null\n  return null;\n}\n\n/**\n * Extraer las citas para cada franja:\n * - Para cada franja, miramos 3 filas:\n *    - Fila base => proveedor\n *    - Fila base+1 => orden\n *    - Fila base+2 => peso, categor칤a, unidades\n */\nfunction extraerCitas(datos, muellesInfo) {\n  mallaEstructurada.franjas.forEach(franja => {\n    const indiceBase = franja.indice;\n    if (indiceBase < 0 || indiceBase + 2 >= datos.length) {\n      return; // no hay suficientes filas\n    }\n    \n    // Recorremos muelle1, muelle2 y sus columnas\n    const asignarCita = (muelleKey, cols) => {\n      cols.forEach(col => {\n        const provKey = `__EMPTY_${col}`;\n        const filaProv = datos[indiceBase];\n        \n        // Si en esta fila hay un proveedor o alg칰n texto\n        if (\n          filaProv &&\n          typeof filaProv[provKey] === 'string' &&\n          filaProv[provKey].length > 2\n        ) {\n          // Determinar el d칤a real\n          const diaOk = getDayForColumn(col);\n          if (!diaOk || !mallaEstructurada.dias[diaOk]) {\n            return; // si no coincide con ninguno, saltamos\n          }\n          \n          // Recuperar valores para proveedor, ordenCompra y dem치s\n          const filaOrden = datos[indiceBase + 1];\n          const filaDet = datos[indiceBase + 2];\n          \n          const proveedor = filaProv[provKey] || \"\";\n          const ordenCompra = filaOrden && filaOrden[provKey] ? filaOrden[provKey] : \"\";\n          const peso = filaDet && filaDet[provKey] ? filaDet[provKey] : \"\";\n          const cat  = filaDet && filaDet[`__EMPTY_${col + 1}`] ? filaDet[`__EMPTY_${col + 1}`] : \"\";\n          const und  = filaDet && filaDet[`__EMPTY_${col + 2}`] ? filaDet[`__EMPTY_${col + 2}`] : \"\";\n          \n          // Antes pon칤amos estado=\"ocupado\" directamente\n          // Ahora verificamos si el texto contiene \"reagendado\", \"cancelado\" o \"fuera de servicio\".\n          const nuevoEstado = determinarEstadoOcupado(proveedor, ordenCompra, peso, cat, und);\n          \n          // Asignamos los datos\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].estado = nuevoEstado;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].proveedor = proveedor;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].ordenCompra = ordenCompra;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].peso = peso;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].categoria = cat;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].unidades = und;\n        }\n      });\n    };\n    \n    if (muellesInfo.muelle1) {\n      asignarCita('muelle1', muellesInfo.muelle1);\n    }\n    if (muellesInfo.muelle2) {\n      asignarCita('muelle2', muellesInfo.muelle2);\n    }\n  });\n}\n\n// -------------------------------------------------------------\n// 2) FUNCIONES PARA CONSULTAR LA MALLA\n// -------------------------------------------------------------\nfunction buscarFranjasDisponibles(categoria, duracionHoras) {\n  const muelle = \"muelle1\"; // Ajusta si usas \"categoria -> muelle\" real\n  \n  const franjasDisponibles = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const libres = [];\n    for (let i = 0; i <= mallaEstructurada.franjas.length - duracionHoras; i++) {\n      let disponible = true;\n      for (let h = 0; h < duracionHoras; h++) {\n        const idxF = i + h;\n        const horaAct = mallaEstructurada.franjas[idxF].hora;\n        if (\n          mallaEstructurada.dias[dia][muelle][horaAct].estado !== 'disponible'\n        ) {\n          disponible = false;\n          break;\n        }\n      }\n      if (disponible) {\n        libres.push({\n          horaInicio: mallaEstructurada.franjas[i].hora,\n          duracion: duracionHoras\n        });\n      }\n    }\n    if (libres.length > 0) {\n      franjasDisponibles.push({ dia, franjas: libres });\n    }\n  });\n  return franjasDisponibles;\n}\n\nfunction buscarCitasProveedor(nombreProveedor) {\n  const citas = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const muelle1 = mallaEstructurada.dias[dia].muelle1;\n    const muelle2 = mallaEstructurada.dias[dia].muelle2;\n    mallaEstructurada.franjas.forEach(f => {\n      const hora = f.hora;\n      // muelle1\n      if (normalizarTexto(muelle1[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 01\",\n          ordenCompra: muelle1[hora].ordenCompra,\n          peso: muelle1[hora].peso,\n          categoria: muelle1[hora].categoria,\n          unidades: muelle1[hora].unidades,\n          estado: muelle1[hora].estado\n        });\n      }\n      // muelle2\n      if (normalizarTexto(muelle2[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 02\",\n          ordenCompra: muelle2[hora].ordenCompra,\n          peso: muelle2[hora].peso,\n          categoria: muelle2[hora].categoria,\n          unidades: muelle2[hora].unidades,\n          estado: muelle2[hora].estado\n        });\n      }\n    });\n  });\n  return citas;\n}\n\nfunction consultarFranjasDisponibles(categoria, duracionHoras) {\n  return buscarFranjasDisponibles(categoria, duracionHoras);\n}\n\nfunction consultarCitasProveedor(nombreProveedor) {\n  return buscarCitasProveedor(nombreProveedor);\n}\n\nfunction obtenerInfoMalla() {\n  return {\n    titulo: mallaEstructurada.titulo,\n    a침o: mallaEstructurada.a침o,\n    semana: mallaEstructurada.semana,\n    rangoDias: mallaEstructurada.rangoDias,\n    franjas: mallaEstructurada.franjas.map(f => f.hora)\n  };\n}\n\nfunction estaDisponible(dia, hora, muelle) {\n  const info = mallaEstructurada.dias[dia]?.[muelle]?.[hora];\n  return info ? (info.estado === 'disponible') : false;\n}\n\nfunction obtenerCoordenadasCita(dia, hora, muelle) {\n  // Ajustar con tu mapeo de celdas en Excel\n  return {\n    proveedor: `${dia}_${hora}_${muelle}_proveedor`,\n    ordenCompra: `${dia}_${hora}_${muelle}_ordenCompra`,\n    peso: `${dia}_${hora}_${muelle}_peso`,\n    categoria: `${dia}_${hora}_${muelle}_categoria`,\n    unidades: `${dia}_${hora}_${muelle}_unidades`\n  };\n}\n\n// -------------------------------------------------------------\n// 3) EJECUTAR TODO Y RETORNAR\n// -------------------------------------------------------------\n// Procesar todos los datos\nconst malla = procesarDatos(excelData);\n\n// Aplicar el filtro de d칤as v치lidos seg칰n la hora actual\nconst diasPermitidos = diasValidosSemanaActual(diaSemanaActual, pasoLimiteDia);\nObject.keys(malla.dias).forEach(dia => {\n  if (!diasPermitidos.includes(dia)) {\n    delete malla.dias[dia]; // eliminar d칤as no v치lidos\n  }\n});\n\nconst resultado = {\n  datosMalla: malla,\n  funciones: {\n    consultarFranjasDisponibles,\n    consultarCitasProveedor,\n    obtenerInfoMalla,\n    estaDisponible,\n    obtenerCoordenadasCita\n  }\n};\n\nreturn [resultado];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2384,
        4720
      ],
      "id": "99439f49-bc6c-4048-b9d3-f9ffcc68ab82",
      "name": "Estructuraci칩n, Datos, Consulta, Citas3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        2704,
        4816
      ],
      "id": "8ffd2fc6-476a-4ff8-b200-af3abf957121",
      "name": "Merge datos Excel3"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    datosMalla: $items(\"Merge datos Excel3\")[0].json.datosMalla,\n    datosMallaProxSemana: $items(\"Merge datos Excel3\")[1].json.datosMallaProxSemana,\n    hojaSeleccionada: $items(\"Merge datos Excel3\")[0].json.datosMalla.semana\n  }\n}];\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2960,
        4816
      ],
      "id": "201551eb-6d35-4cd9-9915-d4e778b4612b",
      "name": "Unificaci칩n y consistencia de datos4"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "ExcelMallaRecibido2025",
        "options": {
          "sheetName": "={{    (function() {     const semanaActual = $('Unificaci칩n y consistencia de datos').item.json.hojaSeleccionada;     const numeroSemana = parseInt(semanaActual.replace(\"SEMANA \", \"\"));     return `SEMANA ${numeroSemana + 1}`;   })() }}"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        2128,
        4928
      ],
      "id": "09a82eb9-2e2a-4765-993e-786fd23a7702",
      "name": "Extract MALLA DE RECIBO Semana Siguiente3",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Si el nodo anterior no devolvi칩 datos (por error al no existir la hoja), retornamos estructura vac칤a con mensaje\n// Obtener los datos del Excel\nconst excelData = $input.all();\n\n// Mejora en la detecci칩n de errores: verificar si hay error expl칤cito o si los datos no son v치lidos\nconst hayError = excelData.some(item => item.json && item.json.error);\nconst datosInvalidos = !excelData || excelData.length === 0 || hayError;\n\nif (datosInvalidos) {\n  return [{\n    datosMallaProxSemana: {\n      titulo: \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\",\n      a침o: \"\",\n      semana: \"\",\n      rangoDias: \"\",\n      franjas: [],\n      dias: {\n        lunes: { muelle1: {}, muelle2: {} },\n        martes: { muelle1: {}, muelle2: {} },\n        mi칠rcoles: { muelle1: {}, muelle2: {} },\n        jueves: { muelle1: {}, muelle2: {} },\n        viernes: { muelle1: {}, muelle2: {} }\n      }\n    },\n    funciones: {\n      consultarFranjasDisponibles: \"function not available\",\n      consultarCitasProveedor: \"function not available\",\n      obtenerInfoMalla: \"function not available\",\n      estaDisponible: \"function not available\",\n      obtenerCoordenadasCita: \"function not available\"\n    }\n  }];\n}\n\n// El resto del c칩digo permanece igual...\nconst hojaSeleccionada = $('Unificaci칩n y consistencia de datos').first().json.hojaSeleccionada;\n\n// Definir estructura de la semana y los d칤as\nconst diasSemana = ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'];\n\n// Objeto para almacenar la malla estructurada\nconst mallaEstructurada = {\n  titulo: \"\",\n  a침o: \"\",\n  semana: \"\",\n  rangoDias: \"\",\n  franjas: [],\n  dias: {}\n};\n\n// Tabla de meses y d칤as. Ajusta si necesitas contemplar bisiestos, etc.\nconst meses = {\n  \"enero\": 1,\n  \"febrero\": 2,\n  \"marzo\": 3,\n  \"abril\": 4,\n  \"mayo\": 5,\n  \"junio\": 6,\n  \"julio\": 7,\n  \"agosto\": 8,\n  \"septiembre\": 9,\n  \"octubre\": 10,\n  \"noviembre\": 11,\n  \"diciembre\": 12\n};\n\nconst nombreMes = {\n  1: \"enero\",\n  2: \"febrero\",\n  3: \"marzo\",\n  4: \"abril\",\n  5: \"mayo\",\n  6: \"junio\",\n  7: \"julio\",\n  8: \"agosto\",\n  9: \"septiembre\",\n  10: \"octubre\",\n  11: \"noviembre\",\n  12: \"diciembre\"\n};\n\n/**\n * Funci칩n para determinar si un a침o es bisiesto\n * Un a침o es bisiesto si es divisible por 4, excepto aquellos divisibles por 100 \n * que no son divisibles por 400\n */\nfunction esBisiesto(year) {\n  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n}\n\n/**\n * Funci칩n para obtener el n칰mero de d칤as en un mes, considerando a침os bisiestos\n */\nfunction getDiasMes(mes, a침o) {\n  const diasPorMes = {\n    1: 31, // enero\n    2: esBisiesto(a침o) ? 29 : 28, // febrero - ajustado para a침o bisiesto\n    3: 31, // marzo\n    4: 30, // abril\n    5: 31, // mayo\n    6: 30, // junio\n    7: 31, // julio\n    8: 31, // agosto\n    9: 30, // septiembre\n    10: 31, // octubre\n    11: 30, // noviembre\n    12: 31  // diciembre\n  };\n  \n  return diasPorMes[mes];\n}\n\n/**\n * Funci칩n para eliminar acentos y pasar a min칰sculas (para buscar palabras clave sin importar tildes ni may칰sculas).\n */\nfunction normalizarTexto(texto) {\n  if (typeof texto !== 'string') return \"\";\n  // Normaliza (NFD) y elimina diacr칤ticos, luego pasa a min칰sculas.\n  return texto\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase();\n}\n\n/**\n * Dada la informaci칩n de proveedor, ordenCompra, peso, categor칤a y unidades,\n * revisa si existe la palabra 'fuera de servicio', 'cancelado' o 'reagendado'\n * en cualquiera de esos campos. De ser as칤, retorna ese estado especial;\n * de lo contrario, retorna 'ocupado'.\n * \n * Se ignoran may칰sculas, min칰sculas y tildes.\n */\nfunction determinarEstadoOcupado(proveedor, ordenCompra, peso, categoria, unidades) {\n  const conjunto = `${proveedor} ${ordenCompra} ${peso} ${categoria} ${unidades}`;\n  const texto = normalizarTexto(conjunto);\n\n  if (texto.includes(\"fuera de servicio\")) {\n    return \"fuera de servicio\";\n  }\n  if (texto.includes(\"cancelado\")) {\n    return \"cancelado\";\n  }\n  if (texto.includes(\"reagendado\")) {\n    return \"reagendado\";\n  }\n  return \"ocupado\";  \n}\n\n// -------------------------------------------------------------\n// 1) PROCESAR DATOS (Cabecera, Horas, Muelles, etc.)\n// -------------------------------------------------------------\nfunction procesarDatos(excelData) {\n  // Verificaci칩n adicional de datos v치lidos\n  if (!excelData || !Array.isArray(excelData) || excelData.length === 0) {\n    return {\n      titulo: \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\",\n      a침o: \"\",\n      semana: \"\",\n      rangoDias: \"\",\n      franjas: [],\n      dias: {\n        lunes: { muelle1: {}, muelle2: {} },\n        martes: { muelle1: {}, muelle2: {} },\n        mi칠rcoles: { muelle1: {}, muelle2: {} },\n        jueves: { muelle1: {}, muelle2: {} },\n        viernes: { muelle1: {}, muelle2: {} }\n      }\n    };\n  }\n  \n  // Intentar mapear datos, con manejo de errores para cada item\n  const datos = excelData.map(item => {\n    try {\n      return item.json || {};\n    } catch (e) {\n      return {};\n    }\n  });\n  \n  // A) Cabecera (T칤tulo, A침o, Rango)\n  datos.forEach((dato, index) => {\n    // Buscar t칤tulo\n    if (dato.__EMPTY_2 === \"MALLA DE RECIBO CEDI KONFIE IA\") {\n      mallaEstructurada.titulo = dato.__EMPTY_2;\n      \n      // En la siguiente fila puede estar a침o, semana, rango\n      if (index + 1 < datos.length) {\n        const datoSiguiente = datos[index + 1];\n        if (datoSiguiente) {\n          // A침o\n          if (datoSiguiente.__EMPTY_2 && !isNaN(datoSiguiente.__EMPTY_2)) {\n            mallaEstructurada.a침o = datoSiguiente.__EMPTY_2;\n          }\n          // Semana\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"SEMANA\")) {\n              mallaEstructurada.semana = v;\n            }\n          });\n          // Rango: p.ej. \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"LUNES\") && v.includes(\"VIERNES\")) {\n              mallaEstructurada.rangoDias = v;\n            }\n          });\n        }\n      }\n    }\n  });\n  \n  // Si despu칠s de procesar no encontramos t칤tulo, es que no hay malla v치lida\n  if (!mallaEstructurada.titulo) {\n    mallaEstructurada.titulo = \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\";\n    return mallaEstructurada;\n  }\n  \n  // B) Detectar franjas horarias (.__EMPTY = fracci칩n de d칤a)\n  const franjasHorarias = [];\n  datos.forEach(dato => {\n    if (\n      dato.__EMPTY !== undefined &&\n      typeof dato.__EMPTY === 'number' &&\n      dato.__EMPTY > 0 &&\n      dato.__EMPTY < 1\n    ) {\n      const totalMin = Math.round(dato.__EMPTY * 24 * 60);\n      const hh = Math.floor(totalMin / 60);\n      const mm = totalMin % 60;\n      \n      let periodo = \"AM\";\n      let hora12 = hh;\n      if (hh >= 12) {\n        periodo = \"PM\";\n        hora12 = (hh === 12 ? 12 : hh - 12);\n      }\n      if (hh === 0) {\n        hora12 = 12;\n      }\n      \n      const horaStr = `${hora12}:${String(mm).padStart(2, '0')} ${periodo}`;\n      franjasHorarias.push({\n        hora: horaStr,\n        indice: datos.indexOf(dato) // fila base\n      });\n    }\n  });\n  franjasHorarias.sort((a, b) => a.indice - b.indice);\n  mallaEstructurada.franjas = franjasHorarias;\n  \n  // C) Detectar muelles (col)\n  const muellesInfo = {};\n  datos.forEach(dato => {\n    Object.entries(dato).forEach(([key, value]) => {\n      if (value === \"MUELLE 01\" || value === \"MUELLE 02\") {\n        const col = parseInt(key.replace(\"__EMPTY_\", \"\"), 10);\n        const muelleKey = (value === \"MUELLE 01\") ? 'muelle1' : 'muelle2';\n        if (!muellesInfo[muelleKey]) {\n          muellesInfo[muelleKey] = [];\n        }\n        muellesInfo[muelleKey].push(col);\n      }\n    });\n  });\n  if (muellesInfo.muelle1) muellesInfo.muelle1.sort((a, b) => a - b);\n  if (muellesInfo.muelle2) muellesInfo.muelle2.sort((a, b) => a - b);\n  \n  // D) Generar los 5 d칤as (lunes-viernes) con su fecha\n  parsearRangoDias();\n  \n  // E) Extraer Citas\n  extraerCitas(datos, muellesInfo);\n  \n  return mallaEstructurada;\n}\n\n/**\n * Parsea la cadena \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n * (o \"LUNES 31 AL VIERNES 04 DE ABRIL\") y maneja el cruce de mes.\n * Ej.: si dayStart=31 y dayEnd=4, la 1춹 fecha es 31 de MARZO,\n * luego 1,2,3,4 de ABRIL, en vez de 32,33, etc.\n */\nfunction parsearRangoDias() {\n  const texto = mallaEstructurada.rangoDias;\n  // Regex simple: p.ej. \"31 AL ... 4 DE ABRIL\"\n  // Captura: dayStart, dayEnd, mesFin\n  // Ojo: si dice \"LUNES 31 DE MARZO AL VIERNES 4 DE ABRIL\",\n  // quedar치: dayStart=31, dayEnd=4, month=ABRIL (al final).\n  const regex = /(\\d+)\\s+AL\\s+\\D+(\\d+)\\s+DE\\s+(\\w+)/i;\n  const match = regex.exec(texto);\n  \n  // Por defecto, creamos 5 d칤as vac칤os sin fecha\n  diasSemana.forEach(d => {\n    mallaEstructurada.dias[d] = {\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  if (!match) {\n    // Sin coincidencia, dejamos los d칤as sin fecha\n    return;\n  }\n  \n  const dayStart = parseInt(match[1], 10); // 31\n  const dayEnd   = parseInt(match[2], 10); // 4\n  const finalMonthName = match[3].toLowerCase(); // \"abril\"\n  \n  // Convertimos a n칰mero\n  const finalMonth = meses[finalMonthName] || 3; // fallback marzo\n  const yearNum = parseInt(mallaEstructurada.a침o, 10) || 2025;\n  \n  // Funci칩n para obtener la fecha formateada\n  function fechaFormateada(d, m, y) {\n    return `${d} de ${nombreMes[m]} de ${y}`;\n  }\n  \n  // Comprobamos cu치ntos d칤as tiene el mes final, considerando bisiestos\n  const diasMesFinal = getDiasMes(finalMonth, yearNum);\n  // y del mes previo\n  const monthPrev = (finalMonth === 1) ? 12 : finalMonth - 1;\n  const yearPrev = (finalMonth === 1) ? yearNum - 1 : yearNum;\n  \n  // Arreglo final con 5 fechas\n  const fechasDias = [];\n  \n  if (dayStart <= dayEnd) {\n    // Caso \"normal\": todo en el mismo mes\n    let d = dayStart;\n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: finalMonth,\n        yearNum: yearNum\n      });\n      d++;\n      if (d > diasMesFinal) {\n        d = 1;\n        const nextMonth = finalMonth % 12 + 1;\n        const nextYear = (nextMonth === 1) ? yearNum + 1 : yearNum;\n        fechasDias[fechasDias.length - 1].mesNum = nextMonth;\n        fechasDias[fechasDias.length - 1].yearNum = nextYear;\n      }\n    }\n  } else {\n    // Caso \"cruza de mes\": dayStart > dayEnd\n    let d = dayStart;\n    let m = monthPrev;\n    let y = yearPrev;\n    \n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: m,\n        yearNum: y\n      });\n      d++;\n      if (d > getDiasMes(m, y)) {\n        d = 1;\n        m = m % 12 + 1;\n        if (m === 1) {\n          y++;\n        }\n      }\n    }\n  }\n  \n  // Ahora volcamos esas 5 fechas en la estructura\n  fechasDias.forEach(fd => {\n    const { diaSem, diaNum, mesNum, yearNum } = fd;\n    mallaEstructurada.dias[diaSem] = {\n      fechaDia: fechaFormateada(diaNum, mesNum, yearNum),\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  // Inicializamos las franjas a 'disponible'\n  if (mallaEstructurada.franjas.length > 0) {\n    diasSemana.forEach(d => {\n      mallaEstructurada.franjas.forEach(f => {\n        mallaEstructurada.dias[d].muelle1[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n        mallaEstructurada.dias[d].muelle2[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n      });\n    });\n  }\n}\n\n/**\n * Funci칩n auxiliar: decide a qu칠 d칤a pertenece una columna,\n * corrigiendo 2 columnas de offset (porque 'Extract from XLSX'\n * deja todo desplazado).\n */\nfunction getDayForColumn(colNumber) {\n  // Ajuste de offset +2\n  const realCol = colNumber + 2;\n\n  // Rangos:\n  //  Lunes:      3..8\n  //  Martes:     9..14\n  //  Mi칠rcoles: 15..20\n  //  Jueves:    21..26\n  //  Viernes:   27..32\n  if (realCol >= 3 && realCol <= 8) {\n    return \"lunes\";\n  }\n  if (realCol >= 9 && realCol <= 14) {\n    return \"martes\";\n  }\n  if (realCol >= 15 && realCol <= 20) {\n    return \"mi칠rcoles\";\n  }\n  if (realCol >= 21 && realCol <= 26) {\n    return \"jueves\";\n  }\n  if (realCol >= 27 && realCol <= 32) {\n    return \"viernes\";\n  }\n  // Si nada coincide, devolvemos null\n  return null;\n}\n\n/**\n * Extraer las citas para cada franja:\n * - Para cada franja, miramos 3 filas:\n *    - Fila base => proveedor\n *    - Fila base+1 => orden\n *    - Fila base+2 => peso, categor칤a, unidades\n */\nfunction extraerCitas(datos, muellesInfo) {\n  mallaEstructurada.franjas.forEach(franja => {\n    const indiceBase = franja.indice;\n    if (indiceBase < 0 || indiceBase + 2 >= datos.length) {\n      return; // no hay suficientes filas\n    }\n    \n    // Recorremos muelle1, muelle2 y sus columnas\n    const asignarCita = (muelleKey, cols) => {\n      cols.forEach(col => {\n        const provKey = `__EMPTY_${col}`;\n        const filaProv = datos[indiceBase];\n        \n        // Si en esta fila hay un proveedor o alg칰n texto\n        if (\n          filaProv &&\n          typeof filaProv[provKey] === 'string' &&\n          filaProv[provKey].length > 2\n        ) {\n          // Determinar el d칤a real\n          const diaOk = getDayForColumn(col);\n          if (!diaOk || !mallaEstructurada.dias[diaOk]) {\n            return; // si no coincide con ninguno, saltamos\n          }\n          \n          // Recuperar valores para proveedor, ordenCompra y dem치s\n          const filaOrden = datos[indiceBase + 1];\n          const filaDet = datos[indiceBase + 2];\n          \n          const proveedor = filaProv[provKey] || \"\";\n          const ordenCompra = filaOrden && filaOrden[provKey] ? filaOrden[provKey] : \"\";\n          const peso = filaDet && filaDet[provKey] ? filaDet[provKey] : \"\";\n          const cat  = filaDet && filaDet[`__EMPTY_${col + 1}`] ? filaDet[`__EMPTY_${col + 1}`] : \"\";\n          const und  = filaDet && filaDet[`__EMPTY_${col + 2}`] ? filaDet[`__EMPTY_${col + 2}`] : \"\";\n          \n          // Antes pon칤amos estado=\"ocupado\" directamente\n          // Ahora verificamos si el texto contiene \"reagendado\", \"cancelado\" o \"fuera de servicio\".\n          const nuevoEstado = determinarEstadoOcupado(proveedor, ordenCompra, peso, cat, und);\n          \n          // Asignamos los datos\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].estado = nuevoEstado;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].proveedor = proveedor;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].ordenCompra = ordenCompra;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].peso = peso;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].categoria = cat;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].unidades = und;\n        }\n      });\n    };\n    \n    if (muellesInfo.muelle1) {\n      asignarCita('muelle1', muellesInfo.muelle1);\n    }\n    if (muellesInfo.muelle2) {\n      asignarCita('muelle2', muellesInfo.muelle2);\n    }\n  });\n}\n\n// -------------------------------------------------------------\n// 2) FUNCIONES PARA CONSULTAR LA MALLA\n// -------------------------------------------------------------\nfunction buscarFranjasDisponibles(categoria, duracionHoras) {\n  const muelle = \"muelle1\"; // Ajusta si usas \"categoria -> muelle\" real\n  \n  const franjasDisponibles = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const libres = [];\n    for (let i = 0; i <= mallaEstructurada.franjas.length - duracionHoras; i++) {\n      let disponible = true;\n      for (let h = 0; h < duracionHoras; h++) {\n        const idxF = i + h;\n        const horaAct = mallaEstructurada.franjas[idxF].hora;\n        if (\n          mallaEstructurada.dias[dia][muelle][horaAct].estado !== 'disponible'\n        ) {\n          disponible = false;\n          break;\n        }\n      }\n      if (disponible) {\n        libres.push({\n          horaInicio: mallaEstructurada.franjas[i].hora,\n          duracion: duracionHoras\n        });\n      }\n    }\n    if (libres.length > 0) {\n      franjasDisponibles.push({ dia, franjas: libres });\n    }\n  });\n  return franjasDisponibles;\n}\n\nfunction buscarCitasProveedor(nombreProveedor) {\n  const citas = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const muelle1 = mallaEstructurada.dias[dia].muelle1;\n    const muelle2 = mallaEstructurada.dias[dia].muelle2;\n    mallaEstructurada.franjas.forEach(f => {\n      const hora = f.hora;\n      // muelle1\n      if (normalizarTexto(muelle1[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 01\",\n          ordenCompra: muelle1[hora].ordenCompra,\n          peso: muelle1[hora].peso,\n          categoria: muelle1[hora].categoria,\n          unidades: muelle1[hora].unidades,\n          estado: muelle1[hora].estado\n        });\n      }\n      // muelle2\n      if (normalizarTexto(muelle2[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 02\",\n          ordenCompra: muelle2[hora].ordenCompra,\n          peso: muelle2[hora].peso,\n          categoria: muelle2[hora].categoria,\n          unidades: muelle2[hora].unidades,\n          estado: muelle2[hora].estado\n        });\n      }\n    });\n  });\n  return citas;\n}\n\nfunction consultarFranjasDisponibles(categoria, duracionHoras) {\n  return buscarFranjasDisponibles(categoria, duracionHoras);\n}\n\nfunction consultarCitasProveedor(nombreProveedor) {\n  return buscarCitasProveedor(nombreProveedor);\n}\n\nfunction obtenerInfoMalla() {\n  return {\n    titulo: mallaEstructurada.titulo,\n    a침o: mallaEstructurada.a침o,\n    semana: mallaEstructurada.semana,\n    rangoDias: mallaEstructurada.rangoDias,\n    franjas: mallaEstructurada.franjas.map(f => f.hora)\n  };\n}\n\nfunction estaDisponible(dia, hora, muelle) {\n  const info = mallaEstructurada.dias[dia]?.[muelle]?.[hora];\n  return info ? (info.estado === 'disponible') : false;\n}\n\nfunction obtenerCoordenadasCita(dia, hora, muelle) {\n  // Ajustar con tu mapeo de celdas en Excel\n  return {\n    proveedor: `${dia}_${hora}_${muelle}_proveedor`,\n    ordenCompra: `${dia}_${hora}_${muelle}_ordenCompra`,\n    peso: `${dia}_${hora}_${muelle}_peso`,\n    categoria: `${dia}_${hora}_${muelle}_categoria`,\n    unidades: `${dia}_${hora}_${muelle}_unidades`\n  };\n}\n\n// -------------------------------------------------------------\n// 3) EJECUTAR TODO Y RETORNAR\n// -------------------------------------------------------------\nconst malla = procesarDatos(excelData);\n\nconst resultado = {\n  datosMallaProxSemana: malla,\n  funciones: {\n    consultarFranjasDisponibles,\n    consultarCitasProveedor,\n    obtenerInfoMalla,\n    estaDisponible,\n    obtenerCoordenadasCita\n  }\n};\n\nreturn [resultado];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2384,
        4928
      ],
      "id": "7b6b38a8-2382-4e6c-aa8d-6c8b6eb53fdc",
      "name": "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana3"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Validaci칩n de reprogramaci칩n de citas - SOLUCI칍N CORREGIDA\n * \n * Correcciones aplicadas:\n * 1. Referencias din치micas en lugar de hardcodeadas (SEMANA 20/21)\n * 2. Permite reprogramaci칩n cuando es la misma cita\n * 3. Normalizaci칩n flexible de fechas (06  6)\n * 4. Normalizaci칩n flexible de horas (09:00 AM  9:00 AM)\n */\n\n// Funci칩n principal\ntry {\n    // 1. Obtener datos necesarios\n    const datosReprogramacion = $node[\"Code Validaci칩n de datos para reprogramaci칩n de citas\"].json;\n    const citaOriginal = $node[\"Microsoft SQL Obtener Cita\"].json;\n    const mallas = $node[\"Unificaci칩n y consistencia de datos4\"].json;\n    \n    // Extraer los datos importantes\n    const idCita = datosReprogramacion.idCita;\n    const ordenCompra = datosReprogramacion.ordenCompra;\n    const nuevaFecha = datosReprogramacion.nuevaFecha; // \"06 de junio de 2025\"\n    const nuevaHoraConFormato = datosReprogramacion.nuevaHora; // \"10:00 AM\"\n    \n    // Normalizar el formato de hora para que coincida con las mallas\n    const nuevaHora = normalizarHora(nuevaHoraConFormato);\n    \n    console.log(`Hora original: \"${nuevaHoraConFormato}\", hora normalizada: \"${nuevaHora}\"`);\n    \n    // Extraer datos de la cita original\n    const idCitaDB = citaOriginal.id;\n    const ordenCompraDB = citaOriginal.orden_compra;\n    const horasEntrega = parseInt(citaOriginal.horas_entrega);\n    const muelleOriginal = citaOriginal.muelle;\n    const horaInicioOriginal = citaOriginal.hora_inicio;\n    const horaFinOriginal = citaOriginal.hora_fin;\n    const proveedorOriginal = citaOriginal.nombre; // Para verificar si es la misma cita\n    \n    // Normalizar n칰mero de muelle\n    let numeroMuelle = 1;\n    if (muelleOriginal && muelleOriginal.toLowerCase().includes(\"muelle\")) {\n        const match = muelleOriginal.match(/\\d+/);\n        if (match) numeroMuelle = parseInt(match[0]);\n    }\n    \n    // 2. Validar coincidencia de ID y orden de compra\n    if (idCita != idCitaDB || ordenCompra !== ordenCompraDB) {\n        return [{\n            json: {\n                franjaDisponible: false,\n                mensaje: `La informaci칩n de la cita no coincide. ID Cita proporcionado: ${idCita}, ID en sistema: ${idCitaDB}. Orden de compra proporcionada: ${ordenCompra}, Orden en sistema: ${ordenCompraDB}.`\n            }\n        }];\n    }\n    \n    // 3. Buscar la fecha en AMBAS mallas usando normalizaci칩n flexible\n    let fechaEncontrada = false;\n    let nombreHoja = null;\n    let diaSemana = null;\n    let datosDia = null;\n    \n    // Buscar primero en la malla principal\n    for (const dia in mallas.datosMalla.dias) {\n        if (compararFechasFlexible(mallas.datosMalla.dias[dia].fechaDia, nuevaFecha)) {\n            console.log(`Fecha encontrada en ${mallas.datosMalla.semana} (${dia})`);\n            fechaEncontrada = true;\n            diaSemana = dia;\n            datosDia = mallas.datosMalla.dias[dia];\n            nombreHoja = mallas.datosMalla.semana;\n            break;\n        }\n    }\n    \n    // Si no se encuentra en la malla principal, buscar en la pr칩xima semana\n    if (!fechaEncontrada) {\n        for (const dia in mallas.datosMallaProxSemana.dias) {\n            if (compararFechasFlexible(mallas.datosMallaProxSemana.dias[dia].fechaDia, nuevaFecha)) {\n                console.log(`Fecha encontrada en ${mallas.datosMallaProxSemana.semana} (${dia})`);\n                fechaEncontrada = true;\n                diaSemana = dia;\n                datosDia = mallas.datosMallaProxSemana.dias[dia];\n                nombreHoja = mallas.datosMallaProxSemana.semana;\n                break;\n            }\n        }\n    }\n    \n    // Si la fecha no se encuentra en ninguna malla\n    if (!fechaEncontrada) {\n        return [{\n            json: {\n                franjaDisponible: false,\n                mensaje: `La fecha ${nuevaFecha} no se encuentra en la programaci칩n disponible.`\n            }\n        }];\n    }\n    \n    // 4. Verificar disponibilidad en la malla correcta\n    // Verificar que exista el muelle para ese d칤a\n    const muelleKey = `muelle${numeroMuelle}`;\n    if (!datosDia[muelleKey]) {\n        return [{\n            json: {\n                franjaDisponible: false,\n                mensaje: `No existe el muelle ${numeroMuelle} para el d칤a ${diaSemana}.`\n            }\n        }];\n    }\n    \n    // Verificar que la hora exista en el muelle\n    const muelle = datosDia[muelleKey];\n    \n    console.log(`Verificando hora: ${nuevaHora} en muelle ${numeroMuelle}`);\n    console.log(`Estado: ${muelle[nuevaHora]?.estado || 'no definido'}`);\n    \n    if (!muelle[nuevaHora]) {\n        return [{\n            json: {\n                franjaDisponible: false,\n                mensaje: `La hora ${nuevaHoraConFormato} no est치 definida para el d칤a ${diaSemana}.`\n            }\n        }];\n    }\n    \n    // Verificar disponibilidad para horas consecutivas\n    let disponible = true;\n    let franjasNoDisponibles = [];\n    let esMismaCita = false; // Nueva bandera para verificar si es reprogramaci칩n de la misma cita\n    \n    // Encontrar la hora en las franjas\n    const franjas = nombreHoja === mallas.datosMalla.semana \n        ? mallas.datosMalla.franjas \n        : mallas.datosMallaProxSemana.franjas;\n    \n    let indiceInicio = -1;\n    \n    // Buscar usando normalizaci칩n flexible de horas\n    for (let i = 0; i < franjas.length; i++) {\n        if (compararHorasFlexible(franjas[i].hora, nuevaHora)) {\n            indiceInicio = i;\n            console.log(`춰Coincidencia encontrada en 칤ndice ${i}!`);\n            break;\n        }\n    }\n    \n    if (indiceInicio === -1) {\n        console.log(\"No se encontr칩 la hora en las franjas\");\n        return [{\n            json: {\n                franjaDisponible: false,\n                mensaje: `La hora ${nuevaHoraConFormato} no se encuentra en las franjas horarias disponibles.`\n            }\n        }];\n    }\n    \n    // Verificar disponibilidad para cada hora necesaria\n    for (let i = 0; i < horasEntrega; i++) {\n        if (indiceInicio + i >= franjas.length) {\n            disponible = false;\n            console.log(\"No hay suficientes horas disponibles en el d칤a\");\n            break;\n        }\n        \n        const franja = franjas[indiceInicio + i];\n        const estadoFranja = muelle[franja.hora];\n        \n        console.log(`Verificando franja ${franja.hora}: ${estadoFranja?.estado || 'no definido'}`);\n        \n        if (!estadoFranja) {\n            disponible = false;\n            franjasNoDisponibles.push(franja.hora);\n        } else if (estadoFranja.estado === \"disponible\") {\n            // Franja disponible, todo bien\n            continue;\n        } else if (estadoFranja.estado === \"ocupado\") {\n            // Verificar si est치 ocupada por la misma cita\n            if (estadoFranja.ordenCompra === ordenCompra && \n                estadoFranja.proveedor === proveedorOriginal) {\n                console.log(`Franja ${franja.hora} ocupada por la misma cita - permitir reprogramaci칩n`);\n                esMismaCita = true;\n                continue;\n            } else {\n                // Ocupada por otra cita\n                disponible = false;\n                franjasNoDisponibles.push(franja.hora);\n            }\n        } else {\n            // Fuera de servicio u otro estado\n            disponible = false;\n            franjasNoDisponibles.push(franja.hora);\n        }\n    }\n    \n    // C츼LCULO PRECISO DEL nombreHoja PARA LA CITA ORIGINAL\n    let nombreHojaOriginal = calcularNombreHojaOriginal(citaOriginal.fecha_cita, mallas);\n    \n    // Si hay disponibilidad o es reprogramaci칩n de la misma cita, retornar respuesta positiva\n    if (disponible || esMismaCita) {\n        const horaFin = calcularHoraFin(nuevaHoraConFormato, horasEntrega);\n        const fechaFormateada = convertirFechaAFormatoISO(nuevaFecha);\n        \n        // Normalizar horaInicio para la respuesta (quitar cero inicial si existe)\n        const horaInicioNormalizada = nuevaHoraConFormato.replace(/^0(\\d:00 [AP]M)$/, \"$1\");\n        \n        const tipoOperacion = esMismaCita ? \"reprogramaci칩n\" : \"nueva programaci칩n\";\n        \n        const respuesta = {\n            franjaDisponible: true,\n            mensaje: `춰Genial! Hay espacio para la ${tipoOperacion} el ${nuevaFecha}, de ${horaInicioNormalizada} a ${horaFin} en MUELLE ${numeroMuelle}.`,\n            datosValidados: {\n                fecha: nuevaFecha,\n                fechaFormateada: fechaFormateada,\n                horaInicio: horaInicioNormalizada,\n                horaFin: horaFin,\n                muelle: `MUELLE ${numeroMuelle}`,\n                duracionHoras: horasEntrega,\n                disponibilidadConfirmada: true,\n                tipoOperacion: tipoOperacion\n            },\n            nombreHoja: nombreHoja,\n            citaAntigua: {\n                id: idCitaDB,\n                fechaFormateada: citaOriginal.fecha_cita ? citaOriginal.fecha_cita.split('T')[0] : \"\",\n                horaInicio: horaInicioOriginal,\n                horaFin: horaFinOriginal,\n                muelle: muelleOriginal,\n                nombreHoja: nombreHojaOriginal || nombreHoja // Usar valor calculado o default\n            }\n        };\n        \n        return [{ json: respuesta }];\n    } else {\n        // Si no hay disponibilidad, buscar alternativas\n        const franjasSemana = nombreHoja === mallas.datosMalla.semana \n            ? mallas.datosMalla.franjas \n            : mallas.datosMallaProxSemana.franjas;\n            \n        const alternativas = buscarAlternativasParaDia(\n            datosDia,\n            franjasSemana,\n            horasEntrega,\n            numeroMuelle\n        );\n        \n        let mensajeAlternativas = `Lo siento, la franja horaria seleccionada ya no est치 disponible. `;\n        \n        if (alternativas.length > 0) {\n            mensajeAlternativas += `Aqu칤 hay algunas alternativas disponibles en el muelle ${numeroMuelle}:\\n\\n`;\n            \n            alternativas.forEach((alt, index) => {\n                mensajeAlternativas += `Opci칩n ${index + 1}: ${alt.fecha} - Muelle ${alt.muelle} - De ${alt.horaInicio} a ${alt.horaFin}\\n`;\n            });\n            \n            mensajeAlternativas += \"\\nSi desea elegir una de estas alternativas, por favor env칤e un nuevo mensaje con todos los datos de reprogramaci칩n. Este chat se reiniciar치 para evitar confusiones con mensajes anteriores.\";\n        } else {\n            mensajeAlternativas += `No se encontraron horarios alternativos disponibles para el muelle ${numeroMuelle} en las pr칩ximas fechas. Por favor, intente con otra fecha u horario. Este chat se reiniciar치 para evitar confusiones con mensajes anteriores.`;\n        }\n        \n        return [{\n            json: {\n                franjaDisponible: false,\n                mensaje: mensajeAlternativas,\n                alternativas: alternativas\n            }\n        }];\n    }\n} catch (error) {\n    console.error(\"Error en la validaci칩n:\", error);\n    return [{\n        json: {\n            franjaDisponible: false,\n            mensaje: \"Error en el proceso de validaci칩n: \" + error.message\n        }\n    }];\n}\n\n// FUNCIONES AUXILIARES MEJORADAS\n\n// Funci칩n para normalizar horas (maneja ambas direcciones)\nfunction normalizarHora(hora) {\n    if (!hora) return hora;\n    \n    // Convertir a string si no lo es\n    const horaStr = hora.toString().trim();\n    \n    // Patr칩n para capturar horas con posible cero inicial\n    const patron = /^(0?)(\\d{1,2}):(\\d{2})\\s*([AP]M)$/i;\n    const match = horaStr.match(patron);\n    \n    if (match) {\n        const [, ceroInicial, hora, minutos, periodo] = match;\n        // Quitar cero inicial si existe y la hora es de un d칤gito\n        const horaSinCero = parseInt(hora, 10);\n        return `${horaSinCero}:${minutos} ${periodo.toUpperCase()}`;\n    }\n    \n    return horaStr;\n}\n\n// Funci칩n para comparar horas de manera flexible\nfunction compararHorasFlexible(hora1, hora2) {\n    const horaNormalizada1 = normalizarHora(hora1);\n    const horaNormalizada2 = normalizarHora(hora2);\n    \n    console.log(`Comparando horas: \"${horaNormalizada1}\" con \"${horaNormalizada2}\"`);\n    \n    return horaNormalizada1 === horaNormalizada2;\n}\n\n// Funci칩n para normalizar fechas (maneja ambas direcciones)\nfunction normalizarFecha(fecha) {\n    if (!fecha) return fecha;\n    \n    const fechaStr = fecha.toString().trim();\n    \n    // Patr칩n para capturar fecha con posible cero inicial en el d칤a\n    const patron = /^(0?)(\\d{1,2})\\s+de\\s+(\\w+)(?:\\s+de\\s+(\\d{4}))?$/i;\n    const match = fechaStr.match(patron);\n    \n    if (match) {\n        const [, ceroInicial, dia, mes, a침o] = match;\n        // Quitar cero inicial si existe\n        const diaSinCero = parseInt(dia, 10);\n        \n        if (a침o) {\n            return `${diaSinCero} de ${mes.toLowerCase()} de ${a침o}`;\n        } else {\n            return `${diaSinCero} de ${mes.toLowerCase()}`;\n        }\n    }\n    \n    return fechaStr;\n}\n\n// Funci칩n para comparar fechas de manera flexible\nfunction compararFechasFlexible(fecha1, fecha2) {\n    const fechaNormalizada1 = normalizarFecha(fecha1);\n    const fechaNormalizada2 = normalizarFecha(fecha2);\n    \n    console.log(`Comparando fechas: \"${fechaNormalizada1}\" con \"${fechaNormalizada2}\"`);\n    \n    // Comparaci칩n exacta\n    if (fechaNormalizada1 === fechaNormalizada2) {\n        return true;\n    }\n    \n    // Comparaci칩n sin a침o (para casos donde una tiene a침o y otra no)\n    const fecha1SinA침o = fechaNormalizada1.replace(/\\s+de\\s+\\d{4}$/, '');\n    const fecha2SinA침o = fechaNormalizada2.replace(/\\s+de\\s+\\d{4}$/, '');\n    \n    return fecha1SinA침o === fecha2SinA침o;\n}\n\n// Funci칩n para calcular el nombreHoja de la cita original\nfunction calcularNombreHojaOriginal(fechaCitaOriginal, mallas) {\n    if (!fechaCitaOriginal) return null;\n    \n    const formatosFechaOriginal = convertirFechaISOaLegible(fechaCitaOriginal);\n    console.log(\"Formatos de fecha original:\", formatosFechaOriginal);\n    \n    // Buscar en malla principal\n    for (const dia in mallas.datosMalla.dias) {\n        const fechaDiaMalla = mallas.datosMalla.dias[dia].fechaDia;\n        \n        if (compararFechasFlexible(fechaDiaMalla, formatosFechaOriginal.conA침o) || \n            compararFechasFlexible(fechaDiaMalla, formatosFechaOriginal.sinA침o)) {\n            console.log(`춰Cita original encontrada en ${mallas.datosMalla.semana}!`);\n            return mallas.datosMalla.semana;\n        }\n    }\n    \n    // Buscar en pr칩xima semana\n    for (const dia in mallas.datosMallaProxSemana.dias) {\n        const fechaDiaMalla = mallas.datosMallaProxSemana.dias[dia].fechaDia;\n        \n        if (compararFechasFlexible(fechaDiaMalla, formatosFechaOriginal.conA침o) || \n            compararFechasFlexible(fechaDiaMalla, formatosFechaOriginal.sinA침o)) {\n            console.log(`춰Cita original encontrada en ${mallas.datosMallaProxSemana.semana}!`);\n            return mallas.datosMallaProxSemana.semana;\n        }\n    }\n    \n    // M칠todo adicional: por d칤a de la semana y rango de fechas\n    const fechaISO = new Date(fechaCitaOriginal);\n    const diaNumerico = fechaISO.getDate();\n    const mes = fechaISO.getMonth();\n    \n    // Funci칩n para extraer rango de d칤as de un string como \"LUNES 02 AL VIERNES 06 DE JUNIO\"\n    function extraerRangoDias(rango) {\n        const partes = rango.split(\" \");\n        let diaInicio = null;\n        let diaFin = null;\n        let mesTexto = null;\n        \n        for (let i = 0; i < partes.length; i++) {\n            if (/^\\d+$/.test(partes[i])) {\n                if (diaInicio === null) {\n                    diaInicio = parseInt(partes[i]);\n                } else {\n                    diaFin = parseInt(partes[i]);\n                }\n            }\n            if (i > 0 && partes[i-1] === \"DE\") {\n                mesTexto = partes[i].toLowerCase();\n            }\n        }\n        \n        const meses = {\n            'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3, 'mayo': 4, 'junio': 5,\n            'julio': 6, 'agosto': 7, 'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11\n        };\n        \n        return { diaInicio, diaFin, mes: meses[mesTexto] };\n    }\n    \n    // Verificar rangos\n    const rangoMallaPrincipal = extraerRangoDias(mallas.datosMalla.rangoDias);\n    console.log(\"Rango malla principal:\", rangoMallaPrincipal);\n    \n    if (mes === rangoMallaPrincipal.mes && \n        diaNumerico >= rangoMallaPrincipal.diaInicio && \n        diaNumerico <= rangoMallaPrincipal.diaFin) {\n        console.log(`Cita original en rango de ${mallas.datosMalla.semana}`);\n        return mallas.datosMalla.semana;\n    }\n    \n    const rangoProxSemana = extraerRangoDias(mallas.datosMallaProxSemana.rangoDias);\n    console.log(\"Rango pr칩xima semana:\", rangoProxSemana);\n    \n    if (mes === rangoProxSemana.mes && \n        diaNumerico >= rangoProxSemana.diaInicio && \n        diaNumerico <= rangoProxSemana.diaFin) {\n        console.log(`Cita original en rango de ${mallas.datosMallaProxSemana.semana}`);\n        return mallas.datosMallaProxSemana.semana;\n    }\n    \n    console.log(`No se pudo determinar la hoja original, usando default: ${mallas.datosMalla.semana}`);\n    return mallas.datosMalla.semana;\n}\n\n// Funci칩n para convertir una fecha ISO a un formato legible\nfunction convertirFechaISOaLegible(fechaISO) {\n    const fechaObj = new Date(fechaISO);\n    const dia = fechaObj.getDate();\n    const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];\n    const mes = meses[fechaObj.getMonth()];\n    const a침o = fechaObj.getFullYear();\n    \n    return {\n        conA침o: `${dia} de ${mes} de ${a침o}`,\n        sinA침o: `${dia} de ${mes}`\n    };\n}\n\n// Funci칩n para calcular la hora final\nfunction calcularHoraFin(horaInicio, horasNecesarias) {\n    try {\n        const partes = horaInicio.trim().split(/\\s+/);\n        const horaMinutos = partes[0].split(':');\n        const periodo = partes[1]; // AM o PM\n        \n        let hora = parseInt(horaMinutos[0], 10);\n        let minutos = parseInt(horaMinutos[1] || \"0\", 10);\n        \n        // Convertir a formato 24 horas para el c치lculo\n        if (periodo.toUpperCase() === \"PM\" && hora < 12) {\n            hora += 12;\n        } else if (periodo.toUpperCase() === \"AM\" && hora === 12) {\n            hora = 0;\n        }\n        \n        // Sumar las horas necesarias\n        hora = (hora + horasNecesarias) % 24;\n        \n        // Convertir de nuevo a formato 12 horas\n        let nuevoPeriodo = \"AM\";\n        if (hora >= 12) {\n            nuevoPeriodo = \"PM\";\n            if (hora > 12) {\n                hora -= 12;\n            }\n        }\n        if (hora === 0) {\n            hora = 12;\n        }\n        \n        return `${hora}:${minutos.toString().padStart(2, '0')} ${nuevoPeriodo}`;\n    } catch (error) {\n        console.error(\"Error al calcular hora fin:\", error);\n        return \"Hora desconocida\";\n    }\n}\n\n// Funci칩n para convertir fecha a formato ISO\nfunction convertirFechaAFormatoISO(fechaTexto) {\n    try {\n        const partes = fechaTexto.split(\" de \");\n        const dia = parseInt(partes[0], 10);\n        const mes = partes[1].toLowerCase();\n        \n        const meses = {\n            'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3, 'mayo': 4, 'junio': 5,\n            'julio': 6, 'agosto': 7, 'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11\n        };\n        \n        const mesNum = meses[mes];\n        if (mesNum === undefined) {\n            throw new Error(`Mes no v치lido: ${mes}`);\n        }\n        \n        let anio = new Date().getFullYear();\n        if (partes.length > 2) {\n            anio = parseInt(partes[2], 10);\n        }\n        \n        return `${anio}-${(mesNum + 1).toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;\n    } catch (error) {\n        console.error(\"Error al convertir fecha a formato ISO:\", error);\n        return \"\";\n    }\n}\n\n// Funci칩n para buscar alternativas en un d칤a\nfunction buscarAlternativasParaDia(datoDia, franjas, horasNecesarias, numeroMuelle) {\n    const alternativas = [];\n    const muelleKey = `muelle${numeroMuelle}`;\n    const muelle = datoDia[muelleKey];\n    \n    if (!muelle) return alternativas;\n    \n    // Para cada posible hora de inicio\n    for (let i = 0; i <= franjas.length - horasNecesarias; i++) {\n        let disponible = true;\n        \n        // Verificar franjas consecutivas\n        for (let j = 0; j < horasNecesarias; j++) {\n            const franja = franjas[i + j];\n            if (!muelle[franja.hora] || muelle[franja.hora].estado !== \"disponible\") {\n                disponible = false;\n                break;\n            }\n        }\n        \n        if (disponible) {\n            const horaInicio = franjas[i].hora;\n            const horaFin = calcularHoraFin(horaInicio, horasNecesarias);\n            \n            alternativas.push({\n                fecha: datoDia.fechaDia,\n                muelle: numeroMuelle,\n                horaInicio: horaInicio,\n                horaFin: horaFin,\n                franjasHorarias: franjas.slice(i, i + horasNecesarias).map(f => f.hora)\n            });\n        }\n    }\n    \n    return alternativas;\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3200,
        4816
      ],
      "id": "c04eb8f5-b8bf-4c5d-ae2c-d825583c8a0d",
      "name": "Code Validacion de Cita en cronograma para reprogramaci칩n"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "de7a1d59-037e-48c1-8ef4-b5667443ca11",
              "leftValue": "={{ $json.franjaDisponible }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3408,
        4816
      ],
      "id": "6fe79ced-a4fd-4fc6-b83a-e930b0ea1e91",
      "name": "If validacion de reprogramacion"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Code Validacion de Cita en cronograma para reprogramaci칩n').first().json.mensaje.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3856,
        4896
      ],
      "id": "2dabea14-789b-4cca-97d1-2c148ed72b14",
      "name": "Validaci칩n de longitud de caracteres9"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Code Validacion de Cita en cronograma para reprogramaci칩n').first().json.mensaje }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Code Validacion de Cita en cronograma para reprogramaci칩n').first().json.mensaje.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4128,
        4960
      ],
      "id": "deb8ff1a-b8a2-4fda-a13c-63272d4dac7d",
      "name": "Organiza variables del mensaje9"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4320,
        4768
      ],
      "id": "07b7558c-b9b4-47a8-bfce-0999cb410315",
      "name": "No Operation, do nothing13"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4128,
        4768
      ],
      "id": "414b0b96-09ee-42b1-953d-6e807c51d47e",
      "name": "HTTP Request Enviar Mensaje por WhatsApp12"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo optimizado para el nodo \"Code (Preparar Cuerpo de Petici칩n)1\"\nconst datosValidados = $input.first().json.datosValidados;\nconst datosCita = $('Microsoft SQL Obtener Cita').first().json;\n// Obtener ambas mallas\nconst mallaActual = $('Unificaci칩n y consistencia de datos4').first().json.datosMalla;\nconst mallaProxima = $('Unificaci칩n y consistencia de datos4').first().json.datosMallaProxSemana;\n\n// Usar fecha de cita original para determinar malla\nconst fechaCitaOriginal = new Date(datosCita.fecha_cita);\n\nfunction fechaEnMalla(fecha, malla) {\n  if (!malla.dias) return false;\n  \n  const fechaBuscada = fecha.toLocaleDateString('es-ES', { \n    day: 'numeric', \n    month: 'long', \n    year: 'numeric' \n  });\n  \n  for (const dia of Object.keys(malla.dias)) {\n    const diaData = malla.dias[dia];\n    if (diaData.fechaDia && diaData.fechaDia === fechaBuscada) {\n      return true;\n    }\n  }\n  return false;\n}\n\n// Seleccionar malla correcta\nlet datosMalla;\nif (fechaEnMalla(fechaCitaOriginal, mallaActual)) {\n  datosMalla = mallaActual;\n  console.log(\"Usando malla actual para edici칩n\");\n} else if (fechaEnMalla(fechaCitaOriginal, mallaProxima)) {\n  datosMalla = mallaProxima;\n  console.log(\"Usando malla pr칩xima para edici칩n\");\n} else {\n  return {\n    json: {\n      error: true,\n      mensaje: \"No se encontr칩 la cita original en ninguna malla\"\n    }\n  };\n}\n\nconst citaAntigua = $input.first().json.citaAntigua || null;\nconst nombreHojaActual = $input.first().json.nombreHoja || datosMalla.semana || \"\";\n\n// Extraer la informaci칩n relevante para la nueva cita\nconst {\n  fecha,\n  fechaFormateada,\n  horaInicio,\n  horaFin,\n  muelle,\n  duracionHoras\n} = datosValidados;\n\n// Mapear correctamente los campos del nodo \"Microsoft SQL Obtener Cita\"\nconst {\n  nombre: proveedor = \"\",\n  orden_compra: ordenCompra = \"\",\n  peso = \"\",\n  categoria = \"\",\n  unidades = \"\"\n} = datosCita;\n\n// **NUEVA FUNCIONALIDAD: Optimizaci칩n de franjas cruzadas**\nfunction calcularFranjasOptimizadas() {\n  if (!citaAntigua) {\n    // Si no hay cita antigua, proceder normalmente\n    return {\n      franjasAEliminar: [],\n      franjasAInsertar: generarFranjasNuevas(),\n      optimizacionAplicada: false,\n      tipoOperacion: \"nueva_cita\"\n    };\n  }\n\n  // Verificar si es el mismo d칤a\n  const fechaNueva = new Date(fechaFormateada);\n  const fechaAntigua = new Date(citaAntigua.fechaFormateada);\n  \n  const esMismoDia = fechaNueva.toDateString() === fechaAntigua.toDateString();\n  \n  if (!esMismoDia) {\n    // D칤as diferentes: eliminar todas las antiguas, insertar todas las nuevas\n    return {\n      franjasAEliminar: generarFranjasAntiguas(),\n      franjasAInsertar: generarFranjasNuevas(),\n      optimizacionAplicada: false,\n      tipoOperacion: \"cambio_dia\"\n    };\n  }\n\n  // **MISMO D칈A: Aplicar optimizaci칩n**\n  const franjasAntiguas = generarFranjasAntiguas();\n  const franjasNuevas = generarFranjasNuevas();\n  \n  // Calcular intersecci칩n (franjas que se cruzan)\n  const franjasAntiguasSet = new Set(franjasAntiguas.map(f => f.hora));\n  const franjasNuevasSet = new Set(franjasNuevas.map(f => f.hora));\n  \n  const franjasComunes = franjasAntiguas.filter(f => franjasNuevasSet.has(f.hora));\n  const franjasComnesSet = new Set(franjasComunes.map(f => f.hora));\n  \n  // Calcular operaciones optimizadas\n  const franjasAEliminar = franjasAntiguas.filter(f => !franjasComnesSet.has(f.hora));\n  const franjasAInsertar = franjasNuevas.filter(f => !franjasComnesSet.has(f.hora));\n  \n  console.log(`Optimizaci칩n aplicada:\\n    - Franjas antiguas: ${franjasAntiguas.length}\\n    - Franjas nuevas: ${franjasNuevas.length}\\n    - Franjas comunes (mantenidas): ${franjasComunes.length}\\n    - Franjas a eliminar: ${franjasAEliminar.length}\\n    - Franjas a insertar: ${franjasAInsertar.length}\\n    - Operaciones evitadas: ${franjasComunes.length * 2}`);\n\n  return {\n    franjasAEliminar,\n    franjasAInsertar,\n    franjasComunes,\n    optimizacionAplicada: true,\n    tipoOperacion: \"mismo_dia_optimizado\",\n    estadisticas: {\n      operacionesEvitadas: franjasComunes.length * 2,\n      eficiencia: ((franjasComunes.length * 2) / (franjasAntiguas.length + franjasNuevas.length) * 100).toFixed(2) + '%'\n    }\n  };\n}\n\nfunction generarFranjasNuevas() {\n  const franjas = [];\n  let horaActual = horaInicio;\n  let horasRestantes = duracionHoras;\n  \n  while (horasRestantes > 0) {\n    const franjaActual = datosMalla.franjas.find(f => horasIguales(f.hora, horaActual));\n    \n    if (!franjaActual) {\n      console.log(`No se encontr칩 informaci칩n para la franja: ${horaActual}`);\n      break;\n    }\n    \n    const filaBase = calcularFilaExcel(horaActual, datosMalla.franjas);\n    if (!filaBase) {\n      console.log(`No se pudo determinar la fila para la franja: ${horaActual}`);\n      break;\n    }\n\n    franjas.push({\n      hora: horaActual,\n      fila: filaBase,\n      datos: {\n        proveedor,\n        ordenCompra,\n        peso,\n        categoria,\n        unidades\n      }\n    });\n    \n    horasRestantes--;\n    if (horasRestantes > 0) {\n      const siguienteFranja = encontrarSiguienteFranja(horaActual, datosMalla.franjas);\n      if (siguienteFranja) {\n        horaActual = siguienteFranja.hora;\n      } else {\n        break;\n      }\n    }\n  }\n  \n  return franjas;\n}\n\nfunction generarFranjasAntiguas() {\n  if (!citaAntigua) return [];\n  \n  const franjas = [];\n  let horaActual = citaAntigua.horaInicio;\n  let horasRestantes = duracionHoras; // Usar la misma duraci칩n\n  \n  while (horasRestantes > 0) {\n    const franjaActual = datosMalla.franjas.find(f => horasIguales(f.hora, horaActual));\n    \n    if (!franjaActual) {\n      console.log(`No se encontr칩 informaci칩n para la franja antigua: ${horaActual}`);\n      break;\n    }\n    \n    const filaBase = calcularFilaExcel(horaActual, datosMalla.franjas);\n    if (!filaBase) {\n      console.log(`No se pudo determinar la fila para la franja antigua: ${horaActual}`);\n      break;\n    }\n\n    franjas.push({\n      hora: horaActual,\n      fila: filaBase,\n      datos: {\n        proveedor: \"\",\n        ordenCompra: \"\",\n        peso: \"\",\n        categoria: \"\",\n        unidades: \"\"\n      }\n    });\n    \n    horasRestantes--;\n    if (horasRestantes > 0) {\n      const siguienteFranja = encontrarSiguienteFranja(horaActual, datosMalla.franjas);\n      if (siguienteFranja) {\n        horaActual = siguienteFranja.hora;\n      } else {\n        break;\n      }\n    }\n  }\n  \n  return franjas;\n}\n\n// --- INICIO DE LA CORRECCI칍N ---\n\n// Nueva funci칩n auxiliar para obtener el d칤a de la semana desde una fecha ISO (YYYY-MM-DD)\nfunction obtenerDiaSemanaDesdeISO(fechaISO) {\n  if (!fechaISO) return null;\n  // Se a침ade T12:00:00Z para evitar problemas de zona horaria al parsear la fecha\n  const fecha = new Date(`${fechaISO}T12:00:00Z`);\n  const diasSemana = [\"domingo\", \"lunes\", \"martes\", \"mi칠rcoles\", \"jueves\", \"viernes\", \"s치bado\"];\n  // getUTCDay() es m치s seguro para evitar desplazamientos de d칤a por zona horaria\n  return diasSemana[fecha.getUTCDay()];\n}\n\n// Funci칩n modificada para aceptar el d칤a de la semana como par치metro\nfunction procesarFranjas(franjas, nombreHoja, diaSemana) {\n  let actualizaciones = [];\n  \n  const muelleKey = muelle.toLowerCase().includes(\"1\") ? \"muelle1\" : \"muelle2\";\n  \n  const mapeoColumnas = {\n    'lunes': { 'muelle1': 'C', 'muelle2': 'F' },\n    'martes': { 'muelle1': 'I', 'muelle2': 'L' },\n    'mi칠rcoles': { 'muelle1': 'O', 'muelle2': 'R' },\n    'jueves': { 'muelle1': 'U', 'muelle2': 'X' },\n    'viernes': { 'muelle1': 'AA', 'muelle2': 'AD' }\n  };\n  \n  if (!mapeoColumnas[diaSemana] || !mapeoColumnas[diaSemana][muelleKey]) {\n    console.log(`No hay mapeo para: d칤a=${diaSemana}, muelle=${muelleKey}`);\n    return [];\n  }\n  \n  const columnaBase = mapeoColumnas[diaSemana][muelleKey];\n  \n  function siguienteColumna(columna) {\n    if (columna.length === 1) {\n      return String.fromCharCode(columna.charCodeAt(0) + 1);\n    } else {\n      const primerChar = columna.charAt(0);\n      const segundoChar = columna.charAt(1);\n      \n      if (segundoChar === 'Z') {\n        return String.fromCharCode(primerChar.charCodeAt(0) + 1) + 'A';\n      } else {\n        return primerChar + String.fromCharCode(segundoChar.charCodeAt(0) + 1);\n      }\n    }\n  }\n  \n  franjas.forEach(franja => {\n    const filaBase = franja.fila;\n    const columnaLineas = siguienteColumna(columnaBase);\n    const columnaUnd = siguienteColumna(columnaLineas);\n    \n    const rangoCeldas = {\n      proveedor: `${columnaBase}${filaBase}`,\n      ordenCompra: `${columnaBase}${filaBase + 1}`,\n      peso: `${columnaBase}${filaBase + 2}`,\n      categoria: `${columnaLineas}${filaBase + 2}`,\n      unidades: `${columnaUnd}${filaBase + 2}`\n    };\n    \n    actualizaciones.push(\n      { celda: rangoCeldas.proveedor, valor: franja.datos.proveedor, nombreHoja },\n      { celda: rangoCeldas.ordenCompra, valor: franja.datos.ordenCompra, nombreHoja },\n      { celda: rangoCeldas.peso, valor: franja.datos.peso, nombreHoja },\n      { celda: rangoCeldas.categoria, valor: franja.datos.categoria, nombreHoja },\n      { celda: rangoCeldas.unidades, valor: franja.datos.unidades, nombreHoja }\n    );\n  });\n  \n  return actualizaciones;\n}\n\n// --- FIN DE LA CORRECCI칍N ---\n\n// Funciones auxiliares (mantener las existentes)\nfunction obtenerDiaSemanaDesdeTexto(fechaStr) {\n  const regex = /(\\d+)\\s+de\\s+(\\w+)\\s+de\\s+(\\d+)/;\n  const match = regex.exec(fechaStr);\n  \n  if (!match) return null;\n  \n  const dia = parseInt(match[1], 10);\n  const mesStr = match[2].toLowerCase();\n  const a침o = parseInt(match[3], 10);\n  \n  const meses = {\n    \"enero\": 0, \"febrero\": 1, \"marzo\": 2, \"abril\": 3, \"mayo\": 4, \"junio\": 5,\n    \"julio\": 6, \"agosto\": 7, \"septiembre\": 8, \"octubre\": 9, \"noviembre\": 10, \"diciembre\": 11\n  };\n  \n  const mesNum = meses[mesStr];\n  if (mesNum === undefined) return null;\n  \n  const fecha = new Date(a침o, mesNum, dia);\n  const diaSemana = fecha.getDay();\n  const diasSemana = [\"domingo\", \"lunes\", \"martes\", \"mi칠rcoles\", \"jueves\", \"viernes\", \"s치bado\"];\n  \n  return diasSemana[diaSemana];\n}\n\nfunction horasIguales(h1, h2) {\n  const normalizar = (h) =>\n    h.toString().trim().toLowerCase().replace(/\\./g, '').replace(/\\s+/g, '').replace(/^0+/, '');\n  return normalizar(h1) === normalizar(h2);\n}\n\nfunction calcularFilaExcel(hora, franjas) {\n  const franjasOrdenadas = [...franjas].sort((a, b) => {\n    function horaAMinutos(hora) {\n      const match = hora.match(/(\\d+):(\\d+)\\s*([AP]M)/i);\n      if (!match) return 0;\n      \n      let horas = parseInt(match[1], 10);\n      const minutos = parseInt(match[2], 10);\n      const periodo = match[3].toUpperCase();\n      \n      if (periodo === 'PM' && horas !== 12) {\n        horas += 12;\n      } else if (periodo === 'AM' && horas === 12) {\n        horas = 0;\n      }\n      \n      return horas * 60 + minutos;\n    }\n    \n    return horaAMinutos(a.hora) - horaAMinutos(b.hora);\n  });\n  \n  const posicion = franjasOrdenadas.findIndex(f => horasIguales(f.hora, hora));\n  \n  if (posicion === -1) {\n    console.log(`No se encontr칩 la posici칩n para la hora ${hora}`);\n    return null;\n  }\n  \n  const FILA_PRIMERA_FRANJA = 12;\n  const INCREMENTO_ESTANDAR = 3;\n  \n  if (posicion === 3) {\n    return 21;\n  } else if (posicion === 4) {\n    return 24;\n  } else if (posicion === 5) {\n    return 27;\n  } else if (posicion < 3) {\n    return FILA_PRIMERA_FRANJA + (posicion * INCREMENTO_ESTANDAR);\n  } else {\n    return 27 + ((posicion - 5) * INCREMENTO_ESTANDAR);\n  }\n}\n\nfunction encontrarSiguienteFranja(horaActual, franjas) {\n  const franjasOrdenadas = [...franjas].sort((a, b) => {\n    function horaAMinutos(hora) {\n      const match = hora.match(/(\\d+):(\\d+)\\s*([AP]M)/i);\n      if (!match) return 0;\n      \n      let horas = parseInt(match[1], 10);\n      const minutos = parseInt(match[2], 10);\n      const periodo = match[3].toUpperCase();\n      \n      if (periodo === 'PM' && horas !== 12) {\n        horas += 12;\n      } else if (periodo === 'AM' && horas === 12) {\n        horas = 0;\n      }\n      \n      return horas * 60 + minutos;\n    }\n    \n    return horaAMinutos(a.hora) - horaAMinutos(b.hora);\n  });\n  \n  const posicionActual = franjasOrdenadas.findIndex(f => horasIguales(f.hora, horaActual));\n  \n  if (posicionActual === -1 || posicionActual >= franjasOrdenadas.length - 1) {\n    return null;\n  }\n  \n  return franjasOrdenadas[posicionActual + 1];\n}\n\n// **EJECUTAR OPTIMIZACI칍N**\nconst resultadoOptimizacion = calcularFranjasOptimizadas();\n\n// --- LLAMADAS CORREGIDAS A procesarFranjas ---\nconst diaSemanaNuevo = obtenerDiaSemanaDesdeTexto(fecha);\nconst diaSemanaAntiguo = citaAntigua ? obtenerDiaSemanaDesdeISO(citaAntigua.fechaFormateada) : null;\n\nconst actualizacionesNuevaCita = procesarFranjas(resultadoOptimizacion.franjasAInsertar, nombreHojaActual, diaSemanaNuevo);\nconst actualizacionesCitaAntigua = citaAntigua ? \n  procesarFranjas(resultadoOptimizacion.franjasAEliminar, citaAntigua.nombreHoja || nombreHojaActual, diaSemanaAntiguo) : [];\n\n// Combinar todas las actualizaciones\nconst todasLasActualizaciones = [...actualizacionesNuevaCita, ...actualizacionesCitaAntigua];\n\n// Preparar el formato final para la petici칩n a Microsoft Graph\nconst actualizacionesGraph = todasLasActualizaciones.map(act => ({\n  address: act.celda,\n  values: [[act.valor]],\n  nombreHoja: act.nombreHoja\n}));\n\n// Preparar el resultado para el siguiente nodo\nreturn {\n  json: {\n    success: true,\n    mensaje: `Preparadas ${todasLasActualizaciones.length} actualizaciones optimizadas para la cita del ${fecha} de ${horaInicio} a ${horaFin} en ${muelle} (${duracionHoras} horas)`,\n    nombreHoja: nombreHojaActual,\n    optimizacion: resultadoOptimizacion,\n    graphRequestData: {\n      updates: actualizacionesGraph\n    },\n    detalles: {\n      actualizacionesDetalladas: todasLasActualizaciones,\n      diaSemana: obtenerDiaSemanaDesdeTexto(fecha),\n      informacionCita: {\n        fecha, horaInicio, horaFin, muelle, proveedor, ordenCompra, peso, categoria, unidades, duracionHoras\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3872,
        4000
      ],
      "id": "415559b8-0713-4503-93ae-5875c3493a6a",
      "name": "Code (Preparar Cuerpo de Petici칩n)1"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo optimizado para \"Code Agrupar Franjas2\"\nconst input = $input.first().json;\n\n// Verificar que tenemos la estructura esperada\nif (!input || !input.graphRequestData || !input.graphRequestData.updates) {\n  console.log('Estructura de datos de entrada no v치lida');\n  return {\n    json: {\n      error: \"FORMATO_INVALIDO\",\n      mensaje: \"La estructura de datos de entrada no es v치lida\"\n    }\n  };\n}\n\nconst updates = input.graphRequestData.updates;\nconst optimizacion = input.optimizacion || {};\n\nconsole.log(`Procesando con optimizaci칩n: ${optimizacion.optimizacionAplicada ? 'S칈' : 'NO'}`);\nif (optimizacion.optimizacionAplicada) {\n  console.log(`Tipo de operaci칩n: ${optimizacion.tipoOperacion}`);\n  console.log(`Estad칤sticas: ${JSON.stringify(optimizacion.estadisticas)}`);\n}\n\n// **NUEVA L칍GICA: Agrupar considerando optimizaci칩n**\nfunction agruparActualizacionesOptimizada() {\n  const actualizacionesInsercion = updates.filter(u => u.values[0][0] !== \"\");\n  const actualizacionesEliminacion = updates.filter(u => u.values[0][0] === \"\");\n  \n  // Si no hay optimizaci칩n, usar la l칩gica original\n  if (!optimizacion.optimizacionAplicada) {\n    return agruparModeLegacy(actualizacionesInsercion, actualizacionesEliminacion);\n  }\n  \n  // **MODO OPTIMIZADO**: Agrupar solo las operaciones necesarias\n  console.log(`Modo optimizado activado:\n    - Inserciones necesarias: ${actualizacionesInsercion.length}\n    - Eliminaciones necesarias: ${actualizacionesEliminacion.length}\n    - Operaciones evitadas: ${optimizacion.estadisticas?.operacionesEvitadas || 0}`);\n  \n  const resultados = [];\n  const maxOperaciones = Math.max(actualizacionesInsercion.length, actualizacionesEliminacion.length);\n  \n  for (let i = 0; i < maxOperaciones; i++) {\n    const insercion = i < actualizacionesInsercion.length ? actualizacionesInsercion[i] : null;\n    const eliminacion = i < actualizacionesEliminacion.length ? actualizacionesEliminacion[i] : null;\n    \n    const parActualizaciones = {\n      json: {\n        insercion: insercion ? {\n          address: insercion.address,\n          values: insercion.values,\n          nombreHoja: insercion.nombreHoja || input.nombreHoja\n        } : null,\n        eliminacion: eliminacion ? {\n          address: eliminacion.address,\n          values: eliminacion.values,\n          nombreHoja: eliminacion.nombreHoja || input.nombreHoja\n        } : null,\n        indice: i + 1,\n        informacionCita: input.detalles?.informacionCita,\n        optimizacion: {\n          aplicada: true,\n          tipo: optimizacion.tipoOperacion,\n          estadisticas: optimizacion.estadisticas\n        }\n      }\n    };\n    \n    resultados.push(parActualizaciones);\n  }\n  \n  return resultados;\n}\n\nfunction agruparModeLegacy(actualizacionesInsercion, actualizacionesEliminacion) {\n  console.log('Usando modo legacy - sin optimizaci칩n');\n  \n  const resultados = [];\n  const maxOperaciones = Math.max(actualizacionesInsercion.length, actualizacionesEliminacion.length);\n  \n  for (let i = 0; i < maxOperaciones; i++) {\n    const insercion = i < actualizacionesInsercion.length ? actualizacionesInsercion[i] : null;\n    const eliminacion = i < actualizacionesEliminacion.length ? actualizacionesEliminacion[i] : null;\n    \n    const parActualizaciones = {\n      json: {\n        insercion: insercion ? {\n          address: insercion.address,\n          values: insercion.values,\n          nombreHoja: insercion.nombreHoja || input.nombreHoja\n        } : null,\n        eliminacion: eliminacion ? {\n          address: eliminacion.address,\n          values: eliminacion.values,\n          nombreHoja: eliminacion.nombreHoja || input.nombreHoja\n        } : null,\n        indice: i + 1,\n        informacionCita: input.detalles?.informacionCita,\n        optimizacion: {\n          aplicada: false,\n          tipo: optimizacion.tipoOperacion || 'legacy',\n          estadisticas: { operacionesEvitadas: 0, eficiencia: '0%' }\n        }\n      }\n    };\n    \n    resultados.push(parActualizaciones);\n  }\n  \n  return resultados;\n}\n\n// Ejecutar agrupaci칩n\nconst resultados = agruparActualizacionesOptimizada();\n\nconsole.log(`Se crearon ${resultados.length} pares de actualizaciones`);\n\nreturn resultados;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4080,
        4000
      ],
      "id": "fd5f4b60-5c81-410d-8595-7e1e24bbff9a",
      "name": "Code Agrupar Franjas2"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4368,
        4000
      ],
      "id": "3100eb2f-ea6c-449d-82d4-dfe1dbec770b",
      "name": "Loop Over Uno a Uno1"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo optimizado para \"Code Preparar cada Insercion1\"\nconst input = $input.first().json;\n\n// Constantes para los IDs de SharePoint/OneDrive\nconst siteId = \"gexpresscargo.sharepoint.com,a592f886-4560-4e62-9646-1eee7add7abe,8b514073-41ae-4619-8f76-724bd912bc65\";\nconst driveId = \"b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8\";\nconst itemId = \"01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME\";\n\n// Verificar que tenemos la estructura esperada\nif (!input || (!input.insercion && !input.eliminacion)) {\n  console.log('Estructura de datos de entrada no v치lida para las operaciones');\n  return {\n    json: {\n      error: \"FORMATO_INVALIDO\",\n      mensaje: \"La estructura de datos de entrada no es v치lida para las operaciones combinadas\"\n    }\n  };\n}\n\nconst optimizacion = input.optimizacion || { aplicada: false };\nconst indice = input.indice;\nconst informacionCita = input.informacionCita || {};\n\n// **NUEVA L칍GICA: Preparar solicitudes considerando optimizaci칩n**\nfunction prepararSolicitudOptimizada() {\n  const solicitudes = [];\n  \n  // Log de optimizaci칩n\n  if (optimizacion.aplicada) {\n    console.log(`Preparando solicitud optimizada - Tipo: ${optimizacion.tipo}`);\n    console.log(`Estad칤sticas de optimizaci칩n: ${JSON.stringify(optimizacion.estadisticas)}`);\n  } else {\n    console.log('Preparando solicitud en modo legacy');\n  }\n  \n  // Preparar solicitud de inserci칩n si existe\n  if (input.insercion && input.insercion.address && input.insercion.values) {\n    const requestIdInsercion = `insercion_${input.insercion.address}_${indice}_${Date.now()}`;\n    const nombreHojaInsercion = input.insercion.nombreHoja;\n    \n    if (!nombreHojaInsercion) {\n      console.log('Nombre de hoja faltante para inserci칩n');\n      return {\n        json: {\n          error: \"HOJA_NO_ESPECIFICADA\",\n          mensaje: \"No se especific칩 el nombre de la hoja para la inserci칩n\"\n        }\n      };\n    }\n    \n    solicitudes.push({\n      id: requestIdInsercion,\n      method: \"PATCH\",\n      url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(nombreHojaInsercion)}/range(address='${input.insercion.address}')`,\n      body: {\n        values: input.insercion.values\n      },\n      headers: {\n        \"Content-Type\": \"application/json\"\n      }\n    });\n    \n    console.log(`Solicitud de inserci칩n: \"${input.insercion.values[0][0]}\" en celda ${input.insercion.address} de hoja \"${nombreHojaInsercion}\"`);\n  }\n  \n  // Preparar solicitud de eliminaci칩n si existe\n  if (input.eliminacion && input.eliminacion.address && input.eliminacion.values) {\n    const requestIdEliminacion = `eliminacion_${input.eliminacion.address}_${indice}_${Date.now()}`;\n    const nombreHojaEliminacion = input.eliminacion.nombreHoja;\n    \n    if (!nombreHojaEliminacion) {\n      console.log('Nombre de hoja faltante para eliminaci칩n');\n      return {\n        json: {\n          error: \"HOJA_NO_ESPECIFICADA\",\n          mensaje: \"No se especific칩 el nombre de la hoja para la eliminaci칩n\"\n        }\n      };\n    }\n    \n    solicitudes.push({\n      id: requestIdEliminacion,\n      method: \"PATCH\",\n      url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(nombreHojaEliminacion)}/range(address='${input.eliminacion.address}')`,\n      body: {\n        values: input.eliminacion.values\n      },\n      headers: {\n        \"Content-Type\": \"application/json\"\n      }\n    });\n    \n    console.log(`Solicitud de eliminaci칩n: limpiar celda ${input.eliminacion.address} en hoja \"${nombreHojaEliminacion}\"`);\n  }\n  \n  // **VALIDACI칍N DE OPTIMIZACI칍N**: Verificar que no estamos procesando franjas innecesarias\n  if (optimizacion.aplicada && optimizacion.tipo === \"mismo_dia_optimizado\") {\n    // En este caso, deber칤amos tener menos solicitudes que en el modo legacy\n    console.log(`Optimizaci칩n aplicada: procesando ${solicitudes.length} solicitudes en lugar de las operaciones completas`);\n  }\n  \n  return {\n    requests: solicitudes,\n    _metadata: {\n      indice: indice,\n      optimizacion: optimizacion,\n      operaciones: {\n        insercion: input.insercion ? {\n          celda: input.insercion.address,\n          valor: input.insercion.values[0][0],\n          hoja: input.insercion.nombreHoja\n        } : null,\n        eliminacion: input.eliminacion ? {\n          celda: input.eliminacion.address,\n          valor: \"\",\n          hoja: input.eliminacion.nombreHoja\n        } : null\n      },\n      informacionCita: informacionCita\n    }\n  };\n}\n\n// Verificar si alguna operaci칩n es realmente necesaria\nif (!input.insercion && !input.eliminacion) {\n  console.log('No hay operaciones que procesar - posible optimizaci칩n completa');\n  return {\n    json: {\n      requests: [],\n      _metadata: {\n        indice: indice,\n        optimizacion: { ...optimizacion, operacionCompleta: true },\n        mensaje: \"No se requieren operaciones - franjas mantenidas por optimizaci칩n\"\n      }\n    }\n  };\n}\n\n// Preparar y retornar la solicitud\nconst requestBody = prepararSolicitudOptimizada();\n\nconsole.log(`Solicitud preparada con ${requestBody.requests.length} operaciones`);\n\nreturn {\n  json: requestBody\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4640,
        4096
      ],
      "id": "cc75b38b-3cef-4678-bbf4-67d0f9533e11",
      "name": "Code Preparar cada Insercion1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.microsoft.com/v1.0/$batch",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4896,
        4096
      ],
      "id": "8ee44a7b-53c4-492e-bbb9-e9f8aabb79c7",
      "name": "HTTP Request Actualizar Excel",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// C칩digo actualizado para verificar tanto la inserci칩n como la eliminaci칩n\nconst input = $input.first().json;\n\n// Verificar que tenemos la estructura esperada en la respuesta\nif (!input || !input.responses || !Array.isArray(input.responses) || input.responses.length === 0) {\n  console.log('Estructura de datos de respuesta no v치lida');\n  return {\n    json: {\n      error: \"RESPUESTA_INVALIDA\",\n      mensaje: \"La estructura de datos de la respuesta no es v치lida\",\n      exito: false\n    }\n  };\n}\n\n// Buscar las respuestas de inserci칩n y eliminaci칩n\nconst respuestaInsercion = input.responses.find(r => r.id && r.id.includes('insercion_'));\nconst respuestaEliminacion = input.responses.find(r => r.id && r.id.includes('eliminacion_'));\n\n// Verificar si encontramos ambas respuestas\nif (!respuestaInsercion || !respuestaEliminacion) {\n  console.log('No se encontraron respuestas para inserci칩n y/o eliminaci칩n');\n  return {\n    json: {\n      error: \"RESPUESTAS_INCOMPLETAS\",\n      mensaje: \"No se encontraron respuestas para inserci칩n y/o eliminaci칩n\",\n      exito: false,\n      respuestasDisponibles: input.responses.map(r => r.id)\n    }\n  };\n}\n\n// Extraer informaci칩n de las respuestas\nfunction extraerInfoCelda(respuesta) {\n  // Extraer informaci칩n del ID\n  const idPartes = respuesta.id.split('_');\n  const tipoOperacion = idPartes[0]; // \"insercion\" o \"eliminacion\"\n  const celda = idPartes[1];         // Por ejemplo \"I21\"\n  \n  // Extraer informaci칩n de direcci칩n de la respuesta\n  let direccionRespuesta = \"\";\n  let hoja = \"\";\n  \n  if (respuesta.body && respuesta.body.address) {\n    // Formato t칤pico: 'SEMANA 21'!I21\n    const direccionCompleta = respuesta.body.address;\n    const partesDireccion = direccionCompleta.split('!');\n    \n    if (partesDireccion.length > 1) {\n      // Eliminar comillas simples y extraer el nombre de la hoja\n      hoja = partesDireccion[0].replace(/'/g, '');\n      direccionRespuesta = partesDireccion[1];\n    }\n  }\n  \n  // Obtener el valor de la celda\n  const valor = respuesta.body && respuesta.body.values && \n                respuesta.body.values[0] && respuesta.body.values[0][0] !== undefined ? \n                respuesta.body.values[0][0] : null;\n  \n  // Verificar el c칩digo de estado HTTP\n  const estadoExitoso = respuesta.status >= 200 && respuesta.status < 300;\n  \n  return {\n    id: respuesta.id,\n    tipoOperacion,\n    celda,\n    direccionRespuesta,\n    hoja,\n    valor,\n    estadoExitoso,\n    statusCode: respuesta.status\n  };\n}\n\n// Procesar ambas respuestas\nconst infoInsercion = extraerInfoCelda(respuestaInsercion);\nconst infoEliminacion = extraerInfoCelda(respuestaEliminacion);\n\n// Determinar 칠xito global\nconst exitoGlobal = infoInsercion.estadoExitoso && infoEliminacion.estadoExitoso;\n\n// Crear resultado detallado\nconst resultado = {\n  exito: exitoGlobal,\n  operaciones: {\n    insercion: {\n      exito: infoInsercion.estadoExitoso,\n      celda: infoInsercion.celda,\n      celdaRespuesta: infoInsercion.direccionRespuesta,\n      hoja: infoInsercion.hoja,\n      valor: infoInsercion.valor,\n      statusCode: infoInsercion.statusCode\n    },\n    eliminacion: {\n      exito: infoEliminacion.estadoExitoso,\n      celda: infoEliminacion.celda,\n      celdaRespuesta: infoEliminacion.direccionRespuesta,\n      hoja: infoEliminacion.hoja,\n      valor: infoEliminacion.valor,\n      statusCode: infoEliminacion.statusCode\n    }\n  },\n  mensaje: exitoGlobal ? \n    `Operaciones completadas exitosamente - Inserci칩n en ${infoInsercion.hoja} y eliminaci칩n en ${infoEliminacion.hoja}` :\n    `Hubo problemas con una o ambas operaciones`,\n  respuestasOriginales: {\n    insercion: respuestaInsercion,\n    eliminacion: respuestaEliminacion\n  }\n};\n\n// Mantener compatibilidad con el formato antiguo para no romper flujos subsiguientes\nconst resultadoCompatible = {\n  exito: exitoGlobal,\n  celdaOriginal: infoInsercion.tipoOperacion,\n  celdaInsertada: infoInsercion.celda,\n  valorInsertado: infoInsercion.valor,\n  statusCode: infoInsercion.statusCode,\n  requestId: infoInsercion.id,\n  indice: infoInsercion.celda,\n  celdasDiferentes: false, // Ya no es relevante con la nueva estructura\n  falloEstado: !exitoGlobal,\n  respuestaOriginal: respuestaInsercion,\n  // Nuevos campos para la versi칩n mejorada\n  resultadoDetallado: resultado\n};\n\n// Obtener chat_id si existe\nconst chatId = $('Organiza el Mensaje').first()?.json?.infoMensaje?.chat_id;\n\n// Registrar resultado en consola\nif (exitoGlobal) {\n  console.log(`Operaciones completadas exitosamente:`);\n  console.log(`- Inserci칩n en hoja ${infoInsercion.hoja}, celda ${infoInsercion.celda}, valor: \"${infoInsercion.valor}\"`);\n  console.log(`- Eliminaci칩n en hoja ${infoEliminacion.hoja}, celda ${infoEliminacion.celda}`);\n} else {\n  console.log(`Hubo problemas con una o ambas operaciones:`);\n  if (!infoInsercion.estadoExitoso) {\n    console.log(`- Fallo en inserci칩n: status ${infoInsercion.statusCode}`);\n  }\n  if (!infoEliminacion.estadoExitoso) {\n    console.log(`- Fallo en eliminaci칩n: status ${infoEliminacion.statusCode}`);\n  }\n}\n\n// Retornar el resultado\nreturn {\n  json: resultadoCompatible,\n  chat_id: chatId\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5120,
        4096
      ],
      "id": "9536f3db-bae4-4abc-87b2-e9dc6c38c154",
      "name": "Code Verificar Inserci칩n1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fb1eda05-eb5e-4683-8556-1cf2b5b8e4d5",
              "leftValue": "={{ $json.exito }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5360,
        4160
      ],
      "id": "c29a148a-171d-4390-8da8-ba6afa8eafb2",
      "name": "If Verificar Inserci칩n1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "15a95144-dd82-4ea5-b9ba-9eb924d2ae5c",
              "leftValue": "={{ $json.celdasDiferentes }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5568,
        4240
      ],
      "id": "6f54c190-b850-4d69-af75-d6a65cad1341",
      "name": "If Diferente Caso1"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para limpiar una celda donde se insert칩 incorrectamente un valor\n// Actualizado para manejar la nueva estructura con operaciones de inserci칩n y eliminaci칩n\nconst input = $input.first().json;\n\n// Constantes para los IDs de SharePoint/OneDrive\nconst siteId = \"gexpresscargo.sharepoint.com,a592f886-4560-4e62-9646-1eee7add7abe,8b514073-41ae-4619-8f76-724bd912bc65\";\nconst driveId = \"b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8\";\nconst itemId = \"01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME\";\n\n// Verificar que tenemos la informaci칩n necesaria\nif (!input || (!input.operaciones && !input.celdaInsertada)) {\n  console.log('Informaci칩n insuficiente para limpiar la celda incorrecta');\n  return {\n    json: {\n      error: \"INFORMACION_INSUFICIENTE\",\n      mensaje: \"No hay suficiente informaci칩n para limpiar la celda incorrecta\"\n    }\n  };\n}\n\n// Determinar qu칠 celdas necesitan limpieza\nconst celdasALimpiar = [];\n\n// Verificar si estamos usando la nueva estructura con operaciones\nif (input.operaciones) {\n  // Nueva estructura: usar informaci칩n de las operaciones\n  const { insercion, eliminacion } = input.operaciones;\n  \n  // Si la inserci칩n fall칩, agregarla para limpieza\n  if (insercion && !insercion.exito && insercion.celdaRespuesta) {\n    celdasALimpiar.push({\n      celda: insercion.celdaRespuesta,\n      hoja: insercion.hoja || \"\"\n    });\n  }\n  \n  // Si la eliminaci칩n fall칩, agregarla para limpieza\n  if (eliminacion && !eliminacion.exito && eliminacion.celdaRespuesta) {\n    celdasALimpiar.push({\n      celda: eliminacion.celdaRespuesta,\n      hoja: eliminacion.hoja || \"\"\n    });\n  }\n} else {\n  // Estructura anterior: solo tenemos informaci칩n de inserci칩n\n  // Obtener la celda a limpiar y la informaci칩n de la hoja\n  const celdaALimpiar = input.celdaInsertada;\n  let hojaExcel = input.nombreHoja || \"\"; // Usar el nombreHoja del input\n  \n  // Intentar extraer el nombre de la hoja de la direcci칩n en la respuesta si no est치 disponible\n  if ((!hojaExcel || hojaExcel === \"\") && input.respuestaOriginal?.body?.address) {\n    const direccionCompleta = input.respuestaOriginal.body.address;\n    hojaExcel = direccionCompleta.split('!')[0].replace(/'/g, '');\n  }\n  \n  celdasALimpiar.push({\n    celda: celdaALimpiar,\n    hoja: hojaExcel\n  });\n}\n\n// Si no hay celdas para limpiar, devolver error\nif (celdasALimpiar.length === 0) {\n  console.log('No se identificaron celdas para limpiar');\n  return {\n    json: {\n      error: \"NO_HAY_CELDAS\",\n      mensaje: \"No se identificaron celdas que necesiten limpieza\",\n      input: input\n    }\n  };\n}\n\n// Crear solicitudes para limpiar cada celda identificada\nconst solicitudes = celdasALimpiar.map((info, index) => {\n  console.log(`Limpiando celda incorrecta ${info.celda} en hoja ${info.hoja}`);\n  \n  return {\n    id: `Limpiar_${info.celda}_${Date.now()}_${index}`,\n    method: \"PATCH\",\n    url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(info.hoja)}/range(address='${info.celda}')`,\n    body: {\n      values: [[\"\"]] // Valor vac칤o para limpiar la celda\n    },\n    headers: {\n      \"Content-Type\": \"application/json\"\n    }\n  };\n});\n\n// Crear la solicitud para limpiar las celdas\nconst requestBody = {\n  requests: solicitudes,\n  _metadata: {\n    accion: \"limpiar\",\n    celdasLimpiadas: celdasALimpiar,\n    datoOriginal: input\n  }\n};\n\n// Retornar el request para limpiar la celda\nreturn {\n  json: requestBody\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5872,
        4064
      ],
      "id": "e02e12a1-d5ae-434d-93ee-0bdced3c17a7",
      "name": "Code Limpiar Celda Incorrecta1",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.microsoft.com/v1.0/$batch",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6096,
        4064
      ],
      "id": "d113e05b-22fa-4198-87e3-8037a6506e03",
      "name": "HTTP Request Limpiar Celda1",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e570827e-13d0-4d6f-b23e-184ca2d3368c",
              "leftValue": "={{ $json.falloEstado }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6032,
        4448
      ],
      "id": "bdd4d029-2c3b-4add-9152-988fe6fa1923",
      "name": "If fallo Estado1"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para reintentar la inserci칩n en la celda correcta\n// Actualizado para manejar la nueva estructura con operaciones de inserci칩n y eliminaci칩n\nconst input = $input.first().json;\n\n// Constantes para los IDs de SharePoint/OneDrive\nconst siteId = \"gexpresscargo.sharepoint.com,a592f886-4560-4e62-9646-1eee7add7abe,8b514073-41ae-4619-8f76-724bd912bc65\";\nconst driveId = \"b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8\";\nconst itemId = \"01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME\";\n\n// Si el input viene del nodo anterior de limpiar celda, extraer el dato original\nconst datoOriginal = input._metadata?.datoOriginal || input;\n\n// Verificar que tenemos la informaci칩n necesaria\nif (!datoOriginal) {\n  console.log('Informaci칩n insuficiente para reintentar la inserci칩n/eliminaci칩n');\n  return {\n    json: {\n      error: \"INFORMACION_INSUFICIENTE\",\n      mensaje: \"No hay suficiente informaci칩n para reintentar las operaciones\"\n    }\n  };\n}\n\n// Operaciones a reintentar\nconst operacionesAReintentar = [];\n\n// Determinar qu칠 operaciones necesitan reintento\nif (datoOriginal.operaciones) {\n  // Nueva estructura: evaluar inserci칩n y eliminaci칩n\n  const { insercion, eliminacion } = datoOriginal.operaciones;\n  \n  // Verificar si la inserci칩n necesita reintento\n  if (insercion && !insercion.exito) {\n    operacionesAReintentar.push({\n      tipo: \"insercion\",\n      celda: insercion.celda,\n      valor: insercion.valor,\n      hoja: insercion.hoja || datoOriginal.resultadoDetallado?.operaciones?.insercion?.hoja || \"\"\n    });\n  }\n  \n  // Verificar si la eliminaci칩n necesita reintento\n  if (eliminacion && !eliminacion.exito) {\n    operacionesAReintentar.push({\n      tipo: \"eliminacion\",\n      celda: eliminacion.celda,\n      valor: \"\", // Para eliminaci칩n, siempre usamos valor vac칤o\n      hoja: eliminacion.hoja || datoOriginal.resultadoDetallado?.operaciones?.eliminacion?.hoja || \"\"\n    });\n  }\n} else {\n  // Estructura anterior: solo tenemos informaci칩n de inserci칩n\n  // Obtener la celda correcta donde insertar y el valor a insertar\n  const celdaCorrecta = datoOriginal.celdaOriginal;\n  \n  // Intentar obtener el valor correcto a insertar\n  let valorAInsertar;\n  \n  // Primero, verificar si tenemos el valor de la respuesta original\n  if (datoOriginal.valorInsertado !== undefined) {\n    valorAInsertar = datoOriginal.valorInsertado;\n  } \n  // Si no, intentar obtenerlo del body de la respuesta\n  else if (datoOriginal.respuestaOriginal?.body?.values?.[0]?.[0] !== undefined) {\n    valorAInsertar = datoOriginal.respuestaOriginal.body.values[0][0];\n  } \n  // Como 칰ltimo recurso, usar un valor vac칤o\n  else {\n    valorAInsertar = \"\";\n    console.log('No se pudo determinar el valor a insertar, usando valor vac칤o');\n  }\n  \n  // Obtener la hoja de Excel - primero del dato original\n  let hojaExcel = datoOriginal.nombreHoja || \"\"; \n  \n  // Si no est치 disponible en el objeto principal, intentar obtenerlo de otros lugares\n  if (!hojaExcel || hojaExcel === \"\") {\n    // Verificar si est치 en el _metadata\n    hojaExcel = input._metadata?.hoja || \"\";\n    \n    // Como 칰ltimo recurso, extraer de la direcci칩n en la respuesta\n    if ((!hojaExcel || hojaExcel === \"\") && datoOriginal.respuestaOriginal?.body?.address) {\n      const direccionCompleta = datoOriginal.respuestaOriginal.body.address;\n      hojaExcel = direccionCompleta.split('!')[0].replace(/'/g, '');\n    }\n  }\n  \n  operacionesAReintentar.push({\n    tipo: \"insercion\",\n    celda: celdaCorrecta,\n    valor: valorAInsertar,\n    hoja: hojaExcel\n  });\n}\n\n// Si no hay operaciones para reintentar, devolver error\nif (operacionesAReintentar.length === 0) {\n  console.log('No se identificaron operaciones para reintentar');\n  return {\n    json: {\n      error: \"NO_HAY_OPERACIONES\",\n      mensaje: \"No se identificaron operaciones que necesiten reintento\",\n      input: datoOriginal\n    }\n  };\n}\n\n// Crear solicitudes para cada operaci칩n a reintentar\nconst solicitudes = operacionesAReintentar.map((op, index) => {\n  // Determinar el tipo de valor y formatearlo adecuadamente\n  let valorFormateado;\n  if (typeof op.valor === 'number') {\n    valorFormateado = [[op.valor]]; // Mantener el tipo num칠rico\n  } else {\n    valorFormateado = [[op.valor.toString()]]; // Convertir a string para otros tipos\n  }\n  \n  console.log(`Reintentando ${op.tipo} en celda ${op.celda} de la hoja ${op.hoja} con valor \"${op.valor}\"`);\n  \n  return {\n    id: `Reintento_${op.tipo}_${op.celda}_${Date.now()}_${index}`,\n    method: \"PATCH\",\n    url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(op.hoja)}/range(address='${op.celda}')`,\n    body: {\n      values: valorFormateado\n    },\n    headers: {\n      \"Content-Type\": \"application/json\"\n    }\n  };\n});\n\n// Crear la solicitud para reintentar las operaciones\nconst requestBody = {\n  requests: solicitudes,\n  _metadata: {\n    accion: \"reintentar\",\n    operaciones: operacionesAReintentar,\n    datoOriginal: datoOriginal,\n    intentos: (datoOriginal._metadata?.intentos || 0) + 1\n  }\n};\n\n// Retornar el request para reintentar las operaciones\nreturn {\n  json: requestBody\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6368,
        4128
      ],
      "id": "5426c3b0-05ad-4965-8214-ad97528b130a",
      "name": "Code Reintentar Inserci칩n1",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.microsoft.com/v1.0/$batch",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6608,
        4240
      ],
      "id": "b8ba4a9b-c780-4557-b6e9-37952d05d50f",
      "name": "HTTP Request Reintentar Inserci칩n1",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para verificar si la inserci칩n y eliminaci칩n fueron exitosas\n// Actualizado para manejar la nueva estructura\nconst input = $input.first().json;\n\n// Verificar que tenemos la estructura esperada en la respuesta\nif (!input || !input.responses || !Array.isArray(input.responses)) {\n  console.log('Estructura de datos de respuesta no v치lida');\n  return {\n    json: {\n      error: \"RESPUESTA_INVALIDA\",\n      mensaje: \"La estructura de datos de la respuesta no es v치lida\",\n      exito: false\n    }\n  };\n}\n\n// Si no hay respuestas, devolver error\nif (input.responses.length === 0) {\n  console.log('No se recibieron respuestas del servidor');\n  return {\n    json: {\n      error: \"SIN_RESPUESTAS\",\n      mensaje: \"No se recibieron respuestas del servidor\",\n      exito: false\n    }\n  };\n}\n\n// Analizar las respuestas para determinar a qu칠 operaci칩n corresponde cada una\nconst respuestas = input.responses.map(response => {\n  // Extraer informaci칩n del ID de la respuesta\n  const idPartes = response.id.split('_');\n  const tipoOperacion = idPartes[0].toLowerCase(); // \"reintento\", \"limpiar\", etc.\n  const tipoEntidad = idPartes[1]?.toLowerCase(); // \"insercion\", \"eliminacion\", etc.\n  const celda = idPartes[2] || \"\"; // La celda como I21, K23, etc.\n  \n  // Extraer informaci칩n de la direcci칩n en la respuesta\n  let direccionRespuesta = \"\";\n  let hojaExcel = \"\";\n  \n  if (response.body && response.body.address) {\n    const direccionCompleta = response.body.address;\n    const partesDireccion = direccionCompleta.split('!');\n    \n    if (partesDireccion.length > 1) {\n      // Quitar las comillas simples del nombre de la hoja\n      hojaExcel = partesDireccion[0].replace(/'/g, '');\n      direccionRespuesta = partesDireccion[1];\n    }\n  }\n  \n  // Obtener el valor de la respuesta\n  const valor = response.body?.values?.[0]?.[0];\n  \n  // Verificar si la operaci칩n fue exitosa (c칩digo 200-299)\n  const estadoExitoso = response.status >= 200 && response.status < 300;\n  \n  // Verificar si la celda en la respuesta coincide con la esperada\n  const celdaCorrecta = direccionRespuesta === celda;\n  \n  return {\n    id: response.id,\n    tipoOperacion,\n    tipoEntidad,\n    celda,\n    direccionRespuesta,\n    hoja: hojaExcel,\n    valor,\n    estadoExitoso,\n    celdaCorrecta,\n    statusCode: response.status,\n    respuesta: response\n  };\n});\n\n// Separar las respuestas por tipo de operaci칩n\nconst respuestasInsercion = respuestas.filter(r => \n  r.tipoEntidad === \"insercion\" || \n  (r.tipoOperacion === \"reintento\" && input._metadata?.operaciones?.[0]?.tipo === \"insercion\")\n);\n\nconst respuestasEliminacion = respuestas.filter(r => \n  r.tipoEntidad === \"eliminacion\" || \n  (r.tipoOperacion === \"reintento\" && input._metadata?.operaciones?.[0]?.tipo === \"eliminacion\")\n);\n\n// Determinar 칠xito por tipo de operaci칩n\nconst insercionExitosa = respuestasInsercion.length > 0 && \n                        respuestasInsercion.every(r => r.estadoExitoso && r.celdaCorrecta);\n\nconst eliminacionExitosa = respuestasEliminacion.length > 0 && \n                          respuestasEliminacion.every(r => r.estadoExitoso && r.celdaCorrecta);\n\n// Determinar 칠xito global basado en las operaciones presentes\nlet exitoGlobal;\n\nif (respuestasInsercion.length > 0 && respuestasEliminacion.length > 0) {\n  // Si hay ambas operaciones, ambas deben ser exitosas\n  exitoGlobal = insercionExitosa && eliminacionExitosa;\n} else if (respuestasInsercion.length > 0) {\n  // Si solo hay inserci칩n, solo esa debe ser exitosa\n  exitoGlobal = insercionExitosa;\n} else if (respuestasEliminacion.length > 0) {\n  // Si solo hay eliminaci칩n, solo esa debe ser exitosa\n  exitoGlobal = eliminacionExitosa;\n} else {\n  // Si no hay operaciones identificables, considerar como no exitoso\n  exitoGlobal = false;\n}\n\n// Obtener la informaci칩n m치s relevante para cada tipo de operaci칩n\nconst infoInsercion = respuestasInsercion.length > 0 ? respuestasInsercion[0] : null;\nconst infoEliminacion = respuestasEliminacion.length > 0 ? respuestasEliminacion[0] : null;\n\n// Crear el resultado detallado\nconst resultadoDetallado = {\n  exito: exitoGlobal,\n  operaciones: {\n    insercion: infoInsercion ? {\n      exito: infoInsercion.estadoExitoso && infoInsercion.celdaCorrecta,\n      celda: infoInsercion.celda,\n      direccionRespuesta: infoInsercion.direccionRespuesta,\n      hoja: infoInsercion.hoja,\n      valor: infoInsercion.valor,\n      statusCode: infoInsercion.statusCode\n    } : null,\n    eliminacion: infoEliminacion ? {\n      exito: infoEliminacion.estadoExitoso && infoEliminacion.celdaCorrecta,\n      celda: infoEliminacion.celda,\n      direccionRespuesta: infoEliminacion.direccionRespuesta,\n      hoja: infoEliminacion.hoja,\n      valor: infoEliminacion.valor,\n      statusCode: infoEliminacion.statusCode\n    } : null\n  },\n  mensaje: exitoGlobal ? \n    \"Todas las operaciones se completaron exitosamente\" : \n    \"Hubo problemas con una o m치s operaciones\",\n  respuestasCompletas: respuestas\n};\n\n// Crear el resultado compatible con el formato anterior\nconst resultadoCompatible = {\n  exito: exitoGlobal,\n  // Usar la primera respuesta para compatibilidad\n  celdaOriginal: infoInsercion?.celda || infoEliminacion?.celda || \"\",\n  celdaInsertada: infoInsercion?.direccionRespuesta || infoEliminacion?.direccionRespuesta || \"\",\n  valorInsertado: infoInsercion?.valor || infoEliminacion?.valor || \"\",\n  statusCode: infoInsercion?.statusCode || infoEliminacion?.statusCode || 0,\n  requestId: infoInsercion?.id || infoEliminacion?.id || \"\",\n  indice: infoInsercion?.celda || infoEliminacion?.celda || \"\",\n  celdasDiferentes: (infoInsercion && infoInsercion.celda !== infoInsercion.direccionRespuesta) ||\n                   (infoEliminacion && infoEliminacion.celda !== infoEliminacion.direccionRespuesta),\n  falloEstado: !exitoGlobal,\n  // Informaci칩n adicional para la versi칩n mejorada\n  resultadoDetallado: resultadoDetallado\n};\n\n// Registrar el resultado en consola\nif (exitoGlobal) {\n  console.log(\"Operaciones completadas exitosamente:\");\n  if (infoInsercion) {\n    console.log(`- Inserci칩n en hoja ${infoInsercion.hoja}, celda ${infoInsercion.celda}, valor: \"${infoInsercion.valor}\"`);\n  }\n  if (infoEliminacion) {\n    console.log(`- Eliminaci칩n en hoja ${infoEliminacion.hoja}, celda ${infoEliminacion.celda}`);\n  }\n} else {\n  console.log(\"Problemas detectados en las operaciones:\");\n  if (infoInsercion && (!infoInsercion.estadoExitoso || !infoInsercion.celdaCorrecta)) {\n    console.log(`- Fallo en inserci칩n: celda=${infoInsercion.celda}, direcci칩n respuesta=${infoInsercion.direccionRespuesta}, status=${infoInsercion.statusCode}`);\n  }\n  if (infoEliminacion && (!infoEliminacion.estadoExitoso || !infoEliminacion.celdaCorrecta)) {\n    console.log(`- Fallo en eliminaci칩n: celda=${infoEliminacion.celda}, direcci칩n respuesta=${infoEliminacion.direccionRespuesta}, status=${infoEliminacion.statusCode}`);\n  }\n}\n\n// Retornar el resultado\nreturn {\n  json: resultadoCompatible\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6832,
        4240
      ],
      "id": "470fc71a-bb5d-4428-8281-ffee2fb9e703",
      "name": "Code Volver a validar Inserci칩n1",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f7205e4e-147c-4e77-8fa8-08d082980b48",
              "leftValue": "={{ $json.exito }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7056,
        4240
      ],
      "id": "a05c1da9-fd80-4e7e-ac95-d2913b7c23d5",
      "name": "If Verificar Inserci칩n "
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        5952,
        4240
      ],
      "id": "2c9895ff-1e90-44d5-8d13-a9f6d9566c03",
      "name": "Wait4",
      "webhookId": "a4bbf2b1-ea0c-4b02-af2c-64b29f2bdb5c"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        7360,
        4416
      ],
      "id": "905de989-347f-40e1-ab9f-8a59e4417ce7",
      "name": "Wait5",
      "webhookId": "9d944db7-9c4f-439e-9990-d9937f2fb18e"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        7792,
        4784
      ],
      "id": "ec0835ef-a04d-41ba-ae4e-367444b40fff",
      "name": "OpenAI Chat Model15",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=Eres un asistente de un sistema de agendamiento de citas para la entrega de mercanc칤a en bodega. Debes notificar al cliente que ha ocurrido un error en el sistema durante el proceso de inserci칩n de la cita.\n\nGenera un mensaje directo aplicando estos principios de UX para WhatsApp:\n\n**FORMATO Y ESTRUCTURA:**\n1. Usa *negritas* para informaci칩n cr칤tica como tiempo l칤mite y acciones urgentes\n2. Usa emojis estrat칠gicos: 游뚿 (urgente), 丘멆잺 (error), 낋 (tiempo l칤mite), 游 (contacto), 游멆잺 (t칠cnico)\n3. Estructura la informaci칩n de forma jer치rquica y visual\n4. Destaca el tiempo l칤mite de *5 minutos* con formato apropiado\n\n**CONTENIDO REQUERIDO:**\n1. 游뚿 Comunica claramente que ocurri칩 un *error t칠cnico* al registrar la cita\n2. 낋 Indica urgentemente que se comunique con el 치rea de bodega en los pr칩ximos *5 minutos*\n3. 丘멆잺 Menciona el riesgo de *perder la franja horaria* por alta demanda de muelles\n4. 游멆잺 Aclara que es una situaci칩n *poco com칰n* por inconveniente t칠cnico\n5. 游똂 Pide disculpas y agradece la comprensi칩n\n\n**TONO:** Urgente pero profesional, enfatizando acci칩n inmediata para mantener la franja horaria.\n\n**EJEMPLO DE ESTRUCTURA ESPERADA:**\n游뚿 *Error t칠cnico en el sistema*\n\n丘멆잺 No pudimos registrar tu cita debido a un *inconveniente t칠cnico* en el sistema.\n\n낋 *URGENTE:* Comun칤cate con el 치rea de bodega en los pr칩ximos *5 minutos* para que puedan agendar tu cita manualmente.\n\n游뚿 Si no estableces contacto en ese tiempo, podr칤as *perder la franja horaria* seleccionada...\n\n游똂 Disculpas por los inconvenientes...\n"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        7872,
        4560
      ],
      "id": "dd31e661-c17c-46c5-8bd2-dc8e2468408a",
      "name": "Basic LLM Notificar No Disponibilidad3",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Basic LLM Notificar No Disponibilidad3').item.json.text.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8272,
        4736
      ],
      "id": "32b40346-3b05-4032-baa6-2f8408f34b25",
      "name": "Validaci칩n de longitud de caracteres10"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad3').item.json.text }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad3').item.json.text.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8576,
        4768
      ],
      "id": "35e1cee8-d687-4492-83b5-f1440b776d51",
      "name": "Organiza variables del mensaje10"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        8752,
        4544
      ],
      "id": "eda276f5-b6d3-41e5-a220-b18f8dbc889e",
      "name": "No Operation, do nothing14"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8576,
        4544
      ],
      "id": "4d767bec-af43-4da7-9040-c77033330f3c",
      "name": "HTTP Request Enviar Mensaje por WhatsApp13"
    },
    {
      "parameters": {
        "jsCode": "/*\n===========================================================\n  Nodo Code - VALIDAR INSERCIONES EN EXCEL (n8n)\n   Analiza la salida del Loop Over Uno a Uno.\n   Agrupa los 칤tems por franja (campo `indice` si existe;\n    de lo contrario, cada bloque de 5 칤tems forma una franja).\n   Verifica que cada inserci칩n tenga:\n        exito === true\n        statusCode === 200\n        falloEstado === false\n   Devuelve un 칰nico objeto JSON con:\n         Resumen global.\n         Detalle por franja (칠xitos / fallos y celdas con error).\n===========================================================\n*/\n\n// 1) Obtener todos los 칤tems que llegan al nodo\nconst items = $input.all();\n\n// 2) Funci칩n auxiliar para determinar el identificador de la franja\nfunction obtenerIdFranja(item, idx) {\n  // Si existe 'indice', 칰salo; de lo contrario agrupa cada 5 칤tems\n  if (item.json && item.json.indice !== undefined && item.json.indice !== null) {\n    return String(item.json.indice).trim();\n  }\n  // +1 para que las franjas queden 1-basadas\n  return String(Math.floor(idx / 5) + 1);\n}\n\n// 3) Agrupar 칤tems por franja\nconst franjas = {};\nitems.forEach((item, idx) => {\n  const idFranja = obtenerIdFranja(item, idx);\n  if (!franjas[idFranja]) {\n    franjas[idFranja] = { id: idFranja, items: [] };\n  }\n  franjas[idFranja].items.push(item.json);\n});\n\n// 4) Analizar cada franja y construir el detalle\nconst detallesPorFranja = Object.values(franjas).map(franja => {\n  const totalOps   = franja.items.length;\n  const exitosas   = franja.items.filter(i =>\n    i.exito === true &&\n    i.statusCode === 200 &&\n    i.falloEstado === false\n  ).length;\n\n  const fallidas   = totalOps - exitosas;\n  const exitoTotal = fallidas === 0;\n\n  // Celdas con error para un diagn칩stico claro\n  const celdasFallidas = franja.items\n    .filter(i => !(i.exito && i.statusCode === 200 && !i.falloEstado))\n    .map(i => ({\n      celdaOriginal   : i.celdaOriginal,\n      celdaInsertada  : i.celdaInsertada,\n      statusCode      : i.statusCode,\n      falloEstado     : i.falloEstado,\n      celdasDiferentes: i.celdasDiferentes,\n      mensaje         : 'Inserci칩n fallida'\n    }));\n\n  return {\n    idFranja                : franja.id,\n    exitoFranja             : exitoTotal,\n    operacionesTotales      : totalOps,\n    operacionesExitosas     : exitosas,\n    operacionesFallidas     : fallidas,\n    porcentajeExitosas      : ((exitosas / totalOps) * 100).toFixed(2) + '%',\n    celdasFallidas\n  };\n});\n\n// 5) Resumen global\nconst operacionesTotales   = items.length;\nconst operacionesExitosas  = detallesPorFranja.reduce((sum, f) => sum + f.operacionesExitosas, 0);\nconst operacionesFallidas  = operacionesTotales - operacionesExitosas;\n\nconst franjasTotales   = detallesPorFranja.length;\nconst franjasExitosas  = detallesPorFranja.filter(f => f.exitoFranja).length;\nconst franjasFallidas  = franjasTotales - franjasExitosas;\n\n\nconst resumen = {\n  estadoGeneral              : franjasFallidas === 0 ? '칄XITO_COMPLETO' : '칄XITO_PARCIAL',\n  franjasTotales,\n  franjasExitosas,\n  franjasFallidas,\n  porcentajeFranjasExitosas  : ((franjasExitosas / franjasTotales) * 100).toFixed(2) + '%',\n  operacionesTotales,\n  operacionesExitosas,\n  operacionesFallidas,\n  porcentajeOperacionesExitosas : ((operacionesExitosas / operacionesTotales) * 100).toFixed(2) + '%',\n  detallesPorFranja\n};\n\n// 6) Devolver un 칰nico 칤tem con el resumen\nreturn [\n  {\n    json: resumen\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4752,
        3904
      ],
      "id": "13f85b3b-f6ca-49f8-ab21-4e981be112c6",
      "name": "Code Validar inserciones1"
    },
    {
      "parameters": {
        "jsCode": "// 1) Leer chat_id una sola vez\nconst chatId = $node[\"Organiza el Mensaje\"].json.infoMensaje.chat_id;\n\n// 2) Tomamos los datos de informacionCita una sola vez\nconst cita = $input.first().json.informacionCita || {};\nconst historialMensajes = $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.historialMensajes;\n\n// Funci칩n para convertir fechas en formato \"06 de mayo de 2025\" a \"YYYY-MM-DD HH:mm:ss\"\nfunction convertirFecha(fechaTexto) {\n  const meses = {\n    enero: '01', febrero: '02', marzo: '03', abril: '04', mayo: '05',\n    junio: '06', julio: '07', agosto: '08', septiembre: '09',\n    octubre: '10', noviembre: '11', diciembre: '12'\n  };\n\n  // Dividir la fecha y mapear el mes\n  const [dia, de, mes, deNuevo, anio] = fechaTexto.split(' ');\n  const mesNumerico = meses[mes.toLowerCase()]; // Convertir el mes a n칰mero\n  return `${anio}-${mesNumerico}-${dia.padStart(2, '0')} 00:00:00`; // Formato DATETIME\n}\n\n// Convertimos la fecha aqu칤\nconst fechaCitaConvertida = convertirFecha(cita.fecha);\n\n// 3) Retornamos un solo objeto con todos los datos necesarios\nreturn {\n  json: {\n    chat_id: chatId,\n    proveedor: cita.proveedor,\n    orden_compra: cita.ordenCompra,\n    peso: cita.peso,\n    unidades: cita.unidades,\n    categoria: cita.categoria,\n    muelle: cita.muelle,\n    fecha_cita: fechaCitaConvertida, // Fecha ya convertida\n    hora_inicio: cita.horaInicio,\n    hora_fin: cita.horaFin,\n    chat_historial: historialMensajes,\n    // Incluimos cualquier otro dato que necesites\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4752,
        3760
      ],
      "id": "07c8b6c7-28cd-446d-bdd3-a7214791e214",
      "name": "Code Datos Insert Cita1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8c501d95-bdf3-4635-a037-224926c2528d",
              "leftValue": "={{ $json.estadoGeneral }}",
              "rightValue": "칄XITO_COMPLETO",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5088,
        3904
      ],
      "id": "717bb3f9-10de-45be-9bc7-f0ba86d9de1f",
      "name": "If Validar inserciones1"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        5392,
        3776
      ],
      "id": "0fe06afe-91f0-4268-a3da-74b6a1083f37",
      "name": "Merge4"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        8240,
        4224
      ],
      "id": "16383538-f710-4132-a749-ac8bf72a9b14",
      "name": "Merge5"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO CitasRecepcion\n(\n    chat_id,\n    nombre,              \n    orden_compra,\n    peso,\n    unidades,\n    horas_entrega,\n    categoria,\n    muelle,\n    fecha_cita,\n    hora_inicio,\n    hora_fin,\n    estado,\n    fecha_creacion,\n    fecha_modificacion,\n    chat_historial,\n    chat_historial_datos\n)\n/* 較較較 AQU칈 較較較 */\nOUTPUT INSERTED.id          --    devolver치 el IDENTITY de la fila reci칠n insertada\nVALUES\n(\n    '{{ $('Code Datos Insert Cita1').item.json.chat_id }}',\n    '{{ $('Code Datos Insert Cita1').item.json.proveedor }}',\n    '{{ $('Code Datos Insert Cita1').item.json.orden_compra }}',\n     {{ $('Code Datos Insert Cita1').item.json.peso }},\n     {{ $('Code Datos Insert Cita1').item.json.unidades }},\n     {{ $json.horas_entrega }},\n    '{{ $('Code Datos Insert Cita1').item.json.categoria }}',\n    '{{ $('Code Datos Insert Cita1').item.json.muelle }}',\n    '{{ $('Code Datos Insert Cita1').item.json.fecha_cita }}',\n    '{{ $('Code Datos Insert Cita1').item.json.hora_inicio }}',\n    '{{ $('Code Datos Insert Cita1').item.json.hora_fin }}',   \n      'PROGRAMADA',                   \n    (SYSDATETIMEOFFSET() AT TIME ZONE 'SA Pacific Standard Time'), \n    NULL,                            \n    '{{ $items(\"Code Datos Insert Cita1\")\n        .map(i => i.json.chat_historial)\n        .join(\"\\n\")\n        .replace(/'/g,\"''\") }}',\n    'SIN DATOS'\n);\n\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        7680,
        3984
      ],
      "id": "36a197b2-42d4-4367-b927-a53f98fab55e",
      "name": "Microsoft SQL Insertar Cita1",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        8560,
        4320
      ],
      "id": "f10608be-32ac-4ca5-b479-23e4df4c18b1",
      "name": "OpenAI Chat Model16",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Basic LLM Notificar Cita Exitosa1').item.json.text.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        9088,
        4288
      ],
      "id": "b1880805-04b5-4c69-b51a-005d936d34de",
      "name": "Validaci칩n de longitud de caracteres11"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Basic LLM Notificar Cita Exitosa1').item.json.text }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Basic LLM Notificar Cita Exitosa1').item.json.text.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9392,
        4400
      ],
      "id": "49583dbc-fa15-41f0-be81-c649f25e1120",
      "name": "Organiza variables del mensaje11"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        9552,
        4176
      ],
      "id": "ad4d9765-b48f-4f6c-b148-13abe06439ec",
      "name": "No Operation, do nothing15"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        9376,
        4176
      ],
      "id": "07f9a73e-0def-4673-8c18-51603a09ed1f",
      "name": "HTTP Request Enviar Mensaje por WhatsApp14"
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# Rol y Objetivo\nEres el asistente virtual de **Konf칤e Logistics** especializado en comunicaci칩n WhatsApp profesional. Tu objetivo es notificar al proveedor que su cita se **reprogram칩 con 칠xito**, utilizando formato WhatsApp con excelente UX.\n\n# Datos disponibles  \n- idCita           = {{ $(\"Microsoft SQL Insertar Cita1\").first().json.id }}  \n- fechaCita        = {{ $(\"Code Datos Insert Cita1\").first().json.fecha_cita }}  \n- horaInicio       = {{ $(\"Code Datos Insert Cita1\").first().json.hora_inicio }}  \n- horaFin          = {{ $(\"Code Datos Insert Cita1\").first().json.hora_fin }}  \n- muelle           = {{ $(\"Code Datos Insert Cita1\").first().json.muelle }}  \n- ordenCompra      = {{ $(\"Code Datos Insert Cita1\").first().json.orden_compra }}  \n- categoria        = {{ $(\"Code Datos Insert Cita1\").first().json.categoria }}  \n- pesoKg           = {{ $(\"Code Datos Insert Cita1\").first().json.peso }}  \n- unidades         = {{ $(\"Code Datos Insert Cita1\").first().json.unidades }}\n\n> Ajusta los nombres de nodos/propiedades si tu flujo usa otros.\n\n# Instrucciones de redacci칩n\n1. Mant칠n un tono profesional, cordial y positivo.  \n2. Empieza con una breve expresi칩n de entusiasmo por la **reprogramaci칩n exitosa** (p. ej.: 럑멖ita reprogramada con 칠xito! o 럑Reprogramaci칩n confirmada!).  \n3. Presenta los **nuevos detalles** de la cita en una lista con vi침etas y emojis adecuados:  \n    游 **N칰mero de cita:** antep칩n 游댔  游댔 {{ $(\"Microsoft SQL Insertar Cita1\").first().json.id }}   \n    游늰 **Fecha:** {{ $(\"Code Datos Insert Cita1\").first().json.fecha_cita.split(\" \")[0] }}  \n    낋 **Horario:** {{ $(\"Code Datos Insert Cita1\").first().json.hora_inicio }}  {{ $(\"Code Datos Insert Cita1\").first().json.hora_fin }}  \n    游뛀 **Muelle:** {{ $(\"Code Datos Insert Cita1\").first().json.muelle }}  \n    游낑勇 **O/C:** {{ $(\"Code Datos Insert Cita1\").first().json.orden_compra }}  \n    游닍 **Categor칤a:** {{ $(\"Code Datos Insert Cita1\").first().json.categoria }}  \n    丘뒲잺 **Peso:** {{ $(\"Code Datos Insert Cita1\").first().json.peso }} kg  \n    游닍 **Unidades:** {{ $(\"Code Datos Insert Cita1\").first().json.unidades }}  \n4. Reitera el n칰mero de cita con el emoji 游댔 y aclara que con ese n칰mero el proveedor podr치 **volver a modificar o cancelar** la cita si lo necesita.  \n5. Explica claramente la pol칤tica: Las modificaciones o cancelaciones deben solicitarse **hasta un d칤a h치bil antes** y **antes de las 4:30 p. m.**; despu칠s de ese plazo no podremos realizar cambios.  \n6. Cierra agradeciendo su colaboraci칩n y confirmando que estaremos atentos a su llegada.  \n7. Devuelve **solo** el mensaje final, sin encabezados ni explicaciones adicionales.\n\n# Salida esperada (ejemplo de estilo)\n\n游댃 *춰Cita reprogramada con 칠xito!* 游꿀\n\n游 *N칰mero de cita:* ```12345```\n\n游늶 *Nuevos detalles:*\n游늰 *Fecha:* 10 de junio de 2025\n낋 *Horario:* 14:00 - 16:00\n游뛀 *Muelle:* 3\n游낑勇 *Orden de Compra:* OC-98765\n游닍 *Categor칤a:* Electrodom칠sticos\n丘뒲잺 *Peso:* 500 kg\n游늵 *Unidades:* 800\n\n游댐 *Importante:* Tu n칰mero de cita ```12345``` sigue siendo el mismo para futuras gestiones.\n\n丘멆잺 *Pol칤tica de cambios:*\nPuedes modificar o cancelar hasta *un d칤a h치bil antes* y antes de las *4:30 p.m.*\n\n游똂 춰Gracias por tu confianza! Te esperamos en la nueva fecha.\n"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        8656,
        4144
      ],
      "id": "3b340abc-1626-423f-88a6-cca488123e05",
      "name": "Basic LLM Notificar Cita Exitosa1",
      "alwaysOutputData": true,
      "executeOnce": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "BEGIN TRANSACTION;\n\nDELETE FROM MensajesWhatsApp\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n   OR (chat_id = 'agenteAI'\n       AND message_id IN (\n           SELECT message_id \n           FROM MensajesWhatsApp\n           WHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n       )\n   );\n\nDELETE FROM FranjasDisponiblesTemp \nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\n-- Resetear estado conversacional a INICIAL despu칠s de reprogramaci칩n exitosa\nUPDATE EstadoConversacional \nSET estado_actual = 'INICIAL', \n    contexto_proceso = '{\"descripcion\": \"Cita reprogramada exitosamente, conversaci칩n reiniciada\", \"ultima_accion\": \"cita_reprogramada\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    contador_fuera_contexto = 0,\n    ultimo_mensaje_fuera_contexto = NULL,\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\n-- Si no existe el registro, crear uno en estado INICIAL\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}', \n        'INICIAL', \n        '{\"descripcion\": \"Cita reprogramada exitosamente, conversaci칩n reiniciada\", \"ultima_accion\": \"cita_reprogramada\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\nCOMMIT;\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        7680,
        4448
      ],
      "id": "bd1ba15f-3953-4d31-89f5-5d9675115304",
      "name": "Microsoft SQL Eliminar Mensajes4",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "/*  拘拘  PEGAR TODO ESTO EN EL CAMPO Query DEL NODO SQL  拘拘  */\n\n/* 較較較較較較較較較較較較較較較較較較較較較較較較較較較\n   Par치metro recibido de n8n\n   較較較較較較較較較較較較較較較較較較較較較較較較較較較\n   Asume que en la secci칩n Query Parameters del nodo tienes\n   un par치metro llamado  id   con el valor  {{ $json.id }}\n   (o la propiedad que traiga tu flujo).\n*/\nDECLARE @id           INT = {{ $('Code Validacion de Cita en cronograma para reprogramaci칩n').first().json.citaAntigua.id }};          -- par치metro que llega de n8n\nDECLARE @nowBogota    DATETIME;\n\n/* Obtener la fecha/hora actual en zona horaria de Bogot치           */\n/* (SQLServer 2016+  requiere soporte ATTIMEZONE)                */\nSET @nowBogota =\n    CONVERT(DATETIME, SYSDATETIMEOFFSET() AT TIME ZONE 'SA Pacific Standard Time');\n\n/* 較較較較較較較較較較較較較  UPDATE  較較較較較較較較較較較較較 */\nUPDATE  dbo.CitasRecepcion\nSET     estado            = N'REPROGRAMADA',\n        fecha_modificacion = @nowBogota\nWHERE   id = @id;\n\n/* Devuelve la fila modificada (칰til para depurar en n8n) */\nSELECT  *\nFROM    dbo.CitasRecepcion\nWHERE   id = @id;\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        7344,
        3968
      ],
      "id": "fc9305ef-ff00-40b9-95bf-b32d3e032333",
      "name": "Microsoft SQLUpdate Cita Anterior",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -752,
        8368
      ],
      "id": "73133faa-0aeb-4a38-8f5d-8d8a3f04300b",
      "name": "OpenAI Chat Model17",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n\"idCita\": \"\",\n\"ordenCompra\": \"\",\n\"camposFaltantes\": []\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        -592,
        8368
      ],
      "id": "28676bc1-0c75-4d64-b615-e88837b00a4f",
      "name": "Structured Output Parser5"
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# Extracci칩n de datos para cancelaci칩n de citas\n\nAnaliza el historial completo de mensajes y el mensaje actual para extraer los datos necesarios para cancelar una cita existente. **Tu 칰nica responsabilidad es extraer datos, no validarlos ni tomar decisiones.**\n\n## Datos a extraer\n- ID de la cita (por ejemplo, \"Cita 12345\", \"N칰mero 12345\", etc.)\n- N칰mero de orden de compra asociado a la cita\n\n## Fuentes de datos a analizar\n- Mensaje actual: {{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.mensajeActual }}\n- Historial de mensajes: {{ $node[\"Unificaci칩n y consistencia de datos\"].json[\"infoMensaje\"][\"historialMensajes\"] }}\n\n## Instrucciones espec칤ficas\n1. Buscar PRIMERO el ID de la cita en formato num칠rico en CUALQUIER mensaje previo\n2. Buscar el n칰mero de orden de compra en CUALQUIER mensaje previo\n3. Considera expresiones como \"cancelar cita\", \"anular cita\", \"no puedo asistir\", etc.\n4. Si no encuentras alguno de los datos requeridos, m치rcalo como faltante\n\n## Estructura de salida JSON\n{\n  \"idCita\": string,          // ID de la cita\n  \"ordenCompra\": string,     // N칰mero de orden de compra\n  \"camposFaltantes\": array   // Lista de campos que no pudieron ser extra칤dos\n}",
        "hasOutputParser": true
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        -672,
        8160
      ],
      "id": "3729f4c1-f11d-4562-aa6b-d8c4eaee6297",
      "name": "Basic LLM Extracci칩n Datos Cancelar Cita"
    },
    {
      "parameters": {
        "jsCode": "// Obtener los datos extra칤dos\nconst datosExtraidos = $('Basic LLM Extracci칩n Datos Cancelar Cita').first().json.output;\n\n// Estructura de respuesta\nconst respuesta = {\n  todoCorrecto: false,\n  idCita: datosExtraidos.idCita || \"\",\n  ordenCompra: datosExtraidos.ordenCompra || \"\",\n  camposFaltantes: datosExtraidos.camposFaltantes || [],\n  mensajeSistema: \"\"\n};\n\n// Verificar si hay campos faltantes\nif (respuesta.camposFaltantes && respuesta.camposFaltantes.length > 0) {\n  respuesta.todoCorrecto = false;\n  respuesta.mensajeSistema = generarMensajeCamposFaltantes(respuesta.camposFaltantes);\n} else {\n  respuesta.todoCorrecto = true;\n  respuesta.mensajeSistema = `Entendido. Est치s solicitando cancelar la cita 游댔 ${respuesta.idCita} con orden de compra ${respuesta.ordenCompra}. Verificar칠 si es posible realizar la cancelaci칩n.`;\n}\n\nfunction generarMensajeCamposFaltantes(camposFaltantes) {\n  let mensaje = \"Para poder cancelar tu cita, necesito \";\n  \n  if (camposFaltantes.includes(\"idCita\")) {\n    mensaje += \"el n칰mero de cita 游댔 que aparece en tu confirmaci칩n, \";\n  }\n  \n  if (camposFaltantes.includes(\"ordenCompra\")) {\n    mensaje += \"el n칰mero de orden de compra para verificaci칩n, \";\n  }\n  \n  mensaje = mensaje.slice(0, -2) + \". \";\n  mensaje += \"Por ejemplo: 'Quiero cancelar mi cita 12345 con orden de compra ARGM47896'.\";\n  \n  return mensaje;\n}\n\nreturn respuesta;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        8160
      ],
      "id": "ef296dd9-a3a7-4311-9608-356a44466bab",
      "name": "Code Validaci칩n datos para cancelaci칩n de citas"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2b68e9c6-bb33-49e0-b323-c6ed61e3d98e",
              "leftValue": "={{ $json.todoCorrecto }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -96,
        8160
      ],
      "id": "fb2796a7-2717-4fcc-9dca-84271ba83f04",
      "name": "If Validar si los datos est치n completos"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DECLARE @Id          INT          = {{ $json.idCita }};\nDECLARE @OrdenCompra VARCHAR(50)  = '{{ $json.ordenCompra }}';\n\nIF EXISTS (SELECT 1\n           FROM   CitasRecepcion\n           WHERE  id           = @Id\n             AND  orden_compra = @OrdenCompra\n             AND  estado       = 'PROGRAMADA')\nBEGIN\n    SELECT *\n    FROM   CitasRecepcion\n    WHERE  id           = @Id\n      AND  orden_compra = @OrdenCompra\n      AND  estado       = 'PROGRAMADA';\nEND\nELSE\nBEGIN\n    -- C칩digo y severidad personalizados\n    THROW 50001, 'La cita no se encuentra en estado PROGRAMADA o los datos no coinciden.', 16;\nEND\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        336,
        7984
      ],
      "id": "8d601ff9-181d-4ec9-8f4d-c48e734e8d57",
      "name": "Microsoft SQL Obtener Cita para Cancelar",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('If Validar si los datos est치n completos').first().json.mensajeSistema.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        928,
        8864
      ],
      "id": "76917af2-21bb-4c64-9038-d886315c9482",
      "name": "Validaci칩n de longitud de caracteres12"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('If Validar si los datos est치n completos').first().json.mensajeSistema }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('If Validar si los datos est치n completos').first().json.mensajeSistema.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1232,
        8944
      ],
      "id": "f736211b-3c34-4d32-a2b3-b161b038b963",
      "name": "Organiza variables del mensaje12"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1392,
        8720
      ],
      "id": "41187880-9aff-43bf-856f-f44202d39204",
      "name": "No Operation, do nothing16"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1216,
        8720
      ],
      "id": "e1be80ad-a147-4715-a18d-c8c9cbfc21a5",
      "name": "HTTP Request Enviar Mensaje por WhatsApp15"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1cc112df-9a2d-4ad5-acf5-74b0fbadc479",
              "leftValue": "={{ $json.error === undefined }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        544,
        7984
      ],
      "id": "ab076f49-8f33-44ff-ae32-9a83f1ed6b84",
      "name": "If cita para cancelar"
    },
    {
      "parameters": {
        "jsCode": "// Generar respuesta de error para cita no programada\nfor (const item of $input.all()) {\n  item.json = {\n    \"error\": true,\n    \"mensaje\": \"游뚿 *Error de validaci칩n* 丘멆잺\\n\\n\" +\n              \"La cita que intentas cancelar ya fue *cancelada* o *reprogramada* anteriormente.\\n\\n\" +\n              \"游늶 *Verificaciones necesarias:*\\n\" +\n              \" 游댌 *N칰mero de cita* correcto\\n\" +\n              \" 游낑勇 *Orden de compra* correcta\\n\" +\n              \" 九 Estado de la cita: *PROGRAMADA*\\n\\n\" +\n              \"游댃 *Acci칩n requerida:*\\n\" +\n              \"Por temas de *trazabilidad*, esta conversaci칩n ser치 eliminada.\\n\\n\" +\n              \"游녤 Inicia un *nuevo chat* con los datos correctos para proceder.\",\n    \"codigo_error\": \"CITA_NO_PROGRAMADA\",\n    \"accion_requerida\": \"REINICIAR_CONVERSACION\",\n    \"timestamp\": new Date().toISOString()\n  };\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        8160
      ],
      "id": "13d0c954-c2cd-4ccc-b6fb-f60507156946",
      "name": "Code respuesta cita no programada"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Code respuesta cita no programada').first().json.mensaje.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1184,
        8400
      ],
      "id": "76c7d37d-50cf-42ad-b209-118dda008774",
      "name": "Validaci칩n de longitud de caracteres13"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Code respuesta cita no programada').first().json.mensaje }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Code respuesta cita no programada').first().json.mensaje.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1472,
        8496
      ],
      "id": "7d119c33-f5cf-4607-b060-4c821deec6c5",
      "name": "Organiza variables del mensaje13"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1648,
        8256
      ],
      "id": "a21b91fd-2c53-49c1-b486-3dbdf9710e5e",
      "name": "No Operation, do nothing17"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1472,
        8256
      ],
      "id": "d171e507-4b7d-4143-bda7-f1f1104f4c74",
      "name": "HTTP Request Enviar Mensaje por WhatsApp16"
    },
    {
      "parameters": {
        "url": "https://graph.microsoft.com/v1.0/sites/a592f886-4560-4e62-9646-1eee7add7abe/drives/b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8/items/01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME/content",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "ExcelMallaRecibido2025"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        976,
        7456
      ],
      "id": "410f2bb5-3fc0-4a49-a0aa-defd6592ea99",
      "name": "HTTP Request MALLA DE RECIBO 3",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      }
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "ExcelMallaRecibido2025",
        "options": {
          "sheetName": "={{ $('Unificaci칩n y consistencia de datos').item.json.hojaSeleccionada }}"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1232,
        7344
      ],
      "id": "f3996975-a5af-43b4-a671-59e19c0e8e97",
      "name": "Extract MALLA DE RECIBO 3"
    },
    {
      "parameters": {
        "jsCode": "// Obtener los datos del Excel\nconst excelData = $input.all();\nconst hojaSeleccionada = $('Unificaci칩n y consistencia de datos').first().json.hojaSeleccionada;\n\n// Obtener hora local en Bogot치\nconst ahora = new Date(new Date().toLocaleString(\"en-US\", { timeZone: \"America/Bogota\" }));\nconst diaSemanaActual = ahora.getDay(); // 0=domingo, 1=lunes, ..., 5=viernes\nconst horaActual = ahora.getHours();\nconst minutosActual = ahora.getMinutes();\n// Determinar si es despu칠s de las 16:30\nconst pasoLimiteDia = horaActual > 16 || (horaActual === 16 && minutosActual >= 30);\n\n// Definir estructura de la semana y los d칤as\nconst diasSemana = ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'];\n\n// Mapeo para saber qu칠 d칤as incluir si hoy es x d칤a y pas칩 el l칤mite\n/**\n * Dado el d칤a de la semana actual (0=domingo ... 6=s치bado),\n * devuelve qu칠 d칤as de la semana actual deben incluirse seg칰n si pas칩 el l칤mite.\n */\nfunction diasValidosSemanaActual(diaSemanaActual, pasoLimite) {\n  const mapa = {\n    1: ['martes', 'mi칠rcoles', 'jueves', 'viernes'],   // lunes\n    2: ['mi칠rcoles', 'jueves', 'viernes'],             // martes\n    3: ['jueves', 'viernes'],                          // mi칠rcoles\n    4: ['viernes'],                                     // jueves\n    5: []                                               // viernes (muy tarde para s치bado)\n  };\n  if (diaSemanaActual < 1 || diaSemanaActual > 5) {\n    return []; // s치bado o domingo no se agendan en semana actual\n  }\n  if (!pasoLimite) {\n    // a칰n est치 antes de las 4:30 p.m., se puede incluir el d칤a siguiente\n    const siguiente = diasSemana[diaSemanaActual];\n    return [siguiente, ...mapa[diaSemanaActual]];\n  }\n  return mapa[diaSemanaActual];\n}\n\n// Objeto para almacenar la malla estructurada\nconst mallaEstructurada = {\n  titulo: \"\",\n  a침o: \"\",\n  semana: \"\",\n  rangoDias: \"\",\n  franjas: [],\n  dias: {}\n};\n\n// Tabla de meses y d칤as. Ajusta si necesitas contemplar bisiestos, etc.\nconst meses = {\n  \"enero\": 1,\n  \"febrero\": 2,\n  \"marzo\": 3,\n  \"abril\": 4,\n  \"mayo\": 5,\n  \"junio\": 6,\n  \"julio\": 7,\n  \"agosto\": 8,\n  \"septiembre\": 9,\n  \"octubre\": 10,\n  \"noviembre\": 11,\n  \"diciembre\": 12\n};\n\nconst nombreMes = {\n  1: \"enero\",\n  2: \"febrero\",\n  3: \"marzo\",\n  4: \"abril\",\n  5: \"mayo\",\n  6: \"junio\",\n  7: \"julio\",\n  8: \"agosto\",\n  9: \"septiembre\",\n  10: \"octubre\",\n  11: \"noviembre\",\n  12: \"diciembre\"\n};\n\n/**\n * Funci칩n para determinar si un a침o es bisiesto\n * Un a침o es bisiesto si es divisible por 4, excepto aquellos divisibles por 100 \n * que no son divisibles por 400\n */\nfunction esBisiesto(year) {\n  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n}\n\n/**\n * Funci칩n para obtener el n칰mero de d칤as en un mes, considerando a침os bisiestos\n */\nfunction getDiasMes(mes, a침o) {\n  const diasPorMes = {\n    1: 31, // enero\n    2: esBisiesto(a침o) ? 29 : 28, // febrero - ajustado para a침o bisiesto\n    3: 31, // marzo\n    4: 30, // abril\n    5: 31, // mayo\n    6: 30, // junio\n    7: 31, // julio\n    8: 31, // agosto\n    9: 30, // septiembre\n    10: 31, // octubre\n    11: 30, // noviembre\n    12: 31  // diciembre\n  };\n  \n  return diasPorMes[mes];\n}\n\n/**\n * Funci칩n para eliminar acentos y pasar a min칰sculas (para buscar palabras clave sin importar tildes ni may칰sculas).\n */\nfunction normalizarTexto(texto) {\n  if (typeof texto !== 'string') return \"\";\n  // Normaliza (NFD) y elimina diacr칤ticos, luego pasa a min칰sculas.\n  return texto\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase();\n}\n\n/**\n * Dada la informaci칩n de proveedor, ordenCompra, peso, categor칤a y unidades,\n * revisa si existe la palabra 'fuera de servicio', 'cancelado' o 'reagendado'\n * en cualquiera de esos campos. De ser as칤, retorna ese estado especial;\n * de lo contrario, retorna 'ocupado'.\n * \n * Se ignoran may칰sculas, min칰sculas y tildes.\n */\nfunction determinarEstadoOcupado(proveedor, ordenCompra, peso, categoria, unidades) {\n  const conjunto = `${proveedor} ${ordenCompra} ${peso} ${categoria} ${unidades}`;\n  const texto = normalizarTexto(conjunto);\n\n  if (texto.includes(\"fuera de servicio\")) {\n    return \"fuera de servicio\";\n  }\n  if (texto.includes(\"cancelado\")) {\n    return \"cancelado\";\n  }\n  if (texto.includes(\"reagendado\")) {\n    return \"reagendado\";\n  }\n  return \"ocupado\";  \n}\n\n// -------------------------------------------------------------\n// 1) PROCESAR DATOS (Cabecera, Horas, Muelles, etc.)\n// -------------------------------------------------------------\nfunction procesarDatos(excelData) {\n  const datos = excelData.map(item => item.json);\n  \n  // A) Cabecera (T칤tulo, A침o, Rango)\n  datos.forEach((dato, index) => {\n    // Buscar t칤tulo\n    if (dato.__EMPTY_2 === \"MALLA DE RECIBO CEDI KONFIE IA\") {\n      mallaEstructurada.titulo = dato.__EMPTY_2;\n      \n      // En la siguiente fila puede estar a침o, semana, rango\n      if (index + 1 < datos.length) {\n        const datoSiguiente = datos[index + 1];\n        if (datoSiguiente) {\n          // A침o\n          if (datoSiguiente.__EMPTY_2 && !isNaN(datoSiguiente.__EMPTY_2)) {\n            mallaEstructurada.a침o = datoSiguiente.__EMPTY_2;\n          }\n          // Semana\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"SEMANA\")) {\n              mallaEstructurada.semana = v;\n            }\n          });\n          // Rango: p.ej. \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"LUNES\") && v.includes(\"VIERNES\")) {\n              mallaEstructurada.rangoDias = v;\n            }\n          });\n        }\n      }\n    }\n  });\n  \n  // B) Detectar franjas horarias (.__EMPTY = fracci칩n de d칤a)\n  const franjasHorarias = [];\n  datos.forEach(dato => {\n    if (\n      dato.__EMPTY !== undefined &&\n      typeof dato.__EMPTY === 'number' &&\n      dato.__EMPTY > 0 &&\n      dato.__EMPTY < 1\n    ) {\n      const totalMin = Math.round(dato.__EMPTY * 24 * 60);\n      const hh = Math.floor(totalMin / 60);\n      const mm = totalMin % 60;\n      \n      let periodo = \"AM\";\n      let hora12 = hh;\n      if (hh >= 12) {\n        periodo = \"PM\";\n        hora12 = (hh === 12 ? 12 : hh - 12);\n      }\n      if (hh === 0) {\n        hora12 = 12;\n      }\n      \n      const horaStr = `${hora12}:${String(mm).padStart(2, '0')} ${periodo}`;\n      franjasHorarias.push({\n        hora: horaStr,\n        indice: datos.indexOf(dato) // fila base\n      });\n    }\n  });\n  franjasHorarias.sort((a, b) => a.indice - b.indice);\n  mallaEstructurada.franjas = franjasHorarias;\n  \n  // C) Detectar muelles (col)\n  const muellesInfo = {};\n  datos.forEach(dato => {\n    Object.entries(dato).forEach(([key, value]) => {\n      if (value === \"MUELLE 01\" || value === \"MUELLE 02\") {\n        const col = parseInt(key.replace(\"__EMPTY_\", \"\"), 10);\n        const muelleKey = (value === \"MUELLE 01\") ? 'muelle1' : 'muelle2';\n        if (!muellesInfo[muelleKey]) {\n          muellesInfo[muelleKey] = [];\n        }\n        muellesInfo[muelleKey].push(col);\n      }\n    });\n  });\n  if (muellesInfo.muelle1) muellesInfo.muelle1.sort((a, b) => a - b);\n  if (muellesInfo.muelle2) muellesInfo.muelle2.sort((a, b) => a - b);\n  \n  // D) Generar los 5 d칤as (lunes-viernes) con su fecha\n  parsearRangoDias();\n  \n  // E) Extraer Citas\n  extraerCitas(datos, muellesInfo);\n  \n  return mallaEstructurada;\n}\n\n/**\n * Parsea la cadena \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n * (o \"LUNES 31 AL VIERNES 04 DE ABRIL\") y maneja el cruce de mes.\n * Ej.: si dayStart=31 y dayEnd=4, la 1춹 fecha es 31 de MARZO,\n * luego 1,2,3,4 de ABRIL, en vez de 32,33, etc.\n */\nfunction parsearRangoDias() {\n  const texto = mallaEstructurada.rangoDias;\n  // Regex simple: p.ej. \"31 AL ... 4 DE ABRIL\"\n  // Captura: dayStart, dayEnd, mesFin\n  // Ojo: si dice \"LUNES 31 DE MARZO AL VIERNES 4 DE ABRIL\",\n  // quedar치: dayStart=31, dayEnd=4, month=ABRIL (al final).\n  const regex = /(\\d+)\\s+AL\\s+\\D+(\\d+)\\s+DE\\s+(\\w+)/i;\n  const match = regex.exec(texto);\n  \n  // Por defecto, creamos 5 d칤as vac칤os sin fecha\n  diasSemana.forEach(d => {\n    mallaEstructurada.dias[d] = {\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  if (!match) {\n    // Sin coincidencia, dejamos los d칤as sin fecha\n    return;\n  }\n  \n  const dayStart = parseInt(match[1], 10); // 31\n  const dayEnd   = parseInt(match[2], 10); // 4\n  const finalMonthName = match[3].toLowerCase(); // \"abril\"\n  \n  // Convertimos a n칰mero\n  const finalMonth = meses[finalMonthName] || 3; // fallback marzo\n  const yearNum = parseInt(mallaEstructurada.a침o, 10) || 2025;\n  \n  // Funci칩n para obtener la fecha formateada\n  function fechaFormateada(d, m, y) {\n    return `${d} de ${nombreMes[m]} de ${y}`;\n  }\n  \n  // Comprobamos cu치ntos d칤as tiene el mes final, considerando bisiestos\n  const diasMesFinal = getDiasMes(finalMonth, yearNum);\n  // y del mes previo\n  const monthPrev = (finalMonth === 1) ? 12 : finalMonth - 1;\n  const yearPrev = (finalMonth === 1) ? yearNum - 1 : yearNum;\n  \n  // Arreglo final con 5 fechas\n  const fechasDias = [];\n  \n  if (dayStart <= dayEnd) {\n    // Caso \"normal\": todo en el mismo mes\n    let d = dayStart;\n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: finalMonth,\n        yearNum: yearNum\n      });\n      d++;\n      if (d > diasMesFinal) {\n        d = 1;\n        const nextMonth = finalMonth % 12 + 1;\n        const nextYear = (nextMonth === 1) ? yearNum + 1 : yearNum;\n        fechasDias[fechasDias.length - 1].mesNum = nextMonth;\n        fechasDias[fechasDias.length - 1].yearNum = nextYear;\n      }\n    }\n  } else {\n    // Caso \"cruza de mes\": dayStart > dayEnd\n    let d = dayStart;\n    let m = monthPrev;\n    let y = yearPrev;\n    \n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: m,\n        yearNum: y\n      });\n      d++;\n      if (d > getDiasMes(m, y)) {\n        d = 1;\n        m = m % 12 + 1;\n        if (m === 1) {\n          y++;\n        }\n      }\n    }\n  }\n  \n  // Ahora volcamos esas 5 fechas en la estructura\n  fechasDias.forEach(fd => {\n    const { diaSem, diaNum, mesNum, yearNum } = fd;\n    mallaEstructurada.dias[diaSem] = {\n      fechaDia: fechaFormateada(diaNum, mesNum, yearNum),\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  // Inicializamos las franjas a 'disponible'\n  if (mallaEstructurada.franjas.length > 0) {\n    diasSemana.forEach(d => {\n      mallaEstructurada.franjas.forEach(f => {\n        mallaEstructurada.dias[d].muelle1[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n        mallaEstructurada.dias[d].muelle2[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n      });\n    });\n  }\n}\n\n/**\n * Funci칩n auxiliar: decide a qu칠 d칤a pertenece una columna,\n * corrigiendo 2 columnas de offset (porque 'Extract from XLSX'\n * deja todo desplazado).\n */\nfunction getDayForColumn(colNumber) {\n  // Ajuste de offset +2\n  const realCol = colNumber + 2;\n\n  // Rangos:\n  //  Lunes:      3..8\n  //  Martes:     9..14\n  //  Mi칠rcoles: 15..20\n  //  Jueves:    21..26\n  //  Viernes:   27..32\n  if (realCol >= 3 && realCol <= 8) {\n    return \"lunes\";\n  }\n  if (realCol >= 9 && realCol <= 14) {\n    return \"martes\";\n  }\n  if (realCol >= 15 && realCol <= 20) {\n    return \"mi칠rcoles\";\n  }\n  if (realCol >= 21 && realCol <= 26) {\n    return \"jueves\";\n  }\n  if (realCol >= 27 && realCol <= 32) {\n    return \"viernes\";\n  }\n  // Si nada coincide, devolvemos null\n  return null;\n}\n\n/**\n * Extraer las citas para cada franja:\n * - Para cada franja, miramos 3 filas:\n *    - Fila base => proveedor\n *    - Fila base+1 => orden\n *    - Fila base+2 => peso, categor칤a, unidades\n */\nfunction extraerCitas(datos, muellesInfo) {\n  mallaEstructurada.franjas.forEach(franja => {\n    const indiceBase = franja.indice;\n    if (indiceBase < 0 || indiceBase + 2 >= datos.length) {\n      return; // no hay suficientes filas\n    }\n    \n    // Recorremos muelle1, muelle2 y sus columnas\n    const asignarCita = (muelleKey, cols) => {\n      cols.forEach(col => {\n        const provKey = `__EMPTY_${col}`;\n        const filaProv = datos[indiceBase];\n        \n        // Si en esta fila hay un proveedor o alg칰n texto\n        if (\n          filaProv &&\n          typeof filaProv[provKey] === 'string' &&\n          filaProv[provKey].length > 2\n        ) {\n          // Determinar el d칤a real\n          const diaOk = getDayForColumn(col);\n          if (!diaOk || !mallaEstructurada.dias[diaOk]) {\n            return; // si no coincide con ninguno, saltamos\n          }\n          \n          // Recuperar valores para proveedor, ordenCompra y dem치s\n          const filaOrden = datos[indiceBase + 1];\n          const filaDet = datos[indiceBase + 2];\n          \n          const proveedor = filaProv[provKey] || \"\";\n          const ordenCompra = filaOrden && filaOrden[provKey] ? filaOrden[provKey] : \"\";\n          const peso = filaDet && filaDet[provKey] ? filaDet[provKey] : \"\";\n          const cat  = filaDet && filaDet[`__EMPTY_${col + 1}`] ? filaDet[`__EMPTY_${col + 1}`] : \"\";\n          const und  = filaDet && filaDet[`__EMPTY_${col + 2}`] ? filaDet[`__EMPTY_${col + 2}`] : \"\";\n          \n          // Antes pon칤amos estado=\"ocupado\" directamente\n          // Ahora verificamos si el texto contiene \"reagendado\", \"cancelado\" o \"fuera de servicio\".\n          const nuevoEstado = determinarEstadoOcupado(proveedor, ordenCompra, peso, cat, und);\n          \n          // Asignamos los datos\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].estado = nuevoEstado;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].proveedor = proveedor;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].ordenCompra = ordenCompra;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].peso = peso;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].categoria = cat;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].unidades = und;\n        }\n      });\n    };\n    \n    if (muellesInfo.muelle1) {\n      asignarCita('muelle1', muellesInfo.muelle1);\n    }\n    if (muellesInfo.muelle2) {\n      asignarCita('muelle2', muellesInfo.muelle2);\n    }\n  });\n}\n\n// -------------------------------------------------------------\n// 2) FUNCIONES PARA CONSULTAR LA MALLA\n// -------------------------------------------------------------\nfunction buscarFranjasDisponibles(categoria, duracionHoras) {\n  const muelle = \"muelle1\"; // Ajusta si usas \"categoria -> muelle\" real\n  \n  const franjasDisponibles = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const libres = [];\n    for (let i = 0; i <= mallaEstructurada.franjas.length - duracionHoras; i++) {\n      let disponible = true;\n      for (let h = 0; h < duracionHoras; h++) {\n        const idxF = i + h;\n        const horaAct = mallaEstructurada.franjas[idxF].hora;\n        if (\n          mallaEstructurada.dias[dia][muelle][horaAct].estado !== 'disponible'\n        ) {\n          disponible = false;\n          break;\n        }\n      }\n      if (disponible) {\n        libres.push({\n          horaInicio: mallaEstructurada.franjas[i].hora,\n          duracion: duracionHoras\n        });\n      }\n    }\n    if (libres.length > 0) {\n      franjasDisponibles.push({ dia, franjas: libres });\n    }\n  });\n  return franjasDisponibles;\n}\n\nfunction buscarCitasProveedor(nombreProveedor) {\n  const citas = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const muelle1 = mallaEstructurada.dias[dia].muelle1;\n    const muelle2 = mallaEstructurada.dias[dia].muelle2;\n    mallaEstructurada.franjas.forEach(f => {\n      const hora = f.hora;\n      // muelle1\n      if (normalizarTexto(muelle1[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 01\",\n          ordenCompra: muelle1[hora].ordenCompra,\n          peso: muelle1[hora].peso,\n          categoria: muelle1[hora].categoria,\n          unidades: muelle1[hora].unidades,\n          estado: muelle1[hora].estado\n        });\n      }\n      // muelle2\n      if (normalizarTexto(muelle2[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 02\",\n          ordenCompra: muelle2[hora].ordenCompra,\n          peso: muelle2[hora].peso,\n          categoria: muelle2[hora].categoria,\n          unidades: muelle2[hora].unidades,\n          estado: muelle2[hora].estado\n        });\n      }\n    });\n  });\n  return citas;\n}\n\nfunction consultarFranjasDisponibles(categoria, duracionHoras) {\n  return buscarFranjasDisponibles(categoria, duracionHoras);\n}\n\nfunction consultarCitasProveedor(nombreProveedor) {\n  return buscarCitasProveedor(nombreProveedor);\n}\n\nfunction obtenerInfoMalla() {\n  return {\n    titulo: mallaEstructurada.titulo,\n    a침o: mallaEstructurada.a침o,\n    semana: mallaEstructurada.semana,\n    rangoDias: mallaEstructurada.rangoDias,\n    franjas: mallaEstructurada.franjas.map(f => f.hora)\n  };\n}\n\nfunction estaDisponible(dia, hora, muelle) {\n  const info = mallaEstructurada.dias[dia]?.[muelle]?.[hora];\n  return info ? (info.estado === 'disponible') : false;\n}\n\nfunction obtenerCoordenadasCita(dia, hora, muelle) {\n  // Ajustar con tu mapeo de celdas en Excel\n  return {\n    proveedor: `${dia}_${hora}_${muelle}_proveedor`,\n    ordenCompra: `${dia}_${hora}_${muelle}_ordenCompra`,\n    peso: `${dia}_${hora}_${muelle}_peso`,\n    categoria: `${dia}_${hora}_${muelle}_categoria`,\n    unidades: `${dia}_${hora}_${muelle}_unidades`\n  };\n}\n\n// -------------------------------------------------------------\n// 3) EJECUTAR TODO Y RETORNAR\n// -------------------------------------------------------------\n// Procesar todos los datos\nconst malla = procesarDatos(excelData);\n\n// Aplicar el filtro de d칤as v치lidos seg칰n la hora actual\nconst diasPermitidos = diasValidosSemanaActual(diaSemanaActual, pasoLimiteDia);\nObject.keys(malla.dias).forEach(dia => {\n  if (!diasPermitidos.includes(dia)) {\n    delete malla.dias[dia]; // eliminar d칤as no v치lidos\n  }\n});\n\nconst resultado = {\n  datosMalla: malla,\n  funciones: {\n    consultarFranjasDisponibles,\n    consultarCitasProveedor,\n    obtenerInfoMalla,\n    estaDisponible,\n    obtenerCoordenadasCita\n  }\n};\n\nreturn [resultado];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1472,
        7344
      ],
      "id": "a2ead2d0-d813-41e3-a067-c1c58c2b4950",
      "name": "Estructuraci칩n, Datos, Consulta, Citas4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        1792,
        7440
      ],
      "id": "5289b72a-b68e-4aba-8904-fd6ca3b2e20c",
      "name": "Merge datos Excel4"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    datosMalla: $items(\"Merge datos Excel4\")[0].json.datosMalla,\n    datosMallaProxSemana: $items(\"Merge datos Excel4\")[1].json.datosMallaProxSemana,\n    hojaSeleccionada: $items(\"Merge datos Excel4\")[0].json.datosMalla.semana\n  }\n}];\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2032,
        7440
      ],
      "id": "da838699-eb2f-4ac3-968e-e6a4e392c51d",
      "name": "Unificaci칩n y consistencia de datos5"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "ExcelMallaRecibido2025",
        "options": {
          "sheetName": "={{    (function() {     const semanaActual = $('Unificaci칩n y consistencia de datos').item.json.hojaSeleccionada;     const numeroSemana = parseInt(semanaActual.replace(\"SEMANA \", \"\"));     return `SEMANA ${numeroSemana + 1}`;   })() }}"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1232,
        7536
      ],
      "id": "5d38f13c-0801-4795-a106-3b35c4c327b6",
      "name": "Extract MALLA DE RECIBO Semana Siguiente4",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Si el nodo anterior no devolvi칩 datos (por error al no existir la hoja), retornamos estructura vac칤a con mensaje\n// Obtener los datos del Excel\nconst excelData = $input.all();\n\n// Mejora en la detecci칩n de errores: verificar si hay error expl칤cito o si los datos no son v치lidos\nconst hayError = excelData.some(item => item.json && item.json.error);\nconst datosInvalidos = !excelData || excelData.length === 0 || hayError;\n\nif (datosInvalidos) {\n  return [{\n    datosMallaProxSemana: {\n      titulo: \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\",\n      a침o: \"\",\n      semana: \"\",\n      rangoDias: \"\",\n      franjas: [],\n      dias: {\n        lunes: { muelle1: {}, muelle2: {} },\n        martes: { muelle1: {}, muelle2: {} },\n        mi칠rcoles: { muelle1: {}, muelle2: {} },\n        jueves: { muelle1: {}, muelle2: {} },\n        viernes: { muelle1: {}, muelle2: {} }\n      }\n    },\n    funciones: {\n      consultarFranjasDisponibles: \"function not available\",\n      consultarCitasProveedor: \"function not available\",\n      obtenerInfoMalla: \"function not available\",\n      estaDisponible: \"function not available\",\n      obtenerCoordenadasCita: \"function not available\"\n    }\n  }];\n}\n\n// El resto del c칩digo permanece igual...\nconst hojaSeleccionada = $('Unificaci칩n y consistencia de datos').first().json.hojaSeleccionada;\n\n// Definir estructura de la semana y los d칤as\nconst diasSemana = ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'];\n\n// Objeto para almacenar la malla estructurada\nconst mallaEstructurada = {\n  titulo: \"\",\n  a침o: \"\",\n  semana: \"\",\n  rangoDias: \"\",\n  franjas: [],\n  dias: {}\n};\n\n// Tabla de meses y d칤as. Ajusta si necesitas contemplar bisiestos, etc.\nconst meses = {\n  \"enero\": 1,\n  \"febrero\": 2,\n  \"marzo\": 3,\n  \"abril\": 4,\n  \"mayo\": 5,\n  \"junio\": 6,\n  \"julio\": 7,\n  \"agosto\": 8,\n  \"septiembre\": 9,\n  \"octubre\": 10,\n  \"noviembre\": 11,\n  \"diciembre\": 12\n};\n\nconst nombreMes = {\n  1: \"enero\",\n  2: \"febrero\",\n  3: \"marzo\",\n  4: \"abril\",\n  5: \"mayo\",\n  6: \"junio\",\n  7: \"julio\",\n  8: \"agosto\",\n  9: \"septiembre\",\n  10: \"octubre\",\n  11: \"noviembre\",\n  12: \"diciembre\"\n};\n\n/**\n * Funci칩n para determinar si un a침o es bisiesto\n * Un a침o es bisiesto si es divisible por 4, excepto aquellos divisibles por 100 \n * que no son divisibles por 400\n */\nfunction esBisiesto(year) {\n  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n}\n\n/**\n * Funci칩n para obtener el n칰mero de d칤as en un mes, considerando a침os bisiestos\n */\nfunction getDiasMes(mes, a침o) {\n  const diasPorMes = {\n    1: 31, // enero\n    2: esBisiesto(a침o) ? 29 : 28, // febrero - ajustado para a침o bisiesto\n    3: 31, // marzo\n    4: 30, // abril\n    5: 31, // mayo\n    6: 30, // junio\n    7: 31, // julio\n    8: 31, // agosto\n    9: 30, // septiembre\n    10: 31, // octubre\n    11: 30, // noviembre\n    12: 31  // diciembre\n  };\n  \n  return diasPorMes[mes];\n}\n\n/**\n * Funci칩n para eliminar acentos y pasar a min칰sculas (para buscar palabras clave sin importar tildes ni may칰sculas).\n */\nfunction normalizarTexto(texto) {\n  if (typeof texto !== 'string') return \"\";\n  // Normaliza (NFD) y elimina diacr칤ticos, luego pasa a min칰sculas.\n  return texto\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase();\n}\n\n/**\n * Dada la informaci칩n de proveedor, ordenCompra, peso, categor칤a y unidades,\n * revisa si existe la palabra 'fuera de servicio', 'cancelado' o 'reagendado'\n * en cualquiera de esos campos. De ser as칤, retorna ese estado especial;\n * de lo contrario, retorna 'ocupado'.\n * \n * Se ignoran may칰sculas, min칰sculas y tildes.\n */\nfunction determinarEstadoOcupado(proveedor, ordenCompra, peso, categoria, unidades) {\n  const conjunto = `${proveedor} ${ordenCompra} ${peso} ${categoria} ${unidades}`;\n  const texto = normalizarTexto(conjunto);\n\n  if (texto.includes(\"fuera de servicio\")) {\n    return \"fuera de servicio\";\n  }\n  if (texto.includes(\"cancelado\")) {\n    return \"cancelado\";\n  }\n  if (texto.includes(\"reagendado\")) {\n    return \"reagendado\";\n  }\n  return \"ocupado\";  \n}\n\n// -------------------------------------------------------------\n// 1) PROCESAR DATOS (Cabecera, Horas, Muelles, etc.)\n// -------------------------------------------------------------\nfunction procesarDatos(excelData) {\n  // Verificaci칩n adicional de datos v치lidos\n  if (!excelData || !Array.isArray(excelData) || excelData.length === 0) {\n    return {\n      titulo: \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\",\n      a침o: \"\",\n      semana: \"\",\n      rangoDias: \"\",\n      franjas: [],\n      dias: {\n        lunes: { muelle1: {}, muelle2: {} },\n        martes: { muelle1: {}, muelle2: {} },\n        mi칠rcoles: { muelle1: {}, muelle2: {} },\n        jueves: { muelle1: {}, muelle2: {} },\n        viernes: { muelle1: {}, muelle2: {} }\n      }\n    };\n  }\n  \n  // Intentar mapear datos, con manejo de errores para cada item\n  const datos = excelData.map(item => {\n    try {\n      return item.json || {};\n    } catch (e) {\n      return {};\n    }\n  });\n  \n  // A) Cabecera (T칤tulo, A침o, Rango)\n  datos.forEach((dato, index) => {\n    // Buscar t칤tulo\n    if (dato.__EMPTY_2 === \"MALLA DE RECIBO CEDI KONFIE IA\") {\n      mallaEstructurada.titulo = dato.__EMPTY_2;\n      \n      // En la siguiente fila puede estar a침o, semana, rango\n      if (index + 1 < datos.length) {\n        const datoSiguiente = datos[index + 1];\n        if (datoSiguiente) {\n          // A침o\n          if (datoSiguiente.__EMPTY_2 && !isNaN(datoSiguiente.__EMPTY_2)) {\n            mallaEstructurada.a침o = datoSiguiente.__EMPTY_2;\n          }\n          // Semana\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"SEMANA\")) {\n              mallaEstructurada.semana = v;\n            }\n          });\n          // Rango: p.ej. \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n          Object.entries(datoSiguiente).forEach(([k, v]) => {\n            if (typeof v === 'string' && v.includes(\"LUNES\") && v.includes(\"VIERNES\")) {\n              mallaEstructurada.rangoDias = v;\n            }\n          });\n        }\n      }\n    }\n  });\n  \n  // Si despu칠s de procesar no encontramos t칤tulo, es que no hay malla v치lida\n  if (!mallaEstructurada.titulo) {\n    mallaEstructurada.titulo = \"丘멆잺 La malla de la pr칩xima semana no existe en el archivo Excel o a칰n no ha sido creada.\";\n    return mallaEstructurada;\n  }\n  \n  // B) Detectar franjas horarias (.__EMPTY = fracci칩n de d칤a)\n  const franjasHorarias = [];\n  datos.forEach(dato => {\n    if (\n      dato.__EMPTY !== undefined &&\n      typeof dato.__EMPTY === 'number' &&\n      dato.__EMPTY > 0 &&\n      dato.__EMPTY < 1\n    ) {\n      const totalMin = Math.round(dato.__EMPTY * 24 * 60);\n      const hh = Math.floor(totalMin / 60);\n      const mm = totalMin % 60;\n      \n      let periodo = \"AM\";\n      let hora12 = hh;\n      if (hh >= 12) {\n        periodo = \"PM\";\n        hora12 = (hh === 12 ? 12 : hh - 12);\n      }\n      if (hh === 0) {\n        hora12 = 12;\n      }\n      \n      const horaStr = `${hora12}:${String(mm).padStart(2, '0')} ${periodo}`;\n      franjasHorarias.push({\n        hora: horaStr,\n        indice: datos.indexOf(dato) // fila base\n      });\n    }\n  });\n  franjasHorarias.sort((a, b) => a.indice - b.indice);\n  mallaEstructurada.franjas = franjasHorarias;\n  \n  // C) Detectar muelles (col)\n  const muellesInfo = {};\n  datos.forEach(dato => {\n    Object.entries(dato).forEach(([key, value]) => {\n      if (value === \"MUELLE 01\" || value === \"MUELLE 02\") {\n        const col = parseInt(key.replace(\"__EMPTY_\", \"\"), 10);\n        const muelleKey = (value === \"MUELLE 01\") ? 'muelle1' : 'muelle2';\n        if (!muellesInfo[muelleKey]) {\n          muellesInfo[muelleKey] = [];\n        }\n        muellesInfo[muelleKey].push(col);\n      }\n    });\n  });\n  if (muellesInfo.muelle1) muellesInfo.muelle1.sort((a, b) => a - b);\n  if (muellesInfo.muelle2) muellesInfo.muelle2.sort((a, b) => a - b);\n  \n  // D) Generar los 5 d칤as (lunes-viernes) con su fecha\n  parsearRangoDias();\n  \n  // E) Extraer Citas\n  extraerCitas(datos, muellesInfo);\n  \n  return mallaEstructurada;\n}\n\n/**\n * Parsea la cadena \"LUNES 31 AL VIERNES 4 DE ABRIL\"\n * (o \"LUNES 31 AL VIERNES 04 DE ABRIL\") y maneja el cruce de mes.\n * Ej.: si dayStart=31 y dayEnd=4, la 1춹 fecha es 31 de MARZO,\n * luego 1,2,3,4 de ABRIL, en vez de 32,33, etc.\n */\nfunction parsearRangoDias() {\n  const texto = mallaEstructurada.rangoDias;\n  // Regex simple: p.ej. \"31 AL ... 4 DE ABRIL\"\n  // Captura: dayStart, dayEnd, mesFin\n  // Ojo: si dice \"LUNES 31 DE MARZO AL VIERNES 4 DE ABRIL\",\n  // quedar치: dayStart=31, dayEnd=4, month=ABRIL (al final).\n  const regex = /(\\d+)\\s+AL\\s+\\D+(\\d+)\\s+DE\\s+(\\w+)/i;\n  const match = regex.exec(texto);\n  \n  // Por defecto, creamos 5 d칤as vac칤os sin fecha\n  diasSemana.forEach(d => {\n    mallaEstructurada.dias[d] = {\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  if (!match) {\n    // Sin coincidencia, dejamos los d칤as sin fecha\n    return;\n  }\n  \n  const dayStart = parseInt(match[1], 10); // 31\n  const dayEnd   = parseInt(match[2], 10); // 4\n  const finalMonthName = match[3].toLowerCase(); // \"abril\"\n  \n  // Convertimos a n칰mero\n  const finalMonth = meses[finalMonthName] || 3; // fallback marzo\n  const yearNum = parseInt(mallaEstructurada.a침o, 10) || 2025;\n  \n  // Funci칩n para obtener la fecha formateada\n  function fechaFormateada(d, m, y) {\n    return `${d} de ${nombreMes[m]} de ${y}`;\n  }\n  \n  // Comprobamos cu치ntos d칤as tiene el mes final, considerando bisiestos\n  const diasMesFinal = getDiasMes(finalMonth, yearNum);\n  // y del mes previo\n  const monthPrev = (finalMonth === 1) ? 12 : finalMonth - 1;\n  const yearPrev = (finalMonth === 1) ? yearNum - 1 : yearNum;\n  \n  // Arreglo final con 5 fechas\n  const fechasDias = [];\n  \n  if (dayStart <= dayEnd) {\n    // Caso \"normal\": todo en el mismo mes\n    let d = dayStart;\n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: finalMonth,\n        yearNum: yearNum\n      });\n      d++;\n      if (d > diasMesFinal) {\n        d = 1;\n        const nextMonth = finalMonth % 12 + 1;\n        const nextYear = (nextMonth === 1) ? yearNum + 1 : yearNum;\n        fechasDias[fechasDias.length - 1].mesNum = nextMonth;\n        fechasDias[fechasDias.length - 1].yearNum = nextYear;\n      }\n    }\n  } else {\n    // Caso \"cruza de mes\": dayStart > dayEnd\n    let d = dayStart;\n    let m = monthPrev;\n    let y = yearPrev;\n    \n    for (let i = 0; i < 5; i++) {\n      fechasDias.push({\n        diaSem: diasSemana[i],\n        diaNum: d,\n        mesNum: m,\n        yearNum: y\n      });\n      d++;\n      if (d > getDiasMes(m, y)) {\n        d = 1;\n        m = m % 12 + 1;\n        if (m === 1) {\n          y++;\n        }\n      }\n    }\n  }\n  \n  // Ahora volcamos esas 5 fechas en la estructura\n  fechasDias.forEach(fd => {\n    const { diaSem, diaNum, mesNum, yearNum } = fd;\n    mallaEstructurada.dias[diaSem] = {\n      fechaDia: fechaFormateada(diaNum, mesNum, yearNum),\n      muelle1: {},\n      muelle2: {}\n    };\n  });\n  \n  // Inicializamos las franjas a 'disponible'\n  if (mallaEstructurada.franjas.length > 0) {\n    diasSemana.forEach(d => {\n      mallaEstructurada.franjas.forEach(f => {\n        mallaEstructurada.dias[d].muelle1[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n        mallaEstructurada.dias[d].muelle2[f.hora] = {\n          estado: \"disponible\",\n          proveedor: \"\",\n          ordenCompra: \"\",\n          peso: \"\",\n          categoria: \"\",\n          unidades: \"\"\n        };\n      });\n    });\n  }\n}\n\n/**\n * Funci칩n auxiliar: decide a qu칠 d칤a pertenece una columna,\n * corrigiendo 2 columnas de offset (porque 'Extract from XLSX'\n * deja todo desplazado).\n */\nfunction getDayForColumn(colNumber) {\n  // Ajuste de offset +2\n  const realCol = colNumber + 2;\n\n  // Rangos:\n  //  Lunes:      3..8\n  //  Martes:     9..14\n  //  Mi칠rcoles: 15..20\n  //  Jueves:    21..26\n  //  Viernes:   27..32\n  if (realCol >= 3 && realCol <= 8) {\n    return \"lunes\";\n  }\n  if (realCol >= 9 && realCol <= 14) {\n    return \"martes\";\n  }\n  if (realCol >= 15 && realCol <= 20) {\n    return \"mi칠rcoles\";\n  }\n  if (realCol >= 21 && realCol <= 26) {\n    return \"jueves\";\n  }\n  if (realCol >= 27 && realCol <= 32) {\n    return \"viernes\";\n  }\n  // Si nada coincide, devolvemos null\n  return null;\n}\n\n/**\n * Extraer las citas para cada franja:\n * - Para cada franja, miramos 3 filas:\n *    - Fila base => proveedor\n *    - Fila base+1 => orden\n *    - Fila base+2 => peso, categor칤a, unidades\n */\nfunction extraerCitas(datos, muellesInfo) {\n  mallaEstructurada.franjas.forEach(franja => {\n    const indiceBase = franja.indice;\n    if (indiceBase < 0 || indiceBase + 2 >= datos.length) {\n      return; // no hay suficientes filas\n    }\n    \n    // Recorremos muelle1, muelle2 y sus columnas\n    const asignarCita = (muelleKey, cols) => {\n      cols.forEach(col => {\n        const provKey = `__EMPTY_${col}`;\n        const filaProv = datos[indiceBase];\n        \n        // Si en esta fila hay un proveedor o alg칰n texto\n        if (\n          filaProv &&\n          typeof filaProv[provKey] === 'string' &&\n          filaProv[provKey].length > 2\n        ) {\n          // Determinar el d칤a real\n          const diaOk = getDayForColumn(col);\n          if (!diaOk || !mallaEstructurada.dias[diaOk]) {\n            return; // si no coincide con ninguno, saltamos\n          }\n          \n          // Recuperar valores para proveedor, ordenCompra y dem치s\n          const filaOrden = datos[indiceBase + 1];\n          const filaDet = datos[indiceBase + 2];\n          \n          const proveedor = filaProv[provKey] || \"\";\n          const ordenCompra = filaOrden && filaOrden[provKey] ? filaOrden[provKey] : \"\";\n          const peso = filaDet && filaDet[provKey] ? filaDet[provKey] : \"\";\n          const cat  = filaDet && filaDet[`__EMPTY_${col + 1}`] ? filaDet[`__EMPTY_${col + 1}`] : \"\";\n          const und  = filaDet && filaDet[`__EMPTY_${col + 2}`] ? filaDet[`__EMPTY_${col + 2}`] : \"\";\n          \n          // Antes pon칤amos estado=\"ocupado\" directamente\n          // Ahora verificamos si el texto contiene \"reagendado\", \"cancelado\" o \"fuera de servicio\".\n          const nuevoEstado = determinarEstadoOcupado(proveedor, ordenCompra, peso, cat, und);\n          \n          // Asignamos los datos\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].estado = nuevoEstado;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].proveedor = proveedor;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].ordenCompra = ordenCompra;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].peso = peso;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].categoria = cat;\n          mallaEstructurada.dias[diaOk][muelleKey][franja.hora].unidades = und;\n        }\n      });\n    };\n    \n    if (muellesInfo.muelle1) {\n      asignarCita('muelle1', muellesInfo.muelle1);\n    }\n    if (muellesInfo.muelle2) {\n      asignarCita('muelle2', muellesInfo.muelle2);\n    }\n  });\n}\n\n// -------------------------------------------------------------\n// 2) FUNCIONES PARA CONSULTAR LA MALLA\n// -------------------------------------------------------------\nfunction buscarFranjasDisponibles(categoria, duracionHoras) {\n  const muelle = \"muelle1\"; // Ajusta si usas \"categoria -> muelle\" real\n  \n  const franjasDisponibles = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const libres = [];\n    for (let i = 0; i <= mallaEstructurada.franjas.length - duracionHoras; i++) {\n      let disponible = true;\n      for (let h = 0; h < duracionHoras; h++) {\n        const idxF = i + h;\n        const horaAct = mallaEstructurada.franjas[idxF].hora;\n        if (\n          mallaEstructurada.dias[dia][muelle][horaAct].estado !== 'disponible'\n        ) {\n          disponible = false;\n          break;\n        }\n      }\n      if (disponible) {\n        libres.push({\n          horaInicio: mallaEstructurada.franjas[i].hora,\n          duracion: duracionHoras\n        });\n      }\n    }\n    if (libres.length > 0) {\n      franjasDisponibles.push({ dia, franjas: libres });\n    }\n  });\n  return franjasDisponibles;\n}\n\nfunction buscarCitasProveedor(nombreProveedor) {\n  const citas = [];\n  Object.keys(mallaEstructurada.dias).forEach(dia => {\n    const muelle1 = mallaEstructurada.dias[dia].muelle1;\n    const muelle2 = mallaEstructurada.dias[dia].muelle2;\n    mallaEstructurada.franjas.forEach(f => {\n      const hora = f.hora;\n      // muelle1\n      if (normalizarTexto(muelle1[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 01\",\n          ordenCompra: muelle1[hora].ordenCompra,\n          peso: muelle1[hora].peso,\n          categoria: muelle1[hora].categoria,\n          unidades: muelle1[hora].unidades,\n          estado: muelle1[hora].estado\n        });\n      }\n      // muelle2\n      if (normalizarTexto(muelle2[hora].proveedor) === normalizarTexto(nombreProveedor)) {\n        citas.push({\n          dia,\n          hora,\n          muelle: \"Muelle 02\",\n          ordenCompra: muelle2[hora].ordenCompra,\n          peso: muelle2[hora].peso,\n          categoria: muelle2[hora].categoria,\n          unidades: muelle2[hora].unidades,\n          estado: muelle2[hora].estado\n        });\n      }\n    });\n  });\n  return citas;\n}\n\nfunction consultarFranjasDisponibles(categoria, duracionHoras) {\n  return buscarFranjasDisponibles(categoria, duracionHoras);\n}\n\nfunction consultarCitasProveedor(nombreProveedor) {\n  return buscarCitasProveedor(nombreProveedor);\n}\n\nfunction obtenerInfoMalla() {\n  return {\n    titulo: mallaEstructurada.titulo,\n    a침o: mallaEstructurada.a침o,\n    semana: mallaEstructurada.semana,\n    rangoDias: mallaEstructurada.rangoDias,\n    franjas: mallaEstructurada.franjas.map(f => f.hora)\n  };\n}\n\nfunction estaDisponible(dia, hora, muelle) {\n  const info = mallaEstructurada.dias[dia]?.[muelle]?.[hora];\n  return info ? (info.estado === 'disponible') : false;\n}\n\nfunction obtenerCoordenadasCita(dia, hora, muelle) {\n  // Ajustar con tu mapeo de celdas en Excel\n  return {\n    proveedor: `${dia}_${hora}_${muelle}_proveedor`,\n    ordenCompra: `${dia}_${hora}_${muelle}_ordenCompra`,\n    peso: `${dia}_${hora}_${muelle}_peso`,\n    categoria: `${dia}_${hora}_${muelle}_categoria`,\n    unidades: `${dia}_${hora}_${muelle}_unidades`\n  };\n}\n\n// -------------------------------------------------------------\n// 3) EJECUTAR TODO Y RETORNAR\n// -------------------------------------------------------------\nconst malla = procesarDatos(excelData);\n\nconst resultado = {\n  datosMallaProxSemana: malla,\n  funciones: {\n    consultarFranjasDisponibles,\n    consultarCitasProveedor,\n    obtenerInfoMalla,\n    estaDisponible,\n    obtenerCoordenadasCita\n  }\n};\n\nreturn [resultado];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1472,
        7536
      ],
      "id": "497463e6-ed6c-4c17-b722-8cf44e7c2682",
      "name": "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana4"
    },
    {
      "parameters": {
        "jsCode": "// Obtener los datos de la cita desde la consulta SQL\nconst citaBD = $('Microsoft SQL Obtener Cita para Cancelar').first().json;\n\n// Obtener los datos de las mallas\nconst datosMalla = $('Unificaci칩n y consistencia de datos5').first().json;\nconst mallaActual = datosMalla.datosMalla;\nconst mallaProxSemana = datosMalla.datosMallaProxSemana;\n\n// Funci칩n para normalizar texto (quitar espacios, convertir a min칰sculas)\nfunction normalizarTexto(texto) {\n  if (!texto) return \"\";\n  return texto.toString().trim().toLowerCase();\n}\n\n// Funci칩n para buscar cita en una malla espec칤fica\nfunction buscarCitaEnMalla(malla, citaBuscar) {\n  const diasSemana = ['lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes'];\n  const muelles = ['muelle1', 'muelle2'];\n  \n  for (const dia of diasSemana) {\n    if (!malla.dias[dia]) continue;\n    \n    for (const muelle of muelles) {\n      if (!malla.dias[dia][muelle]) continue;\n      \n      // Revisar todas las franjas horarias\n      for (const [hora, citaMalla] of Object.entries(malla.dias[dia][muelle])) {\n        // Solo revisar citas ocupadas\n        if (citaMalla.estado !== 'ocupado') continue;\n        \n        // Comparar campos clave\n        const proveedorCoincide = normalizarTexto(citaMalla.proveedor) === normalizarTexto(citaBuscar.nombre);\n        const ordenCoincide = normalizarTexto(citaMalla.ordenCompra) === normalizarTexto(citaBuscar.orden_compra);\n        \n        // Verificar peso (puede ser number o string)\n        let pesoCoincide = false;\n        const pesoBD = parseFloat(citaBuscar.peso) || 0;\n        const pesoMalla = parseFloat(citaMalla.peso) || 0;\n        pesoCoincide = Math.abs(pesoBD - pesoMalla) < 0.01; // tolerancia para decimales\n        \n        // Verificar unidades\n        let unidadesCoincide = false;\n        const unidadesBD = parseFloat(citaBuscar.unidades) || 0;\n        const unidadesMalla = parseFloat(citaMalla.unidades) || 0;\n        unidadesCoincide = Math.abs(unidadesBD - unidadesMalla) < 0.01;\n        \n        // Si coinciden los campos principales, es la misma cita\n        if (proveedorCoincide && ordenCoincide && pesoCoincide && unidadesCoincide) {\n          return {\n            encontrada: true,\n            ubicacion: {\n              malla: malla.semana,\n              dia: dia,\n              hora: hora,\n              muelle: muelle,\n              fechaDia: malla.dias[dia].fechaDia || \"Fecha no disponible\"\n            },\n            detalles: citaMalla\n          };\n        }\n      }\n    }\n  }\n  \n  return { encontrada: false };\n}\n\n// Buscar la cita en ambas mallas\nlet citaEncontrada = null;\nlet ubicacionEncontrada = null;\n\n// Primero buscar en la malla actual\nconst resultadoMallaActual = buscarCitaEnMalla(mallaActual, citaBD);\nif (resultadoMallaActual.encontrada) {\n  citaEncontrada = resultadoMallaActual.detalles;\n  ubicacionEncontrada = resultadoMallaActual.ubicacion;\n}\n\n// Si no se encontr칩 en la malla actual, buscar en la pr칩xima semana\nif (!citaEncontrada) {\n  const resultadoMallaProxima = buscarCitaEnMalla(mallaProxSemana, citaBD);\n  if (resultadoMallaProxima.encontrada) {\n    citaEncontrada = resultadoMallaProxima.detalles;\n    ubicacionEncontrada = resultadoMallaProxima.ubicacion;\n  }\n}\n\n// Generar respuesta basada en si se encontr칩 o no la cita\nif (citaEncontrada) {\n  // Cita encontrada - continuar con el proceso de cancelaci칩n\n  return [{\n    validacionExitosa: true,\n    citaEncontrada: true,\n    datosValidacion: {\n      citaBD: {\n        id: citaBD.id,\n        nombre: citaBD.nombre,\n        ordenCompra: citaBD.orden_compra,\n        peso: citaBD.peso,\n        unidades: citaBD.unidades,\n        fechaCita: citaBD.fecha_cita,\n        estado: citaBD.estado\n      },\n      citaMalla: citaEncontrada,\n      ubicacion: ubicacionEncontrada\n    },\n    mensaje: `九 **Validaci칩n exitosa**\\n\\n` +\n             `Se ha verificado que la cita 游댔 **${citaBD.id}** con orden de compra **${citaBD.orden_compra}** ` +\n             `se encuentra correctamente registrada en la malla de la ${ubicacionEncontrada.malla}.\\n\\n` +\n             `游늸 **Ubicaci칩n en malla:**\\n` +\n             ` **D칤a:** ${ubicacionEncontrada.dia} (${ubicacionEncontrada.fechaDia})\\n` +\n             ` **Hora:** ${ubicacionEncontrada.hora}\\n` +\n             ` **Muelle:** ${ubicacionEncontrada.muelle.replace('muelle', 'Muelle ')}\\n` +\n             ` **Proveedor:** ${citaEncontrada.proveedor}\\n\\n` +\n             `Procediendo con la cancelaci칩n de la cita...`\n  }];\n} else {\n  // Cita NO encontrada - generar error\n  return [{\n    validacionExitosa: false,\n    citaEncontrada: false,\n    error: true,\n    datosValidacion: {\n      citaBD: {\n        id: citaBD.id,\n        nombre: citaBD.nombre,\n        ordenCompra: citaBD.orden_compra,\n        peso: citaBD.peso,\n        unidades: citaBD.unidades,\n        fechaCita: citaBD.fecha_cita,\n        estado: citaBD.estado\n      },\n      mallaRevisada: {\n        semanaActual: mallaActual.semana,\n        rangoActual: mallaActual.rangoDias,\n        semanaProxima: mallaProxSemana.semana,\n        rangoProximo: mallaProxSemana.rangoDias\n      }\n    },\n    mensaje: `仇 **Error de validaci칩n de malla**\\n\\n` +\n             `La cita 游댔 **${citaBD.id}** con orden de compra **${citaBD.orden_compra}** ` +\n             `se encuentra registrada en la base de datos como **PROGRAMADA**, pero ` +\n             `**NO coincide** con ninguna cita ocupada en la malla de horarios.\\n\\n` +\n             `游늵 **Datos de la cita en BD:**\\n` +\n             ` **Proveedor:** ${citaBD.nombre}\\n` +\n             ` **Orden de compra:** ${citaBD.orden_compra}\\n` +\n             ` **Peso:** ${citaBD.peso} kg\\n` +\n             ` **Unidades:** ${citaBD.unidades}\\n` +\n             ` **Fecha programada:** ${citaBD.fecha_cita}\\n\\n` +\n             `游댌 **Mallas revisadas:**\\n` +\n             ` ${mallaActual.semana}: ${mallaActual.rangoDias}\\n` +\n             ` ${mallaProxSemana.semana}: ${mallaProxSemana.rangoDias}\\n\\n` +\n             `丘멆잺 **Acci칩n requerida:**\\n` +\n             `Por favor comun칤quese con el **치rea de bodega** para verificar qu칠 sucedi칩 con esta cita. ` +\n             `Es posible que haya una inconsistencia entre la base de datos y la malla de horarios.\\n\\n` +\n             `游 **Contacto:** Extensi칩n 1234 - Coordinaci칩n de Bodega\\n\\n` +\n             `游댃 **Esta conversaci칩n ser치 eliminada** para mantener la trazabilidad del historial.`,\n    codigoError: \"CITA_NO_ENCONTRADA_EN_MALLA\",\n    accionRequerida: \"CONTACTAR_BODEGA\"\n  }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2320,
        7440
      ],
      "id": "2274c079-bb38-4bfc-bbc9-f6b129a404e6",
      "name": "Code validaci칩n de cita en malla"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "64a1bea0-f03e-4e93-8f05-f2e606167be0",
              "leftValue": "={{ $json.citaEncontrada }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2592,
        7440
      ],
      "id": "66d97fb1-bf6c-4489-a25c-68d5905653a5",
      "name": "If validar cita existe"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Code validaci칩n de cita en malla').first().json.mensaje.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3040,
        7824
      ],
      "id": "2278fc66-300c-42b9-988e-9ab066c46b1a",
      "name": "Validaci칩n de longitud de caracteres14"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Code validaci칩n de cita en malla').first().json.mensaje }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Code validaci칩n de cita en malla').first().json.mensaje.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3312,
        7888
      ],
      "id": "0d7ebdcd-7c95-4050-be64-75dc5d3002a8",
      "name": "Organiza variables del mensaje14"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3488,
        7680
      ],
      "id": "ccf90cf0-a3ad-417b-a75e-36919d2fb8cd",
      "name": "No Operation, do nothing18"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3312,
        7680
      ],
      "id": "550e54c6-dcf8-45a2-808d-1e40b5b6a1d7",
      "name": "HTTP Request Enviar Mensaje por WhatsApp17"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo adaptado para CANCELACI칍N de citas\nconst datosValidacion = $('Code validaci칩n de cita en malla').first().json.datosValidacion;\nconst citaBD = datosValidacion.citaBD;\nconst ubicacionCita = datosValidacion.ubicacion;\n// Usar la fecha de la cita para determinar qu칠 malla usar\nconst mallaActual = $('Unificaci칩n y consistencia de datos5').first().json.datosMalla;\nconst mallaProxima = $('Unificaci칩n y consistencia de datos5').first().json.datosMallaProxSemana;\n\nconst fechaCita = new Date(citaBD.fechaCita);\n\n// Funci칩n para verificar si una fecha est치 en un rango de malla\nfunction fechaEnMalla(fecha, malla) {\n  if (!malla.dias) return false;\n  \n  const fechaBuscada = fecha.toLocaleDateString('es-ES', { \n    day: 'numeric', \n    month: 'long', \n    year: 'numeric' \n  });\n  \n  for (const dia of Object.keys(malla.dias)) {\n    const diaData = malla.dias[dia];\n    if (diaData.fechaDia && diaData.fechaDia === fechaBuscada) {\n      console.log(`Fecha encontrada en d칤a ${dia}: ${diaData.fechaDia}`);\n      return true;\n    }\n  }\n  return false;\n}\n\nlet datosMalla;\nif (fechaEnMalla(fechaCita, mallaActual)) {\n  datosMalla = mallaActual;\n  console.log(\"Usando malla actual para fecha:\", fechaCita.toDateString());\n} else if (fechaEnMalla(fechaCita, mallaProxima)) {\n  datosMalla = mallaProxima;\n  console.log(\"Usando malla pr칩xima para fecha:\", fechaCita.toDateString());\n} else {\n  console.log(\"Fecha no encontrada en ninguna malla\");\n  return {\n    json: {\n      error: true,\n      mensaje: `No se encontr칩 la fecha ${fechaCita.toDateString()} en ninguna malla`,\n      datosValidacion\n    }\n  };\n}\n\nconsole.log(\"=== ESTRUCTURA DATOS MALLA ===\");\nconsole.log(\"Claves disponibles en datosMalla:\", Object.keys(datosMalla || {}));\nconsole.log(\"Claves en datosMalla.dias:\", Object.keys(datosMalla?.dias || {}));\nconsole.log(\"Estructura completa dias:\", datosMalla?.dias);\n\nconsole.log(`Preparando cancelaci칩n de cita ID ${citaBD.id} ubicada en: ${ubicacionCita.dia} ${ubicacionCita.hora} ${ubicacionCita.muelle}`);\n\n// Funci칩n para calcular las franjas ocupadas por la cita\nfunction calcularFranjasOcupadas() {\n  const franjas = [];\n  \n  console.log(\"=== DEBUG CANCELACI칍N ===\");\n  console.log(\"Ubicaci칩n cita:\", ubicacionCita);\n  console.log(\"Datos cita BD:\", citaBD);\n  \n  // Encontrar la franja de inicio\n  const franjasOrdenadas = [...datosMalla.franjas].sort((a, b) => {\n    function horaAMinutos(hora) {\n      const match = hora.match(/(\\\\d+):(\\\\d+)\\\\s*([AP]M)/i);\n      if (!match) return 0;\n      \n      let horas = parseInt(match[1], 10);\n      const minutos = parseInt(match[2], 10);\n      const periodo = match[3].toUpperCase();\n      \n      if (periodo === 'PM' && horas !== 12) {\n        horas += 12;\n      } else if (periodo === 'AM' && horas === 12) {\n        horas = 0;\n      }\n      \n      return horas * 60 + minutos;\n    }\n    \n    return horaAMinutos(a.hora) - horaAMinutos(b.hora);\n  });\n  \n  console.log(\"Franjas ordenadas:\", franjasOrdenadas.map(f => f.hora));\n  \n  // Encontrar el 칤ndice de la franja actual\n  const indiceInicio = franjasOrdenadas.findIndex(f => \n    f.hora.trim().toLowerCase() === ubicacionCita.hora.trim().toLowerCase()\n  );\n  \n  console.log(`Buscando hora: \"${ubicacionCita.hora}\" - 칈ndice encontrado: ${indiceInicio}`);\n  \n  if (indiceInicio === -1) {\n    console.log(`No se encontr칩 la franja ${ubicacionCita.hora} en la malla`);\n    return [];\n  }\n  \n  const muelleKey = ubicacionCita.muelle.toLowerCase().includes(\"1\") ? \"muelle1\" : \"muelle2\";\n  const diaData = datosMalla.dias[ubicacionCita.dia];\n  \n  console.log(`D칤a: ${ubicacionCita.dia}, Muelle: ${muelleKey}`);\n  console.log(\"Datos del d칤a:\", Object.keys(diaData || {}));\n  console.log(\"Datos del muelle:\", Object.keys(diaData?.[muelleKey] || {}));\n  \n  if (!diaData || !diaData[muelleKey]) {\n    console.log(`No se encontraron datos para ${ubicacionCita.dia} ${muelleKey}`);\n    return [];\n  }\n  \n  // Buscar franjas consecutivas con los mismos datos de la cita\n  for (let i = indiceInicio; i < franjasOrdenadas.length; i++) {\n    const franja = franjasOrdenadas[i];\n    const datosFramja = diaData[muelleKey][franja.hora];\n    \n    console.log(`\\n--- Evaluando franja ${franja.hora} ---`);\n    console.log(\"Datos franja:\", datosFramja);\n    \n    if (!datosFramja) {\n      console.log(\"No hay datos para esta franja\");\n      break;\n    }\n    \n    // Comparaciones individuales para debug\n    const estadoOK = datosFramja.estado === 'ocupado';\n    const proveedorOK = datosFramja.proveedor && citaBD.nombre && \n      String(datosFramja.proveedor).trim().toLowerCase() === String(citaBD.nombre).trim().toLowerCase();\n    const ordenOK = String(datosFramja.ordenCompra) === String(citaBD.ordenCompra);\n    \n    console.log(`Estado OK: ${estadoOK} (${datosFramja.estado} === 'ocupado')`);\n    console.log(`Proveedor OK: ${proveedorOK} (\"${datosFramja.proveedor}\" === \"${citaBD.nombre}\")`);\n    console.log(`Orden OK: ${ordenOK} (${datosFramja.ordenCompra} === ${citaBD.ordenCompra})`);\n    \n    const mismaCita = datosFramja && estadoOK && proveedorOK && ordenOK;\n    \n    if (mismaCita) {\n      const filaBase = calcularFilaExcel(franja.hora, franjasOrdenadas);\n      if (filaBase) {\n        franjas.push({\n          hora: franja.hora,\n          fila: filaBase,\n          datos: {\n            proveedor: \"\",\n            ordenCompra: \"\",\n            peso: \"\",\n            categoria: \"\",\n            unidades: \"\"\n          }\n        });\n        console.log(`九 Franja a침adida: ${franja.hora}`);\n      }\n    } else {\n      console.log(`仇 No es la misma cita, deteniendo b칰squeda`);\n      break;\n    }\n  }\n  \n  console.log(`=== RESULTADO: ${franjas.length} franjas encontradas ===`);\n  return franjas;\n}\n\n// Funciones auxiliares (mantener las mismas del nodo original)\nfunction calcularFilaExcel(hora, franjas) {\n  const franjasOrdenadas = [...franjas].sort((a, b) => {\n    function horaAMinutos(hora) {\n      const match = hora.match(/(\\\\d+):(\\\\d+)\\\\s*([AP]M)/i);\n      if (!match) return 0;\n      \n      let horas = parseInt(match[1], 10);\n      const minutos = parseInt(match[2], 10);\n      const periodo = match[3].toUpperCase();\n      \n      if (periodo === 'PM' && horas !== 12) {\n        horas += 12;\n      } else if (periodo === 'AM' && horas === 12) {\n        horas = 0;\n      }\n      \n      return horas * 60 + minutos;\n    }\n    \n    return horaAMinutos(a.hora) - horaAMinutos(b.hora);\n  });\n  \n  const posicion = franjasOrdenadas.findIndex(f => \n    f.hora.trim().toLowerCase() === hora.trim().toLowerCase()\n  );\n  \n  if (posicion === -1) {\n    console.log(`No se encontr칩 la posici칩n para la hora ${hora}`);\n    return null;\n  }\n  \n  const FILA_PRIMERA_FRANJA = 12;\n  const INCREMENTO_ESTANDAR = 3;\n  \n  if (posicion === 3) {\n    return 21;\n  } else if (posicion === 4) {\n    return 24;\n  } else if (posicion === 5) {\n    return 27;\n  } else if (posicion < 3) {\n    return FILA_PRIMERA_FRANJA + (posicion * INCREMENTO_ESTANDAR);\n  } else {\n    return 27 + ((posicion - 5) * INCREMENTO_ESTANDAR);\n  }\n}\n\nfunction procesarFranjas(franjas, nombreHoja) {\n  let actualizaciones = [];\n  \n  const diaSemana = ubicacionCita.dia;\n  const muelleKey = ubicacionCita.muelle.toLowerCase().includes(\"1\") ? \"muelle1\" : \"muelle2\";\n  \n  const mapeoColumnas = {\n    'lunes': { 'muelle1': 'C', 'muelle2': 'F' },\n    'martes': { 'muelle1': 'I', 'muelle2': 'L' },\n    'mi칠rcoles': { 'muelle1': 'O', 'muelle2': 'R' },\n    'jueves': { 'muelle1': 'U', 'muelle2': 'X' },\n    'viernes': { 'muelle1': 'AA', 'muelle2': 'AD' }\n  };\n  \n  if (!mapeoColumnas[diaSemana] || !mapeoColumnas[diaSemana][muelleKey]) {\n    console.log(`No hay mapeo para: d칤a=${diaSemana}, muelle=${muelleKey}`);\n    return [];\n  }\n  \n  const columnaBase = mapeoColumnas[diaSemana][muelleKey];\n  \n  function siguienteColumna(columna) {\n    if (columna.length === 1) {\n      return String.fromCharCode(columna.charCodeAt(0) + 1);\n    } else {\n      const primerChar = columna.charAt(0);\n      const segundoChar = columna.charAt(1);\n      \n      if (segundoChar === 'Z') {\n        return String.fromCharCode(primerChar.charCodeAt(0) + 1) + 'A';\n      } else {\n        return primerChar + String.fromCharCode(segundoChar.charCodeAt(0) + 1);\n      }\n    }\n  }\n  \n  franjas.forEach((franja, index) => {\n    const filaBase = franja.fila;\n    const columnaLineas = siguienteColumna(columnaBase);\n    const columnaUnd = siguienteColumna(columnaLineas);\n    \n    const rangoCeldas = {\n      proveedor: `${columnaBase}${filaBase}`,\n      ordenCompra: `${columnaBase}${filaBase + 1}`,\n      peso: `${columnaBase}${filaBase + 2}`,\n      categoria: `${columnaLineas}${filaBase + 2}`,\n      unidades: `${columnaUnd}${filaBase + 2}`\n    };\n    \n    console.log(`Limpiando franja ${index + 1}: ${franja.hora} - Celdas: ${JSON.stringify(rangoCeldas)}`);\n    \n    // Para cancelaci칩n, todos los valores son vac칤os\n    actualizaciones.push(\n      { celda: rangoCeldas.proveedor, valor: \"\", nombreHoja },\n      { celda: rangoCeldas.ordenCompra, valor: \"\", nombreHoja },\n      { celda: rangoCeldas.peso, valor: \"\", nombreHoja },\n      { celda: rangoCeldas.categoria, valor: \"\", nombreHoja },\n      { celda: rangoCeldas.unidades, valor: \"\", nombreHoja }\n    );\n  });\n  \n  return actualizaciones;\n}\n\n// Ejecutar la l칩gica de cancelaci칩n\nconst franjasACancelar = calcularFranjasOcupadas();\n\nif (franjasACancelar.length === 0) {\n  return {\n    json: {\n      error: true,\n      mensaje: \"No se pudieron identificar las franjas de la cita para cancelar\",\n      datosValidacion\n    }\n  };\n}\n\n// Usar la semana de la ubicaci칩n encontrada\nconst nombreHojaActual = ubicacionCita.malla;\n\n// Procesar las franjas para cancelaci칩n (limpieza)\nconst actualizacionesCancelacion = procesarFranjas(franjasACancelar, nombreHojaActual);\n\n// Preparar el formato para Microsoft Graph\nconst actualizacionesGraph = actualizacionesCancelacion.map(act => ({\n  address: act.celda,\n  values: [[act.valor]], // Valores vac칤os para cancelaci칩n\n  nombreHoja: act.nombreHoja\n}));\n\n// Preparar el resultado\nreturn {\n  json: {\n    success: true,\n    accion: \"CANCELACION\",\n    mensaje: `Preparadas ${actualizacionesCancelacion.length} operaciones de limpieza para cancelar la cita ID ${citaBD.id}`,\n    nombreHoja: nombreHojaActual,\n    citaCancelada: {\n      id: citaBD.id,\n      proveedor: citaBD.nombre,\n      ordenCompra: citaBD.ordenCompra,\n      ubicacion: ubicacionCita\n    },\n    graphRequestData: {\n      updates: actualizacionesGraph\n    },\n    detalles: {\n      actualizacionesDetalladas: actualizacionesCancelacion,\n      franjasLimpiadas: franjasACancelar.length,\n      informacionCita: {\n        id: citaBD.id,\n        dia: ubicacionCita.dia,\n        hora: ubicacionCita.hora,\n        muelle: ubicacionCita.muelle,\n        proveedor: citaBD.nombre,\n        ordenCompra: citaBD.ordenCompra\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3296,
        6496
      ],
      "id": "1ede2689-c651-4eea-bf8d-bf633bff417c",
      "name": "Code (Preparar Cuerpo de Petici칩n)2"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo modificado para \"Code Agrupar Franjas3\" - CANCELACI칍N\n// Ahora devuelve los valores individuales igual que en crear cita\nconst input = $input.first().json;\n\n// Verificar que tenemos la estructura esperada\nif (!input || !input.graphRequestData || !input.graphRequestData.updates) {\n  console.log('Estructura de datos de entrada no v치lida');\n  return {\n    json: {\n      error: \"FORMATO_INVALIDO\",\n      mensaje: \"La estructura de datos de entrada no es v치lida\"\n    }\n  };\n}\n\nconst updates = input.graphRequestData.updates;\nconst resultados = [];\n\n// Recorremos cada actualizaci칩n y creamos un item individual\nupdates.forEach((update, index) => {\n  // Para cancelaci칩n, el valor siempre es vac칤o\n  resultados.push({\n    json: {\n      valor: \"\", // Siempre vac칤o para cancelaci칩n\n      indice: Math.floor(index / 5) + 1, // Agrupar cada 5 items como una franja\n      nombreHoja: input.nombreHoja,\n      address: update.address,\n      informacionCita: input.detalles?.informacionCita || {},\n      accion: \"CANCELACION\"\n    }\n  });\n});\n\nconsole.log(`Se prepararon ${resultados.length} operaciones de limpieza para cancelaci칩n`);\nreturn resultados;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3488,
        6496
      ],
      "id": "84e60d8e-7f58-43bd-9421-c892304efa96",
      "name": "Code Agrupar Franjas3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3792,
        6496
      ],
      "id": "ff4bb74a-9ca0-4784-b7fa-dacfe2d58730",
      "name": "Loop Over Uno a Uno2"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para preparar cada limpieza (cancelaci칩n) para Microsoft Graph API\nconst input = $input.first().json;\n\n// Constantes para los IDs de SharePoint/OneDrive\nconst siteId = \"gexpresscargo.sharepoint.com,a592f886-4560-4e62-9646-1eee7add7abe,8b514073-41ae-4619-8f76-724bd912bc65\";\nconst driveId = \"b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8\";\nconst itemId = \"01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME\";\n\n// Verificar que tenemos la estructura esperada (igual que en crear cita)\nif (!input || input.valor === undefined || !input.address || !input.nombreHoja) {\n  console.log('Estructura de datos de entrada no v치lida para la cancelaci칩n');\n  return {\n    json: {\n      error: \"FORMATO_INVALIDO\",\n      mensaje: \"La estructura de datos de entrada no es v치lida para la cancelaci칩n\"\n    }\n  };\n}\n\n// Para cancelaci칩n, siempre usamos valor vac칤o\nconst valorFormateado = [[\"\"]];\n\n// Generar un ID 칰nico para esta solicitud\nconst requestId = `cancelacion_${input.address}_${input.indice}_${Date.now()}`;\n\n// Crear la estructura de solicitud para Microsoft Graph $batch\nconst requestBody = {\n  requests: [\n    {\n      id: requestId,\n      method: \"PATCH\",\n      url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(input.nombreHoja)}/range(address='${input.address}')`,\n      body: {\n        values: valorFormateado // Siempre [[\"\"]] para limpiar\n      },\n      headers: {\n        \"Content-Type\": \"application/json\"\n      }\n    }\n  ],\n  _metadata: {\n    celda: input.address,\n    valor: \"\", // Vac칤o para cancelaci칩n\n    indice: input.indice,\n    accion: input.accion || \"CANCELACION\",\n    informacionCita: input.informacionCita || {}\n  }\n};\n\nconsole.log(`Preparada solicitud ${requestId} para limpiar celda ${input.address} en la hoja \"${input.nombreHoja}\"`);\n\n// Retornar el objeto request listo para ser enviado a Microsoft Graph $batch\nreturn {\n  json: requestBody\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4048,
        6608
      ],
      "id": "03494b3f-9ae9-43b7-975c-96bb4d3b7995",
      "name": "Code Preparar cada Insercion2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.microsoft.com/v1.0/$batch",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4288,
        6608
      ],
      "id": "7c3984fe-095e-4ce2-8a7b-6405d2fdb204",
      "name": "HTTP Request Actualizar Excel2",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para verificar si la limpieza fue exitosa (cancelaci칩n)\nconst input = $input.first().json;\n\n// Verificar que tenemos la estructura esperada en la respuesta\nif (!input || !input.responses || !Array.isArray(input.responses) || input.responses.length === 0) {\n  console.log('Estructura de datos de respuesta no v치lida');\n  return {\n    json: {\n      error: \"RESPUESTA_INVALIDA\",\n      mensaje: \"La estructura de datos de la respuesta no es v치lida\",\n      exito: false\n    }\n  };\n}\n\n// Obtener la primera respuesta\nconst response = input.responses[0];\n\n// Extraer informaci칩n de la solicitud original del ID\nconst idPartes = response.id.split('_');\nconst tipoOperacion = idPartes[0]; // \"cancelacion\"\nconst celdaOriginal = idPartes[1];\nconst indice = idPartes[2];\n\n// Verificar que la respuesta tiene un cuerpo\nif (!response.body || !response.body.address) {\n  console.log(`Error: La respuesta no contiene informaci칩n sobre la direcci칩n de celda`);\n  return {\n    json: {\n      error: \"RESPUESTA_SIN_DIRECCION\",\n      mensaje: \"La respuesta no incluye informaci칩n sobre la direcci칩n de celda\",\n      requestId: response.id,\n      status: response.status,\n      celdaOriginal: celdaOriginal,\n      exito: false\n    }\n  };\n}\n\n// Extraer la direcci칩n de celda de la respuesta\nlet direccionRespuesta = \"\";\nif (response.body && response.body.address) {\n  const partesDireccion = response.body.address.split('!');\n  if (partesDireccion.length > 1) {\n    direccionRespuesta = partesDireccion[1];\n  }\n}\n\n// Obtener el valor de la respuesta (debe ser vac칤o para cancelaci칩n)\nconst valorRespuesta = response.body.values && response.body.values[0] && response.body.values[0][0];\n\n// Verificar si la operaci칩n se realiz칩 en la celda correcta\nconst celdaCorrecta = direccionRespuesta === celdaOriginal;\n\n// Verificar el c칩digo de estado HTTP\nconst estadoExitoso = response.status >= 200 && response.status < 300;\n\n// Para cancelaci칩n, tambi칠n verificamos que el valor sea vac칤o\nconst valorCorrecto = tipoOperacion === \"cancelacion\" ? valorRespuesta === \"\" : true;\n\n// Crear objeto para almacenar el resultado de la verificaci칩n\nconst resultado = {\n  exito: celdaCorrecta && estadoExitoso && valorCorrecto,\n  tipoOperacion: tipoOperacion,\n  celdaOriginal: celdaOriginal,\n  celdaInsertada: direccionRespuesta,\n  valorInsertado: valorRespuesta,\n  statusCode: response.status,\n  requestId: response.id,\n  indice: indice,\n  celdasDiferentes: !celdaCorrecta && estadoExitoso,\n  falloEstado: !estadoExitoso,\n  falloValor: !valorCorrecto\n};\n\nconst chatId = $('Organiza el Mensaje').first().json.infoMensaje.chat_id;\n\nif (!resultado.exito) {\n  console.log(`Error en ${tipoOperacion}: celda=${celdaOriginal}, insertada=${direccionRespuesta}, status=${response.status}, valor=\"${valorRespuesta}\"`);\n} else {\n  console.log(`${tipoOperacion} exitosa en celda ${celdaOriginal}`);\n}\n\n// Incluir la respuesta original para tener toda la informaci칩n\nresultado.respuestaOriginal = response;\n\n// Retornar el resultado de la verificaci칩n\nreturn {\n  json: resultado,\n  chat_id: chatId\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4528,
        6608
      ],
      "id": "9722430e-186b-4451-a06b-020bd2980b9e",
      "name": "Code Verificar Inserci칩n2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fb1eda05-eb5e-4683-8556-1cf2b5b8e4d5",
              "leftValue": "={{ $json.exito }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4768,
        6656
      ],
      "id": "6146606c-bad2-462c-a33e-61aa03294a40",
      "name": "If Verificar Inserci칩n2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "15a95144-dd82-4ea5-b9ba-9eb924d2ae5c",
              "leftValue": "={{ $json.celdasDiferentes }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4992,
        6736
      ],
      "id": "9c20b873-affc-4b08-a0a2-e38f1416547c",
      "name": "If Diferente Caso2"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para limpiar una celda donde se insert칩 incorrectamente un valor\n// Actualizado para manejar la nueva estructura con operaciones de inserci칩n y eliminaci칩n\nconst input = $input.first().json;\n\n// Constantes para los IDs de SharePoint/OneDrive\nconst siteId = \"gexpresscargo.sharepoint.com,a592f886-4560-4e62-9646-1eee7add7abe,8b514073-41ae-4619-8f76-724bd912bc65\";\nconst driveId = \"b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8\";\nconst itemId = \"01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME\";\n\n// Verificar que tenemos la informaci칩n necesaria\nif (!input || (!input.operaciones && !input.celdaInsertada)) {\n  console.log('Informaci칩n insuficiente para limpiar la celda incorrecta');\n  return {\n    json: {\n      error: \"INFORMACION_INSUFICIENTE\",\n      mensaje: \"No hay suficiente informaci칩n para limpiar la celda incorrecta\"\n    }\n  };\n}\n\n// Determinar qu칠 celdas necesitan limpieza\nconst celdasALimpiar = [];\n\n// Verificar si estamos usando la nueva estructura con operaciones\nif (input.operaciones) {\n  // Nueva estructura: usar informaci칩n de las operaciones\n  const { insercion, eliminacion } = input.operaciones;\n  \n  // Si la inserci칩n fall칩, agregarla para limpieza\n  if (insercion && !insercion.exito && insercion.celdaRespuesta) {\n    celdasALimpiar.push({\n      celda: insercion.celdaRespuesta,\n      hoja: insercion.hoja || \"\"\n    });\n  }\n  \n  // Si la eliminaci칩n fall칩, agregarla para limpieza\n  if (eliminacion && !eliminacion.exito && eliminacion.celdaRespuesta) {\n    celdasALimpiar.push({\n      celda: eliminacion.celdaRespuesta,\n      hoja: eliminacion.hoja || \"\"\n    });\n  }\n} else {\n  // Estructura anterior: solo tenemos informaci칩n de inserci칩n\n  // Obtener la celda a limpiar y la informaci칩n de la hoja\n  const celdaALimpiar = input.celdaInsertada;\n  let hojaExcel = input.nombreHoja || \"\"; // Usar el nombreHoja del input\n  \n  // Intentar extraer el nombre de la hoja de la direcci칩n en la respuesta si no est치 disponible\n  if ((!hojaExcel || hojaExcel === \"\") && input.respuestaOriginal?.body?.address) {\n    const direccionCompleta = input.respuestaOriginal.body.address;\n    hojaExcel = direccionCompleta.split('!')[0].replace(/'/g, '');\n  }\n  \n  celdasALimpiar.push({\n    celda: celdaALimpiar,\n    hoja: hojaExcel\n  });\n}\n\n// Si no hay celdas para limpiar, devolver error\nif (celdasALimpiar.length === 0) {\n  console.log('No se identificaron celdas para limpiar');\n  return {\n    json: {\n      error: \"NO_HAY_CELDAS\",\n      mensaje: \"No se identificaron celdas que necesiten limpieza\",\n      input: input\n    }\n  };\n}\n\n// Crear solicitudes para limpiar cada celda identificada\nconst solicitudes = celdasALimpiar.map((info, index) => {\n  console.log(`Limpiando celda incorrecta ${info.celda} en hoja ${info.hoja}`);\n  \n  return {\n    id: `Limpiar_${info.celda}_${Date.now()}_${index}`,\n    method: \"PATCH\",\n    url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(info.hoja)}/range(address='${info.celda}')`,\n    body: {\n      values: [[\"\"]] // Valor vac칤o para limpiar la celda\n    },\n    headers: {\n      \"Content-Type\": \"application/json\"\n    }\n  };\n});\n\n// Crear la solicitud para limpiar las celdas\nconst requestBody = {\n  requests: solicitudes,\n  _metadata: {\n    accion: \"limpiar\",\n    celdasLimpiadas: celdasALimpiar,\n    datoOriginal: input\n  }\n};\n\n// Retornar el request para limpiar la celda\nreturn {\n  json: requestBody\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5296,
        6560
      ],
      "id": "ef437ff4-c64d-4379-95f9-6fcc4b77812c",
      "name": "Code Limpiar Celda Incorrecta2",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.microsoft.com/v1.0/$batch",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5520,
        6560
      ],
      "id": "8bbc1aef-34be-4fec-bce6-caffa74de4c1",
      "name": "HTTP Request Limpiar Celda2",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e570827e-13d0-4d6f-b23e-184ca2d3368c",
              "leftValue": "={{ $json.falloEstado }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5456,
        6944
      ],
      "id": "97409cec-c45c-4b38-8880-918c9a2d63cf",
      "name": "If fallo Estado2"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para reintentar la inserci칩n en la celda correcta\n// Actualizado para manejar la nueva estructura con operaciones de inserci칩n y eliminaci칩n\nconst input = $input.first().json;\n\n// Constantes para los IDs de SharePoint/OneDrive\nconst siteId = \"gexpresscargo.sharepoint.com,a592f886-4560-4e62-9646-1eee7add7abe,8b514073-41ae-4619-8f76-724bd912bc65\";\nconst driveId = \"b!hviSpWBFYk6WRh7uet16vnNAUYuuQRlGj3ZyS9kSvGVZ4DSg6c5MRqYYm2MdAER8\";\nconst itemId = \"01PPLUUYXY5E2GK3SJ25EZLJPUYJ43H3ME\";\n\n// Si el input viene del nodo anterior de limpiar celda, extraer el dato original\nconst datoOriginal = input._metadata?.datoOriginal || input;\n\n// Verificar que tenemos la informaci칩n necesaria\nif (!datoOriginal) {\n  console.log('Informaci칩n insuficiente para reintentar la inserci칩n/eliminaci칩n');\n  return {\n    json: {\n      error: \"INFORMACION_INSUFICIENTE\",\n      mensaje: \"No hay suficiente informaci칩n para reintentar las operaciones\"\n    }\n  };\n}\n\n// Operaciones a reintentar\nconst operacionesAReintentar = [];\n\n// Determinar qu칠 operaciones necesitan reintento\nif (datoOriginal.operaciones) {\n  // Nueva estructura: evaluar inserci칩n y eliminaci칩n\n  const { insercion, eliminacion } = datoOriginal.operaciones;\n  \n  // Verificar si la inserci칩n necesita reintento\n  if (insercion && !insercion.exito) {\n    operacionesAReintentar.push({\n      tipo: \"insercion\",\n      celda: insercion.celda,\n      valor: insercion.valor,\n      hoja: insercion.hoja || datoOriginal.resultadoDetallado?.operaciones?.insercion?.hoja || \"\"\n    });\n  }\n  \n  // Verificar si la eliminaci칩n necesita reintento\n  if (eliminacion && !eliminacion.exito) {\n    operacionesAReintentar.push({\n      tipo: \"eliminacion\",\n      celda: eliminacion.celda,\n      valor: \"\", // Para eliminaci칩n, siempre usamos valor vac칤o\n      hoja: eliminacion.hoja || datoOriginal.resultadoDetallado?.operaciones?.eliminacion?.hoja || \"\"\n    });\n  }\n} else {\n  // Estructura anterior: solo tenemos informaci칩n de inserci칩n\n  // Obtener la celda correcta donde insertar y el valor a insertar\n  const celdaCorrecta = datoOriginal.celdaOriginal;\n  \n  // Intentar obtener el valor correcto a insertar\n  let valorAInsertar;\n  \n  // Primero, verificar si tenemos el valor de la respuesta original\n  if (datoOriginal.valorInsertado !== undefined) {\n    valorAInsertar = datoOriginal.valorInsertado;\n  } \n  // Si no, intentar obtenerlo del body de la respuesta\n  else if (datoOriginal.respuestaOriginal?.body?.values?.[0]?.[0] !== undefined) {\n    valorAInsertar = datoOriginal.respuestaOriginal.body.values[0][0];\n  } \n  // Como 칰ltimo recurso, usar un valor vac칤o\n  else {\n    valorAInsertar = \"\";\n    console.log('No se pudo determinar el valor a insertar, usando valor vac칤o');\n  }\n  \n  // Obtener la hoja de Excel - primero del dato original\n  let hojaExcel = datoOriginal.nombreHoja || \"\"; \n  \n  // Si no est치 disponible en el objeto principal, intentar obtenerlo de otros lugares\n  if (!hojaExcel || hojaExcel === \"\") {\n    // Verificar si est치 en el _metadata\n    hojaExcel = input._metadata?.hoja || \"\";\n    \n    // Como 칰ltimo recurso, extraer de la direcci칩n en la respuesta\n    if ((!hojaExcel || hojaExcel === \"\") && datoOriginal.respuestaOriginal?.body?.address) {\n      const direccionCompleta = datoOriginal.respuestaOriginal.body.address;\n      hojaExcel = direccionCompleta.split('!')[0].replace(/'/g, '');\n    }\n  }\n  \n  operacionesAReintentar.push({\n    tipo: \"insercion\",\n    celda: celdaCorrecta,\n    valor: valorAInsertar,\n    hoja: hojaExcel\n  });\n}\n\n// Si no hay operaciones para reintentar, devolver error\nif (operacionesAReintentar.length === 0) {\n  console.log('No se identificaron operaciones para reintentar');\n  return {\n    json: {\n      error: \"NO_HAY_OPERACIONES\",\n      mensaje: \"No se identificaron operaciones que necesiten reintento\",\n      input: datoOriginal\n    }\n  };\n}\n\n// Crear solicitudes para cada operaci칩n a reintentar\nconst solicitudes = operacionesAReintentar.map((op, index) => {\n  // Determinar el tipo de valor y formatearlo adecuadamente\n  let valorFormateado;\n  if (typeof op.valor === 'number') {\n    valorFormateado = [[op.valor]]; // Mantener el tipo num칠rico\n  } else {\n    valorFormateado = [[op.valor.toString()]]; // Convertir a string para otros tipos\n  }\n  \n  console.log(`Reintentando ${op.tipo} en celda ${op.celda} de la hoja ${op.hoja} con valor \"${op.valor}\"`);\n  \n  return {\n    id: `Reintento_${op.tipo}_${op.celda}_${Date.now()}_${index}`,\n    method: \"PATCH\",\n    url: `/sites/${siteId}/drives/${driveId}/items/${itemId}/workbook/worksheets/${encodeURIComponent(op.hoja)}/range(address='${op.celda}')`,\n    body: {\n      values: valorFormateado\n    },\n    headers: {\n      \"Content-Type\": \"application/json\"\n    }\n  };\n});\n\n// Crear la solicitud para reintentar las operaciones\nconst requestBody = {\n  requests: solicitudes,\n  _metadata: {\n    accion: \"reintentar\",\n    operaciones: operacionesAReintentar,\n    datoOriginal: datoOriginal,\n    intentos: (datoOriginal._metadata?.intentos || 0) + 1\n  }\n};\n\n// Retornar el request para reintentar las operaciones\nreturn {\n  json: requestBody\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5792,
        6624
      ],
      "id": "d81eccd9-13a3-4e63-97a8-53eb423007d7",
      "name": "Code Reintentar Inserci칩n2",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.microsoft.com/v1.0/$batch",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "microsoftOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6032,
        6736
      ],
      "id": "9cae734c-98dd-4412-b8f2-95beba442998",
      "name": "HTTP Request Reintentar Inserci칩n2",
      "credentials": {
        "microsoftOAuth2Api": {
          "id": "mh8Z8hxFvd7LDO8D",
          "name": "CuentaMy SharePoint App Desarrollador1 Konfie "
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para verificar si la inserci칩n y eliminaci칩n fueron exitosas\n// Actualizado para manejar la nueva estructura\nconst input = $input.first().json;\n\n// Verificar que tenemos la estructura esperada en la respuesta\nif (!input || !input.responses || !Array.isArray(input.responses)) {\n  console.log('Estructura de datos de respuesta no v치lida');\n  return {\n    json: {\n      error: \"RESPUESTA_INVALIDA\",\n      mensaje: \"La estructura de datos de la respuesta no es v치lida\",\n      exito: false\n    }\n  };\n}\n\n// Si no hay respuestas, devolver error\nif (input.responses.length === 0) {\n  console.log('No se recibieron respuestas del servidor');\n  return {\n    json: {\n      error: \"SIN_RESPUESTAS\",\n      mensaje: \"No se recibieron respuestas del servidor\",\n      exito: false\n    }\n  };\n}\n\n// Analizar las respuestas para determinar a qu칠 operaci칩n corresponde cada una\nconst respuestas = input.responses.map(response => {\n  // Extraer informaci칩n del ID de la respuesta\n  const idPartes = response.id.split('_');\n  const tipoOperacion = idPartes[0].toLowerCase(); // \"reintento\", \"limpiar\", etc.\n  const tipoEntidad = idPartes[1]?.toLowerCase(); // \"insercion\", \"eliminacion\", etc.\n  const celda = idPartes[2] || \"\"; // La celda como I21, K23, etc.\n  \n  // Extraer informaci칩n de la direcci칩n en la respuesta\n  let direccionRespuesta = \"\";\n  let hojaExcel = \"\";\n  \n  if (response.body && response.body.address) {\n    const direccionCompleta = response.body.address;\n    const partesDireccion = direccionCompleta.split('!');\n    \n    if (partesDireccion.length > 1) {\n      // Quitar las comillas simples del nombre de la hoja\n      hojaExcel = partesDireccion[0].replace(/'/g, '');\n      direccionRespuesta = partesDireccion[1];\n    }\n  }\n  \n  // Obtener el valor de la respuesta\n  const valor = response.body?.values?.[0]?.[0];\n  \n  // Verificar si la operaci칩n fue exitosa (c칩digo 200-299)\n  const estadoExitoso = response.status >= 200 && response.status < 300;\n  \n  // Verificar si la celda en la respuesta coincide con la esperada\n  const celdaCorrecta = direccionRespuesta === celda;\n  \n  return {\n    id: response.id,\n    tipoOperacion,\n    tipoEntidad,\n    celda,\n    direccionRespuesta,\n    hoja: hojaExcel,\n    valor,\n    estadoExitoso,\n    celdaCorrecta,\n    statusCode: response.status,\n    respuesta: response\n  };\n});\n\n// Separar las respuestas por tipo de operaci칩n\nconst respuestasInsercion = respuestas.filter(r => \n  r.tipoEntidad === \"insercion\" || \n  (r.tipoOperacion === \"reintento\" && input._metadata?.operaciones?.[0]?.tipo === \"insercion\")\n);\n\nconst respuestasEliminacion = respuestas.filter(r => \n  r.tipoEntidad === \"eliminacion\" || \n  (r.tipoOperacion === \"reintento\" && input._metadata?.operaciones?.[0]?.tipo === \"eliminacion\")\n);\n\n// Determinar 칠xito por tipo de operaci칩n\nconst insercionExitosa = respuestasInsercion.length > 0 && \n                        respuestasInsercion.every(r => r.estadoExitoso && r.celdaCorrecta);\n\nconst eliminacionExitosa = respuestasEliminacion.length > 0 && \n                          respuestasEliminacion.every(r => r.estadoExitoso && r.celdaCorrecta);\n\n// Determinar 칠xito global basado en las operaciones presentes\nlet exitoGlobal;\n\nif (respuestasInsercion.length > 0 && respuestasEliminacion.length > 0) {\n  // Si hay ambas operaciones, ambas deben ser exitosas\n  exitoGlobal = insercionExitosa && eliminacionExitosa;\n} else if (respuestasInsercion.length > 0) {\n  // Si solo hay inserci칩n, solo esa debe ser exitosa\n  exitoGlobal = insercionExitosa;\n} else if (respuestasEliminacion.length > 0) {\n  // Si solo hay eliminaci칩n, solo esa debe ser exitosa\n  exitoGlobal = eliminacionExitosa;\n} else {\n  // Si no hay operaciones identificables, considerar como no exitoso\n  exitoGlobal = false;\n}\n\n// Obtener la informaci칩n m치s relevante para cada tipo de operaci칩n\nconst infoInsercion = respuestasInsercion.length > 0 ? respuestasInsercion[0] : null;\nconst infoEliminacion = respuestasEliminacion.length > 0 ? respuestasEliminacion[0] : null;\n\n// Crear el resultado detallado\nconst resultadoDetallado = {\n  exito: exitoGlobal,\n  operaciones: {\n    insercion: infoInsercion ? {\n      exito: infoInsercion.estadoExitoso && infoInsercion.celdaCorrecta,\n      celda: infoInsercion.celda,\n      direccionRespuesta: infoInsercion.direccionRespuesta,\n      hoja: infoInsercion.hoja,\n      valor: infoInsercion.valor,\n      statusCode: infoInsercion.statusCode\n    } : null,\n    eliminacion: infoEliminacion ? {\n      exito: infoEliminacion.estadoExitoso && infoEliminacion.celdaCorrecta,\n      celda: infoEliminacion.celda,\n      direccionRespuesta: infoEliminacion.direccionRespuesta,\n      hoja: infoEliminacion.hoja,\n      valor: infoEliminacion.valor,\n      statusCode: infoEliminacion.statusCode\n    } : null\n  },\n  mensaje: exitoGlobal ? \n    \"Todas las operaciones se completaron exitosamente\" : \n    \"Hubo problemas con una o m치s operaciones\",\n  respuestasCompletas: respuestas\n};\n\n// Crear el resultado compatible con el formato anterior\nconst resultadoCompatible = {\n  exito: exitoGlobal,\n  // Usar la primera respuesta para compatibilidad\n  celdaOriginal: infoInsercion?.celda || infoEliminacion?.celda || \"\",\n  celdaInsertada: infoInsercion?.direccionRespuesta || infoEliminacion?.direccionRespuesta || \"\",\n  valorInsertado: infoInsercion?.valor || infoEliminacion?.valor || \"\",\n  statusCode: infoInsercion?.statusCode || infoEliminacion?.statusCode || 0,\n  requestId: infoInsercion?.id || infoEliminacion?.id || \"\",\n  indice: infoInsercion?.celda || infoEliminacion?.celda || \"\",\n  celdasDiferentes: (infoInsercion && infoInsercion.celda !== infoInsercion.direccionRespuesta) ||\n                   (infoEliminacion && infoEliminacion.celda !== infoEliminacion.direccionRespuesta),\n  falloEstado: !exitoGlobal,\n  // Informaci칩n adicional para la versi칩n mejorada\n  resultadoDetallado: resultadoDetallado\n};\n\n// Registrar el resultado en consola\nif (exitoGlobal) {\n  console.log(\"Operaciones completadas exitosamente:\");\n  if (infoInsercion) {\n    console.log(`- Inserci칩n en hoja ${infoInsercion.hoja}, celda ${infoInsercion.celda}, valor: \"${infoInsercion.valor}\"`);\n  }\n  if (infoEliminacion) {\n    console.log(`- Eliminaci칩n en hoja ${infoEliminacion.hoja}, celda ${infoEliminacion.celda}`);\n  }\n} else {\n  console.log(\"Problemas detectados en las operaciones:\");\n  if (infoInsercion && (!infoInsercion.estadoExitoso || !infoInsercion.celdaCorrecta)) {\n    console.log(`- Fallo en inserci칩n: celda=${infoInsercion.celda}, direcci칩n respuesta=${infoInsercion.direccionRespuesta}, status=${infoInsercion.statusCode}`);\n  }\n  if (infoEliminacion && (!infoEliminacion.estadoExitoso || !infoEliminacion.celdaCorrecta)) {\n    console.log(`- Fallo en eliminaci칩n: celda=${infoEliminacion.celda}, direcci칩n respuesta=${infoEliminacion.direccionRespuesta}, status=${infoEliminacion.statusCode}`);\n  }\n}\n\n// Retornar el resultado\nreturn {\n  json: resultadoCompatible\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6256,
        6736
      ],
      "id": "73b6429d-b7e0-4d42-8607-47c75509cda9",
      "name": "Code Volver a validar Inserci칩n2",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f7205e4e-147c-4e77-8fa8-08d082980b48",
              "leftValue": "={{ $json.exito }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6480,
        6736
      ],
      "id": "ceca419e-8df7-4500-a67b-455797b35361",
      "name": "If Verificar Inserci칩n 1"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        5376,
        6736
      ],
      "id": "e6615b78-29a2-45c8-9335-a961b969fcf6",
      "name": "Wait6",
      "webhookId": "a4bbf2b1-ea0c-4b02-af2c-64b29f2bdb5c"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        6768,
        6928
      ],
      "id": "83aff37d-7d86-448a-b8ae-65f4429ac197",
      "name": "Wait7",
      "webhookId": "9d944db7-9c4f-439e-9990-d9937f2fb18e"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        7216,
        7280
      ],
      "id": "96d25067-2424-4b9d-83ec-cc6ae1049661",
      "name": "OpenAI Chat Model18",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=Eres un asistente de un sistema de agendamiento de citas para la entrega de mercanc칤a en bodega. Debes notificar al cliente que ha ocurrido un error en el sistema durante el proceso de cancelaci칩n de la cita.\n\nGenera un mensaje directo aplicando estos principios de UX para WhatsApp:\n\n**FORMATO Y ESTRUCTURA:**\n1. Usa *negritas* para informaci칩n cr칤tica como tiempo l칤mite y acciones urgentes\n2. Usa emojis estrat칠gicos: 游뚿 (urgente), 丘멆잺 (error), 낋 (tiempo l칤mite), 游 (contacto), 游멆잺 (t칠cnico), 游뛂 (cancelaci칩n)\n3. Estructura la informaci칩n de forma jer치rquica y visual\n4. Destaca el tiempo l칤mite de *5 minutos* con formato apropiado\n\n**CONTENIDO REQUERIDO:**\n1. 游뚿 Comunica claramente que ocurri칩 un *error t칠cnico* al cancelar la cita\n2. 낋 Indica urgentemente que se comunique con el 치rea de bodega en los pr칩ximos *5 minutos*\n3. 游뛂 Solicita que cancelen la cita *manualmente* por este inconveniente\n4. 游멆잺 Aclara que es una situaci칩n *poco com칰n* por inconveniente t칠cnico\n5. 游똂 Pide disculpas y agradece la comprensi칩n\n\n**TONO:** Urgente pero profesional, enfatizando acci칩n inmediata para completar la cancelaci칩n.\n\n**EJEMPLO DE ESTRUCTURA ESPERADA:**\n游뚿 *Error t칠cnico en cancelaci칩n*\n\n丘멆잺 No pudimos cancelar tu cita debido a un *inconveniente t칠cnico* en el sistema.\n\n낋 *URGENTE:* Comun칤cate con el 치rea de bodega en los pr칩ximos *5 minutos* para que puedan *cancelar tu cita manualmente*.\n\n游멆잺 Esta situaci칩n es *poco com칰n* y se debe a un inconveniente t칠cnico...\n\n游똂 Disculpas por los inconvenientes...\n"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        7296,
        7056
      ],
      "id": "5b4ffdfa-2763-45ee-b41c-612346742c0a",
      "name": "Basic LLM Notificar No Disponibilidad4",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Basic LLM Notificar No Disponibilidad4').item.json.text.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7696,
        7248
      ],
      "id": "9190e18e-039b-43e0-b419-54cf81f0065e",
      "name": "Validaci칩n de longitud de caracteres16"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad4').item.json.text }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Basic LLM Notificar No Disponibilidad4').item.json.text.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8000,
        7264
      ],
      "id": "181effde-7336-4d9f-81d6-bb9e3f87e914",
      "name": "Organiza variables del mensaje15"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        8176,
        7040
      ],
      "id": "1bd95b08-30ab-4156-87da-a36e4523a197",
      "name": "No Operation, do nothing20"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8000,
        7040
      ],
      "id": "bda2cc37-7fa3-4f21-95c2-edc3cc36c645",
      "name": "HTTP Request Enviar Mensaje por WhatsApp19"
    },
    {
      "parameters": {
        "jsCode": "/*\n===========================================================\n  Nodo Code - VALIDAR INSERCIONES EN EXCEL (n8n)\n   Analiza la salida del Loop Over Uno a Uno.\n   Agrupa los 칤tems por franja (campo `indice` si existe;\n    de lo contrario, cada bloque de 5 칤tems forma una franja).\n   Verifica que cada inserci칩n tenga:\n        exito === true\n        statusCode === 200\n        falloEstado === false\n   Devuelve un 칰nico objeto JSON con:\n         Resumen global.\n         Detalle por franja (칠xitos / fallos y celdas con error).\n===========================================================\n*/\n\n// 1) Obtener todos los 칤tems que llegan al nodo\nconst items = $input.all();\n\n// 2) Funci칩n auxiliar para determinar el identificador de la franja\nfunction obtenerIdFranja(item, idx) {\n  // Si existe 'indice', 칰salo; de lo contrario agrupa cada 5 칤tems\n  if (item.json && item.json.indice !== undefined && item.json.indice !== null) {\n    return String(item.json.indice).trim();\n  }\n  // +1 para que las franjas queden 1-basadas\n  return String(Math.floor(idx / 5) + 1);\n}\n\n// 3) Agrupar 칤tems por franja\nconst franjas = {};\nitems.forEach((item, idx) => {\n  const idFranja = obtenerIdFranja(item, idx);\n  if (!franjas[idFranja]) {\n    franjas[idFranja] = { id: idFranja, items: [] };\n  }\n  franjas[idFranja].items.push(item.json);\n});\n\n// 4) Analizar cada franja y construir el detalle\nconst detallesPorFranja = Object.values(franjas).map(franja => {\n  const totalOps   = franja.items.length;\n  const exitosas   = franja.items.filter(i =>\n    i.exito === true &&\n    i.statusCode === 200 &&\n    i.falloEstado === false\n  ).length;\n\n  const fallidas   = totalOps - exitosas;\n  const exitoTotal = fallidas === 0;\n\n  // Celdas con error para un diagn칩stico claro\n  const celdasFallidas = franja.items\n    .filter(i => !(i.exito && i.statusCode === 200 && !i.falloEstado))\n    .map(i => ({\n      celdaOriginal   : i.celdaOriginal,\n      celdaInsertada  : i.celdaInsertada,\n      statusCode      : i.statusCode,\n      falloEstado     : i.falloEstado,\n      celdasDiferentes: i.celdasDiferentes,\n      mensaje         : 'Inserci칩n fallida'\n    }));\n\n  return {\n    idFranja                : franja.id,\n    exitoFranja             : exitoTotal,\n    operacionesTotales      : totalOps,\n    operacionesExitosas     : exitosas,\n    operacionesFallidas     : fallidas,\n    porcentajeExitosas      : ((exitosas / totalOps) * 100).toFixed(2) + '%',\n    celdasFallidas\n  };\n});\n\n// 5) Resumen global\nconst operacionesTotales   = items.length;\nconst operacionesExitosas  = detallesPorFranja.reduce((sum, f) => sum + f.operacionesExitosas, 0);\nconst operacionesFallidas  = operacionesTotales - operacionesExitosas;\n\nconst franjasTotales   = detallesPorFranja.length;\nconst franjasExitosas  = detallesPorFranja.filter(f => f.exitoFranja).length;\nconst franjasFallidas  = franjasTotales - franjasExitosas;\n\n\nconst resumen = {\n  estadoGeneral              : franjasFallidas === 0 ? '칄XITO_COMPLETO' : '칄XITO_PARCIAL',\n  franjasTotales,\n  franjasExitosas,\n  franjasFallidas,\n  porcentajeFranjasExitosas  : ((franjasExitosas / franjasTotales) * 100).toFixed(2) + '%',\n  operacionesTotales,\n  operacionesExitosas,\n  operacionesFallidas,\n  porcentajeOperacionesExitosas : ((operacionesExitosas / operacionesTotales) * 100).toFixed(2) + '%',\n  detallesPorFranja\n};\n\n// 6) Devolver un 칰nico 칤tem con el resumen\nreturn [\n  {\n    json: resumen\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4176,
        6400
      ],
      "id": "a3ccd5fa-6939-439e-96ed-45117891539e",
      "name": "Code Validar inserciones2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8c501d95-bdf3-4635-a037-224926c2528d",
              "leftValue": "={{ $json.estadoGeneral }}",
              "rightValue": "칄XITO_COMPLETO",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4592,
        6400
      ],
      "id": "5e7cc10d-8231-478f-a098-c921dc0d26e0",
      "name": "If Validar inserciones2"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        5072,
        6320
      ],
      "id": "ddeda9f6-6249-413c-9740-a65fadcd0fee",
      "name": "Merge6"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        7648,
        6720
      ],
      "id": "f811f9b0-3292-4605-b7b2-b09d931939f9",
      "name": "Merge7"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        7968,
        6816
      ],
      "id": "bd2d33d7-6e27-4c9f-b78e-d8efee492880",
      "name": "OpenAI Chat Model19",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bfbecb3-9d4f-4425-aa76-a92abc7708fb",
              "leftValue": "={{ $('Basic LLM Notificar Cancelar Cita').item.json.text.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8512,
        6784
      ],
      "id": "00906212-b77e-46de-b497-ac3238fce539",
      "name": "Validaci칩n de longitud de caracteres17"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Basic LLM Notificar Cancelar Cita').item.json.text }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Basic LLM Notificar Cancelar Cita').item.json.text.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8816,
        6896
      ],
      "id": "76081124-c697-44c2-897a-c1beaa066710",
      "name": "Organiza variables del mensaje16"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        8976,
        6688
      ],
      "id": "ace76655-395a-4f41-89e4-c56abd62cea0",
      "name": "No Operation, do nothing21"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Code Respuesta Faltantes').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8800,
        6688
      ],
      "id": "36b65692-8b63-4d08-9fef-07459184d4e9",
      "name": "HTTP Request Enviar Mensaje por WhatsApp20"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "BEGIN TRANSACTION;\n\nDELETE FROM MensajesWhatsApp\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n   OR (chat_id = 'agenteAI'\n       AND message_id IN (\n           SELECT message_id \n           FROM MensajesWhatsApp\n           WHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n       )\n   );\n\nDELETE FROM FranjasDisponiblesTemp \nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\n-- Resetear estado conversacional a INICIAL despu칠s de cancelaci칩n exitosa\nUPDATE EstadoConversacional \nSET estado_actual = 'INICIAL', \n    contexto_proceso = '{\"descripcion\": \"Cita cancelada exitosamente, conversaci칩n reiniciada\", \"ultima_accion\": \"cita_cancelada\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    contador_fuera_contexto = 0,\n    ultimo_mensaje_fuera_contexto = NULL,\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\n-- Si no existe el registro, crear uno en estado INICIAL\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}', \n        'INICIAL', \n        '{\"descripcion\": \"Cita cancelada exitosamente, conversaci칩n reiniciada\", \"ultima_accion\": \"cita_cancelada\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\nCOMMIT;\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        7088,
        6944
      ],
      "id": "c269f578-33a7-45f0-adaa-9d300be02576",
      "name": "Microsoft SQL Eliminar Mensajes5",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DECLARE @id           INT = {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.id }};\nDECLARE @nowBogota    DATETIME;\n\n/* Obtener fecha/hora actual en Bogot치 */\nSET @nowBogota = CONVERT(DATETIME, SYSDATETIMEOFFSET() AT TIME ZONE 'SA Pacific Standard Time');\n\n/* UPDATE para CANCELACI칍N */\nUPDATE dbo.CitasRecepcion\nSET estado = N'CANCELADA',\n    fecha_modificacion = @nowBogota\nWHERE id = @id;\n\n/* Devolver la fila modificada */\nSELECT *\nFROM dbo.CitasRecepcion\nWHERE id = @id;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        6720,
        6480
      ],
      "id": "4dba4322-8f75-4f0e-bfbb-7d844b563e13",
      "name": "Microsoft SQLUpdate Cita Anterior1",
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// C칩digo para preparar datos de CANCELACI칍N\nconst datosValidacion = $('Code validaci칩n de cita en malla').first().json.datosValidacion;\nconst citaBD = datosValidacion.citaBD;\nconst chatId = $('Organiza el Mensaje').first().json.infoMensaje.chat_id;\nconst historialMensajes = $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.historialMensajes;\n\nconsole.log(`Preparando datos para cancelaci칩n de cita ID ${citaBD.id}`);\n\nconst datosCancelacion = {\n  // Datos identificadores\n  id: citaBD.id,\n  chat_id: chatId,\n  \n  // Datos de la cita cancelada\n  proveedor: citaBD.nombre,\n  orden_compra: citaBD.ordenCompra,\n  peso: citaBD.peso,\n  unidades: citaBD.unidades,\n  fecha_cita_original: citaBD.fechaCita,\n  \n  // Estado y auditor칤a\n  estado_anterior: \"PROGRAMADA\",\n  estado_nuevo: \"CANCELADA\",\n  chat_historial: historialMensajes,\n  fecha_cancelacion: new Date().toISOString(),\n  \n  // Informaci칩n adicional\n  ubicacion_malla: datosValidacion.ubicacion,\n  accion: \"CANCELACION\",\n  motivo: \"cancelacion_por_proveedor\"\n};\n\nconsole.log(`Cancelaci칩n preparada: ${datosCancelacion.proveedor} - O/C: ${datosCancelacion.orden_compra}`);\n\nreturn {\n  json: datosCancelacion\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4176,
        6176
      ],
      "id": "b1a406c1-8f61-401d-b4ab-166d16786bde",
      "name": "Code Datos Cancelar Cita"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Actualizar estado a CANCELANDO_CITA cuando se est치 procesando la cancelaci칩n\nUPDATE EstadoConversacional \nSET estado_actual = 'CANCELANDO_CITA', \n    contexto_proceso = '{\"descripcion\": \"Procesando cancelaci칩n de cita\", \"id_cita_cancelando\": \"{{ $json.id }}\", \"proveedor\": \"{{ $json.proveedor }}\", \"orden_compra\": \"{{ $json.orden_compra }}\", \"fecha_cita_original\": \"{{ $json.fecha_cita_original }}\", \"accion\": \"cancelacion_en_proceso\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $json.chat_id }}';\n\n-- Si no existe el registro, crear uno nuevo\nIF @@ROWCOUNT = 0\nBEGIN\n    INSERT INTO EstadoConversacional (chat_id, estado_actual, contexto_proceso, fecha_creacion, fecha_actualizacion)\n    VALUES (\n        '{{ $json.chat_id }}', \n        'CANCELANDO_CITA', \n        '{\"descripcion\": \"Procesando cancelaci칩n de cita\", \"id_cita_cancelando\": \"{{ $json.id }}\", \"proveedor\": \"{{ $json.proveedor }}\", \"orden_compra\": \"{{ $json.orden_compra }}\", \"fecha_cita_original\": \"{{ $json.fecha_cita_original }}\", \"accion\": \"cancelacion_en_proceso\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n        GETDATE(),\n        GETDATE()\n    );\nEND\n\n-- Confirmar actualizaci칩n\nSELECT \n  'CANCELANDO_CITA' as nuevo_estado,\n  'CANCELACION_EN_PROCESO' as tipo_actualizacion,\n  '{{ $json.chat_id }}' as chat_id,\n  '{{ $json.id }}' as id_cita,\n  GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        7104,
        6480
      ],
      "id": "f192d557-6fac-473b-a98f-0598cd8b5378",
      "name": "Estado SQL - CANCELANDO_CITA",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# Rol\nEres el asistente virtual de **Konf칤e Logistics**.  \nTu objetivo es notificar al proveedor que su cita se **cancel칩 exitosamente**.\n\n# Datos disponibles  \n- idCita           = {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.id }}  \n- ordenCompra      = {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.ordenCompra }}\n- proveedor        = {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.nombre }}\n- peso             = {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.peso }}\n- unidades         = {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.unidades }}\n- fechaCita        = {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.fechaCita }}\n- ubicacionMalla   = {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.ubicacion }}\n\n# Instrucciones de redacci칩n\n1. Mant칠n un tono profesional, comprensivo y servicial.  \n2. Empieza confirmando la cancelaci칩n exitosa (ej: \"九 Cancelaci칩n confirmada\" o \"游뛂 Cita cancelada exitosamente\").  \n3. Muestra los **detalles de la cita cancelada** con emojis:  \n    游댔 **Cita cancelada:** {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.id }}\n    游녻 **Proveedor:** {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.nombre }}\n    游낑勇 **O/C:** {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.ordenCompra }}\n    游늰 **Fecha programada:** {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.fechaCita }}\n    丘뒲잺 **Peso:** {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.peso }} kg\n    游닍 **Unidades:** {{ $('Code validaci칩n de cita en malla').first().json.datosValidacion.citaBD.unidades }}\n4. Informa que si necesita **agendar una nueva cita**, puede iniciar una nueva conversaci칩n.\n5. Agradece por haber notificado la cancelaci칩n con anticipaci칩n.\n6. Devuelve **solo** el mensaje final, sin encabezados.\n\n# Salida esperada (ejemplo de estilo)\n\n九 *춰Cancelaci칩n exitosa!* 游뛂\n\n游늶 *Datos de la cita cancelada:*\n游 *N칰mero de cita:* ```12345```\n游녻 *Proveedor:* SPB COLOMBIA S.A.S\n游낑勇 *Orden de Compra:* ARGM47896\n游늰 *Fecha programada:* 10 de junio de 2025\n丘뒲잺 *Peso:* 300 kg\n游늵 *Unidades:* 600\n\n游댃 *쯅ecesitas una nueva cita?*\nPuedes iniciar una nueva conversaci칩n cuando gustes.\n\n游똂 *춰Gracias por avisar con anticipaci칩n!* Esto nos ayuda a optimizar nuestros horarios."
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        8080,
        6640
      ],
      "id": "d2e20241-a92c-4466-918f-2d3bece36e7d",
      "name": "Basic LLM Notificar Cancelar Cita",
      "alwaysOutputData": true,
      "executeOnce": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        816,
        10288
      ],
      "id": "5631d0fa-3300-4b2f-a11f-e62661f7dd85",
      "name": "OpenAI Chat Model5",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b2110549-dd58-46b3-9707-dbbe0a5004f2",
              "leftValue": "={{ $('Estructuraci칩n, de datos').item.json.mensajeParaEnviar.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1936,
        10080
      ],
      "id": "1040cb06-d05f-49e6-ba68-2720344bd2f7",
      "name": "Validaci칩n de longitud de caracteres15"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2400,
        9936
      ],
      "id": "0529f197-31f5-4d39-a0be-e5c2e1a5f262",
      "name": "No Operation, do nothing19"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Estructuraci칩n, de datos').item.json.mensajeParaEnviar }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2208,
        9936
      ],
      "id": "cbd66c02-c8e2-48bd-925d-7d89e659660d",
      "name": "HTTP Request Enviar Mensaje por WhatsApp18"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Estructuraci칩n, de datos').item.json.mensajeParaEnviar }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Estructuraci칩n, de datos').item.json.mensajeParaEnviar.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6448,
        10064
      ],
      "id": "df08b8f3-ade3-4d2a-be2c-a680c4d361b7",
      "name": "Organiza variables del mensaje17"
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=# ASISTENTE DE INFORMACI칍N GENERAL - KONFIE IA LOGISTICS\n\nEres un asistente especializado en proporcionar informaci칩n general sobre Konfie IA Logistics, una empresa pionera en log칤stica inteligente en Colombia.\n\n## CONTEXTO IMPORTANTE DEL CHAT\n**PROP칍SITO ESPEC칈FICO:** Este chat de WhatsApp est치 dise침ado EXCLUSIVAMENTE para que los proveedores de Konfie IA Logistics puedan gestionar citas de entrega de mercanc칤a en la bodega de la empresa. No est치 autorizado ni programado para otras gestiones comerciales, ventas, contrataciones o servicios generales.\n\n**AUDIENCIA:** Proveedores que necesitan agendar, consultar, modificar o cancelar citas de descargue de mercanc칤a.\n\n## INFORMACI칍N DE LA EMPRESA\n\n### Acerca de Konfie IA Logistics\n**Misi칩n:** Redefinir los l칤mites de lo posible en log칤stica a trav칠s de la transparencia y la innovaci칩n.\n**Visi칩n:** Transformar la log칤stica en una experiencia sin precedentes.\n**Especialidad:** Log칤stica inteligente con tecnolog칤a de inteligencia artificial y sistemas GPS de 칰ltima generaci칩n.\n\n### Servicios Principales\n1. **Transporte Impo y Expo**\n   - Operaciones de transporte de carga contenerizada desde y hacia los puertos\n   - Servicios FTL (Full Truck Load), LTL (Less Than Truck Load), ITR\n\n2. **Carga Masiva Nacional**\n   - Transporte masivo nacional\n   - Servicios urbanos y nacionales\n   - Multientregas con rutas l칩gicas\n   - Diferentes tipos de veh칤culos\n\n3. **Distribuci칩n Multientrega**\n   - Transporte a m칰ltiples destinos\n   - Seguimiento en tiempo real\n   - Informaci칩n detallada de cada entrega por separado\n\n4. **Almacenamiento**\n   - Administraci칩n, control y seguridad de mercanc칤a\n   - Gesti칩n integral de inventarios\n\n5. **칔ltima Milla**\n   - Distribuci칩n a cliente final\n   - Desde centros de distribuci칩n o almacenamiento\n   - Cualquier tipo de veh칤culo requerido\n   - Servicio de urgencias\n\n6. **ITR (Inland Terminal Rail)**\n   - Operaci칩n de patios en puertos\n   - Cargue y descargue de veh칤culos\n   - Consolidaci칩n de mercanc칤as\n\n7. **Flotas Dedicadas**\n   - Ajuste a especificaciones t칠cnicas espec칤ficas\n   - Flotas personalizadas seg칰n tipo de veh칤culo requerido\n\n### Tecnolog칤a e Innovaci칩n\n- **Inteligencia Artificial:** Optimizaci칩n de rutas y procesos\n- **Sistemas GPS:** Tecnolog칤a de 칰ltima generaci칩n para seguimiento\n- **Seguimiento en tiempo real:** Informaci칩n oportuna y veraz\n- **Sostenibilidad:** Pr치cticas responsables con el medio ambiente\n\n### Cobertura\n- **Pa칤s principal:** Colombia\n- **Alcance:** Env칤os en toda Colombia\n- **Experiencia:** A침os de trayectoria en el mercado log칤stico\n\n### Sitio Web\n- **URL:** https://www.konfie.com/es_CO\n- **Redes sociales:** Facebook - Konfie IA Logistics\n\n## INSTRUCCIONES PARA RESPONDER\n\n1. **SIEMPRE mencionar el prop칩sito del chat:** En cada respuesta, recuerda al usuario que este chat est치 destinado exclusivamente para gesti칩n de citas de entrega de mercanc칤a en la bodega\n2. **Respuestas claras y concisas:** Proporciona informaci칩n directa y 칰til sobre la empresa\n3. **Tono profesional y amigable:** Mant칠n un tono cordial pero profesional\n4. **Informaci칩n espec칤fica:** Cuando sea posible, proporciona detalles espec칤ficos sobre servicios de la empresa\n5. **Redirecci칩n apropiada:** Siempre orienta hacia el prop칩sito principal del chat (gesti칩n de citas)\n6. **Respuestas completas:** Aseg칰rate de abordar la consulta pero contextualizar el prop칩sito del chat\n\n## TIPOS DE PREGUNTAS QUE PUEDES RESPONDER\n- Informaci칩n sobre servicios y capacidades de Konfie IA Logistics\n- Ubicaci칩n y cobertura geogr치fica de la empresa\n- Tecnolog칤a y diferenciadores de la empresa\n- Proceso general de trabajo de la empresa\n- Informaci칩n corporativa de Konfie IA Logistics\n- Preguntas sobre sostenibilidad y responsabilidad ambiental de la empresa\n\n**IMPORTANTE:** Independientemente del tipo de pregunta, SIEMPRE debes contextualizar que este chat es para gesti칩n de citas de entrega de mercanc칤a.\n\n## MANEJO DE CONSULTAS NO RELACIONADAS CON LA EMPRESA\n\n### Si la pregunta NO tiene relaci칩n con Konfie IA Logistics:\n**Ejemplo de respuesta:**\n\"Hola, espero que est칠s bien. Este chat pertenece a **Konfie IA Logistics**, una empresa especializada en log칤stica inteligente que ofrece servicios como transporte de carga, distribuci칩n, almacenamiento y 칰ltima milla en Colombia. \n\nEspec칤ficamente, este chat est치 dise침ado para que nuestros **proveedores puedan gestionar citas de entrega de mercanc칤a en nuestra bodega** (agendar, consultar, modificar o cancelar citas de descargue).\n\nSi necesitas m치s informaci칩n sobre nuestra empresa, puedes visitar: https://www.konfie.com/es_CO\n\n쮼n qu칠 puedo ayudarte con la gesti칩n de tu cita de entrega?\"\n\n### Si la pregunta S칈 est치 relacionada con Konfie pero NO con citas de entrega:\n**Ejemplo de respuesta:**\n\"Te comparto la informaci칩n sobre [responder la pregunta espec칤fica sobre la empresa]. \n\nEs importante mencionar que este chat est치 espec칤ficamente dise침ado para que nuestros **proveedores gestionen citas de entrega de mercanc칤a en nuestra bodega**. Para consultas comerciales, contrataciones o otros servicios, te recomiendo contactar directamente a trav칠s de nuestro sitio web: https://www.konfie.com/es_CO\n\n쯅ecesitas ayuda con alguna gesti칩n de cita de entrega de mercanc칤a?\"\n\n## LIMITACIONES\n- **NO proporciones informaci칩n de precios espec칤ficos** (solicita que contacten directamente)\n- **NO hagas promesas sobre tiempos de entrega espec칤ficos** sin conocer detalles\n- **NO proporciones informaci칩n de contacto espec칤fica** que no tengas confirmada\n- **NO gestiones consultas comerciales, ventas o contrataciones** (este chat es solo para citas de entrega)\n- **SIEMPRE contextualiza** que este chat es para gesti칩n de citas de entrega de mercanc칤a en la bodega\n\n---\n\n## DATOS DEL MENSAJE ACTUAL\n**Pregunta del usuario:**\n```\n{{ $json.infoMensaje.mensajeActual }}\n```\n\n**Historial de conversaci칩n:**\n```\n{{ $json.infoMensaje.historialMensajes }}\n```\n\n**Fecha:** {{ $json.infoMensaje.fechaMensajeActual }}\n**Hora:** {{ $json.infoMensaje.horaMensajeActual }}\n\n---\n\n### INSTRUCCIONES FINALES\n1. Analiza la pregunta del usuario en el contexto del historial\n2. **SIEMPRE menciona** que este chat est치 dise침ado para gesti칩n de citas de entrega de mercanc칤a por parte de proveedores\n3. Proporciona informaci칩n 칰til y completa sobre Konfie IA Logistics cuando sea relevante\n4. Si la pregunta no est치 relacionada con la empresa, explica qu칠 es Konfie IA Logistics y redirige al prop칩sito del chat\n5. Si la pregunta est치 relacionada con la empresa pero no con citas de entrega, proporciona la informaci칩n pero contextualiza el prop칩sito espec칤fico del chat\n6. Mant칠n un tono profesional pero cercano\n7. Si necesitan informaci칩n muy espec칤fica (precios, cotizaciones, servicios comerciales), inv칤talos a contactar directamente a trav칠s del sitio web\n8. **SIEMPRE finaliza** preguntando si necesitan ayuda con gesti칩n de citas de entrega\n\n**FORMATO DE RESPUESTA:**\n- Responde la consulta de manera 칰til\n- Contextualiza el prop칩sito espec칤fico del chat (gesti칩n de citas de entrega de mercanc칤a)\n- Proporciona el sitio web si es necesario: https://www.konfie.com/es_CO\n- Pregunta si necesitan ayuda con citas de entrega\n\n**EJEMPLOS DE CIERRE:**\n- \"쯅ecesitas ayuda con alguna gesti칩n de cita de entrega de mercanc칤a?\"\n- \"쮼n qu칠 puedo ayudarte con la gesti칩n de tu cita de entrega?\"\n- \"Requieres agendar, consultar o modificar alguna cita de entrega en nuestra bodega?\""
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        896,
        10080
      ],
      "id": "1342f00e-dac1-453d-be13-20a26470bdb0",
      "name": "Basic LLM CONVERSACI칍N GENERAL"
    },
    {
      "parameters": {
        "jsCode": "const items = $node[\"Basic LLM CONVERSACI칍N GENERAL\"].all();\nconst output = [];\n\nfor (const item of items) {\n  try {\n    // Para PREGUNTA_GENERAL, el LLM devuelve texto plano, no JSON\n    let respuestaTexto = item.json.text ? item.json.text.trim() : \"\";\n    \n    // Verificar que hay contenido\n    if (!respuestaTexto) {\n      throw new Error(\"Respuesta vac칤a del modelo LLM\");\n    }\n    \n    // Estructurar la salida para PREGUNTA_GENERAL\n    output.push({\n      json: {\n        mensajeParaEnviar: respuestaTexto,\n        tipo: \"informacion_general\",\n        accion: \"respuesta_informativa\", \n        origen: \"intencionPreguntaGeneral\"\n      }\n    });\n    \n  } catch (error) {\n    output.push({\n      json: {\n        error: true,\n        mensaje: \"Error al interpretar la respuesta del modelo LLM\",\n        detalle: error.message,\n        contenidoOriginal: item.json.text || \"No hay contenido\",\n        tipo: \"error\",\n        accion: \"error_procesamiento\",\n        origen: \"intencionPreguntaGeneral\"\n      }\n    });\n  }\n}\n\nreturn output;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        10080
      ],
      "id": "6af6e084-e76b-4b74-86c6-b00dd4bfd49c",
      "name": "Estructuraci칩n, de datos"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b2110549-dd58-46b3-9707-dbbe0a5004f2",
              "leftValue": "={{ $('Estructuraci칩n, de datos1').item.json.message.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1648,
        11120
      ],
      "id": "7d7d7207-e5a9-4052-b4ae-421dfc7b7ff9",
      "name": "Validaci칩n de longitud de caracteres18"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2192,
        10976
      ],
      "id": "16ced739-d104-4ee4-8d40-9ae904651611",
      "name": "No Operation, do nothing22"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Estructuraci칩n, de datos1').item.json.mensajeParaEnviar }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2016,
        10976
      ],
      "id": "f75b821e-b42b-40f7-9ae7-8420b0565980",
      "name": "HTTP Request Enviar Mensaje por WhatsApp21"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Estructuraci칩n, de datos1').item.json.message }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Estructuraci칩n, de datos1').item.json.message.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6480,
        11104
      ],
      "id": "912db056-8092-41ac-88d0-28ed707fd09b",
      "name": "Organiza variables del mensaje18"
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      message: `九 **ELIMINACI칍N DE CONVERSACI칍N EXITOSA**\n\nLa eliminaci칩n de mensajes en la base de datos se ha completado correctamente.\n\n游댃 **Puedes empezar una nueva conversaci칩n**\nAhora puedes iniciar una conversaci칩n completamente limpia con el asistente.\n\n游늰 **Tus citas est치n seguras**\nSi ten칤as citas programadas, no te preocupes - las citas NO se han eliminado. Solo se elimin칩 el historial de conversaci칩n para hacer limpieza del sistema.\n\n游눫 **Conversaci칩n limpia lista**\nPuedes comenzar de nuevo y tener una experiencia fresca con el asistente. Todos tus datos importantes permanecen intactos.\n\n춰Escribe tu mensaje para empezar una nueva conversaci칩n!`,\n      success: true,\n      timestamp: new Date().toISOString()\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        10816
      ],
      "id": "be620b67-9d4c-469d-bbb1-a3f0da90137f",
      "name": "Estructuraci칩n, de datos1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "BEGIN TRANSACTION;\n\nDELETE FROM MensajesWhatsApp\nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n   OR (chat_id = 'agenteAI'\n       AND message_id IN (\n           SELECT message_id \n           FROM MensajesWhatsApp\n           WHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}'\n       )\n   );\n\nDELETE FROM FranjasDisponiblesTemp \nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\n  DELETE FROM EstadoConversacional \nWHERE chat_id = '{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.chat_id }}';\n\nCOMMIT;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        -64,
        11248
      ],
      "id": "d201d5f4-6530-44a3-8135-6b74e82b3036",
      "name": "Microsoft SQL Eliminaci칩n Mensajes",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "40ef08c9-6248-4a94-a661-1638e344db90",
              "leftValue": "={{ $json.mensaje_especial.length }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1824,
        12032
      ],
      "id": "2d73e320-6d3c-433d-9553-483d90a06c5d",
      "name": "Validaci칩n de longitud de caracteres19"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2384,
        11888
      ],
      "id": "d5417855-d143-4129-bfd2-b273267b3ac0",
      "name": "No Operation, do nothing23"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evolutionapi-evolution-api.cpyock.easypanel.host/message/sendText/{{ $('Mensaje Entrada').first().json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Mensaje Entrada').first().json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Mensaje Entrada').first().json.body.data.key.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $('Estructuraci칩n, de datos2').item.json.mensajeParaEnviar }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2192,
        11888
      ],
      "id": "c4a070a2-04f5-420f-8e2f-752e2cd35d00",
      "name": "HTTP Request Enviar Mensaje por WhatsApp22"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d9c2ff70-4fd1-4b93-8571-6d0ac5a0093e",
              "name": "mensaje.ia",
              "value": "={{ $('Validaci칩n de longitud de caracteres19').item.json.mensaje_especial }}",
              "type": "string"
            },
            {
              "id": "ac8a03be-0292-4735-9580-39a385945c47",
              "name": "mensaje.longitud",
              "value": "={{ $('Validaci칩n de longitud de caracteres19').item.json.mensaje_especial.length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6656,
        12016
      ],
      "id": "5a48ae96-c40c-4f11-9e9b-f2a110a48638",
      "name": "Organiza variables del mensaje19"
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      // --- CAMBIO REALIZADO AQU칈 ---\n      mensaje_especial: `仇 **ERROR EN ELIMINACI칍N DE CONVERSACI칍N**\n\nLamentamos informarte que ha ocurrido un error durante la eliminaci칩n autom치tica de la conversaci칩n en nuestro sistema.\n\n游댢 **Acci칩n requerida**\nPor favor, comun칤cate directamente con el **치rea de Bodega de Konf칤e** para que validen manualmente qu칠 sucedi칩 con la eliminaci칩n de datos en el sistema.\n\n游 **Contacto necesario**\nEl equipo de Bodega deber치 revisar y procesar manualmente la eliminaci칩n de tu conversaci칩n para garantizar que se complete correctamente.\n\n丘멆잺 **Situaci칩n excepcional**\nTe pedimos disculpas por este inconveniente. Este tipo de errores son muy poco frecuentes en nuestro sistema, pero requieren atenci칩n manual para resolverse adecuadamente.\n\n游똂 **Disculpas por las molestias**\nSentimos mucho las molestias causadas por esta situaci칩n t칠cnica. El equipo de Bodega te ayudar치 a resolver esto lo antes posible.\n\nPor favor contacta a Bodega de Konf칤e para continuar con el proceso.`,\n      // -----------------------------\n      success: false,\n      error: true,\n      timestamp: new Date().toISOString(),\n      action_required: \"contact_bodega\"\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1072,
        11680
      ],
      "id": "734ac518-95be-4705-9ebc-1287a144ac7c",
      "name": "Estructuraci칩n, de datos2"
    },
    {
      "parameters": {
        "promptType": "=define",
        "text": "=### SISTEMA\n\nEres un asistente especializado en log칤stica de bodegas para **Konf칤e IA Logistics**. \n\nEl usuario ha enviado un mensaje que **NO est치 relacionado con el contexto de nuestro negocio** (log칤stica, citas, entregas, horarios, etc.).\n\n### TU TAREA:\n\nGenera un mensaje aplicando estos principios de UX para WhatsApp:\n\n**FORMATO Y ESTRUCTURA:**\n1. Usa *negritas* para destacar informaci칩n importante como servicios disponibles\n2. Usa emojis estrat칠gicos: 좶잺 (informaci칩n), 游끽 (empresa), 游늶 (servicios), 丘멆잺 (advertencia), 游댃 (reinicio)\n3. Estructura la informaci칩n de forma jer치rquica y clara\n4. Usa vi침etas con emojis para listar servicios disponibles\n\n**CONTENIDO REQUERIDO:**\n1. 游끽 Responder de manera *amable pero firme* que el mensaje no est치 relacionado con el servicio\n2. 游늶 Redirigir hacia los servicios que *s칤 puedes ofrecer* con lista clara\n3. 丘멆잺 Advertir *suavemente* sobre posible reinicio si contin칰a fuera de contexto\n4. 仇 Invitar a usar los servicios relacionados con bodega\n\n**SERVICIOS A MENCIONAR:**\n游늰 Agendar nuevas citas de entrega\n游댌 Consultar disponibilidad de horarios  \n九勇 Editar citas existentes\n游뛂 Cancelar entregas programadas\n\n**TONO:** Profesional pero cordial, firme pero no rudo, redirigiendo de manera constructiva.\n\n### MENSAJE DEL USUARIO:\n{{ $('Unificaci칩n y consistencia de datos').first().json.infoMensaje.mensajeActual }}\n\n### HISTORIAL DE CONVERSACI칍N:\n{{ $node[\"Unificaci칩n y consistencia de datos\"].json[\"infoMensaje\"][\"historialMensajes\"] }}\n\n### FORMATO DE RESPUESTA (JSON v치lido):\n```json\n{\n  \"mensajeSistema\": \"좶잺 Entiendo tu mensaje, pero soy un asistente especializado en *gesti칩n de citas de bodega* para **Konf칤e IA Logistics**. No puedo ayudarte con temas fuera de este contexto.\\n\\n游늶 *Servicios disponibles:*\\n游늰 Agendar nuevas citas de entrega\\n游댌 Consultar disponibilidad de horarios\\n九勇 Modificar citas existentes\\n游뛂 Cancelar entregas programadas\\n\\n丘멆잺 Si contin칰as enviando mensajes no relacionados con nuestro servicio, tendr칠 que *reiniciar nuestra conversaci칩n*.\\n\\n仇 쯊e gustar칤a que te ayude con alguna *gesti칩n de cita de entrega*?\"\n}\n```"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        -5408,
        6720
      ],
      "id": "a2e6227a-e998-461e-96c8-afe30e3ca1b1",
      "name": "Basic LLM MANEJO FUERA CONTEXTO"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Consultar estado conversacional actual\nSELECT \n  ISNULL(estado_actual, 'INICIAL') as estado_actual,\n  ISNULL(contexto_proceso, '{\"descripcion\": \"Estado inicial\"}') as contexto_proceso,\n  ISNULL(contador_fuera_contexto, 0) as contador_fuera_contexto,\n  ultimo_mensaje_fuera_contexto\nFROM EstadoConversacional \nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}'\n\nUNION ALL\n\n-- Si no existe registro, devolver valores por defecto\nSELECT \n  'INICIAL' as estado_actual,\n  '{\"descripcion\": \"Estado inicial\"}' as contexto_proceso,\n  0 as contador_fuera_contexto,\n  NULL as ultimo_mensaje_fuera_contexto\nWHERE NOT EXISTS (\n  SELECT 1 FROM EstadoConversacional \n  WHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}'\n);"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        -12912,
        5072
      ],
      "id": "b0a6bc52-ae51-48f0-a201-355a5a155991",
      "name": "Consultar Estado Conversacional",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Actualizar estado conversacional basado en intenci칩n detectada\nMERGE EstadoConversacional AS target\nUSING (\n  SELECT \n    '{{ $('Parametrizaci칩n').first().json.message.chat.id }}' AS chat_id,\n    CASE \n      WHEN '{{ $json.intencionDetectada }}' = 'CREAR_CITA' THEN 'SOLICITANDO_DATOS_CREAR'\n      WHEN '{{ $json.intencionDetectada }}' = 'EDITAR_CITA' THEN 'SOLICITANDO_DATOS_EDITAR'\n      WHEN '{{ $json.intencionDetectada }}' = 'CANCELAR_CITA' THEN 'CONFIRMANDO_CANCELACION'\n      WHEN '{{ $json.intencionDetectada }}' = 'CONSULTAR_MALLA' THEN 'CONSULTANDO_DISPONIBILIDAD'\n      WHEN '{{ $json.intencionDetectada }}' = 'CONFIRMACION_CITA' THEN 'CONFIRMANDO_FRANJA'\n      WHEN '{{ $json.intencionDetectada }}' = 'SALUDO' THEN 'SALUDANDO'\n      WHEN '{{ $json.intencionDetectada }}' = 'PREGUNTA_GENERAL' THEN 'RESPONDIENDO_PREGUNTA'\n      WHEN '{{ $json.intencionDetectada }}' = 'RESPUESTA_FUERA_CONTEXTO' THEN 'FUERA_CONTEXTO'\n      WHEN '{{ $json.intencionDetectada }}' = 'ELIMINAR_MENSAJES' THEN 'ELIMINANDO_MENSAJES'\n      ELSE 'INICIAL'\n    END AS estado_actual,\n    CASE \n      WHEN '{{ $json.intencionDetectada }}' = 'RESPUESTA_FUERA_CONTEXTO' THEN \n        '{\"intencion_detectada\": \"{{ $json.intencionDetectada }}\", \"timestamp\": \"{{ new Date().toISOString() }}\", \"accion\": \"incrementar_contador\"}'\n      ELSE \n        '{\"intencion_detectada\": \"{{ $json.intencionDetectada }}\", \"timestamp\": \"{{ new Date().toISOString() }}\", \"accion\": \"cambio_estado\"}'\n    END AS contexto_proceso\n) AS source ON (target.chat_id = source.chat_id)\nWHEN MATCHED THEN\n    UPDATE SET \n      estado_actual = source.estado_actual, \n      contexto_proceso = source.contexto_proceso, \n      fecha_actualizacion = GETDATE(),\n      contador_fuera_contexto = CASE \n        WHEN '{{ $json.intencionDetectada }}' = 'RESPUESTA_FUERA_CONTEXTO' THEN contador_fuera_contexto + 1\n        ELSE CASE WHEN '{{ $json.intencionDetectada }}' != 'RESPUESTA_FUERA_CONTEXTO' THEN 0 ELSE contador_fuera_contexto END\n      END,\n      ultimo_mensaje_fuera_contexto = CASE \n        WHEN '{{ $json.intencionDetectada }}' = 'RESPUESTA_FUERA_CONTEXTO' THEN GETDATE()\n        ELSE ultimo_mensaje_fuera_contexto\n      END\nWHEN NOT MATCHED THEN\n    INSERT (chat_id, estado_actual, contexto_proceso, contador_fuera_contexto, ultimo_mensaje_fuera_contexto) \n    VALUES (\n      source.chat_id, \n      source.estado_actual, \n      source.contexto_proceso,\n      CASE WHEN '{{ $json.intencionDetectada }}' = 'RESPUESTA_FUERA_CONTEXTO' THEN 1 ELSE 0 END,\n      CASE WHEN '{{ $json.intencionDetectada }}' = 'RESPUESTA_FUERA_CONTEXTO' THEN GETDATE() ELSE NULL END\n    );\n\n-- Devolver la intenci칩n para el siguiente nodo\nSELECT '{{ $json.intencionDetectada }}' as intencionDetectada, \n       '{{ $('Parametrizaci칩n').first().json.message.chat.id }}' as chat_id,\n       GETDATE() as timestamp_actualizacion;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        -6880,
        5264
      ],
      "id": "e88e90c1-6fdc-40b7-b6da-158d8a6a112c",
      "name": "Actualizar Estado por Intenci칩n",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "SALUDO",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "2a4110a6-abce-4bf4-88e0-942700219980"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SALUDO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "12844e18-8e96-4137-8cc9-92ffc859122d",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "CREAR_CITA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CREAR_CITA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "ee404726-165f-4392-8bd7-1c760f06c7f8",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "CONFIRMACION_CITA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CONFIRMACION_CITA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "3efa4dc0-5ed7-49b6-a886-6166ffad4b2d",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "EDITAR_CITA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EDITAR_CITA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "f9627527-88c2-4004-81c7-f0b6ea67b200",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "CANCELAR_CITA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CANCELAR_CITA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "57ed6e86-2535-45be-acd4-cbfa654001d0",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "CONSULTAR_MALLA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CONSULTAR_MALLA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "c4a8f2d0-aa7f-40a9-a5e2-4d54a1a433b6",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "PREGUNTA_GENERAL",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PREGUNTA_GENERAL"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "8192b61d-956c-4f8c-a8eb-77d456c3ec1d",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "ELIMINAR_MENSAJES",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ELIMINAR_MENSAJES"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "7b80f0f8-3cf9-4951-9d47-6a1eb40e6a06",
                    "leftValue": "={{ $json.intencionDetectada }}",
                    "rightValue": "RESPUESTA_FUERA_CONTEXTO",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "RESPUESTA_FUERA_CONTEXTO"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -6688,
        5152
      ],
      "id": "e22cc0df-9de6-48fe-b840-73650a7b98b7",
      "name": "Switch Redistribuci칩n por Intenci칩n"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Verificar si necesita reinicio autom치tico por exceso de mensajes fuera de contexto\nSELECT \n  chat_id,\n  estado_actual,\n  contador_fuera_contexto,\n  CASE \n    WHEN contador_fuera_contexto >= 3 THEN 'REINICIAR_CONVERSACION'\n    WHEN contador_fuera_contexto = 2 THEN 'ADVERTENCIA_FINAL'\n    WHEN contador_fuera_contexto = 1 THEN 'PRIMERA_ADVERTENCIA'\n    ELSE 'NORMAL'\n  END as accion_requerida,\n  CASE \n    WHEN contador_fuera_contexto >= 3 THEN 'Has enviado varios mensajes que no est치n relacionados con nuestro servicio de gesti칩n de citas. Para poder ayudarte mejor, voy a reiniciar nuestra conversaci칩n. Por favor, cu칠ntame en qu칠 puedo asistirte con el servicio de bodega.'\n    WHEN contador_fuera_contexto = 2 THEN 'Te recuerdo que soy un asistente especializado en gesti칩n de citas de bodega. Si contin칰as con mensajes no relacionados, tendr칠 que reiniciar nuestra conversaci칩n. 쮿ay algo sobre el servicio de bodega en lo que pueda ayudarte?'\n    ELSE COALESCE('{{ $(\"Basic LLM MANEJO FUERA CONTEXTO\").first().json.text }}', '')\n  END as mensaje_especial\nFROM EstadoConversacional \nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}';\n\n-- Si el contador es >= 3, reiniciar autom치ticamente\nUPDATE EstadoConversacional \nSET estado_actual = 'INICIAL', \n    contexto_proceso = '{\"descripcion\": \"Conversaci칩n reiniciada autom치ticamente por exceso de mensajes fuera de contexto\", \"reinicio_automatico\": true}',\n    contador_fuera_contexto = 0,\n    ultimo_mensaje_fuera_contexto = NULL,\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}'\n  AND contador_fuera_contexto >= 3;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        -1440,
        11728
      ],
      "id": "55894380-a1a8-4f61-bf50-2343838fbb9b",
      "name": "Verificar Reinicio Fuera Contexto",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Resetear estado a INICIAL despu칠s de operaci칩n exitosa\nUPDATE EstadoConversacional \nSET estado_actual = 'INICIAL', \n    contexto_proceso = '{\"descripcion\": \"Operaci칩n completada exitosamente\", \"ultima_accion\": \"cita_creada\", \"timestamp\": \"{{ new Date().toISOString() }}\"}',\n    contador_fuera_contexto = 0,\n    ultimo_mensaje_fuera_contexto = NULL,\n    fecha_actualizacion = GETDATE()\nWHERE chat_id = '{{ $('Parametrizaci칩n').first().json.message.chat.id }}';\n\n-- Confirmar actualizaci칩n\nSELECT \n  'INICIAL' as nuevo_estado,\n  'OPERACION_EXITOSA' as tipo_reseteo,\n  '{{ $('Parametrizaci칩n').first().json.message.chat.id }}' as chat_id,\n  GETDATE() as timestamp_reseteo;"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        8960,
        2992
      ],
      "id": "c9e7d981-6bd5-4777-b89d-8e04d11a3c89",
      "name": "Resetear Estado - Cita Exitosa",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "UNJs1wxs3vPQMTeN",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "bcf1d355-87f6-41d6-bb8e-c69b5d663ee1",
              "leftValue": "={{ $json.contador_fuera_contexto }}",
              "rightValue": 3,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -800,
        11728
      ],
      "id": "a34a30c6-c7ee-44e1-a6fe-2cf3dabb2dcb",
      "name": "If contador_fuera_contexto"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1520,
        12032
      ],
      "id": "42325b06-037b-4145-bd74-a1fb38f85b39",
      "name": "Merge8"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        28432,
        8848
      ],
      "id": "8f58ea5c-bf35-4519-860f-47112890359a",
      "name": "OpenAI Chat Model20",
      "credentials": {
        "openAiApi": {
          "id": "AD8kPcNVReuclASd",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Mensaje Entrada": {
      "main": [
        [
          {
            "node": "Parametrizaci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parametrizaci칩n": {
      "main": [
        [
          {
            "node": "Guarda el mensaje en SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guarda el mensaje en SQL": {
      "main": [
        [
          {
            "node": "Recupera todos los mensajes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recupera todos los mensajes": {
      "main": [
        [
          {
            "node": "Consultar Estado Conversacional",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Count y Tiempo 칔ltimo Mensaje": {
      "main": [
        [
          {
            "node": "If (Salida 0 - No hacer nada)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If (Salida 0 - No hacer nada)": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If (Salida 1 - Esperar)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If (Salida 1 - Esperar)": {
      "main": [
        [
          {
            "node": "Espera X segundos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If (Salida 2 - Seguir)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera X segundos": {
      "main": [
        [
          {
            "node": "Recupera todos los mensajes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If (Salida 2 - Seguir)": {
      "main": [
        [
          {
            "node": "Merge de Datos",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organizaci칩n y estructuracion de mensajes": {
      "main": [
        [
          {
            "node": "Organiza el Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza el Mensaje": {
      "main": [
        [
          {
            "node": "Merge de Datos para session ID",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Recuperar historial Citas": {
      "main": [
        [
          {
            "node": "Remueve registros de citas duplicados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge de Datos": {
      "main": [
        [
          {
            "node": "Organizaci칩n y estructuracion de mensajes",
            "type": "main",
            "index": 0
          },
          {
            "node": "Recuperar historial Citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remueve registros de citas duplicados": {
      "main": [
        [
          {
            "node": "Organizaci칩n y estructuracion historial citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organizaci칩n y estructuracion historial citas": {
      "main": [
        [
          {
            "node": "Organiza el historial de citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza el historial de citas": {
      "main": [
        [
          {
            "node": "Merge de Datos para session ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge de Datos para session ID": {
      "main": [
        [
          {
            "node": "Unificaci칩n y consistencia de datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unificaci칩n y consistencia de datos": {
      "main": [
        [
          {
            "node": "MongoDB Consulta Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB Consulta Contexto": {
      "main": [
        [
          {
            "node": "Combinar Contexto MongoDB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combinar Contexto MongoDB": {
      "main": [
        [
          {
            "node": "Basic LLM CLASIFICADOR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request MALLA DE RECIBO 2025": {
      "main": [
        [
          {
            "node": "Extract MALLA DE RECIBO 2025",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract MALLA DE RECIBO Semana Siguiente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract MALLA DE RECIBO 2025": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Datos, Consulta, Citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Malla Fija": {
      "main": [
        [
          {
            "node": "Extract Datos Proveedor",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract from Categorias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Datos Proveedor": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Consulta, Datos Proveedor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Datos, Consulta, Citas": {
      "main": [
        [
          {
            "node": "Merge datos Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Consulta, Datos Proveedor": {
      "main": [
        [
          {
            "node": "Merge datos Excel",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Merge datos Excel": {
      "main": [
        [
          {
            "node": "Unificaci칩n y consistencia de datos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from Categorias": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Consulta, Datos Categorias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Consulta, Datos Categorias": {
      "main": [
        [
          {
            "node": "Merge datos Excel",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Unificaci칩n y consistencia de datos1": {
      "main": [
        [
          {
            "node": "Basic LLM Chain RECOLECCI칍N1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM CLASIFICADOR",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM CLASIFICADOR": {
      "main": [
        [
          {
            "node": "Respuesta Anticipada Inteligente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM CONVERSACI칍N (SALUDO)",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Basic LLM MANEJO FUERA CONTEXTO",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Switch basado en intenci칩n": {
      "main": [
        [
          {
            "node": "Actualizar Estado por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Actualizar Estado por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Actualizar Estado por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Actualizar Estado por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Actualizar Estado por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Actualizar Estado por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Actualizar Estado por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Actualizar Estado por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Actualizar Estado por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Almacenar la intenci칩n detectada": {
      "main": [
        [
          {
            "node": "Switch basado en intenci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta Anticipada Inteligente": {
      "main": [
        [
          {
            "node": "쯋sar Respuesta Anticipada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "쯋sar Respuesta Anticipada?": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Anticipada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Almacenar la intenci칩n detectada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Anticipada": {
      "main": [
        [
          {
            "node": "Finalizar Respuesta Anticipada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain RECOLECCI칍N",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain RECOLECCI칍N": {
      "main": [
        [
          {
            "node": "Code (Formatear JSON RECOLECCI칍N)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code (Formatear JSON RECOLECCI칍N)": {
      "main": [
        [
          {
            "node": "IF Datos Completos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Datos Completos": {
      "main": [
        [
          {
            "node": "Basic LLM Chain EXTRACCI칍N_DATOS_CITA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Estado SQL - SOLICITANDO_DATOS_CREAR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - SOLICITANDO_DATOS_CREAR": {
      "main": [
        [
          {
            "node": "Code Respuesta Faltantes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Respuesta Faltantes": {
      "main": [
        [
          {
            "node": "Setear estado conversacional",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setear estado conversacional": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp": {
      "main": [
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Separaci칩n de Mensaje": {
      "main": [
        [
          {
            "node": "Split Out Separa el Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out Separa el Mensaje": {
      "main": [
        [
          {
            "node": "Loop Over Items Recorre las Partes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items Recorre las Partes": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Recuento de Caracteres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recuento de Caracteres": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp1": {
      "main": [
        [
          {
            "node": "Microsoft SQL1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp2": {
      "main": [
        [
          {
            "node": "Microsoft SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp3": {
      "main": [
        [
          {
            "node": "Microsoft SQL2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL1": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL2": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Loop Over Items Recorre las Partes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract MALLA DE RECIBO Semana Siguiente": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana": {
      "main": [
        [
          {
            "node": "Merge datos Excel",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "OpenAI Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM CONSULTAR MALLA",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Malla Fija1": {
      "main": [
        [
          {
            "node": "Extract from Categorias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from Categorias1": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Consulta, Datos Categorias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Consulta, Datos Categorias1": {
      "main": [
        [
          {
            "node": "Basic LLM CONSULTAR MALLA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM CONSULTAR MALLA": {
      "main": [
        [
          {
            "node": "Estado SQL - CONSULTANDO_DISPONIBILIDAD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - CONSULTANDO_DISPONIBILIDAD": {
      "main": [
        [
          {
            "node": "Consistencia de datos, intenci칩n consultar malla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consistencia de datos, intenci칩n consultar malla": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp4": {
      "main": [
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres1": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje1": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM CONVERSACI칍N (SALUDO)": {
      "main": [
        [
          {
            "node": "Estado SQL - SALUDANDO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - SALUDANDO": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Consulta, Datos Categorias2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres2": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp5": {
      "main": [
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Consulta, Datos Categorias2": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje2": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain MOSTRAR_FRANJAS",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model8": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain EXTRACCI칍N_DATOS_CITA",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain EXTRACCI칍N_DATOS_CITA": {
      "main": [
        [
          {
            "node": "Microsoft SQL Guardar EXTRACCI칍N_DATOS_CITA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Basic LLM Chain EXTRACCI칍N_DATOS_CITA",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain MOSTRAR_FRANJAS": {
      "main": [
        [
          {
            "node": "Code estandarizar respuestas MOSTRAR_FRANJAS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Guardar EXTRACCI칍N_DATOS_CITA": {
      "main": [
        [
          {
            "node": "Code MOSTRAR_FRANJAS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code estandarizar respuestas MOSTRAR_FRANJAS": {
      "main": [
        [
          {
            "node": "Microsoft SQL Guardar MOSTRAR_FRANJAS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code MOSTRAR_FRANJAS": {
      "main": [
        [
          {
            "node": "Basic LLM Chain MOSTRAR_FRANJAS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code RECOLECCI칍N": {
      "main": [
        [
          {
            "node": "Basic LLM Chain RECOLECCI칍N",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres3": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp6": {
      "main": [
        [
          {
            "node": "No Operation, do nothing5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Guardar MOSTRAR_FRANJAS": {
      "main": [
        [
          {
            "node": "IF Disponibilidad Confirmada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Disponibilidad Confirmada": {
      "main": [
        [
          {
            "node": "Estado SQL - ESPERANDO_CONFIRMACION_CREAR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validaci칩n de longitud de caracteres3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - ESPERANDO_CONFIRMACION_CREAR": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje3": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Obtener Alternativas": {
      "main": [
        [
          {
            "node": "Estado SQL - CONFIRMANDO_FRANJA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - CONFIRMANDO_FRANJA": {
      "main": [
        [
          {
            "node": "Code Verificar Tiempo Transcurrido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Verificar Tiempo Transcurrido": {
      "main": [
        [
          {
            "node": "If Verificar Expiraci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model9": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar Expiraci칩n": {
      "main": [
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request MALLA DE RECIBO ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request MALLA DE RECIBO ": {
      "main": [
        [
          {
            "node": "Extract MALLA DE RECIBO ",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract MALLA DE RECIBO Semana Siguiente1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract MALLA DE RECIBO ": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Datos, Consulta, Citas1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Datos, Consulta, Citas1": {
      "main": [
        [
          {
            "node": "Merge datos Excel1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge datos Excel1": {
      "main": [
        [
          {
            "node": "Unificaci칩n y consistencia de datos2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract MALLA DE RECIBO Semana Siguiente1": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana1": {
      "main": [
        [
          {
            "node": "Merge datos Excel1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Unificaci칩n y consistencia de datos2": {
      "main": [
        [
          {
            "node": "Basic LLM Validar selecci칩n alternativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code VALIDACI칍N DE CITA EN CRONOGRAMA": {
      "main": [
        [
          {
            "node": "If CREACION DE CITA EN CRONOGRAMA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If CREACION DE CITA EN CRONOGRAMA": {
      "main": [
        [
          {
            "node": "Code (Preparar Cuerpo de Petici칩n)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model10": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres4": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp7": {
      "main": [
        [
          {
            "node": "No Operation, do nothing6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Notificar No Disponibilidad": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje4": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres5": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp8",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp8": {
      "main": [
        [
          {
            "node": "No Operation, do nothing7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Notificar No Disponibilidad1": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje5": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model11": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Validar selecci칩n alternativa",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Validar selecci칩n alternativa": {
      "main": [
        [
          {
            "node": "Code VALIDACI칍N DE CITA EN CRONOGRAMA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser2": {
      "ai_outputParser": [
        [
          {
            "node": "Basic LLM Validar selecci칩n alternativa",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Code (Preparar Cuerpo de Petici칩n)": {
      "main": [
        [
          {
            "node": "Code Agrupar Franjas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Agrupar Franjas": {
      "main": [
        [
          {
            "node": "Loop Over Uno a Uno",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code Datos Insert Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Uno a Uno": {
      "main": [
        [
          {
            "node": "Code Validar inserciones",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code Preparar cada Insercion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Preparar cada Insercion": {
      "main": [
        [
          {
            "node": "HTTP Request Actualizar Excel1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Actualizar Excel1": {
      "main": [
        [
          {
            "node": "Code Verificar Inserci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Verificar Inserci칩n": {
      "main": [
        [
          {
            "node": "If Verificar Inserci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar Inserci칩n": {
      "main": [
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Diferente Caso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Diferente Caso": {
      "main": [
        [
          {
            "node": "Code Limpiar Celda Incorrecta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If fallo Estado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Limpiar Celda Incorrecta": {
      "main": [
        [
          {
            "node": "HTTP Request Limpiar Celda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If fallo Estado": {
      "main": [
        [
          {
            "node": "Code Reintentar Inserci칩n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "HTTP Request Limpiar Celda": {
      "main": [
        [
          {
            "node": "Code Reintentar Inserci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Reintentar Inserci칩n": {
      "main": [
        [
          {
            "node": "HTTP Request Reintentar Inserci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Reintentar Inserci칩n": {
      "main": [
        [
          {
            "node": "Code Volver a validar Inserci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Volver a validar Inserci칩n": {
      "main": [
        [
          {
            "node": "If Verificar Inserci칩n 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Loop Over Uno a Uno",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar Inserci칩n 2": {
      "main": [
        [
          {
            "node": "Wait3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Wait3": {
      "main": [
        [
          {
            "node": "Loop Over Uno a Uno",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model12": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres6": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp9",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp9": {
      "main": [
        [
          {
            "node": "No Operation, do nothing8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Notificar No Disponibilidad2": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje6": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain RECOLECCI칍N1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain RECOLECCI칍N1": {
      "main": [
        [
          {
            "node": "Code RECOLECCI칍N",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser3": {
      "ai_outputParser": [
        [
          {
            "node": "Basic LLM Chain RECOLECCI칍N1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Code Datos Insert Cita": {
      "main": [
        [
          {
            "node": "Microsoft SQL Franjas Temporales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Validar inserciones": {
      "main": [
        [
          {
            "node": "If Validar inserciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Franjas Temporales": {
      "main": [
        [
          {
            "node": "Code Estructuraci칩n de franjas temporales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Validar inserciones": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Estado SQL - CREANDO_CITA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - CREANDO_CITA": {
      "main": [
        [
          {
            "node": "Microsoft SQL Insertar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Estructuraci칩n de franjas temporales": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Microsoft SQL Eliminar Mensajes2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Insertar Cita": {
      "main": [
        [
          {
            "node": "Basic LLM Notificar Cita Exitosa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model13": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Notificar Cita Exitosa",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres7": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp10",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp10": {
      "main": [
        [
          {
            "node": "No Operation, do nothing9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Notificar Cita Exitosa": {
      "main": [
        [
          {
            "node": "Resetear Estado - Cita Exitosa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Eliminar Mensajes": {
      "main": [
        [
          {
            "node": "No Operation, do nothing10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje7": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Eliminar Mensajes2": {
      "main": [
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model14": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Extracci칩n y Validacion de Datos Editar Cita",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser4": {
      "ai_outputParser": [
        [
          {
            "node": "Basic LLM Extracci칩n y Validacion de Datos Editar Cita",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Extracci칩n y Validacion de Datos Editar Cita": {
      "main": [
        [
          {
            "node": "Estado SQL - SOLICITANDO_DATOS_EDITAR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - SOLICITANDO_DATOS_EDITAR": {
      "main": [
        [
          {
            "node": "Code Validaci칩n de datos para reprogramaci칩n de citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Validar si la operaci칩n es posible (todoCorrecto)": {
      "main": [
        [
          {
            "node": "Microsoft SQL Obtener Cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Verificar si se intenta modificar datos no permitidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar si se intenta modificar datos no permitidos": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres8",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Verificar si es un rechazo por motivos temporales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar si es un rechazo por motivos temporales": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres8",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Verificar si faltan datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar si faltan datos": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres8",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code Mensaje Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres8": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp11",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp11": {
      "main": [
        [
          {
            "node": "No Operation, do nothing11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Mensaje Error": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres8",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje8": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Obtener Cita": {
      "main": [
        [
          {
            "node": "If existe cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If existe cita": {
      "main": [
        [
          {
            "node": "HTTP Request MALLA DE RECIBO 2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code Mensaje Error1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Mensaje Error1": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres8",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Recupera todos los mensajes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code integracion de mensajes": {
      "main": [
        [
          {
            "node": "Microsoft SQL Actualiza la Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recupera todos los mensajes1": {
      "main": [
        [
          {
            "node": "Code integracion de mensajes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Actualiza la Cita": {
      "main": [
        [
          {
            "node": "Microsoft SQL Eliminar Mensajes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Validaci칩n de datos para reprogramaci칩n de citas": {
      "main": [
        [
          {
            "node": "Estado SQL - ESPERANDO_CONFIRMACION_EDITAR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - ESPERANDO_CONFIRMACION_EDITAR": {
      "main": [
        [
          {
            "node": "If Validar si la operaci칩n es posible (todoCorrecto)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "Microsoft SQL Eliminar Mensajes3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Eliminar Mensajes3": {
      "main": [
        [
          {
            "node": "No Operation, do nothing12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request MALLA DE RECIBO 2": {
      "main": [
        [
          {
            "node": "Extract MALLA DE RECIBO 2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract MALLA DE RECIBO Semana Siguiente3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract MALLA DE RECIBO 2": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Datos, Consulta, Citas3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Datos, Consulta, Citas3": {
      "main": [
        [
          {
            "node": "Merge datos Excel3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge datos Excel3": {
      "main": [
        [
          {
            "node": "Unificaci칩n y consistencia de datos4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract MALLA DE RECIBO Semana Siguiente3": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana3": {
      "main": [
        [
          {
            "node": "Merge datos Excel3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Unificaci칩n y consistencia de datos4": {
      "main": [
        [
          {
            "node": "Code Validacion de Cita en cronograma para reprogramaci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Validacion de Cita en cronograma para reprogramaci칩n": {
      "main": [
        [
          {
            "node": "If validacion de reprogramacion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If validacion de reprogramacion": {
      "main": [
        [
          {
            "node": "Code (Preparar Cuerpo de Petici칩n)1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validaci칩n de longitud de caracteres9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres9": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp12",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp12": {
      "main": [
        [
          {
            "node": "No Operation, do nothing13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje9": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code (Preparar Cuerpo de Petici칩n)1": {
      "main": [
        [
          {
            "node": "Code Agrupar Franjas2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Agrupar Franjas2": {
      "main": [
        [
          {
            "node": "Loop Over Uno a Uno1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code Datos Insert Cita1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Uno a Uno1": {
      "main": [
        [
          {
            "node": "Code Validar inserciones1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code Preparar cada Insercion1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Preparar cada Insercion1": {
      "main": [
        [
          {
            "node": "HTTP Request Actualizar Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Actualizar Excel": {
      "main": [
        [
          {
            "node": "Code Verificar Inserci칩n1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Verificar Inserci칩n1": {
      "main": [
        [
          {
            "node": "If Verificar Inserci칩n1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar Inserci칩n1": {
      "main": [
        [
          {
            "node": "Wait4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Diferente Caso1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Diferente Caso1": {
      "main": [
        [
          {
            "node": "Code Limpiar Celda Incorrecta1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If fallo Estado1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Limpiar Celda Incorrecta1": {
      "main": [
        [
          {
            "node": "HTTP Request Limpiar Celda1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Limpiar Celda1": {
      "main": [
        [
          {
            "node": "Code Reintentar Inserci칩n1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If fallo Estado1": {
      "main": [
        [
          {
            "node": "Code Reintentar Inserci칩n1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Code Reintentar Inserci칩n1": {
      "main": [
        [
          {
            "node": "HTTP Request Reintentar Inserci칩n1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Reintentar Inserci칩n1": {
      "main": [
        [
          {
            "node": "Code Volver a validar Inserci칩n1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Volver a validar Inserci칩n1": {
      "main": [
        [
          {
            "node": "If Verificar Inserci칩n ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar Inserci칩n ": {
      "main": [
        [
          {
            "node": "Wait5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Wait4": {
      "main": [
        [
          {
            "node": "Loop Over Uno a Uno1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait5": {
      "main": [
        [
          {
            "node": "Loop Over Uno a Uno1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model15": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Notificar No Disponibilidad3": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres10": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp13",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp13": {
      "main": [
        [
          {
            "node": "No Operation, do nothing14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Validar inserciones1": {
      "main": [
        [
          {
            "node": "If Validar inserciones1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Datos Insert Cita1": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Validar inserciones1": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "Estado SQL - EDITANDO_CITA",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - EDITANDO_CITA": {
      "main": [
        [
          {
            "node": "Microsoft SQLUpdate Cita Anterior",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge5": {
      "main": [
        [
          {
            "node": "Microsoft SQL Eliminar Mensajes4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Insertar Cita1": {
      "main": [
        [
          {
            "node": "Basic LLM Notificar Cita Exitosa1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model16": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Notificar Cita Exitosa1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres11": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp14",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp14": {
      "main": [
        [
          {
            "node": "No Operation, do nothing15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Notificar Cita Exitosa1": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Eliminar Mensajes4": {
      "main": [
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQLUpdate Cita Anterior": {
      "main": [
        [
          {
            "node": "Microsoft SQL Insertar Cita1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje11": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje10": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model17": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Extracci칩n Datos Cancelar Cita",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser5": {
      "ai_outputParser": [
        [
          {
            "node": "Basic LLM Extracci칩n Datos Cancelar Cita",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Extracci칩n Datos Cancelar Cita": {
      "main": [
        [
          {
            "node": "Code Validaci칩n datos para cancelaci칩n de citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Validaci칩n datos para cancelaci칩n de citas": {
      "main": [
        [
          {
            "node": "If Validar si los datos est치n completos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Validar si los datos est치n completos": {
      "main": [
        [
          {
            "node": "Microsoft SQL Obtener Cita para Cancelar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validaci칩n de longitud de caracteres12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres12": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp15",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp15": {
      "main": [
        [
          {
            "node": "No Operation, do nothing16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje12": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Obtener Cita para Cancelar": {
      "main": [
        [
          {
            "node": "If cita para cancelar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If cita para cancelar": {
      "main": [
        [
          {
            "node": "HTTP Request MALLA DE RECIBO 3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code respuesta cita no programada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres13": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp16",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp16": {
      "main": [
        [
          {
            "node": "No Operation, do nothing17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code respuesta cita no programada": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres13",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje13": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request MALLA DE RECIBO 3": {
      "main": [
        [
          {
            "node": "Extract MALLA DE RECIBO 3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract MALLA DE RECIBO Semana Siguiente4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract MALLA DE RECIBO 3": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Datos, Consulta, Citas4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Datos, Consulta, Citas4": {
      "main": [
        [
          {
            "node": "Merge datos Excel4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge datos Excel4": {
      "main": [
        [
          {
            "node": "Unificaci칩n y consistencia de datos5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract MALLA DE RECIBO Semana Siguiente4": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, Datos, Consulta, Citas Proxima Semana4": {
      "main": [
        [
          {
            "node": "Merge datos Excel4",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Unificaci칩n y consistencia de datos5": {
      "main": [
        [
          {
            "node": "Code validaci칩n de cita en malla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code validaci칩n de cita en malla": {
      "main": [
        [
          {
            "node": "If validar cita existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres14": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp17",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp17": {
      "main": [
        [
          {
            "node": "No Operation, do nothing18",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If validar cita existe": {
      "main": [
        [
          {
            "node": "Code (Preparar Cuerpo de Petici칩n)2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validaci칩n de longitud de caracteres14",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje14": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code (Preparar Cuerpo de Petici칩n)2": {
      "main": [
        [
          {
            "node": "Code Agrupar Franjas3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Agrupar Franjas3": {
      "main": [
        [
          {
            "node": "Loop Over Uno a Uno2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code Datos Cancelar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Uno a Uno2": {
      "main": [
        [
          {
            "node": "Code Validar inserciones2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code Preparar cada Insercion2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Preparar cada Insercion2": {
      "main": [
        [
          {
            "node": "HTTP Request Actualizar Excel2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Actualizar Excel2": {
      "main": [
        [
          {
            "node": "Code Verificar Inserci칩n2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Verificar Inserci칩n2": {
      "main": [
        [
          {
            "node": "If Verificar Inserci칩n2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar Inserci칩n2": {
      "main": [
        [
          {
            "node": "Wait6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Diferente Caso2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Diferente Caso2": {
      "main": [
        [
          {
            "node": "Code Limpiar Celda Incorrecta2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If fallo Estado2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Limpiar Celda Incorrecta2": {
      "main": [
        [
          {
            "node": "HTTP Request Limpiar Celda2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Limpiar Celda2": {
      "main": [
        [
          {
            "node": "Code Reintentar Inserci칩n2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If fallo Estado2": {
      "main": [
        [
          {
            "node": "Code Reintentar Inserci칩n2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Code Reintentar Inserci칩n2": {
      "main": [
        [
          {
            "node": "HTTP Request Reintentar Inserci칩n2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Reintentar Inserci칩n2": {
      "main": [
        [
          {
            "node": "Code Volver a validar Inserci칩n2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Volver a validar Inserci칩n2": {
      "main": [
        [
          {
            "node": "If Verificar Inserci칩n 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Verificar Inserci칩n 1": {
      "main": [
        [
          {
            "node": "Wait7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Wait6": {
      "main": [
        [
          {
            "node": "Loop Over Uno a Uno2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait7": {
      "main": [
        [
          {
            "node": "Loop Over Uno a Uno2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model18": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad4",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Notificar No Disponibilidad4": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres16": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp19",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp19": {
      "main": [
        [
          {
            "node": "No Operation, do nothing20",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Validar inserciones2": {
      "main": [
        [
          {
            "node": "If Validar inserciones2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Validar inserciones2": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge6": {
      "main": [
        [
          {
            "node": "Microsoft SQLUpdate Cita Anterior1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge7": {
      "main": [
        [
          {
            "node": "Microsoft SQL Eliminar Mensajes5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model19": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Notificar Cancelar Cita",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres17": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp20",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp20": {
      "main": [
        [
          {
            "node": "No Operation, do nothing21",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Eliminar Mensajes5": {
      "main": [
        [
          {
            "node": "Basic LLM Notificar No Disponibilidad4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQLUpdate Cita Anterior1": {
      "main": [
        [
          {
            "node": "Estado SQL - CANCELANDO_CITA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - CANCELANDO_CITA": {
      "main": [
        [
          {
            "node": "Basic LLM Notificar Cancelar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Datos Cancelar Cita": {
      "main": [
        [
          {
            "node": "Estado SQL - CONFIRMANDO_CANCELACION",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - CONFIRMANDO_CANCELACION": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Notificar Cancelar Cita": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje15": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje16": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM CONVERSACI칍N GENERAL",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres15": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp18",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp18": {
      "main": [
        [
          {
            "node": "No Operation, do nothing19",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM CONVERSACI칍N GENERAL": {
      "main": [
        [
          {
            "node": "Estado SQL - RESPONDIENDO_PREGUNTA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado SQL - RESPONDIENDO_PREGUNTA": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, de datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, de datos": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje17": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres18": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp21",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje18",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp21": {
      "main": [
        [
          {
            "node": "No Operation, do nothing22",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, de datos1": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres18",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Microsoft SQL Eliminaci칩n Mensajes": {
      "main": [
        [
          {
            "node": "Estructuraci칩n, de datos1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Estructuraci칩n, de datos2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje18": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci칩n de longitud de caracteres19": {
      "main": [
        [
          {
            "node": "HTTP Request Enviar Mensaje por WhatsApp22",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Organiza variables del mensaje19",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Enviar Mensaje por WhatsApp22": {
      "main": [
        [
          {
            "node": "No Operation, do nothing23",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estructuraci칩n, de datos2": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Organiza variables del mensaje19": {
      "main": [
        [
          {
            "node": "Basic LLM Separaci칩n de Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM MANEJO FUERA CONTEXTO": {
      "main": [
        [
          {
            "node": "Verificar Reinicio Fuera Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Estado Conversacional": {
      "main": [
        [
          {
            "node": "Merge de Datos",
            "type": "main",
            "index": 0
          },
          {
            "node": "Count y Tiempo 칔ltimo Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Estado por Intenci칩n": {
      "main": [
        [
          {
            "node": "Switch Redistribuci칩n por Intenci칩n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Redistribuci칩n por Intenci칩n": {
      "main": [
        [
          {
            "node": "Basic LLM CONVERSACI칍N (SALUDO)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request MALLA DE RECIBO 2025",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Request Malla Fija",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Microsoft SQL Obtener Alternativas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Basic LLM Extracci칩n y Validacion de Datos Editar Cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Basic LLM Extracci칩n Datos Cancelar Cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request Malla Fija1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Basic LLM CONVERSACI칍N GENERAL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Microsoft SQL Eliminaci칩n Mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Basic LLM MANEJO FUERA CONTEXTO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Reinicio Fuera Contexto": {
      "main": [
        [
          {
            "node": "If contador_fuera_contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resetear Estado - Cita Exitosa": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If contador_fuera_contexto": {
      "main": [
        [
          {
            "node": "Microsoft SQL Eliminaci칩n Mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge8",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge8": {
      "main": [
        [
          {
            "node": "Validaci칩n de longitud de caracteres19",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model20": {
      "ai_languageModel": [
        [
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "231a2153-a360-4055-9830-a186634c2262",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "1eb0088037a07ba7867394f235324ea67bbb89bb030f5b44da808ec979ca0c6d"
  },
  "id": "K7ebXPtGcFBUADxI",
  "tags": []
}